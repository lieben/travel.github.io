<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‰∫≤Â≠êÊóÖÊ∏∏ÊâãÂ∏êAIÂ∞èÂä©Êâã V5.1 - ÁªàÊûÅÂÆåÊï¥Áâà</title>
    <style>
     /* CSSÊ†∑Âºè - 100%ÂÆåÊï¥ */
@import url('https://fonts.googleapis.com/css2?family=ZCOOL+XiaoWei&family=Noto+Sans+SC:wght@400;700&display=swap');
body {
    font-family: 'Noto Sans SC', sans-serif;
    background: linear-gradient(135deg, #E3F2FD 0%, #F3E5F5 50%, #FFF3E0 100%);
    color: #2E3A59;
    margin: 0;
    padding: 20px;
    display: flex;
    flex-direction: column;
    align-items: center;
    min-height: 100vh;
}
.container {
    width: 100%;
    max-width: 800px;
    background: rgba(255, 255, 255, 0.95);
    border-radius: 25px;
    box-shadow: 0 15px 35px rgba(46, 58, 89, 0.15);
    padding: 30px;
    box-sizing: border-box;
    margin-bottom: 20px;
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.2);
}
header { 
    text-align: center; 
    margin-bottom: 30px; 
    border-bottom: 3px dashed #FFCC80; 
    padding-bottom: 20px; 
}
header h1 {
    font-family: 'ZCOOL+XiaoWei', serif;
    font-size: 2.8em;
    color: #5C6BC0;
    margin: 0;
    text-shadow: 2px 2px 4px rgba(92, 107, 192, 0.3);
}
header p { 
    font-size: 1.1em; 
    color: #795548; 
}
.form-block {
    background: linear-gradient(135deg, #F8F9FF 0%, #F3E5F5 100%);
    border-radius: 20px;
    padding: 25px;
    margin-bottom: 25px;
    border: 1px solid rgba(92, 107, 192, 0.1);
    position: relative;
    overflow: hidden;
}

.form-block::before {
    content: '';
    position: absolute;
    top: -50%;
    right: -20px;
    width: 100px;
    height: 100px;
    background: url('images/afbcfbd3-addf-4e32-a3ab-6e2bca0a2ebd.jpeg') no-repeat center;
    background-size: contain;
    opacity: 0.05;
    transform: rotate(15deg);
}
.form-block h3 {
    font-family: 'ZCOOL XiaoWei', serif;
    font-size: 1.5em;
    color: #5C6BC0;
    margin-top: 0;
    display: flex;
    align-items: center;
    position: relative;
    z-index: 2;
    cursor: pointer;
    user-select: none;
    transition: all 0.3s ease;
    padding: 10px;
    border-radius: 10px;
    margin: -10px -10px 15px -10px;
}
.form-block h3:hover {
    background-color: rgba(92, 107, 192, 0.1);
    transform: translateY(-2px);
}
.form-block h3 span {
    font-size: 1.8em;
    margin-right: 10px;
}
.form-block h3::after {
    content: '‚ñº';
    margin-left: auto;
    font-size: 0.8em;
    transition: transform 0.3s ease;
    color: #5C6BC0;
}
.form-block.collapsed h3::after {
    transform: rotate(-90deg);
}
.form-block-content {
    transition: all 0.3s ease;
    overflow: hidden;
}
.form-block.collapsed .form-block-content {
    max-height: 0;
    opacity: 0;
    margin-top: 0;
    padding-top: 0;
}
.input-group { 
    display: flex; 
    flex-direction: column; 
    flex-grow: 1; 
    gap: 5px; 
}
.input-label, label { 
    font-weight: 700; 
    margin-bottom: 5px; 
    display: block; 
}
input[type="text"], input[type="number"], input[type="password"], input[type="date"], select, textarea {
    padding: 12px;
    border: 2px solid #B39DDB;
    border-radius: 12px;
    font-size: 1em;
    background-color: rgba(255, 255, 255, 0.9);
    width: 100%;
    box-sizing: border-box;
    font-family: 'Noto Sans SC', 'Microsoft YaHei', sans-serif;
    transition: all 0.3s ease;
}

input:focus, select:focus, textarea:focus {
    border-color: #5C6BC0;
    box-shadow: 0 0 0 3px rgba(92, 107, 192, 0.1);
    outline: none;
}
textarea {
    resize: vertical;
    min-height: 80px;
}

/* ÂèØÁºñËæëÂÖÉÁ¥†Ê†∑Âºè */
.editable-title, .editable-mission, .editable-funfact, .editable-challenge,
.editable-knowledge, .editable-info, .editable-topic, .editable-story,
.editable-prompt, .editable-journal {
    transition: all 0.3s ease;
}

.editable-title:focus, .editable-mission:focus, .editable-funfact:focus,
.editable-challenge:focus, .editable-knowledge:focus, .editable-info:focus,
.editable-topic:focus, .editable-story:focus, .editable-prompt:focus,
.editable-journal:focus {
    background-color: rgba(92, 107, 192, 0.1) !important;
    border: 1px solid #5C6BC0 !important;
    border-radius: 4px;
    padding: 4px 8px;
    outline: none;
    box-shadow: 0 0 0 2px rgba(92, 107, 192, 0.2);
}

.editable-title:hover, .editable-mission:hover, .editable-funfact:hover,
.editable-challenge:hover, .editable-knowledge:hover, .editable-info:hover,
.editable-topic:hover, .editable-story:hover, .editable-prompt:hover,
.editable-journal:hover {
    background-color: rgba(92, 107, 192, 0.05) !important;
    cursor: text;
}
.api-key-row { 
    display: flex; 
    gap: 10px; 
    align-items: center; 
}
.fetch-btn, .clear-btn {
    padding: 12px 18px;
    background: linear-gradient(135deg, #7986CB, #5C6BC0);
    color: white;
    border: none;
    border-radius: 12px;
    cursor: pointer;
    font-weight: bold;
    transition: all 0.3s ease;
    box-shadow: 0 4px 12px rgba(92, 107, 192, 0.3);
}

.fetch-btn:hover, .clear-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(92, 107, 192, 0.4);
}
.clear-btn {
    background-color: #E0E0E0;
    color: #757575;
    font-size: 0.8em;
    padding: 5px 10px;
}
#custom-endpoint-group {
    margin-top: 15px;
}
.search-status {
    font-size: 0.9em;
    color: #4CAF50;
    margin-top: 5px;
}
.gemini-search-highlight {
    background: linear-gradient(135deg, #E8F5E9, #F1F8E9);
    border: 1px solid #4CAF50;
    border-radius: 8px;
    padding: 8px;
    margin-top: 5px;
}
.search-feature-badge {
    display: inline-block;
    background: #4CAF50;
    color: white;
    font-size: 0.7em;
    padding: 2px 6px;
    border-radius: 10px;
    margin-left: 5px;
}
#api-status { 
    font-size: 0.9em; 
    color: #4CAF50; 
    min-height: 1.2em; 
}
.icon-options { 
    display: flex; 
    gap: 10px; 
    flex-wrap: wrap; 
}
.icon-options label { 
    display: flex; 
    flex-direction: column; 
    align-items: center; 
    cursor: pointer; 
    padding: 10px; 
    border-radius: 10px; 
    transition: all 0.2s; 
    border: 2px solid transparent; 
}
.icon-options input[type="radio"], .icon-options input[type="checkbox"] { 
    display: none; 
}
.icon-options .icon { 
    font-size: 2.5em; 
}
.icon-options span { 
    margin-top: 5px; 
    font-weight: bold; 
    font-size: 0.9em; 
}
.icon-options .content { 
    display: flex; 
    flex-direction: column; 
    align-items: center; 
    transition: transform 0.2s; 
}
.icon-options input:checked + .content {
    transform: scale(1.1);
    color: #FF7043;
}
.icon-options label.selected {
    background-color: #FFECB3;
    border-color: #FFCC80;
}
.dynamic-list .list-item { 
    display: flex; 
    align-items: center; 
    gap: 10px; 
    background: #fff; 
    padding: 8px 10px; 
    border-radius: 8px; 
    margin-bottom: 10px; 
}
.dynamic-list input { 
    border: none; 
    background: transparent; 
    flex-grow: 1; 
}
#multi-city-container .list-item input { 
    border-bottom: 1px solid #ddd; 
}
.add-btn, .remove-btn { 
    background-color: #FFAB91; 
    color: white; 
    border: none; 
    border-radius: 50%; 
    width: 28px; 
    height: 28px; 
    font-size: 1.5em; 
    cursor: pointer; 
    display: flex; 
    align-items: center; 
    justify-content: center; 
    flex-shrink: 0; 
    line-height: 1; 
}
.remove-btn { 
    background-color: #E0E0E0; 
    color: #757575; 
}
.submit-btn { 
    width: 100%; 
    padding: 15px; 
    font-family: 'ZCOOL XiaoWei', serif; 
    font-size: 1.8em; 
    background-color: #FF7043; 
    color: white; 
    border: none; 
    border-radius: 15px; 
    cursor: pointer; 
}
.submit-btn:disabled, .fetch-btn:disabled { 
    background-color: #BDBDBD; 
    cursor: not-allowed; 
}
.plan-section, #loading-indicator {
    display: none;
}
.action-buttons {
    display: flex;
    gap: 15px;
    justify-content: center;
    margin-top: 30px;
    padding: 20px;
}
.print-btn, .new-plan-btn {
    padding: 12px 24px;
    border: none;
    border-radius: 10px;
    font-family: 'ZCOOL XiaoWei', serif;
    font-size: 1.1em;
    cursor: pointer;
    transition: all 0.3s ease;
}
.print-btn {
    background-color: #4CAF50;
    color: white;
}
.print-btn:hover {
    background-color: #45a049;
}
.new-plan-btn {
    background-color: #2196F3;
    color: white;
}
.new-plan-btn:hover {
    background-color: #1976D2;
}
.tab-controls { 
    display: flex; 
    gap: 10px; 
    margin-bottom: -2px; 
}
.tab-btn { 
    padding: 10px 20px; 
    font-family: 'ZCOOL XiaoWei', serif; 
    font-size: 1.3em; 
    border: 2px solid #FFAB91; 
    border-bottom: none; 
    background: #FFF3E0; 
    border-radius: 10px 10px 0 0; 
    cursor: pointer; 
}
.tab-btn.active { 
    background: #fff; 
    color: #FF7043; 
    border-bottom: 2px solid #fff; 
}
.tab-content { 
    display: none; 
}
.tab-content.active { 
    display: block; 
}
.day-page { 
    background: #fff; 
    border: 2px solid #FFAB91; 
    border-radius: 0 15px 15px 15px; 
    padding: 30px; 
    margin-bottom: 20px; 
}
.day-header h2 { 
    font-family: 'ZCOOL XiaoWei', serif; 
    font-size: 2em; 
    color: #FF7043; 
    margin: 0; 
}
.itinerary-item ul { 
    padding-left: 20px; 
    margin: 0; 
    list-style-type: 'üèñÔ∏è '; 
}
.itinerary-item li { 
    margin-bottom: 10px; 
}
.parent-tip { 
    background-color: #E8F5E9; 
    border-left: 4px solid #4CAF50; 
    padding: 10px; 
    margin-top: 15px; 
    border-radius: 4px; 
    font-size: 0.9em; 
}
.doodle-area { 
    border: 2px dashed #BDBDBD; 
    border-radius: 10px; 
    padding: 20px; 
    margin-top: 30px; 
    text-align: center; 
    color: #BDBDBD; 
    min-height: 100px; 
}
.print-btn, .new-plan-btn { 
    width: 100%; 
    padding: 15px; 
    font-weight: bold; 
    font-size: 1.2em; 
    background-color: #4CAF50; 
    color: white; 
    border: none; 
    border-radius: 15px; 
    cursor: pointer; 
    margin-top: 10px; 
}
.new-plan-btn { 
    background-color: #FF9800; 
}
#loading-indicator {
    text-align: center;
    padding: 40px;
    font-size: 1.5em;
    color: #FF7043;
    font-family: 'ZCOOL XiaoWei', serif;
}

/* ËÆ∞‰∫ãÊú¨Ê†∑Âºè */
.travel-notebook {
    display: flex;
    background: #f8f8f8;
    border-radius: 15px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.15);
    overflow: hidden;
    min-height: 800px;
    position: relative;
}

.notebook-tabs {
    position: absolute;
    right: -15px;
    top: 50px;
    display: flex;
    flex-direction: column;
    gap: 5px;
    z-index: 10;
}

.tab-item {
    width: 35px;
    height: 60px;
    background: linear-gradient(135deg, #7986CB, #5C6BC0);
    border-radius: 8px 0 0 8px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s ease;
    color: white;
    font-size: 0.7em;
    font-weight: bold;
    box-shadow: -3px 3px 8px rgba(92, 107, 192, 0.3);
    position: relative;
}

.tab-item::before {
    content: '';
    position: absolute;
    left: -8px;
    top: 50%;
    transform: translateY(-50%);
    width: 0;
    height: 0;
    border-top: 8px solid transparent;
    border-bottom: 8px solid transparent;
    border-right: 8px solid #5C6BC0;
}

.tab-item:hover {
    transform: translateX(-5px);
    box-shadow: -5px 5px 12px rgba(92, 107, 192, 0.4);
}

.tab-item.active {
    background: linear-gradient(135deg, #AB47BC, #8E24AA);
    transform: translateX(-8px);
    box-shadow: -6px 6px 15px rgba(142, 36, 170, 0.4);
}

.tab-item.active::before {
    border-right-color: #8E24AA;
}

.tab-number {
    font-size: 0.9em;
    font-weight: bold;
    margin-bottom: 2px;
    line-height: 1;
}

.tab-label {
    font-size: 0.6em;
    text-align: center;
    line-height: 1;
    margin-bottom: 2px;
}

.tab-icon {
    font-size: 0.7em;
    opacity: 0.9;
    line-height: 1;
}

.notebook-content {
    width: 100%;
    background: white;
    position: relative;
    overflow: hidden;
    border-radius: 15px;
    box-shadow: 0 10px 25px rgba(46, 58, 89, 0.15);
}

.notebook-page {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    opacity: 0;
    transform: translateX(20px);
    transition: all 0.4s ease;
    display: none;
}

.notebook-page.active {
    opacity: 1;
    transform: translateX(0);
    display: block;
}

.page-content {
    padding: 40px;
    height: 100%;
    overflow-y: auto;
    background:
        linear-gradient(90deg, #5C6BC0 0px, #5C6BC0 2px, transparent 2px),
        repeating-linear-gradient(transparent, transparent 24px, #E8EAF6 24px, #E8EAF6 25px);
    background-size: 100% 100%, 100% 25px;
    background-position: 0 0, 0 40px;
    position: relative;
}

.page-content::after {
    content: '';
    position: absolute;
    bottom: 20px;
    right: 20px;
    width: 60px;
    height: 60px;
    background: url('images/afbcfbd3-addf-4e32-a3ab-6e2bca0a2ebd.jpeg') no-repeat center;
    background-size: cover;
    border-radius: 50%;
    opacity: 0.1;
    pointer-events: none;
}

.notebook-controls {
    display: flex;
    gap: 15px;
    justify-content: center;
    margin-top: 20px;
}

/* Â∞ÅÈù¢È°µÊ†∑Âºè */
.cover-page {
    text-align: center;
    display: flex;
    flex-direction: column;
    justify-content: center;
    background: linear-gradient(135deg, #E8EAF6 0%, #F3E5F5 50%, #E1F5FE 100%);
    position: relative;
    overflow: hidden;
}

.cover-page::before {
    content: '';
    position: absolute;
    top: 10%;
    left: 10%;
    width: 120px;
    height: 120px;
    background: url('images/afbcfbd3-addf-4e32-a3ab-6e2bca0a2ebd.jpeg') no-repeat center;
    background-size: cover;
    border-radius: 50%;
    opacity: 0.08;
    transform: rotate(-15deg);
}

.cover-page::after {
    content: '';
    position: absolute;
    bottom: 10%;
    right: 10%;
    width: 100px;
    height: 100px;
    background: url('images/afbcfbd3-addf-4e32-a3ab-6e2bca0a2ebd.jpeg') no-repeat center;
    background-size: cover;
    border-radius: 50%;
    opacity: 0.06;
    transform: rotate(25deg);
}

.cover-title {
    font-family: 'ZCOOL XiaoWei', serif;
    font-size: 3em;
    color: #5C6BC0;
    margin-bottom: 20px;
    text-shadow: 2px 2px 4px rgba(92, 107, 192, 0.3);
}

.cover-subtitle {
    font-size: 1.5em;
    color: #8D6E63;
    margin-bottom: 30px;
}

.cover-info {
    background: rgba(255,255,255,0.8);
    padding: 20px;
    border-radius: 15px;
    margin: 20px auto;
    max-width: 400px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}

/* Ë°åÁ®ãÈ°µÊ†∑Âºè */
.itinerary-page h2 {
    font-family: 'ZCOOL XiaoWei', serif;
    color: #5C6BC0;
    border-bottom: 3px solid #B39DDB;
    padding-bottom: 10px;
    margin-bottom: 20px;
}

.day-summary {
    background: #FFFDE7;
    border-left: 5px solid #FFCC80;
    padding: 15px;
    margin-bottom: 20px;
    border-radius: 0 10px 10px 0;
}

.day-summary h3 {
    color: #FF7043;
    margin: 0 0 10px 0;
    font-family: 'ZCOOL XiaoWei', serif;
}

/* Ê∏ÖÂçïÈ°µÊ†∑Âºè */
.checklist-page h2 {
    font-family: 'ZCOOL XiaoWei', serif;
    color: #FF7043;
    border-bottom: 3px solid #FFCC80;
    padding-bottom: 10px;
    margin-bottom: 20px;
}

.checklist-section {
    background: #FFFDE7;
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 20px;
}

.checklist-section h3 {
    color: #8D6E63;
    margin-bottom: 15px;
    font-family: 'ZCOOL XiaoWei', serif;
}

.checklist-item {
    display: flex;
    align-items: center;
    margin-bottom: 8px;
    padding: 5px 0;
}

.checklist-item input[type="checkbox"] {
    margin-right: 10px;
    transform: scale(1.2);
}

/* ËØ¶ÊÉÖÈ°µÊ†∑Âºè */
.detail-page h2 {
    font-family: 'ZCOOL XiaoWei', serif;
    color: #FF7043;
    border-bottom: 3px solid #FFCC80;
    padding-bottom: 10px;
    margin-bottom: 20px;
}

.location-info {
    background: #FFFDE7;
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 20px;
}

.info-section {
    margin-bottom: 20px;
}

.info-section h4 {
    color: #8D6E63;
    margin-bottom: 10px;
    font-family: 'ZCOOL XiaoWei', serif;
}

.drawing-area {
    border: 2px dashed #FFCC80;
    padding: 10px;
    border-radius: 10px;
    background: #FFFDE7;
    display: flex;
    gap: 10px;
    align-items: flex-start;
    flex-wrap: wrap;
}

.drawing-area canvas {
    border: 1px solid #ccc;
    cursor: crosshair;
    background-color: #fff;
    border-radius: 8px;
}

/* Âàõ‰ΩúÂå∫Ê†∑Âºè‰ºòÂåñ */
.creative-zone {
    position: relative;
    border: 2px dashed #FFCC80;
    border-radius: 15px;
    background: #FFFDE7;
    padding: 15px;
    min-height: 300px;
}

.creative-zone-header {
    position: absolute;
    top: 8px;
    left: 15px;
    font-size: 0.9em;
    font-weight: bold;
    color: #FF8A65;
    background: #FFFDE7;
    padding: 2px 8px;
    border-radius: 4px;
    z-index: 10;
}

.creative-prompt {
    margin-top: 25px;
    margin-bottom: 15px;
    font-size: 0.95em;
    color: #8D6E63;
    text-align: center;
    font-style: italic;
}

.creative-zone .drawing-area {
    border: none;
    padding: 0;
    background: transparent;
    display: flex;
    justify-content: center;
    align-items: center;
}

/* Free SpaceÂå∫ÂüüÊ†∑Âºè */
.free-space-zone {
    position: relative;
    border: 2px dashed #90CAF9;
    border-radius: 15px;
    background: #E3F2FD;
    padding: 15px;
    min-height: 300px;
}

.free-space-header {
    position: absolute;
    top: 8px;
    left: 15px;
    font-size: 0.9em;
    font-weight: bold;
    color: #5C6BC0;
    background: #E3F2FD;
    padding: 2px 8px;
    border-radius: 4px;
    z-index: 10;
}

.free-space-zone .drawing-area {
    border: none;
    padding: 0;
    background: transparent;
    display: flex;
    justify-content: center;
    align-items: center;
    margin-top: 20px;
}

.sticker-palette {
    display: flex;
    flex-direction: column;
    gap: 10px;
    padding: 10px;
    background: rgba(255, 255, 255, 0.5);
    border-radius: 10px;
}

.sticker-palette p {
    margin: 0 0 5px 0;
    font-size: 0.9em;
    color: #8D6E63;
    font-weight: bold;
}

.stickers {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
}

.sticker {
    width: 50px;
    height: 50px;
    cursor: grab;
    transition: transform 0.1s;
}

.sticker:active {
    cursor: grabbing;
    transform: scale(1.1);
}

/* ÂÆâÂÖ®È°µÊ†∑Âºè */
.safety-page h2 {
    font-family: 'ZCOOL XiaoWei', serif;
    color: #F44336;
    border-bottom: 3px solid #FFCDD2;
    padding-bottom: 10px;
    margin-bottom: 20px;
}

.emergency-contact {
    background: #FFEBEE;
    border: 2px solid #FFCDD2;
    border-radius: 10px;
    padding: 15px;
    margin-bottom: 15px;
}

.emergency-contact h4 {
    color: #F44336;
    margin-bottom: 10px;
    font-family: 'ZCOOL XiaoWei', serif;
}

.contact-number {
    font-size: 1.2em;
    font-weight: bold;
    color: #D32F2F;
    background: white;
    padding: 5px 10px;
    border-radius: 5px;
    display: inline-block;
    margin: 5px 0;
}

/* ÂõæÁâáÁõ∏ÂÖ≥Ê†∑Âºè */
.page-decoration {
    position: absolute;
    opacity: 0.1;
    pointer-events: none;
    z-index: 1;
}

.page-decoration.top-right {
    top: 20px;
    right: 20px;
    width: 80px;
    height: 80px;
}

.page-decoration.bottom-left {
    bottom: 20px;
    left: 20px;
    width: 60px;
    height: 60px;
}

.page-decoration.center {
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 100px;
    height: 100px;
    opacity: 0.05;
}

.illustration {
    max-width: 100%;
    height: auto;
    border-radius: 10px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    margin: 15px 0;
}

.cover-illustration {
    width: 120px;
    height: 120px;
    margin: 20px auto;
    border-radius: 50%;
    overflow: hidden;
    box-shadow: 0 10px 25px rgba(255,112,67,0.3);
}

.cover-illustration img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.section-icon {
    width: 40px;
    height: 40px;
    display: inline-block;
    vertical-align: middle;
    margin-right: 10px;
    filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.1));
}

/* ÂìçÂ∫îÂºèÂõæÁâáÂ§ÑÁêÜ */
@media (max-width: 768px) {
    .cover-illustration {
        width: 80px;
        height: 80px;
    }

    .section-icon {
        width: 30px;
        height: 30px;
    }

    .page-decoration {
        display: none;
    }
}

/* ÂõæÁâáÂä†ËΩΩÂä®Áîª */
.illustration, .cover-illustration img, .section-icon {
    transition: all 0.3s ease;
}

.illustration:hover, .cover-illustration:hover {
    transform: scale(1.05);
}

/* ÂõæÁâáÂä†ËΩΩÂ§±Ë¥•Â§ÑÁêÜ */
img {
    max-width: 100%;
    height: auto;
}

img[alt]:after {
    content: attr(alt);
    display: block;
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: #f0f0f0;
    color: #666;
    font-size: 12px;
    text-align: center;
    line-height: 1.5;
    padding: 10px;
    box-sizing: border-box;
}

@media print {
    body {
        background-color: #fff;
        padding: 0;
        margin: 0;
    }
    .container, .input-section, .notebook-controls, header {
        display: none !important;
    }
    .plan-section {
        display: block !important;
        box-shadow: none;
        width: 100%;
        max-width: 100%;
        margin: 0;
    }
    .travel-notebook {
        box-shadow: none;
        border-radius: 0;
        min-height: auto;
    }
    .notebook-tabs {
        display: none !important;
    }
    .notebook-content {
        width: 100%;
    }
    .notebook-page {
        position: static !important;
        opacity: 1 !important;
        transform: none !important;
        display: block !important;
        page-break-after: always;
        height: auto;
        min-height: 100vh;
    }
    .notebook-page:last-child {
        page-break-after: avoid;
    }
    .page-content {
        padding: 20px;
        height: auto;
        min-height: calc(100vh - 40px);
        background: white;
        overflow: visible;
    }
    .cover-page {
        background: white !important;
    }
    .checklist-item input[type="checkbox"] {
        -webkit-appearance: checkbox;
        appearance: checkbox;
    }
    .contact-number {
        background: #f0f0f0 !important;
    }
}

/* ÁâàÊú¨ÂàáÊç¢Ê†∑Âºè */
.version-tabs {
    display: flex;
    justify-content: center;
    gap: 10px;
    margin-bottom: 30px;
    padding-bottom: 0;
    border-bottom: none;
}

.version-btn {
    padding: 12px 20px;
    font-size: 1em;
    font-weight: bold;
    border: 2px solid #E0E0E0;
    background-color: #f8f9fa;
    border-radius: 25px;
    cursor: pointer;
    transition: all 0.3s ease;
    color: #757575;
    position: relative;
    bottom: 0;
}

.version-btn.active {
    background-color: #5C6BC0;
    color: white;
    border-color: #5C6BC0;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(92, 107, 192, 0.3);
}

.version-btn:hover:not(.active) {
    background-color: #e9ecef;
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.version-content-wrapper {
    background: transparent;
    border: none;
    border-radius: 0;
    min-height: 400px;
    position: relative;
}

.version-content {
    display: none;
    padding: 0;
}

.version-content.active {
    display: block;
}

.notebook-controls {
    display: flex;
    justify-content: space-between;
    gap: 15px;
    margin-top: 20px;
}

/* Âú∞ÁÇπÈ°µÈù¢ÂÆπÂô®Ê†∑Âºè - ‰ªøÁ¨îËÆ∞Êú¨ËÆæËÆ° */
.location-page-container {
    margin-bottom: 40px;
    padding: 20px;
    border: 1px solid #eee;
    border-radius: 15px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    background: white;
}

.location-page-container:last-child {
    margin-bottom: 0;
}

.location-title-h1 {
    font-family: 'ZCOOL XiaoWei', serif;
    font-size: 2.5em;
    color: #5C6BC0;
    text-align: center;
    margin-bottom: 10px;
}

.location-title-h2 {
    font-size: 1.2em;
    color: #795548;
    text-align: center;
    margin-bottom: 30px;
    font-style: italic;
}

.section-container {
    margin-bottom: 25px;
}

.section-title-h3 {
    font-family: 'ZCOOL XiaoWei', serif;
    font-size: 1.6em;
    color: #FF7043;
    display: flex;
    align-items: center;
    gap: 10px;
    border-bottom: 2px solid #FFECB3;
    padding-bottom: 8px;
    margin-bottom: 15px;
}

.section-title-h3 span {
    font-size: 1.5em;
}

/* ÂÑøÁ´•Áâà‰∏ìÂ±ûÊ†∑Âºè */
.mission-list {
    list-style-type: none;
    padding-left: 0;
}

.mission-item {
    background: #FFFDE7;
    border-left: 5px solid #FFCC80;
    padding: 15px;
    margin-bottom: 10px;
    border-radius: 0 8px 8px 0;
    font-size: 1.1em;
}

.fun-fact-box {
    background: #E3F2FD;
    border: 2px dashed #90CAF9;
    padding: 20px;
    border-radius: 15px;
    text-align: center;
    margin: 20px 0;
}

.creative-zone {
    border: 3px dashed #B39DDB;
    border-radius: 15px;
    padding: 20px;
    min-height: 150px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    text-align: center;
    color: #9575CD;
    background-color: #F3E5F520;
}

.creative-zone p {
    margin: 5px 0;
    font-weight: bold;
}

/* ÈùíÂ∞ëÂπ¥Áâà‰∏ìÂ±ûÊ†∑Âºè */
.teen-mission-item {
    font-size: 1.1em;
    margin-bottom: 8px;
    color: #555;
}

.knowledge-plus-box {
    background-color: #f8f9fa;
    border-left: 4px solid #5C6BC0;
    padding: 15px;
    margin: 15px 0;
    font-size: 0.95em;
    border-radius: 4px;
}

.inspiration-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
}

.inspiration-item {
    background: #fafafa;
    border: 1px solid #eee;
    padding: 15px;
    border-radius: 8px;
}

.inspiration-item h4 {
    margin: 0 0 10px 0;
    color: #333;
    font-weight: bold;
}

.color-palette {
    display: flex;
    gap: 10px;
}

.color-swatch {
    width: 30px;
    height: 30px;
    border-radius: 50%;
    background-color: #eee;
}

.dot-grid {
    background-image: radial-gradient(#ccc 1px, transparent 0);
    background-size: 15px 15px;
    padding: 20px;
}

/* ÂÆ∂ÈïøÁâà‰∏ìÂ±ûÊ†∑Âºè */
.practical-info-box {
    background: #E8F5E9;
    padding: 15px;
    border-radius: 8px;
    border-left: 4px solid #66BB6A;
}

.practical-info-box ul {
    padding-left: 20px;
    margin: 0;
}

.storytelling-item, .engagement-item {
    margin-bottom: 15px;
}

.storytelling-item h4, .engagement-item h4 {
    color: #5C6BC0;
    font-weight: bold;
    margin-bottom: 5px;
}

.journal-space {
    border: 2px dashed #FFCC80;
    min-height: 100px;
    padding: 15px;
    border-radius: 10px;
    background: #FFFDE7;
    color: #8D6E63;
}

/* ÊóÖË°åËÆ°ÂàíÊ†∑Âºè */
.travel-plan-container {
    max-width: 800px;
    margin: 0 auto;
    padding: 20px;
    background: white;
    border-radius: 15px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.1);
}

.plan-header {
    text-align: center;
    margin-bottom: 30px;
    padding: 20px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 15px;
}

.plan-header h1 {
    margin: 0 0 15px 0;
    font-size: 2em;
}

.plan-info {
    display: flex;
    justify-content: space-around;
    flex-wrap: wrap;
    gap: 10px;
}

.plan-info p {
    margin: 5px;
    background: rgba(255,255,255,0.2);
    padding: 8px 15px;
    border-radius: 20px;
    font-size: 0.9em;
}

.day-plan {
    margin-bottom: 30px;
    border: 2px solid #f0f0f0;
    border-radius: 15px;
    overflow: hidden;
}

.day-plan h2 {
    background: #f8f9fa;
    margin: 0;
    padding: 15px 20px;
    color: #333;
    border-bottom: 2px solid #e9ecef;
}

.day-sections {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 0;
}

.parent-section, .child-section {
    padding: 20px;
}

.parent-section {
    background: #fff8f0;
    border-right: 1px solid #e9ecef;
}

.child-section {
    background: #f0f8ff;
}

.parent-section h3 {
    color: #d63384;
    margin: 0 0 15px 0;
    font-size: 1.1em;
}

.child-section h3 {
    color: #0d6efd;
    margin: 0 0 15px 0;
    font-size: 1.1em;
}

.parent-section h4, .child-section h4 {
    margin: 0 0 15px 0;
    color: #495057;
    font-size: 1em;
}

.activities, .tips, .fun-facts {
    margin-bottom: 15px;
}

.activities h5, .tips h5, .fun-facts h5 {
    margin: 0 0 8px 0;
    color: #6c757d;
    font-size: 0.9em;
    font-weight: bold;
}

.activities ul, .tips ul, .fun-facts ul {
    margin: 0;
    padding-left: 20px;
}

.activities li, .tips li, .fun-facts li {
    margin-bottom: 5px;
    line-height: 1.4;
}

@media print {
    body {
        background-color: #fff;
        padding: 0;
        margin: 0;
    }
    .container {
        max-width: none;
        margin: 0;
    }
    .plan-section {
        display: block !important;
    }
    .version-tabs, .notebook-controls, .input-section, header {
        display: none !important;
    }
    .version-content {
        display: none !important;
    }
    .version-content.active {
        display: block !important;
    }
    .version-content-wrapper {
        border: none !important;
        padding: 0 !important;
        box-shadow: none;
    }
    .location-page-container {
        border: none !important;
        box-shadow: none;
        page-break-inside: avoid;
        page-break-before: always;
        min-height: 90vh;
        padding: 20px;
        margin: 0;
    }

    .location-page-container:first-child {
        page-break-before: auto;
    }

    /* Á°Æ‰øùÊØè‰∏™Âú∞ÁÇπÁöÑÂÜÖÂÆπ‰∏ç‰ºöË∑®È°µÂàÜÂâ≤ */
    .section-container {
        page-break-inside: avoid;
        margin-bottom: 15px;
    }

    /* Ê†áÈ¢ò‰∏çË¶ÅÂçïÁã¨Âú®È°µÈù¢Â∫ïÈÉ® */
    .location-title-h1, .location-title-h2 {
        page-break-after: avoid;
    }

    /* Á°Æ‰øùÁâàÊú¨ÂÜÖÂÆπÂÆπÂô®‰∏ç‰ºö‰∫ßÁîüÈ¢ùÂ§ñÂàÜÈ°µ */
    .version-content-wrapper {
        page-break-inside: auto;
    }

    /* ‰ºòÂåñÈ°µÈù¢ËæπË∑ù */
    @page {
        margin: 1cm;
        size: A4;
    }
}

@media (max-width: 768px) {
    .day-sections {
        grid-template-columns: 1fr;
    }

    .parent-section {
        border-right: none;
        border-bottom: 1px solid #e9ecef;
    }

    .plan-info {
        flex-direction: column;
        align-items: center;
    }
}

/* Á¨îËÆ∞Êú¨Ê†∑Âºè */
.notebook-tabs {
    display: flex;
    justify-content: center;
    margin-bottom: -1px; /* ËÆ©Ê†áÁ≠æÂíåÈ°µÈù¢ËæπÊ°ÜÈáçÂêà */
    flex-wrap: wrap;
    padding: 0 20px;
}

.tab {
    background-color: #F5F5F5;
    border: 1px solid #ddd;
    border-bottom: none;
    padding: 10px 15px;
    cursor: pointer;
    border-radius: 10px 10px 0 0;
    margin: 0 5px;
    font-family: 'LXGW WenKai Screen', cursive;
    font-weight: bold;
    color: #5C6BC0;
    position: relative;
    bottom: -5px;
    transition: all 0.2s ease-in-out;
}

.tab.active {
    background-color: #fff;
    border-top: 3px solid #7986CB;
    bottom: 0;
    padding-top: 12px;
}

.notebook-container {
    display: flex;
    gap: 30px;
    justify-content: center;
    width: 100%;
    margin-bottom: 20px;
}

.notebook-wrapper {
    width: 48%;
    max-width: 700px;
    display: flex;
    flex-direction: column;
    align-items: center;
}

.notebook-wrapper h2 {
    font-family: 'ZCOOL XiaoWei', serif;
    color: #3F51B5;
    margin-bottom: 15px;
}

@media (max-width: 1200px) {
    .notebook-container {
        flex-direction: column;
        align-items: center;
    }
    .notebook-wrapper {
        width: 90%;
    }
}
    </style>
</head>
<body>

    <div class="container input-section" id="input-container">
        <header>
            <h1>‰∫≤Â≠êÊóÖË°åÊâãÂÜå</h1>
            <div style="display: flex; justify-content: center; margin: 15px 0;">
                <img src="images/afbcfbd3-addf-4e32-a3ab-6e2bca0a2ebd.jpeg" style="width: 80px; height: 80px; border-radius: 50%; object-fit: cover; box-shadow: 0 5px 15px rgba(92,107,192,0.3);" alt="Â∞èÂØºÊ∏∏">
            </div>
            <p>‰∏Ä‰∏™Âú∞ÁÇπÔºå‰∏âÁßçÁé©Ê≥ïÔºÅ‰∏ì‰∏∫ÊúâÂìÅÂë≥„ÄÅÁà±Êé¢Á¥¢ÁöÑÂÆ∂Â∫≠ËÆæËÆ°Ôºå‰∏∫‰∏çÂêåÂπ¥ÈæÑÊÆµÁöÑÂ≠©Â≠êÁîüÊàê‰∏ìÂ±ûÁöÑÊóÖË°åÊâãË¥¶ÔºÅ</p>
        </header>

        <form id="trip-form" onsubmit="return false;">
            <!-- API ËÆæÁΩÆ -->
            <div class="form-block">
                <h3><span>üîë</span>ËøûÊé•AIÂä©Êâã</h3>
                <div class="form-block-content">
                <div class="input-group">
                    <label for="api-provider">ÈÄâÊã©AIÊúçÂä°ÂïÜ</label>
                    <select id="api-provider">
                        <option value="gemini">Google Gemini (Êé®Ëçê)</option>
                        <option value="openai">OpenAI</option>
                        <option value="deepseek">DeepSeek</option>
                        <option value="custom">Ëá™ÂÆö‰πâOpenAIÂÖºÂÆπÊé•Âè£</option>
                    </select>
                </div>
                <div class="input-group" id="custom-endpoint-group" style="margin-top: 15px; display: none;">
                    <label for="custom-endpoint">Ëá™ÂÆö‰πâAPIÁ´ØÁÇπ</label>
                    <input type="text" id="custom-endpoint" placeholder="‰æãÂ¶ÇÔºöhttps://api.deepseek.com/v1">
                </div>
                <!-- Ëá™ÂÆö‰πâÈâ¥ÊùÉÔºà‰ªÖÂú®Ëá™ÂÆö‰πâOpenAIÂÖºÂÆπÊé•Âè£Êó∂ÂèØÈÖçÁΩÆÔºâ -->
                <div class="input-group" id="custom-auth-group" style="margin-top: 10px; display: none;">
                    <label>Ëá™ÂÆö‰πâÈâ¥ÊùÉËØ∑Ê±ÇÂ§¥ÔºàÂèØÈÄâÔºâ</label>
                    <div class="api-key-row" style="gap: 10px; align-items: center;">
                        <input type="text" id="custom-auth-header-name" placeholder="Â§¥ÂêçÔºå‰æãÂ¶ÇÔºöAuthorization Êàñ X-API-Key" style="flex: 1;" />
                        <input type="text" id="custom-auth-header-value" placeholder="Â§¥ÂÄºÊ®°ÊùøÔºå‰æãÂ¶ÇÔºöBearer {key} Êàñ {key}" style="flex: 1;" />
                    </div>
                    <div style="font-size: 0.8em; color: #666; margin-top: 5px;">
                        ‰ΩøÁî®ËØ¥ÊòéÔºö{key} Â∞ÜÂú®ËØ∑Ê±ÇÊó∂ÊõøÊç¢‰∏∫ÊÇ®Â°´ÂÜôÁöÑAPI KeyÔºõÁïôÁ©∫Âàô‰ΩøÁî®ÂÜÖÁΩÆÂÖºÂÆπÈÄªËæëÔºàBearer/X-API-Key/...Ôºâ„ÄÇ
                    </div>
                </div>
                <!-- Gemini API Key -->
                <div class="input-group api-key-group" id="gemini-key-group" style="margin-top: 15px;">
                    <label for="gemini-api-key">Gemini API Key</label>
                    <div class="api-key-row">
                        <input type="password" id="gemini-api-key" placeholder="AIza... (‰ªé Google AI Studio Ëé∑Âèñ)">
                        <button type="button" class="fetch-btn" id="fetch-models-btn" disabled>ÊãâÂèñÊ®°Âûã</button>
                    </div>
                    <div style="font-size: 0.8em; color: #666; margin-top: 5px;">
                        Ëé∑ÂèñÂú∞ÂùÄ: <a href="https://aistudio.google.com/app/apikey" target="_blank">Google AI Studio</a>
                    </div>
                </div>

                <!-- OpenAI API Key -->
                <div class="input-group api-key-group" id="openai-key-group" style="margin-top: 15px; display: none;">
                    <label for="openai-api-key">OpenAI API Key</label>
                    <div class="api-key-row">
                        <input type="password" id="openai-api-key" placeholder="sk-... (‰ªé OpenAI Ëé∑Âèñ)">
                        <button type="button" class="fetch-btn" id="fetch-models-btn" disabled>ÊãâÂèñÊ®°Âûã</button>
                    </div>
                    <div style="font-size: 0.8em; color: #666; margin-top: 5px;">
                        Ëé∑ÂèñÂú∞ÂùÄ: <a href="https://platform.openai.com/api-keys" target="_blank">OpenAI Platform</a>
                    </div>
                </div>

                <!-- DeepSeek API Key -->
                <div class="input-group api-key-group" id="deepseek-key-group" style="margin-top: 15px; display: none;">
                    <label for="deepseek-api-key">DeepSeek API Key</label>
                    <div class="api-key-row">
                        <input type="password" id="deepseek-api-key" placeholder="sk-... (‰ªé DeepSeek Ëé∑Âèñ)">
                        <button type="button" class="fetch-btn" id="fetch-models-btn" disabled>ÊãâÂèñÊ®°Âûã</button>
                    </div>
                    <div style="font-size: 0.8em; color: #666; margin-top: 5px;">
                        Ëé∑ÂèñÂú∞ÂùÄ: <a href="https://platform.deepseek.com/api_keys" target="_blank">DeepSeek Platform</a>
                    </div>
                </div>

                <!-- Custom API Key -->
                <div class="input-group api-key-group" id="custom-key-group" style="margin-top: 15px; display: none;">
                    <label for="custom-api-key">Ëá™ÂÆö‰πâAPI Key</label>
                    <div class="api-key-row">
                        <input type="password" id="custom-api-key" placeholder="Ê†πÊçÆÊÇ®ÁöÑÊúçÂä°ÂïÜË¶ÅÊ±ÇËæìÂÖ•">
                        <button type="button" class="fetch-btn" id="fetch-models-btn" disabled>ÊãâÂèñÊ®°Âûã</button>
                    </div>
                    <div style="font-size: 0.8em; color: #666; margin-top: 5px;">
                        ËØ∑ÂèÇËÄÉÊÇ®ÁöÑËá™ÂÆö‰πâÊúçÂä°ÂïÜÊñáÊ°£
                    </div>
                </div>
                <div class="input-group" style="margin-top: 15px;">
                    <label for="model-select">ÈÄâÊã©Ê®°Âûã</label>
                    <select id="model-select" disabled>
                        <option>ËØ∑ÂÖàËæìÂÖ•KeyÂπ∂ÊãâÂèñÊ®°Âûã</option>
                    </select>
                    <div id="api-status"></div>
                </div>
                <div class="input-group" style="margin-top: 15px;">
                    <button type="button" class="clear-btn" id="clear-settings-btn">üóëÔ∏è Ê∏ÖÈô§‰øùÂ≠òÁöÑËÆæÁΩÆ</button>
                    <div style="font-size: 0.8em; color: #666; margin-top: 5px;">
                        Ê∏ÖÈô§ÊâÄÊúâ‰øùÂ≠òÂú®ÊµèËßàÂô®‰∏≠ÁöÑAPIËÆæÁΩÆ
                    </div>
                    <div id="settings-status" style="font-size: 0.8em; margin-top: 5px;"></div>
                </div>
                <div class="input-group" style="margin-top: 15px;">
                    <label>
                        <input type="checkbox" id="enable-search" checked>
                        ÂêØÁî®ËÅîÁΩëÊêúÁ¥¢ (Ëé∑ÂèñÂÆûÊó∂‰ø°ÊÅØ)
                    </label>
                    <div style="font-size: 0.9em; color: #666; margin-top: 5px;" id="search-description">
                        ÂºÄÂêØÂêéAIÂ∞ÜÊêúÁ¥¢ÊúÄÊñ∞ÁöÑÊôØÁÇπ‰ø°ÊÅØ„ÄÅÂ§©Ê∞î„ÄÅ‰ª∑Ê†ºÁ≠â
                    </div>
                </div>
                <div class="input-group" style="margin-top: 15px;" id="search-api-group">
                    <label for="search-api-key">ÊêúÁ¥¢API Key (ÂèØÈÄâ)</label>
                    <input type="password" id="search-api-key" placeholder="SerpAPI Key - Êèê‰æõÊõ¥ÂáÜÁ°ÆÁöÑÊêúÁ¥¢ÁªìÊûú">
                    <div style="font-size: 0.8em; color: #666; margin-top: 5px;">
                        ‰∏çÂ°´ÂÜôÂ∞Ü‰ΩøÁî®Ê®°ÊãüÊêúÁ¥¢ÁªìÊûú„ÄÇËé∑ÂèñÂÖçË¥πAPI Key: <a href="https://serpapi.com" target="_blank">SerpAPI</a>
                    </div>
                </div>
                </div>
            </div>

            <!-- ‰ΩøÁî®Ê®°ÂºèÈÄâÊã© -->
            <div class="form-block">
                <h3><span>üéØ</span>Á¨¨‰∏ÄÊ≠•ÔºöÈÄâÊã©‰ΩøÁî®Ê®°Âºè</h3>
                <div class="form-block-content">
                <div class="icon-options" id="usage-mode-selector">
                    <label><input type="radio" name="usage-mode" value="ai-planning" checked><div class="content"><div class="icon">ü§ñ</div><span>AIËßÑÂàíË°åÁ®ã</span><div style="font-size:0.8em;color:#666;margin-top:3px;">ËÆ©AI‰∏∫ÊÇ®ÂÆâÊéíÂÆåÊï¥Ë°åÁ®ã</div></div></label>
                    <label><input type="radio" name="usage-mode" value="existing-plan"><div class="content"><div class="icon">üìã</div><span>Â∑≤ÊúâË°åÁ®ãÂÆâÊéí</span><div style="font-size:0.8em;color:#666;margin-top:3px;">‰∏∫Áé∞ÊúâË°åÁ®ãË°•ÂÖÖÊîªÁï•‰ø°ÊÅØ</div></div></label>
                </div>
                </div>
            </div>

            <!-- ËØ≠Ë®ÄÈÄâÊã© -->
            <div class="form-block">
                <h3><span>üåê</span>Á¨¨‰∫åÊ≠•ÔºöÈÄâÊã©ÊîªÁï•ËØ≠Ë®Ä</h3>
                <div class="form-block-content">
                 <div class="icon-options">
                    <label><input type="radio" name="language" value="Simplified Chinese" checked><div class="content"><div class="icon">üá®üá≥</div><span>ÁÆÄ‰Ωì‰∏≠Êñá</span></div></label>
                    <label><input type="radio" name="language" value="English"><div class="content"><div class="icon">üá¨üáß</div><span>English</span></div></label>
                </div>
                </div>
            </div>

            <!-- ÊóÖÁ®ãÂü∫Êú¨ËÆæÁΩÆ -->
            <div class="form-block">
                <h3><span>üó∫Ô∏è</span>Á¨¨‰∏âÊ≠•ÔºöÊàë‰ª¨ÁöÑÊóÖÁ®ã</h3>
                <div class="form-block-content">
                <div class="input-label">ÊóÖÁ®ãÁ±ªÂûã</div>
                <div class="icon-options" id="trip-type-selector">
                    <label><input type="radio" name="trip-type" value="day-trip" checked><div class="content"><div class="icon">üèôÔ∏è</div><span>‰∏ÄÊó•Ê∏∏</span></div></label>
                    <label><input type="radio" name="trip-type" value="single-city"><div class="content"><div class="icon">üè°</div><span>Áü≠ÈÄîÊóÖË°å</span></div></label>
                    <label><input type="radio" name="trip-type" value="multi-city"><div class="content"><div class="icon">‚úàÔ∏è</div><span>ÈïøÈÄîÊóÖË°å</span></div></label>
                </div>
                <div id="destination-inputs" style="margin-top: 15px;">
                    <div id="single-dest-group">
                        <div class="input-group">
                            <label for="destination">ÁõÆÁöÑÂú∞</label>
                            <input type="text" id="destination" placeholder="‰æãÂ¶ÇÔºöÂåó‰∫¨">
                        </div>
                        <div class="input-group" style="margin-top:10px;">
                            <label for="duration">Â§©Êï∞</label>
                            <input type="number" id="duration" value="1" min="1" readonly>
                        </div>
                        <div class="input-group" style="margin-top:10px;">
                            <label for="departure-date">Âá∫ÂèëÊó•Êúü</label>
                            <input type="date" id="departure-date">
                            <div style="font-size: 0.8em; color: #666; margin-top: 3px;">
                                Â°´ÂÜôÂêéÂèØËá™Âä®Êü•ËØ¢Â§©Ê∞îÈ¢ÑÊä•
                            </div>
                        </div>
                    </div>
                    <div class="dynamic-list" id="multi-city-container" style="display: none;">
                        <button type="button" class="add-btn" id="add-city-btn">+</button>
                    </div>
                </div>

                <!-- AIËßÑÂàíÊ®°ÂºèÁöÑÂøÖÂéªÊôØÁÇπ -->
                <div id="ai-planning-section" style="margin-top: 20px;">
                    <div class="input-group">
                        <label for="must-visit-places">ÂøÖÂéªÊôØÁÇπ (ÂèØÈÄâ)</label>
                        <textarea id="must-visit-places" rows="4" placeholder="Â¶ÇÊûúÊúâÁâπÂà´ÊÉ≥ÂéªÁöÑÂú∞ÊñπÔºåËØ∑ÂàóÂá∫Êù•Ôºå‰æãÂ¶ÇÔºö
- ÊïÖÂÆ´ÂçöÁâ©Èô¢
- Â§©ÂÆâÈó®ÂπøÂú∫
- È¢êÂíåÂõ≠
- ÁéãÂ∫ú‰∫ïÂ§ßË°ó
...

AI‰ºö‰ºòÂÖàÂÆâÊéíËøô‰∫õÊôØÁÇπÔºåÂπ∂Ë°•ÂÖÖÂÖ∂‰ªñÊé®ËçêÂú∞ÁÇπ"></textarea>
                        <div style="font-size: 0.8em; color: #666; margin-top: 5px;">
                            AI‰ºö‰ºòÂÖàÂÆâÊéíËøô‰∫õÊôØÁÇπÔºåÂπ∂Âú®Ê≠§Âü∫Á°Ä‰∏äË°•ÂÖÖÂÖ∂‰ªñÈÄÇÂêàÁöÑÂú∞ÁÇπÂíåÊ¥ªÂä®
                        </div>
                    </div>
                </div>

                <!-- Â∑≤ÊúâË°åÁ®ãËæìÂÖ•Âå∫Âüü -->
                <div id="existing-plan-section" style="display: none; margin-top: 20px;">
                    <div class="input-group">
                        <label for="existing-itinerary">ÊÇ®ÁöÑËØ¶ÁªÜË°åÁ®ãÂÆâÊéí</label>
                        <textarea id="existing-itinerary" rows="8" placeholder="ËØ∑ËØ¶ÁªÜÊèèËø∞ÊÇ®ÁöÑË°åÁ®ãÂÆâÊéíÔºå‰æãÂ¶ÇÔºö
Á¨¨‰∏ÄÂ§©Ôºö
‰∏äÂçà9:00 - ÊïÖÂÆ´ÂçöÁâ©Èô¢
‰∏≠Âçà12:00 - ÂçàÈ§ê
‰∏ãÂçà2:00 - Â§©ÂÆâÈó®ÂπøÂú∫
...

Á¨¨‰∫åÂ§©Ôºö
‰∏äÂçà10:00 - È¢êÂíåÂõ≠
..."></textarea>
                        <div style="font-size: 0.8em; color: #666; margin-top: 5px;">
                            AIÂ∞Ü‰∏∫ÊÇ®ÁöÑË°åÁ®ãË°•ÂÖÖÈ§êÂéÖÊé®Ëçê„ÄÅ‰∫§ÈÄöÂª∫ËÆÆ„ÄÅ‰∫≤Â≠êË¥¥Â£´Á≠âÂÆûÁî®‰ø°ÊÅØ
                        </div>
                    </div>
                </div>
                </div>
            </div>

            <!-- ÂÆ∂Â∫≠ÊàêÂëò -->
            <div class="form-block">
                <h3><span>üë®‚Äçüë©‚Äçüëß‚Äçüë¶</span>Á¨¨ÂõõÊ≠•ÔºöÂíåË∞Å‰∏ÄËµ∑ÂéªÔºü</h3>
                <div class="form-block-content">
                <div class="dynamic-list" id="family-list">
                    <div class="list-item">
                        <input type="text" placeholder="Áß∞Ë∞ì (Â¶Ç: Áà∏Áà∏)" value="Áà∏Áà∏">
                        <input type="number" placeholder="Âπ¥ÈæÑ" value="35" style="max-width: 80px;">
                        <button type="button" class="remove-btn">-</button>
                    </div>
                    <div class="list-item">
                        <input type="text" placeholder="Áß∞Ë∞ì" value="Êàë">
                        <input type="number" placeholder="Âπ¥ÈæÑ" value="5" style="max-width: 80px;">
                        <button type="button" class="remove-btn">-</button>
                    </div>
                </div>
                <button type="button" class="add-btn" id="add-family-btn">+</button>
                </div>
            </div>

            <!-- ÂÖ¥Ë∂£Áà±Â•ΩÈÄâÊã© -->
            <div class="form-block">
                <h3><span>üéà</span>Á¨¨‰∫îÊ≠•ÔºöÊàë‰ª¨ÁöÑÂñúÂ•Ω‰∏éÁâπÊÆäÈúÄÊ±Ç</h3>
                <div class="form-block-content">
                <div class="input-label">Êàë‰ª¨ÂñúÊ¨¢ÂÅö‰ªÄ‰πàÔºü(ÂèØÂ§öÈÄâ)</div>
                <div class="icon-options" id="interests-selector">
                    <label><input type="checkbox" name="interests" value="‰∏ªÈ¢ò‰πêÂõ≠"><div class="content"><div class="icon">üé¢</div><span>‰∏ªÈ¢ò‰πêÂõ≠</span></div></label>
                    <label><input type="checkbox" name="interests" value="ÂçöÁâ©È¶Ü"><div class="content"><div class="icon">üèõÔ∏è</div><span>ÂçöÁâ©È¶Ü</span></div></label>
                    <label><input type="checkbox" name="interests" value="‰∫≤ËøëËá™ÁÑ∂"><div class="content"><div class="icon">üå≥</div><span>‰∫≤ËøëËá™ÁÑ∂</span></div></label>
                    <label><input type="checkbox" name="interests" value="ÂêÉÂ•ΩÂêÉÁöÑ"><div class="content"><div class="icon">üçî</div><span>ÂêÉÂ•ΩÂêÉÁöÑ</span></div></label>
                    <label><input type="checkbox" name="interests" value="Ë¥≠Áâ©"><div class="content"><div class="icon">üõçÔ∏è</div><span>Ë¥≠Áâ©</span></div></label>
                    <label><input type="checkbox" name="interests" value="ÂéÜÂè≤ÊñáÂåñ"><div class="content"><div class="icon">üèØ</div><span>ÂéÜÂè≤ÊñáÂåñ</span></div></label>
                    <label><input type="checkbox" name="interests" value="Ëâ∫ÊúØÂ±ïËßà"><div class="content"><div class="icon">üé®</div><span>Ëâ∫ÊúØÂ±ïËßà</span></div></label>
                    <label><input type="checkbox" name="interests" value="ÁßëÊäÄ‰ΩìÈ™å"><div class="content"><div class="icon">üî¨</div><span>ÁßëÊäÄ‰ΩìÈ™å</span></div></label>
                    <label><input type="checkbox" name="interests" value="ËøêÂä®ÂÅ•Ë∫´"><div class="content"><div class="icon">‚öΩ</div><span>ËøêÂä®ÂÅ•Ë∫´</span></div></label>
                    <label><input type="checkbox" name="interests" value="Êµ∑Êª©Êµ∑Â≤õ"><div class="content"><div class="icon">üèñÔ∏è</div><span>Êµ∑Êª©Êµ∑Â≤õ</span></div></label>
                    <label><input type="checkbox" name="interests" value="Â±±Â∑ùÂæíÊ≠•"><div class="content"><div class="icon">‚õ∞Ô∏è</div><span>Â±±Â∑ùÂæíÊ≠•</span></div></label>
                    <label><input type="checkbox" name="interests" value="Âä®Áâ©Âõ≠"><div class="content"><div class="icon">ü¶Å</div><span>Âä®Áâ©Âõ≠</span></div></label>
                    <label><input type="checkbox" name="interests" value="Ê∞¥ÊóèÈ¶Ü"><div class="content"><div class="icon">üê†</div><span>Ê∞¥ÊóèÈ¶Ü</span></div></label>
                    <label><input type="checkbox" name="interests" value="Ê∏∏‰πêÂú∫"><div class="content"><div class="icon">üé†</div><span>Ê∏∏‰πêÂú∫</span></div></label>
                    <label><input type="checkbox" name="interests" value="Ê∏©Ê≥âSPA"><div class="content"><div class="icon">‚ô®Ô∏è</div><span>Ê∏©Ê≥âSPA</span></div></label>
                    <label><input type="checkbox" name="interests" value="Â§úÂ∏ÇÂ∞èÂêÉ"><div class="content"><div class="icon">üçú</div><span>Â§úÂ∏ÇÂ∞èÂêÉ</span></div></label>
                    <label><input type="checkbox" name="interests" value="ÊëÑÂΩ±ÊâìÂç°"><div class="content"><div class="icon">üì∏</div><span>ÊëÑÂΩ±ÊâìÂç°</span></div></label>
                    <label><input type="checkbox" name="interests" value="ÊâãÂ∑•‰ΩìÈ™å"><div class="content"><div class="icon">üé≠</div><span>ÊâãÂ∑•‰ΩìÈ™å</span></div></label>
                    <label><input type="checkbox" name="interests" value="Èü≥‰πêÊºîÂá∫"><div class="content"><div class="icon">üéµ</div><span>Èü≥‰πêÊºîÂá∫</span></div></label>
                    <label><input type="checkbox" name="interests" value="ÂΩìÂú∞Ê∞ë‰øó"><div class="content"><div class="icon">üéé</div><span>ÂΩìÂú∞Ê∞ë‰øó</span></div></label>
                </div>

                <div class="input-label" style="margin-top: 20px;">ÁâπÊÆäÈúÄÊ±Ç (ÂèØÈÄâ)</div>
                <div class="icon-options">
                    <label><input type="checkbox" name="special-needs" value="Êó†ÈöúÁ¢çËÆæÊñΩ"><div class="content"><div class="icon">‚ôø</div><span>Êó†ÈöúÁ¢çËÆæÊñΩ</span></div></label>
                    <label><input type="checkbox" name="special-needs" value="Â©¥ÂÑøÂèãÂ•Ω"><div class="content"><div class="icon">üë∂</div><span>Â©¥ÂÑøÂèãÂ•Ω</span></div></label>
                    <label><input type="checkbox" name="special-needs" value="Á¥†È£üÈÄâÊã©"><div class="content"><div class="icon">ü•ó</div><span>Á¥†È£üÈÄâÊã©</span></div></label>
                    <label><input type="checkbox" name="special-needs" value="ÂÆ†Áâ©ÂèãÂ•Ω"><div class="content"><div class="icon">üêï</div><span>ÂÆ†Áâ©ÂèãÂ•Ω</span></div></label>
                    <label><input type="checkbox" name="special-needs" value="È¢ÑÁÆóÊúâÈôê"><div class="content"><div class="icon">üí∞</div><span>È¢ÑÁÆóÊúâÈôê</span></div></label>
                    <label><input type="checkbox" name="special-needs" value="ÈÅøÂÖç‰∫∫Áæ§"><div class="content"><div class="icon">ü§´</div><span>ÈÅøÂÖç‰∫∫Áæ§</span></div></label>
                </div>

                <div class="input-group" style="margin-top: 15px;">
                    <label for="other-preferences">ÂÖ∂‰ªñÂÅèÂ•ΩÊàñË¶ÅÊ±Ç</label>
                    <textarea id="other-preferences" rows="3" placeholder="‰æãÂ¶ÇÔºöÂñúÊ¨¢ÂÆâÈùôÁöÑÂú∞Êñπ„ÄÅÂØπÊüê‰∫õÈ£üÁâ©ËøáÊïè„ÄÅÂ∏åÊúõÊúâÊïôËÇ≤ÊÑè‰πâÁöÑÊ¥ªÂä®Á≠â..."></textarea>
                </div>
                </div>
            </div>

            <!-- ‰∫§ÈÄöÂíåÂ§©Ê∞î -->
            <div class="form-block">
                <h3><span>üöó</span>Á¨¨ÂÖ≠Ê≠•Ôºö‰∫§ÈÄö‰∏éÂ§©Ê∞î</h3>
                <div class="form-block-content">
                <div class="input-label">ÂéªÁõÆÁöÑÂú∞Âùê‰ªÄ‰πàÔºü</div>
                <div class="icon-options">
                    <label><input type="radio" name="main-transport" value="È£ûÊú∫"><div class="content"><div class="icon">‚úàÔ∏è</div><span>È£ûÊú∫</span></div></label>
                    <label><input type="radio" name="main-transport" value="ÁÅ´ËΩ¶" checked><div class="content"><div class="icon">üöÑ</div><span>ÁÅ´ËΩ¶</span></div></label>
                    <label><input type="radio" name="main-transport" value="Ê±ΩËΩ¶"><div class="content"><div class="icon">üöó</div><span>Ê±ΩËΩ¶</span></div></label>
                    <label><input type="radio" name="main-transport" value="ÂÖ∂‰ªñ"><div class="content"><div class="icon">üöå</div><span>ÂÖ∂‰ªñ</span></div></label>
                </div>
                <div class="input-group" id="custom-main-transport-group" style="display: none; margin-top: 10px;">
                    <input type="text" id="custom-main-transport" placeholder="ËØ∑ËæìÂÖ•ÂÖ∂‰ªñ‰∫§ÈÄöÊñπÂºèÔºå‰æãÂ¶ÇÔºöÈïøÈÄîÂ∑¥Â£´„ÄÅËá™È©æ„ÄÅËàπËà∂Á≠â">
                </div>
                <div class="input-label" style="margin-top: 15px;">Âú®ÂüéÂ∏ÇÈáå‰∏ªË¶ÅÂùê‰ªÄ‰πàÔºü(ÂèØÂ§öÈÄâ)</div>
                <div class="icon-options">
                    <label><input type="checkbox" name="daily-transport" value="Âú∞ÈìÅ"><div class="content"><div class="icon">üöá</div><span>Âú∞ÈìÅ</span></div></label>
                    <label><input type="checkbox" name="daily-transport" value="Â∑¥Â£´"><div class="content"><div class="icon">üöå</div><span>Â∑¥Â£´</span></div></label>
                    <label><input type="checkbox" name="daily-transport" value="Ê±ΩËΩ¶"><div class="content"><div class="icon">üöó</div><span>Ê±ΩËΩ¶</span></div></label>
                    <label><input type="checkbox" name="daily-transport" value="Ëµ∞Ë∑Ø" checked><div class="content"><div class="icon">üö∂‚Äç‚ôÇÔ∏è</div><span>Ëµ∞Ë∑Ø</span></div></label>
                    <label><input type="checkbox" name="daily-transport" value="ÂÖ∂‰ªñ"><div class="content"><div class="icon">üõ¥</div><span>ÂÖ∂‰ªñ</span></div></label>
                </div>
                <div class="input-group" id="custom-daily-transport-group" style="display: none; margin-top: 10px;">
                    <input type="text" id="custom-daily-transport" placeholder="ËØ∑ËæìÂÖ•ÂÖ∂‰ªñ‰∫§ÈÄöÊñπÂºèÔºå‰æãÂ¶ÇÔºöÂÖ±‰∫´ÂçïËΩ¶„ÄÅÁîµÂä®ÊªëÊùøËΩ¶„ÄÅÊë©ÊâòËΩ¶Á≠â">
                </div>

                <div class="input-label" style="margin-top: 15px;">Âá∫Ë°åÂ≠£ËäÇ</div>
                <div class="icon-options">
                    <label><input type="radio" name="season" value="Êò•Â≠£" checked><div class="content"><div class="icon">üå∏</div><span>Êò•Â≠£</span><div style="font-size:0.8em;color:#666;margin-top:3px;">3-5ÊúàÔºåÊ∏©ÊöñËàíÈÄÇ</div></div></label>
                    <label><input type="radio" name="season" value="Â§èÂ≠£"><div class="content"><div class="icon">‚òÄÔ∏è</div><span>Â§èÂ≠£</span><div style="font-size:0.8em;color:#666;margin-top:3px;">6-8ÊúàÔºåÁÇéÁÉ≠Â§öÈõ®</div></div></label>
                    <label><input type="radio" name="season" value="ÁßãÂ≠£"><div class="content"><div class="icon">üçÇ</div><span>ÁßãÂ≠£</span><div style="font-size:0.8em;color:#666;margin-top:3px;">9-11ÊúàÔºåÂáâÁàΩÂÆú‰∫∫</div></div></label>
                    <label><input type="radio" name="season" value="ÂÜ¨Â≠£"><div class="content"><div class="icon">‚ùÑÔ∏è</div><span>ÂÜ¨Â≠£</span><div style="font-size:0.8em;color:#666;margin-top:3px;">12-2ÊúàÔºåÂØíÂÜ∑Âπ≤Áá•</div></div></label>
                </div>
                </div>
            </div>



            <!-- Ë°åÊùéÊ∏ÖÂçï -->
            <div class="form-block">
                <h3><span>üéí</span>Á¨¨‰∏ÉÊ≠•ÔºöË°åÊùéÊ∏ÖÂçï</h3>
                <div class="form-block-content">
                <div class="input-label">ÂÑøÁ´•Ë°åÊùéÊ∏ÖÂçï (ËÆ©AIÂèÇËÄÉ)</div>
                <div class="dynamic-list" id="checklist-items">
                    <div class="list-item"><input type="text" value="ÊúÄÂñúÊ¨¢ÁöÑÂ∞èÁÜäÁé©ÂÅ∂"><button type="button" class="remove-btn">-</button></div>
                    <div class="list-item"><input type="text" value="ÊÅêÈæôÁªòÊú¨"><button type="button" class="remove-btn">-</button></div>
                </div>
                <button type="button" class="add-btn" id="add-checklist-btn">+</button>
                </div>
            </div>

            <button type="submit" class="submit-btn" id="generate-btn" disabled>‚ú® ÁîüÊàêÊóÖË°åÊâãÂ∏ê ‚ú®</button>
        </form>
    </div>

    <!-- ËÆ°ÂàíËæìÂá∫Âå∫Âüü -->
    <div class="container plan-section" id="plan-output" style="display: none;">
        <!-- ÁâàÊú¨ÂàáÊç¢ÊåâÈíÆ -->
        <div class="version-tabs">
            <button class="version-btn active" data-version="child">üé® ÂÑøÁ´•Áâà (ÂÜíÈô©Êó•Âøó)</button>
            <button class="version-btn" data-version="teenager">‚úíÔ∏è ÈùíÂ∞ëÂπ¥Áâà (ÁÅµÊÑüÁ∞ø)</button>
            <button class="version-btn" data-version="parent">üìñ ÂÆ∂ÈïøÁâà (ÊåáÂØºÊâãÂÜå)</button>
        </div>

        <!-- ÂÜÖÂÆπÂÆπÂô® -->
        <div class="version-content-wrapper">
            <!-- ÂÑøÁ´•ÁâàÂÜÖÂÆπ -->
            <div id="child-view-content" class="version-content active">
                <!-- ÂÑøÁ´•ÁâàÂÜÖÂÆπÂ∞ÜÂä®ÊÄÅÁîüÊàêÂú®ËøôÈáå -->
            </div>
            <!-- ÈùíÂ∞ëÂπ¥ÁâàÂÜÖÂÆπ -->
            <div id="teenager-view-content" class="version-content">
                <!-- ÈùíÂ∞ëÂπ¥ÁâàÂÜÖÂÆπÂ∞ÜÂä®ÊÄÅÁîüÊàêÂú®ËøôÈáå -->
            </div>
            <!-- ÂÆ∂ÈïøÁâàÂÜÖÂÆπ -->
            <div id="parent-view-content" class="version-content">
                <!-- ÂÆ∂ÈïøÁâàÂÜÖÂÆπÂ∞ÜÂä®ÊÄÅÁîüÊàêÂú®ËøôÈáå -->
            </div>
        </div>

        <!-- ÊéßÂà∂ÊåâÈíÆ -->
        <div class="notebook-controls">
            <button class="print-btn" onclick="handlePrint()">üñ®Ô∏è ÊâìÂç∞ÂΩìÂâçÁâàÊú¨</button>
            <button class="new-plan-btn" onclick="handleNewPlan()">üÜï Âà∂‰ΩúÊñ∞ÊîªÁï•</button>
        </div>
    </div>

    <!-- Âä†ËΩΩÊåáÁ§∫Âô® -->
    <div class="container" id="loading-indicator" style="display: none;">
        <div style="text-align: center; padding: 50px;">
            <div style="font-size: 3em; margin-bottom: 20px;">üîÑ</div>
            <h2>AIÊ≠£Âú®‰∏∫ÊÇ®Á≤æÂøÉËßÑÂàíÊóÖÁ®ã...</h2>
            <p>ËØ∑Á®çÂÄôÔºåËøôÂèØËÉΩÈúÄË¶ÅÂá†ÂàÜÈíüÊó∂Èó¥</p>
        </div>
    </div>

                <script>
                // JSÈÄªËæë - 100%ÂÆåÊï¥

                // ÂÖ®Â±ÄÂèòÈáè
                let modelsCache = {};
                let currentPlanData = null;
                const imagePaths = [
                    'images/02ee957c-32fc-4cdb-a169-e5f2e738a58f.png',
                    'images/1b49ea1c-cacb-4161-a3ec-89d06d47b306.png',
                    'images/7633aa7e-33aa-4ada-b715-ef314f196859.png',
                    'images/afbcfbd3-addf-4e32-a3ab-6e2bca0a2ebd.jpeg',
                    'images/c5a9952a-2a41-4995-8822-6052069de53c.png',
                    'images/e1f3c3a9-985a-4467-af91-53e4a9990508.png',
                    'images/e3a8a3c2-c07c-42a3-98c1-58133379531e.png'
                ];

                // DOM ÂÖÉÁ¥†
                const geminiApiKeyInput = document.getElementById('gemini-api-key');
                const openaiApiKeyInput = document.getElementById('openai-api-key');
                const deepseekApiKeyInput = document.getElementById('deepseek-api-key');
                const customApiKeyInput = document.getElementById('custom-api-key');
                const apiProviderSelect = document.getElementById('api-provider');
                const customEndpointGroup = document.getElementById('custom-endpoint-group');
                const customEndpointInput = document.getElementById('custom-endpoint');
                const modelSelect = document.getElementById('model-select');
                const fetchModelsBtns = document.querySelectorAll('.fetch-btn');
                const apiStatus = document.getElementById('api-status');
                const clearSettingsBtn = document.getElementById('clear-settings-btn');
                const settingsStatus = document.getElementById('settings-status');
                const searchApiKeyInput = document.getElementById('search-api-key');
                const enableSearchCheckbox = document.getElementById('enable-search');
                const searchApiGroup = document.getElementById('search-api-group');
                const searchDescription = document.getElementById('search-description');

                // Â§áÊ≥®Ôºö‰øÆÂ§ç‚ÄúÊãâÂèñÊ®°Âûã‚ÄùÊåâÈíÆÂè™ÂØπGeminiÁîüÊïàÁöÑÈóÆÈ¢ò„ÄÇ
                // ÂéüÂõ†ÔºöÈ°µÈù¢Â≠òÂú®Â§ö‰∏™Áõ∏ÂêåIDÁöÑÊåâÈíÆ(id="fetch-models-btn")Ôºå‰πãÂâç‰ªÖÁªôÁ¨¨‰∏Ä‰∏™ÊåâÈíÆÁªëÂÆö‰∫ã‰ª∂ÂíåÊõ¥Êñ∞Áä∂ÊÄÅ„ÄÇ
                // ‰øÆÊîπÔºöÊîπ‰∏∫ÈÄâÊã©ÊâÄÊúâÁ±ªÂêç‰∏∫.fetch-btnÁöÑÊåâÈíÆÁªü‰∏ÄÁªëÂÆöÔºõÂπ∂‰ªÖÂêØÁî®ÂΩìÂâçÊúçÂä°ÂïÜÂàÜÁªÑÂÜÖÁöÑÊåâÈíÆ„ÄÇ
                // Â§áÊ≥®Ë°•ÂÖÖÔºö‰∏∫ÈÅøÂÖçÊµèËßàÂô®Ëá™Âä®Â°´ÂÖÖ/Á≤òË¥¥Êú™Ëß¶Âèë input ÂØºËá¥ÊåâÈíÆ‰øùÊåÅÁ¶ÅÁî®ÔºåÂ¢ûÂä†Â§ö‰∫ã‰ª∂ÁõëÂê¨‰∏éÂàùÂßãÂåñÂº∫Âà∂Âà∑Êñ∞„ÄÇ

                function getActiveFetchButton() {
                    const provider = apiProviderSelect.value;
                    const groupIdMap = {
                        gemini: 'gemini-key-group',
                        openai: 'openai-key-group',
                        deepseek: 'deepseek-key-group',
                        custom: 'custom-key-group'
                    };
                    const groupId = groupIdMap[provider];
                    return document.querySelector(`#${groupId} .fetch-btn`);
                }

                // Ëé∑ÂèñÂΩìÂâçÈÄâ‰∏≠ÊúçÂä°ÂïÜÁöÑAPI Key
                function getCurrentApiKey() {
                    const provider = apiProviderSelect.value;
                    switch (provider) {
                        case 'gemini':
                            return geminiApiKeyInput.value.trim();
                        case 'openai':
                            return openaiApiKeyInput.value.trim();
                        case 'deepseek':
                            return deepseekApiKeyInput.value.trim();
                        case 'custom':
                            return customApiKeyInput.value.trim();
                        default:
                            return '';
                    }
                }

                // Ëé∑ÂèñÂΩìÂâçÈÄâ‰∏≠ÊúçÂä°ÂïÜÁöÑAPI KeyËæìÂÖ•Ê°Ü
                function getCurrentApiKeyInput() {
                    const provider = apiProviderSelect.value;
                    switch (provider) {
                        case 'gemini':
                            return geminiApiKeyInput;
                        case 'openai':
                            return openaiApiKeyInput;
                        case 'deepseek':
                            return deepseekApiKeyInput;
                        case 'custom':
                            return customApiKeyInput;
                        default:
                            return null;
                    }
                }

                // Êõ¥Êñ∞API KeyËæìÂÖ•Ê°ÜÊòæÁ§∫
                function updateApiKeyVisibility() {
                    const provider = apiProviderSelect.value;

                    // ÈöêËóèÊâÄÊúâAPI KeyËæìÂÖ•Ê°Ü
                    document.getElementById('gemini-key-group').style.display = 'none';
                    document.getElementById('openai-key-group').style.display = 'none';
                    document.getElementById('deepseek-key-group').style.display = 'none';
                    document.getElementById('custom-key-group').style.display = 'none';

                    // ÊòæÁ§∫ÂØπÂ∫îÁöÑAPI KeyËæìÂÖ•Ê°Ü
                    switch (provider) {
                        case 'gemini':
                            document.getElementById('gemini-key-group').style.display = 'block';
                            break;
                        case 'openai':
                            document.getElementById('openai-key-group').style.display = 'block';
                            break;
                        case 'deepseek':
                            document.getElementById('deepseek-key-group').style.display = 'block';
                            break;
                        case 'custom':
                            document.getElementById('custom-key-group').style.display = 'block';
                            break;
                    }

                    // Ëá™ÂÆö‰πâÁ´ØÁÇπ‰∏éËá™ÂÆö‰πâÈâ¥ÊùÉÂ§¥‰ªÖÂú® custom Êèê‰æõÂïÜ‰∏ãÂèØËßÅ
                    const isCustom = provider === 'custom';
                    document.getElementById('custom-endpoint-group').style.display = isCustom ? 'block' : 'none';
                    const customAuthGroup = document.getElementById('custom-auth-group');
                    if (customAuthGroup) customAuthGroup.style.display = isCustom ? 'block' : 'none';

                    // Êõ¥Êñ∞ÊãâÂèñÊ®°ÂûãÊåâÈíÆÁä∂ÊÄÅ
                    updateFetchButtonState();
                }

                // Êõ¥Êñ∞ÊãâÂèñÊ®°ÂûãÊåâÈíÆÁä∂ÊÄÅ
                function updateFetchButtonState() {
                    const apiKey = getCurrentApiKey();
                    // ÂÖàÂÖ®ÈÉ®Á¶ÅÁî®
                    fetchModelsBtns.forEach(btn => btn.disabled = true);
                    // ÂêØÁî®ÂΩìÂâçÊúçÂä°ÂïÜÂàÜÁªÑÂÜÖÁöÑÊåâÈíÆ
                    const activeBtn = getActiveFetchButton();
                    if (activeBtn) activeBtn.disabled = !apiKey;
                }

                const tripForm = document.getElementById('trip-form');
                const submitBtn = document.getElementById('generate-btn');
                const loadingIndicator = document.getElementById('loading-indicator');
                const inputContainer = document.getElementById('input-container');
                const planOutput = document.getElementById('plan-output');
                const tripTypeSelector = document.getElementById('trip-type-selector');
                const destinationInput = document.getElementById('destination');
                const durationInput = document.getElementById('duration');
                const singleDestGroup = document.getElementById('single-dest-group');
                const multiCityContainer = document.getElementById('multi-city-container');
                const addCityBtn = document.getElementById('add-city-btn');
                const departureDateInput = document.getElementById('departure-date');
                const addFamilyBtn = document.getElementById('add-family-btn');
                const familyList = document.getElementById('family-list');
                const usageModeSelector = document.getElementById('usage-mode-selector');
                const aiPlanningSection = document.getElementById('ai-planning-section');
                const existingPlanSection = document.getElementById('existing-plan-section');
                const mainTransportRadios = document.querySelectorAll('input[name="main-transport"]');
                const customMainTransportGroup = document.getElementById('custom-main-transport-group');
                const customMainTransportInput = document.getElementById('custom-main-transport');

                // ËÆæÁΩÆ‰øùÂ≠òÂíåÂä†ËΩΩÂäüËÉΩ
                function loadSettings() {
                    try {
                        const savedSettings = localStorage.getItem('travelPlannerSettings');
                        if (savedSettings) {
                            const settings = JSON.parse(savedSettings);

                            // ÊÅ¢Â§çAPIËÆæÁΩÆ
                            if (settings.geminiApiKey) geminiApiKeyInput.value = settings.geminiApiKey;
                            if (settings.openaiApiKey) openaiApiKeyInput.value = settings.openaiApiKey;
                            if (settings.deepseekApiKey) deepseekApiKeyInput.value = settings.deepseekApiKey;
                            if (settings.customApiKey) customApiKeyInput.value = settings.customApiKey;
                            if (settings.apiProvider) apiProviderSelect.value = settings.apiProvider;
                            if (settings.customEndpoint) customEndpointInput.value = settings.customEndpoint;
                            if (settings.customAuthHeaderName) document.getElementById('custom-auth-header-name').value = settings.customAuthHeaderName;
                            if (settings.customAuthHeaderValue) document.getElementById('custom-auth-header-value').value = settings.customAuthHeaderValue;
                            if (settings.searchApiKey) searchApiKeyInput.value = settings.searchApiKey;
                            if (settings.enableSearch !== undefined) enableSearchCheckbox.checked = settings.enableSearch;

                            // ÊÅ¢Â§çÂΩìÂâçÊúçÂä°ÂïÜÁöÑÊ®°ÂûãÈÄâÊã©
                            const currentProvider = apiProviderSelect.value;
                            const providerModelsKey = `${currentProvider}_models`;
                            const providerSelectedModelKey = `${currentProvider}_selectedModel`;

                            if (settings[providerModelsKey] && settings[providerModelsKey].length > 0) {
                                modelSelect.innerHTML = settings[providerModelsKey].map(model => `<option value="${model}">${model}</option>`).join('');
                                modelSelect.disabled = false;
                                if (settings[providerSelectedModelKey]) {
                                    modelSelect.value = settings[providerSelectedModelKey];
                                }
                                console.log(`ÊÅ¢Â§ç${currentProvider}ÁöÑÊ®°ÂûãÈÄâÊã©:`, settings[providerSelectedModelKey]);
                            } else if (settings.models && settings.models.length > 0) {
                                // ÂêëÂêéÂÖºÂÆπÔºöÂ¶ÇÊûúÊ≤°ÊúâÊúçÂä°ÂïÜÁâπÂÆöÁöÑÊ®°ÂûãÔºå‰ΩøÁî®ÈÄöÁî®ÁöÑÊ®°ÂûãÂàóË°®
                                modelSelect.innerHTML = settings.models.map(model => `<option value="${model}">${model}</option>`).join('');
                                modelSelect.disabled = false;
                                if (settings.selectedModel) {
                                    modelSelect.value = settings.selectedModel;
                                }
                                console.log('‰ΩøÁî®ÈÄöÁî®Ê®°ÂûãÈÄâÊã©:', settings.selectedModel);
                            }

                            settingsStatus.textContent = 'Â∑≤Âä†ËΩΩ‰øùÂ≠òÁöÑËÆæÁΩÆ';
                            setTimeout(() => settingsStatus.textContent = '', 3000);
                            validateForm();
                        }

                        // Êõ¥Êñ∞API KeyÊòæÁ§∫ÂíåÊåâÈíÆÁä∂ÊÄÅ
                        updateApiKeyVisibility();
                    } catch (error) {
                        console.error('Âä†ËΩΩËÆæÁΩÆÂ§±Ë¥•:', error);
                        settingsStatus.textContent = 'Âä†ËΩΩËÆæÁΩÆÂ§±Ë¥•';
                        settingsStatus.style.color = 'red';
                        setTimeout(() => {
                            settingsStatus.textContent = '';
                            settingsStatus.style.color = '';
                        }, 3000);
                    }
                }

                function saveSettings() {
                    try {
                        // Ëé∑ÂèñÁé∞ÊúâËÆæÁΩÆ
                        const existingSettings = localStorage.getItem('travelPlannerSettings');
                        const settings = existingSettings ? JSON.parse(existingSettings) : {};

                        // Êõ¥Êñ∞Âü∫Êú¨ËÆæÁΩÆ
                        settings.geminiApiKey = geminiApiKeyInput.value;
                        settings.openaiApiKey = openaiApiKeyInput.value;
                        settings.deepseekApiKey = deepseekApiKeyInput.value;
                        settings.customApiKey = customApiKeyInput.value;
                        settings.apiProvider = apiProviderSelect.value;
                        settings.customEndpoint = customEndpointInput.value;
                        // ‰øùÂ≠òËá™ÂÆö‰πâÈâ¥ÊùÉÂ§¥ËÆæÁΩÆ
                        const customAuthHeaderNameInput = document.getElementById('custom-auth-header-name');
                        const customAuthHeaderValueInput = document.getElementById('custom-auth-header-value');
                        settings.customAuthHeaderName = customAuthHeaderNameInput ? customAuthHeaderNameInput.value : '';
                        settings.customAuthHeaderValue = customAuthHeaderValueInput ? customAuthHeaderValueInput.value : '';
                        settings.searchApiKey = searchApiKeyInput.value;
                        settings.enableSearch = enableSearchCheckbox.checked;

                        // ‰∏∫ÂΩìÂâçÊúçÂä°ÂïÜ‰øùÂ≠òÊ®°ÂûãÂàóË°®
                        const currentProvider = apiProviderSelect.value;
                        const providerModelsKey = `${currentProvider}_models`;
                        const providerSelectedModelKey = `${currentProvider}_selectedModel`;

                        settings[providerModelsKey] = Array.from(modelSelect.options).map(option => option.value);
                        settings[providerSelectedModelKey] = modelSelect.value;

                        // ‰øùÊåÅÂêëÂêéÂÖºÂÆπ
                        settings.models = Array.from(modelSelect.options).map(option => option.value);
                        settings.selectedModel = modelSelect.value;

                        localStorage.setItem('travelPlannerSettings', JSON.stringify(settings));
                        settingsStatus.textContent = 'ËÆæÁΩÆÂ∑≤‰øùÂ≠ò';
                        settingsStatus.style.color = 'green';
                        setTimeout(() => {
                            settingsStatus.textContent = '';
                            settingsStatus.style.color = '';
                        }, 3000);
                    } catch (error) {
                        console.error('‰øùÂ≠òËÆæÁΩÆÂ§±Ë¥•:', error);
                        settingsStatus.textContent = '‰øùÂ≠òËÆæÁΩÆÂ§±Ë¥•';
                        settingsStatus.style.color = 'red';
                        setTimeout(() => {
                            settingsStatus.textContent = '';
                            settingsStatus.style.color = '';
                        }, 3000);
                    }
                }

                function clearSettings() {
                    try {
                        localStorage.removeItem('travelPlannerSettings');

                        // Ê∏ÖÈô§Ë°®Âçï
                        geminiApiKeyInput.value = '';
                        openaiApiKeyInput.value = '';
                        deepseekApiKeyInput.value = '';
                        customApiKeyInput.value = '';
                        apiProviderSelect.value = 'gemini';
                        customEndpointInput.value = '';
                        searchApiKeyInput.value = '';
                        enableSearchCheckbox.checked = true;
                        modelSelect.innerHTML = '<option>ËØ∑ÂÖàËæìÂÖ•KeyÂπ∂ÊãâÂèñÊ®°Âûã</option>';
                        modelSelect.disabled = true;
                        apiStatus.textContent = '';

                        // Êõ¥Êñ∞UI
                        updateCustomEndpointVisibility();
                        updateGeminiSearchUI();
                        // Á¶ÅÁî®ÊâÄÊúâ‚ÄúÊãâÂèñÊ®°Âûã‚ÄùÊåâÈíÆ
                        fetchModelsBtns.forEach(btn => btn.disabled = true);

                        settingsStatus.textContent = 'ËÆæÁΩÆÂ∑≤Ê∏ÖÈô§';
                        settingsStatus.style.color = 'orange';
                        setTimeout(() => {
                            settingsStatus.textContent = '';
                            settingsStatus.style.color = '';
                        }, 3000);
                    } catch (error) {
                        console.error('Ê∏ÖÈô§ËÆæÁΩÆÂ§±Ë¥•:', error);
                        settingsStatus.textContent = 'Ê∏ÖÈô§ËÆæÁΩÆÂ§±Ë¥•';
                        settingsStatus.style.color = 'red';
                        setTimeout(() => {
                            settingsStatus.textContent = '';
                            settingsStatus.style.color = '';
                        }, 3000);
                    }
                }

                // ÂàùÂßãÂåñÂèØÁºñËæëÂÖÉÁ¥†
                function initializeEditableElements() {
                    // Ëá™Âä®Ë∞ÉÊï¥textareaÈ´òÂ∫¶
                    const textareas = document.querySelectorAll('.editable-mission, .editable-funfact, .editable-challenge, .editable-knowledge, .editable-story, .editable-prompt, .editable-journal');
                    textareas.forEach(textarea => {
                        // ÂàùÂßãÂåñÈ´òÂ∫¶
                        textarea.style.height = 'auto';
                        textarea.style.height = textarea.scrollHeight + 'px';

                        // Ê∑ªÂä†ËæìÂÖ•‰∫ã‰ª∂ÁõëÂê¨
                        textarea.addEventListener('input', function() {
                            this.style.height = 'auto';
                            this.style.height = this.scrollHeight + 'px';
                        });
                    });

                    // Ëá™Âä®Ë∞ÉÊï¥inputÂÆΩÂ∫¶
                    const inputs = document.querySelectorAll('.editable-title, .editable-info, .editable-topic');
                    inputs.forEach(input => {
                        // ÂàùÂßãÂåñÂÆΩÂ∫¶
                        adjustInputWidth(input);

                        // Ê∑ªÂä†ËæìÂÖ•‰∫ã‰ª∂ÁõëÂê¨
                        input.addEventListener('input', function() {
                            adjustInputWidth(this);
                        });
                    });

                    // ÂàùÂßãÂåñ‰∫§‰∫íÂÖÉÁ¥†ÔºàÁîªÂ∏ÉÁ≠âÔºâ
                    const canvases = document.querySelectorAll('.drawing-area canvas');
                    canvases.forEach(canvas => {
                        const ctx = canvas.getContext('2d');
                        ctx.strokeStyle = '#000';
                        ctx.lineWidth = 3;
                        ctx.lineCap = 'round';

                        let isDrawing = false;

                        canvas.addEventListener('mousedown', (e) => {
                            isDrawing = true;
                            const rect = canvas.getBoundingClientRect();
                            const x = e.clientX - rect.left;
                            const y = e.clientY - rect.top;
                            ctx.beginPath();
                            ctx.moveTo(x, y);
                        });

                        canvas.addEventListener('mousemove', (e) => {
                            if (!isDrawing) return;
                            const rect = canvas.getBoundingClientRect();
                            const x = e.clientX - rect.left;
                            const y = e.clientY - rect.top;
                            ctx.lineTo(x, y);
                            ctx.stroke();
                        });

                        canvas.addEventListener('mouseup', () => {
                            isDrawing = false;
                        });

                        canvas.addEventListener('mouseout', () => {
                            isDrawing = false;
                        });
                    });
                }

                function adjustInputWidth(input) {
                    // ÂàõÂª∫‰∏¥Êó∂ÂÖÉÁ¥†Êù•ÊµãÈáèÊñáÊú¨ÂÆΩÂ∫¶
                    const temp = document.createElement('span');
                    temp.style.visibility = 'hidden';
                    temp.style.position = 'absolute';
                    temp.style.fontSize = window.getComputedStyle(input).fontSize;
                    temp.style.fontFamily = window.getComputedStyle(input).fontFamily;
                    temp.style.fontWeight = window.getComputedStyle(input).fontWeight;
                    temp.textContent = input.value || input.placeholder;
                    document.body.appendChild(temp);

                    const width = Math.max(temp.offsetWidth + 20, parseInt(input.style.minWidth) || 100);
                    input.style.width = width + 'px';

                    document.body.removeChild(temp);
                }

                // ÊäòÂè†ÂäüËÉΩ
                function initializeCollapsible() {
                    const formBlocks = document.querySelectorAll('.form-block');

                    formBlocks.forEach((block, index) => {
                        const header = block.querySelector('h3');
                        const content = block.querySelector('.form-block-content');

                        if (header && content) {
                            // AIÂä©Êâã(index=0)ÈªòËÆ§ÊäòÂè†ÔºåÁ¨¨‰∏ÄÊ≠•(index=1)ÈªòËÆ§Â±ïÂºÄÔºåÂÖ∂‰ªñÊäòÂè†
                            if (index !== 1) {
                                block.classList.add('collapsed');
                            }

                            header.addEventListener('click', () => {
                                block.classList.toggle('collapsed');

                                // Âπ≥ÊªëÂä®Áîª
                                if (block.classList.contains('collapsed')) {
                                    content.style.maxHeight = '0px';
                                } else {
                                    content.style.maxHeight = content.scrollHeight + 'px';

                                    // Âä®ÁîªÂÆåÊàêÂêéÁßªÈô§maxHeightÈôêÂà∂
                                    setTimeout(() => {
                                        if (!block.classList.contains('collapsed')) {
                                            content.style.maxHeight = 'none';
                                        }
                                    }, 300);
                                }
                            });

                            // ËÆæÁΩÆÂàùÂßãÁä∂ÊÄÅ
                            if (block.classList.contains('collapsed')) {
                                content.style.maxHeight = '0px';
                            } else {
                                content.style.maxHeight = 'none';
                            }
                        }
                    });
                }

                // ÂàùÂßãÂåñ
                document.addEventListener('DOMContentLoaded', () => {
                    console.log('DOM loaded, initializing...');
                    loadSettings();
                    setupEventListeners();
                    updateFormForTripType();
                    updateFormForUsageMode();
                    updateGeminiSearchUI();
                    updateCustomEndpointVisibility();
                    updateMainTransportUI();
                    updateOptionStyles();
                    initializeCollapsible();

                    // ÂàùÂßãÂåñAPI KeyÊòæÁ§∫ÂíåÊåâÈíÆÁä∂ÊÄÅ
                    updateApiKeyVisibility();
                    console.log('API Key present:', !!getCurrentApiKey());
                    const activeBtn = getActiveFetchButton();
                    console.log('Active fetch button disabled:', activeBtn ? activeBtn.disabled : 'N/A');
                    // Âº∫Âà∂Âà∑Êñ∞‰∏ÄÊ¨°ÊåâÈíÆÁä∂ÊÄÅÔºåË¶ÜÁõñËá™Âä®Â°´ÂÖÖÁ≠âÊÉÖÂÜµ
                    updateFetchButtonState();

                    console.log('Initialization complete');
                });

                // Ë°®ÂçïÊèê‰∫§Â§ÑÁêÜ
                async function handleFormSubmit(e) {
                    e.preventDefault();

                    // È™åËØÅÂøÖÂ°´Â≠óÊÆµ
                    const apiKey = getCurrentApiKey();
                    const selectedModel = modelSelect.value;
                    const provider = apiProviderSelect.value;

                    if (!apiKey) {
                        showError('ËØ∑ËæìÂÖ•API Key');
                        return;
                    }

                    if (!selectedModel || selectedModel === 'ËØ∑ÂÖàËæìÂÖ•KeyÂπ∂ÊãâÂèñÊ®°Âûã') {
                        showError('ËØ∑ÂÖàÊãâÂèñÂπ∂ÈÄâÊã©Ê®°Âûã');
                        return;
                    }

                    // Êî∂ÈõÜË°®ÂçïÊï∞ÊçÆ
                    const formData = collectFormData();
                    if (!formData) return; // È™åËØÅÂ§±Ë¥•

                    // ÊòæÁ§∫ËΩΩÂÖ•Áä∂ÊÄÅ
                    showLoading();

                    try {
                        // ÁîüÊàêÊèêÁ§∫ËØç
                        const prompt = generatePrompt(formData);

                        // Ë∞ÉÁî®AI API
                        const response = await callAI(apiKey, selectedModel, prompt, provider);
                        console.log('AI Response:', response);

                        // Ëß£ÊûêÂìçÂ∫î
                        let planData;
                        console.log('ÂéüÂßãAIÂìçÂ∫îÈïøÂ∫¶:', response.length);
                        console.log('ÂéüÂßãAIÂìçÂ∫îÂâç500Â≠óÁ¨¶:', response.substring(0, 500));

                        try {
                            // Â∞ùËØïÁõ¥Êé•Ëß£Êûê‰∏∫JSON
                            planData = JSON.parse(response);
                            console.log('Áõ¥Êé•JSONËß£ÊûêÊàêÂäü');
                        } catch (e) {
                            console.log('Áõ¥Êé•JSONËß£ÊûêÂ§±Ë¥•ÔºåÂ∞ùËØïÂÖ∂‰ªñÊñπÊ≥ï...');

                            // ÊñπÊ≥ï1: ÊèêÂèñÊúÄÂ§ßÁöÑJSONÂØπË±°
                            let jsonMatch = response.match(/\{[\s\S]*\}/);
                            if (jsonMatch) {
                                try {
                                    planData = JSON.parse(jsonMatch[0]);
                                    console.log('ÊèêÂèñJSONÂØπË±°ÊàêÂäü');
                                } catch (e2) {
                                    console.log('ÊèêÂèñÁöÑJSONÂØπË±°Ëß£ÊûêÂ§±Ë¥•ÔºåÂ∞ùËØïÊ∏ÖÁêÜ...');

                                    // ÊñπÊ≥ï2: Ê∏ÖÁêÜÂ∏∏ËßÅÁöÑÈùûJSONÂÜÖÂÆπ
                                    let cleanedResponse = response
                                        .replace(/```json\s*/gi, '')  // ÁßªÈô§markdown‰ª£Á†ÅÂùóÊ†áËÆ∞
                                        .replace(/```\s*/gi, '')      // ÁßªÈô§markdown‰ª£Á†ÅÂùóÁªìÊùüÊ†áËÆ∞
                                        .replace(/^[^{]*/, '')        // ÁßªÈô§ÂºÄÂ§¥ÁöÑÈùûJSONÂÜÖÂÆπ
                                        .replace(/[^}]*$/, '}')       // Á°Æ‰øù‰ª•}ÁªìÂ∞æ
                                        .trim();

                                    try {
                                        planData = JSON.parse(cleanedResponse);
                                        console.log('Ê∏ÖÁêÜÂêéJSONËß£ÊûêÊàêÂäü');
                                    } catch (e3) {
                                        console.log('Ê∏ÖÁêÜÂêé‰ªçÁÑ∂Ëß£ÊûêÂ§±Ë¥•ÔºåÂ∞ùËØïÊü•ÊâæJSONÊï∞ÁªÑ...');

                                        // ÊñπÊ≥ï3: Êü•ÊâæJSONÊï∞ÁªÑ
                                        const arrayMatch = response.match(/\[[\s\S]*\]/);
                                        if (arrayMatch) {
                                            try {
                                                const arrayData = JSON.parse(arrayMatch[0]);
                                                planData = { itinerary: arrayData };
                                                console.log('JSONÊï∞ÁªÑËß£ÊûêÊàêÂäüÔºåÂåÖË£Ö‰∏∫ÂØπË±°');
                                            } catch (e4) {
                                                console.error('ÊâÄÊúâËß£ÊûêÊñπÊ≥ïÈÉΩÂ§±Ë¥•‰∫Ü');
                                                console.error('ÂéüÂßãÂìçÂ∫î:', response);
                                                throw new Error(`AIËøîÂõûÁöÑÂÜÖÂÆπ‰∏çÊòØÊúâÊïàÁöÑJSONÊ†ºÂºè„ÄÇÂìçÂ∫îÂÜÖÂÆπ: ${response.substring(0, 200)}...`);
                                            }
                                        } else {
                                            console.error('Êú™ÊâæÂà∞ÊúâÊïàÁöÑJSONÁªìÊûÑ');
                                            console.error('ÂéüÂßãÂìçÂ∫î:', response);
                                            throw new Error(`AIËøîÂõûÁöÑÂÜÖÂÆπ‰∏≠Ê≤°ÊúâÊâæÂà∞JSONÊ†ºÂºèÁöÑÊï∞ÊçÆ„ÄÇÂìçÂ∫îÂÜÖÂÆπ: ${response.substring(0, 200)}...`);
                                        }
                                    }
                                }
                            } else {
                                console.error('Êú™ÊâæÂà∞JSONÂØπË±°');
                                console.error('ÂéüÂßãÂìçÂ∫î:', response);
                                throw new Error(`AIËøîÂõûÁöÑÂÜÖÂÆπ‰∏≠Ê≤°ÊúâÊâæÂà∞JSONÊ†ºÂºèÁöÑÊï∞ÊçÆ„ÄÇÂìçÂ∫îÂÜÖÂÆπ: ${response.substring(0, 200)}...`);
                            }
                        }

                        // Ê∏≤ÊüìËÆ°Âàí
                        renderPlan(planData);

                        // ÂàùÂßãÂåñÂèØÁºñËæëÂÖÉÁ¥†
                        initializeEditableElements();

                        // ÈöêËóèÂä†ËΩΩÁä∂ÊÄÅÔºåÊòæÁ§∫ÁªìÊûú
                        hideLoading();
                        showPlanOutput();

                    } catch (error) {
                        console.error('ÁîüÊàêËÆ°ÂàíÂ§±Ë¥•:', error);
                        hideLoading();
                        showError(`ÁîüÊàêÂ§±Ë¥•: ${error.message}`);
                    }
                }

                // Êî∂ÈõÜË°®ÂñÆÊï∏Êìö
                function collectFormData() {
                    const tripType = document.querySelector('input[name="trip-type"]:checked')?.value;
                    const language = document.querySelector('input[name="language"]:checked')?.value;
                    const usageMode = document.querySelector('input[name="usage-mode"]:checked')?.value;

                    let destination = '';
                    let duration = '';

                    if (tripType === 'multi-city') {
                        const cities = Array.from(document.querySelectorAll('#multi-city-container .list-item')).map(item => {
                            const cityInput = item.querySelector('.city-name') || item.querySelector('input[type="text"]');
                            const durationInput = item.querySelector('.city-duration');
                            return {
                                city: cityInput?.value?.trim() || '',
                                duration: parseInt(durationInput?.value) || 1
                            };
                        }).filter(city => city.city);

                        if (cities.length === 0) {
                            showError('ËØ∑Ëá≥Â∞ëÊ∑ªÂä†‰∏Ä‰∏™ÂüéÂ∏Ç');
                            return null;
                        }

                        destination = cities.map(c => c.city).join('„ÄÅ');
                        duration = cities.reduce((sum, c) => sum + c.duration, 0);
                    } else {
                        destination = destinationInput.value.trim();
                        duration = parseInt(document.getElementById('duration')?.value) || 1;

                        if (!destination) {
                            showError('ËØ∑ËæìÂÖ•ÁõÆÁöÑÂú∞');
                            return null;
                        }
                    }

                    // Êî∂ÈõÜÂÆ∂Â∫≠ÊàêÂì°
                    const familyMembers = Array.from(document.querySelectorAll('#family-list .list-item')).map(item => {
                        const nameInput = item.querySelector('.member-name') || item.querySelector('input[type="text"]');
                        const ageInput = item.querySelector('.member-age') || item.querySelector('input[type="number"]');
                        return {
                            name: nameInput?.value?.trim() || '',
                            age: parseInt(ageInput?.value) || 0
                        };
                    }).filter(member => member.name);

                    // Êî∂ÈõÜÂÖ¥Ë∂£Áà±Â•Ω
                    const interests = Array.from(document.querySelectorAll('input[name="interests"]:checked')).map(input => input.value);

                    // Êî∂ÈõÜÁâπÊÆäÈúÄÊ±Ç
                    const specialNeeds = Array.from(document.querySelectorAll('input[name="special-needs"]:checked')).map(input => input.value);

                    // Êî∂ÈõÜÂÖ∂‰ªñÂÅèÂ•Ω
                    const otherPreferences = document.getElementById('other-preferences')?.value?.trim() || '';

                    // Êî∂ÈõÜÂ≠£ËäÇ‰ø°ÊÅØ
                    const season = document.querySelector('input[name="season"]:checked')?.value || 'Êò•Â≠£';

                    return {
                        tripType,
                        language,
                        usageMode,
                        destination,
                        duration,
                        familyMembers,
                        interests,
                        specialNeeds,
                        otherPreferences,
                        season,
                        enableSearch: enableSearchCheckbox.checked,
                        searchApiKey: searchApiKeyInput.value.trim()
                    };
                }

                // Ëé∑ÂèñË°®ÂçïÂø´ÁÖßÔºàÁî®‰∫éÊ∏≤ÊüìËÆ°ÂàíÔºâ
                function getFormSnapshot() {
                    const tripType = document.querySelector('input[name="trip-type"]:checked')?.value;
                    let destination = '';
                    let tripDuration = '';

                    if (tripType === 'multi-city') {
                        const cities = Array.from(document.querySelectorAll('#multi-city-container .list-item')).map(item => {
                            const cityInput = item.querySelector('.city-name') || item.querySelector('input[type="text"]');
                            const durationInput = item.querySelector('.city-duration');
                            return {
                                city: cityInput?.value?.trim() || '',
                                duration: parseInt(durationInput?.value) || 1
                            };
                        }).filter(city => city.city);

                        destination = cities.map(c => c.city).join('„ÄÅ');
                        tripDuration = cities.reduce((sum, c) => sum + c.duration, 0);
                    } else {
                        destination = destinationInput.value.trim();
                        tripDuration = parseInt(document.getElementById('duration')?.value) || 1;
                    }

                    // Êî∂ÈõÜÂÆ∂Â∫≠ÊàêÂì°
                    const familyMembers = Array.from(document.querySelectorAll('#family-list .list-item')).map(item => {
                        const nameInput = item.querySelector('.member-name') || item.querySelector('input[type="text"]');
                        const ageInput = item.querySelector('.member-age') || item.querySelector('input[type="number"]');
                        return {
                            name: nameInput?.value?.trim() || '',
                            age: parseInt(ageInput?.value) || 0
                        };
                    }).filter(member => member.name);

                    return {
                        destination,
                        familyMembers,
                        tripDuration
                    };
                }

                // È™åËØÅË°®ÂçïÂπ∂Êõ¥Êñ∞Êèê‰∫§ÊåâÈíÆÁä∂ÊÄÅ
                function validateForm() {
                    const apiKey = getCurrentApiKey();
                    const selectedModel = modelSelect.value;
                    const destination = destinationInput.value.trim();

                    const isValid = apiKey &&
                                   selectedModel &&
                                   selectedModel !== 'ËØ∑ÂÖàËæìÂÖ•KeyÂπ∂ÊãâÂèñÊ®°Âûã' &&
                                   destination;

                    submitBtn.disabled = !isValid;
                }

                // Êõ¥Êñ∞ÈÄâÈ°πÊ†∑Âºè
                function updateOptionStyles() {
                    // Êõ¥Êñ∞ÊâÄÊúâradioÂíåcheckboxÁöÑÈÅ∏‰∏≠Ê®£Âºè
                    document.querySelectorAll('.icon-options input[type="radio"], .icon-options input[type="checkbox"]').forEach(input => {
                        const label = input.closest('label');
                        if (input.checked) {
                            label.classList.add('selected');
                        } else {
                            label.classList.remove('selected');
                        }
                    });
                }

                // ËÆæÁΩÆ‰∫ã‰ª∂ÁõëÂê¨Âô®
                function setupEventListeners() {
                    // ‰∏∫ÊâÄÊúâAPI KeyËæìÂÖ•Ê°ÜÊ∑ªÂä†‰∫ã‰ª∂ÁõëÂê¨
                    [geminiApiKeyInput, openaiApiKeyInput, deepseekApiKeyInput, customApiKeyInput].forEach(input => {
                        ['input','change','paste','keyup','blur'].forEach(evt => {
                            input.addEventListener(evt, () => {
                                updateFetchButtonState();
                                validateForm();
                                // Â§áÊ≥®ÔºöÁî®Êà∑Ë¶ÅÊ±ÇÈô§ Gemini Â§ñÁöÑÂÖ∂‰ªñ‰ª§Áâå‰πüÂ∫îËá™Âä®‰øùÂ≠òÔºåËøôÈáåÂú®ËæìÂÖ•Èò∂ÊÆµÂç≥‰øùÂ≠ò
                                saveSettings();
                            });
                        });
                    });

                    // ÁªëÂÆöÊâÄÊúâ‚ÄúÊãâÂèñÊ®°Âûã‚ÄùÊåâÈíÆÁÇπÂáª‰∫ã‰ª∂
                    fetchModelsBtns.forEach(btn => btn.addEventListener('click', fetchModels));
                    clearSettingsBtn.addEventListener('click', clearSettings);

                    // ÊúçÂä°ÂïÜÂàáÊç¢Êó∂‰πüÁ´ãÂç≥‰øùÂ≠òÔºå‰øùËØÅÂΩìÂâçÊèê‰æõÂïÜ‰∏éÁõ∏ÂÖ≥KeyÊåÅ‰πÖÂåñ
                    apiProviderSelect.addEventListener('change', () => {
                        updateApiKeyVisibility();
                        updateCustomEndpointVisibility();
                        updateGeminiSearchUI();
                        updateMainTransportUI();
                        updateOptionStyles();
                        updateFetchButtonState();

                        // Â∞ùËØïÊÅ¢Â§çËØ•ÊúçÂä°ÂïÜÁöÑÊ®°ÂûãÂàóË°®
                        const savedSettings = localStorage.getItem('travelPlannerSettings');
                        if (savedSettings) {
                            const settings = JSON.parse(savedSettings);
                            const currentProvider = apiProviderSelect.value;
                            const providerModelsKey = `${currentProvider}_models`;
                            const providerSelectedModelKey = `${currentProvider}_selectedModel`;

                            if (settings[providerModelsKey] && settings[providerModelsKey].length > 0) {
                                modelSelect.innerHTML = settings[providerModelsKey].map(model => `<option value="${model}">${model}</option>`).join('');
                                modelSelect.disabled = false;
                                if (settings[providerSelectedModelKey]) {
                                    modelSelect.value = settings[providerSelectedModelKey];
                                }
                                apiStatus.textContent = `Â∑≤ÊÅ¢Â§ç ${settings[providerModelsKey].length} ‰∏™Ê®°Âûã`;
                            } else {
                                modelSelect.innerHTML = '<option>ËØ∑ÂÖàËæìÂÖ•KeyÂπ∂ÊãâÂèñÊ®°Âûã</option>';
                                modelSelect.disabled = true;
                                apiStatus.textContent = '';
                            }
                        } else {
                            modelSelect.innerHTML = '<option>ËØ∑ÂÖàËæìÂÖ•KeyÂπ∂ÊãâÂèñÊ®°Âûã</option>';
                            modelSelect.disabled = true;
                            apiStatus.textContent = '';
                        }

                        validateForm();
                        saveSettings();
                    });

                    // Ëá™ÂÆö‰πâÁ´ØÁÇπÂèòÂåñÊó∂‰πüËøõË°å‰øùÂ≠ò
                    ['input','change','blur'].forEach(evt => {
                        customEndpointInput.addEventListener(evt, () => {
                            saveSettings();
                        });
                    });
                    // Ëá™ÂÆö‰πâÈâ¥ÊùÉÂ§¥ÂèòÂåñÊó∂‰πü‰øùÂ≠ò
                    const customAuthHeaderNameInput = document.getElementById('custom-auth-header-name');
                    const customAuthHeaderValueInput = document.getElementById('custom-auth-header-value');
                    if (customAuthHeaderNameInput && customAuthHeaderValueInput) {
                        ['input','change','blur'].forEach(evt => {
                            customAuthHeaderNameInput.addEventListener(evt, saveSettings);
                            customAuthHeaderValueInput.addEventListener(evt, saveSettings);
                        });
                    }

                    modelSelect.addEventListener('change', () => {
                        validateForm();
                        saveSettings(); // Ëá™Âä®‰øùÂ≠òÈÄâÊã©ÁöÑÊ®°Âûã
                        console.log('Ê®°ÂûãÈÄâÊã©Â∑≤‰øùÂ≠ò:', modelSelect.value);
                    });
                    destinationInput.addEventListener('input', validateForm);
                    enableSearchCheckbox.addEventListener('change', updateGeminiSearchUI);
                    tripTypeSelector.addEventListener('change', () => {
                        updateFormForTripType();
                        updateOptionStyles();
                    });
                    usageModeSelector.addEventListener('change', () => {
                        updateFormForUsageMode();
                        updateOptionStyles();
                    });
                    addCityBtn.addEventListener('click', () => addCityRow());
                    addFamilyBtn.addEventListener('click', () => addFamilyMember());
                    familyList.addEventListener('click', e => {
                        if (e.target.classList.contains('remove-btn')) {
                            e.target.closest('.list-item').remove();
                        }
                    });
                    multiCityContainer.addEventListener('click', e => {
                        if (e.target.classList.contains('remove-btn')) {
                            e.target.closest('.list-item').remove();
                            updateDurationFromCities();
                        }
                    });
                    multiCityContainer.addEventListener('input', e => {
                        if (e.target.classList.contains('city-duration')) {
                            updateDurationFromCities();
                        }
                    });
                    tripForm.addEventListener('submit', handleFormSubmit);

                    // ‰∏∫ÊâÄÊúâÈÄâÈ°πÊ∑ªÂä†Ê†∑ÂºèÊõ¥Êñ∞‰∫ã‰ª∂
                    document.addEventListener('change', (e) => {
                        if (e.target.matches('.icon-options input[type="radio"], .icon-options input[type="checkbox"]')) {
                            updateOptionStyles();
                        }
                    });

                    mainTransportRadios.forEach(radio => {
                        radio.addEventListener('change', updateMainTransportUI);
                    });
                }

                // ÁîüÊàêAIÊèêÁ§∫ËØç
                function generatePrompt(formData) {
                    const { destination, duration, familyMembers, tripType, language, usageMode, enableSearch, interests, specialNeeds, otherPreferences, season } = formData;

                    let prompt = `ËØ∑‰∏∫ÊàëËßÑÂàí‰∏Ä‰∏™${destination}ÁöÑ${duration}Â§©ÊóÖË°åËÆ°Âàí„ÄÇ`;

                    if (familyMembers.length > 0) {
                        const familyInfo = familyMembers.map(m => `${m.name}(${m.age}Â≤Å)`).join('„ÄÅ');
                        prompt += `ÊóÖË°åÊàêÂëòÔºö${familyInfo}„ÄÇ`;
                    }

                    // Ê∑ªÂä†Â≠£ËäÇ‰ø°ÊÅØ
                    if (season) {
                        prompt += `Âá∫Ë°åÂ≠£ËäÇÔºö${season}„ÄÇ`;
                    }

                    // Ê∑ªÂä†ÂÖ¥Ë∂£Áà±Â•Ω‰ø°ÊÅØ
                    if (interests && interests.length > 0) {
                        prompt += `Êàë‰ª¨ÁöÑÂÖ¥Ë∂£Áà±Â•ΩÔºö${interests.join('„ÄÅ')}„ÄÇ`;
                    }

                    // Ê∑ªÂä†ÁâπÊÆäÈúÄÊ±Ç‰ø°ÊÅØ
                    if (specialNeeds && specialNeeds.length > 0) {
                        prompt += `ÁâπÊÆäÈúÄÊ±ÇÔºö${specialNeeds.join('„ÄÅ')}„ÄÇ`;
                    }

                    // Ê∑ªÂä†ÂÖ∂‰ªñÂÅèÂ•Ω
                    if (otherPreferences) {
                        prompt += `ÂÖ∂‰ªñÂÅèÂ•ΩÂíåË¶ÅÊ±ÇÔºö${otherPreferences}„ÄÇ`;
                    }

                    if (enableSearch) {
                        prompt += 'ËØ∑ÊêúÁ¥¢ÊúÄÊñ∞ÁöÑÊôØÁÇπ‰ø°ÊÅØ„ÄÅÂ§©Ê∞î„ÄÅ‰ª∑Ê†ºÁ≠âÂÆûÊó∂ËµÑËÆØ„ÄÇ';
                    }

                    prompt += `

ÈáçË¶ÅËØ¥ÊòéÔºö
1. ËØ∑Â∞ÜÊóÖË°åËÆ°ÂàíÂàÜËß£‰∏∫ÂÖ∑‰ΩìÁöÑÂú∞ÁÇπ/ÊôØÁÇπÔºåËÄå‰∏çÊòØÊåâÂ§©ÂàÜÁªÑ
2. ÊØè‰∏™Âú∞ÁÇπÈÉΩË¶ÅÊèê‰æõ‰∏â‰∏™ÁâàÊú¨ÔºöÂÑøÁ´•Áâà„ÄÅÈùíÂ∞ëÂπ¥Áâà„ÄÅÂÆ∂ÈïøÁâà
3. ËØ∑Á°Æ‰øùÂÜÖÂÆπ‰∏∞ÂØå‰∏îÈÄÇÂêà‰∏çÂêåÂπ¥ÈæÑÂ±Ç

**ÈáçË¶ÅÔºöËæìÂá∫Ê†ºÂºèË¶ÅÊ±Ç**
1. ÂøÖÈ°ªÂè™ËøîÂõûÁ∫ØJSONÊ†ºÂºèÔºå‰∏çË¶ÅÂåÖÂê´‰ªª‰ΩïËß£ÈáäÊñáÂ≠ó
2. ‰∏çË¶Å‰ΩøÁî®markdown‰ª£Á†ÅÂùóÊ†áËÆ∞ÔºàÂ¶Ç\`\`\`jsonÔºâ
3. ‰∏çË¶ÅÂú®JSONÂâçÂêéÊ∑ªÂä†‰ªª‰ΩïËØ¥ÊòéÊñáÂ≠ó
4. Á°Æ‰øùJSONÊ†ºÂºèÂÆåÂÖ®Ê≠£Á°ÆÔºåÂèØ‰ª•Áõ¥Êé•Ëß£Êûê

ËØ∑‰∏•Ê†ºÊåâÁÖß‰ª•‰∏ãJSONÊ†ºÂºèËøîÂõûÔºö

{
  "itinerary": [
    {
      "day": 1,
      "locationName": "ÂÖ∑‰ΩìÂú∞ÁÇπÂêçÁß∞Ôºå‰æãÂ¶ÇÔºö'Èõ∑Â≥∞Â°î'",
      "estimatedTime": "Âª∫ËÆÆÂÅúÁïôÊó∂Èó¥Ôºå‰æãÂ¶ÇÔºö'1.5Â∞èÊó∂'",
      "childVersion": {
        "title": "ÈÄÇÂêàÂÑøÁ´•ÁöÑÊúâË∂£Ê†áÈ¢ò",
        "missions": ["ÈÄÇÂêàÂÑøÁ´•ÁöÑÁÆÄÂçï‰ªªÂä°Ôºå‰∏éÊ≠§Âú∞ÁÇπÁõ∏ÂÖ≥"],
        "funFact": "ÂÖ≥‰∫éÊ≠§Âú∞ÁöÑÊúâË∂£‰∫ãÂÆûÔºåÊòì‰∫éÁêÜËß£",
        "creativePrompt": "‰∏éÊ≠§Âú∞ÁÇπÁõ∏ÂÖ≥ÁöÑÁªòÁîªÊèêÁ§∫"
      },
      "teenagerVersion": {
        "title": "ÈÄÇÂêàÈùíÂ∞ëÂπ¥ÁöÑÈÖ∑ÁÇ´Ê†áÈ¢ò",
        "challenges": ["ÈÄÇÂêàÈùíÂ∞ëÂπ¥ÁöÑÊ∑±Â∫¶‰ªªÂä°"],
        "knowledgePlus": "ÂÖ≥‰∫éÊ≠§Âú∞ÁöÑÊ∑±Â∫¶Áü•ËØÜ",
        "inspirationPrompts": {
          "bgm": "ÈÄÇÂêàÊ≠§Âú∞ÁÇπÁöÑÈü≥‰πêÈ£éÊ†ºÊèêÁ§∫",
          "colorPalette": ["‰ª£Ë°®Ê≠§Âú∞ÁÇπÁöÑÈ¢úËâ≤1", "È¢úËâ≤2"],
          "reflection": "ÂºïÂèëÊÄùËÄÉÁöÑ‰∏ÄÂè•ËØùÊèêÁ§∫"
        }
      },
      "parentVersion": {
        "title": "ÂÆûÁî®ÁöÑÂú∞ÁÇπÊ†áÈ¢ò",
        "practicalInfo": {
          "timing": "Âª∫ËÆÆÊó∂Èó¥Ôºå‰æãÂ¶ÇÔºö'‰∏äÂçà10:00-11:30'",
          "transport": "‰∫§ÈÄöÂª∫ËÆÆ",
          "tips": "ÈáçË¶ÅÊèêÁ§∫"
        },
        "storytellingToolkit": [{"topic": "Âú∞ÁÇπÁâπËâ≤", "story": "ÂèØ‰ª•ÂàÜ‰∫´ÁöÑÂ∞èÊïÖ‰∫ã"}],
        "engagementGuide": [{"prompt": "ÂèØ‰ª•Âú®Ê≠§Âú∞ÁÇπÈóÆÂ≠©Â≠êÁöÑÂºÄÊîæÊÄßÈóÆÈ¢ò"}],
        "journalPrompt": "ÂÆ∂ÈïøÂèçÊÄùÊ≠§Âú∞ÁÇπÁöÑÊèêÁ§∫"
      }
    }
  ]
}


ÈáçË¶ÅÊèêÈÜíÔºö
- ËØ∑Áî®${language}ÂõûÂ∫î
- Âè™ËøîÂõûJSONÔºå‰∏çË¶Å‰ªª‰ΩïÈ¢ùÂ§ñÊñáÂ≠ó
- Á°Æ‰øùJSONËØ≠Ê≥ïÂÆåÂÖ®Ê≠£Á°Æ
- ‰∏çË¶Å‰ΩøÁî®markdownÊ†ºÂºè

Áé∞Âú®ËØ∑ÂºÄÂßãÁîüÊàêJSONÔºö`;

                    return prompt;
                }

                // ÊòæÁ§∫ËΩΩÂÖ•Áä∂ÊÄÅ
                function showLoading() {
                    loadingIndicator.style.display = 'block';
                    inputContainer.style.display = 'none';
                    const generateBtn = document.getElementById('generate-btn');
                    if (generateBtn) {
                        generateBtn.disabled = true;
                        generateBtn.textContent = 'Ê≠£Âú®ÁîüÊàê‰∏≠...';
                    }
                }

                // ÈöêËóèËΩΩÂÖ•Áä∂ÊÄÅ
                function hideLoading() {
                    loadingIndicator.style.display = 'none';
                    const generateBtn = document.getElementById('generate-btn');
                    if (generateBtn) {
                        generateBtn.disabled = false;
                        generateBtn.textContent = 'ÁÇπÊàëÁîüÊàêÂÜíÈô©ÊâãË¥¶';
                    }
                }

                // ÊòæÁ§∫ËÆ°ÂàíËæìÂá∫
                function showPlanOutput() {
                    planOutput.style.display = 'block';
                    inputContainer.style.display = 'none';
                }

                // ÊòæÁ§∫ÈîôËØØ‰ø°ÊÅØ
                function showError(message) {
                    alert(message); // ÁÆÄÂçïÁöÑÈîôËØØÊòæÁ§∫ÔºåÂèØ‰ª•ÂêéÁª≠ÊîπËøõ
                }

                // Â§ÑÁêÜÊâìÂç∞ÂäüËÉΩ
                function handlePrint() {
                    window.print();
                }

                // Â§ÑÁêÜÊñ∞ËÆ°ÂàíÂäüËÉΩ
                function handleNewPlan() {
                    planOutput.style.display = 'none';
                    inputContainer.style.display = 'block';

                    // ÈáçÁΩÆË°®ÂçïÔºàÂèØÈÄâÔºâ
                    // tripForm.reset();
                }

                // UI Êõ¥Êñ∞ÂáΩÊï∞
                function updateCustomEndpointVisibility() {
                    customEndpointGroup.style.display = apiProviderSelect.value === 'custom' ? 'block' : 'none';
                }

                function updateGeminiSearchUI() {
                    const isGemini = apiProviderSelect.value === 'gemini';
                    enableSearchCheckbox.disabled = !isGemini;
                    searchApiGroup.style.display = enableSearchCheckbox.checked && isGemini ? 'block' : 'none';
                    searchDescription.textContent = isGemini 
                        ? 'ÂºÄÂêØÂêéAIÂ∞ÜÊêúÁ¥¢ÊúÄÊñ∞ÁöÑÊôØÁÇπ‰ø°ÊÅØ„ÄÅÂ§©Ê∞î„ÄÅ‰ª∑Ê†ºÁ≠â' 
                        : 'ËÅîÁΩëÊêúÁ¥¢‰ªÖÊîØÊåÅGoogle GeminiÊ®°Âûã';
                    if (!isGemini) {
                        enableSearchCheckbox.checked = false;
                    }
                }

                function updateMainTransportUI() {
                    const selectedTransport = document.querySelector('input[name="main-transport"]:checked').value;
                    customMainTransportGroup.style.display = selectedTransport === 'ÂÖ∂‰ªñ' ? 'block' : 'none';
                }

                function updateFormForTripType() {
                    const selectedTripType = document.querySelector('input[name="trip-type"]:checked')?.value;
                    console.log('Selected trip type:', selectedTripType);

                    // ‰∏ÄÊó•Ê∏∏ÂíåÁü≠ÈÄîÊóÖË°åÈÉΩÊòæÁ§∫Âçï‰∏ÄÁõÆÁöÑÂú∞ËæìÂÖ•
                    if (selectedTripType === 'day-trip' || selectedTripType === 'single-city') {
                        singleDestGroup.style.display = 'block';
                        multiCityContainer.style.display = 'none';
                        // Ê†πÊçÆÁ±ªÂûãËÆæÁΩÆÂ§©Êï∞
                        if (selectedTripType === 'day-trip') {
                            durationInput.value = 1;
                            durationInput.readOnly = true;
                        } else {
                            durationInput.readOnly = false;
                        }
                    } else if (selectedTripType === 'multi-city') {
                        singleDestGroup.style.display = 'none';
                        multiCityContainer.style.display = 'block';
                        if (multiCityContainer.children.length <= 1) { // Âè™ÊúâÊ∑ªÂä†ÊåâÈíÆ
                            addCityRow();
                        }
                    }
                }

                function updateFormForUsageMode() {
                    const selectedMode = document.querySelector('input[name="usage-mode"]:checked')?.value;
                    if (selectedMode === 'ai-planning') {
                        aiPlanningSection.style.display = 'block';
                        existingPlanSection.style.display = 'none';
                    } else if (selectedMode === 'existing-plan') {
                        aiPlanningSection.style.display = 'none';
                        existingPlanSection.style.display = 'block';
                    }
                }

                function addCityRow(city = '', days = 1) {
                    const cityRow = document.createElement('div');
                    cityRow.className = 'list-item';
                    cityRow.innerHTML = `
                        <input type="text" class="city-name" placeholder="ÂüéÂ∏ÇÂêçÁß∞" value="${city}">
                        <input type="number" class="city-duration" placeholder="Â§©Êï∞" min="1" value="${days}">
                        <button type="button" class="remove-btn">-</button>
                    `;
                    multiCityContainer.appendChild(cityRow);
                }

                function updateDurationFromCities() {
                    const cityDurations = document.querySelectorAll('.city-duration');
                    const totalDays = Array.from(cityDurations).reduce((sum, input) => sum + (parseInt(input.value, 10) || 0), 0);
                    durationInput.value = totalDays;
                }

                function addFamilyMember() {
                    const memberRow = document.createElement('div');
                    memberRow.className = 'list-item';
                    memberRow.innerHTML = `
                        <input type="text" class="member-name" placeholder="ÂßìÂêç/Áß∞Âëº">
                        <input type="number" class="member-age" placeholder="Âπ¥ÈæÑ">
                        <select class="member-gender">
                            <option value="male">Áî∑</option>
                            <option value="female">Â•≥</option>
                        </select>
                        <button type="button" class="remove-btn">-</button>
                    `;
                    familyList.appendChild(memberRow);
                }

                // -------------------
                // --- API Calls ---
                // -------------------

                async function fetchModels() {
                    console.log('fetchModels called');
                    const apiKey = getCurrentApiKey();
                    const provider = apiProviderSelect.value;
                    console.log('API Key:', apiKey ? 'Present' : 'Missing', 'Provider:', provider);
                    if (!apiKey) {
                        showError('ËØ∑ÂÖàËæìÂÖ•API Key');
                        return;
                    }

                    apiStatus.textContent = 'Ê≠£Âú®ÊãâÂèñÊ®°Âûã...';
                    modelSelect.disabled = true;

                    try {
                        let models = [];
                        if (provider === 'gemini') {
                            models = await getGeminiModels(apiKey);
                        } else {
                            const endpoint = provider === 'custom' ? customEndpointInput.value.trim() : null;
                            console.log('Ë∞ÉËØï‰ø°ÊÅØ - ‰ªéËæìÂÖ•Ê°ÜËé∑ÂèñÁöÑÁ´ØÁÇπ:', endpoint);
                            console.log('Ë∞ÉËØï‰ø°ÊÅØ - ËæìÂÖ•Ê°ÜÂéüÂßãÂÄº:', customEndpointInput.value);
                            models = await getOpenAICompatibleModels(apiKey, endpoint);
                        }

                        // ‰øùÂ≠òÂΩìÂâçÈÄâÊã©ÁöÑÊ®°Âûã
                        const currentSelectedModel = modelSelect.value;

                        // Êõ¥Êñ∞Ê®°ÂûãÂàóË°®
                        modelSelect.innerHTML = models.map(model => `<option value="${model}">${model}</option>`).join('');
                        modelSelect.disabled = false;

                        // Â∞ùËØïÊÅ¢Â§ç‰πãÂâçÈÄâÊã©ÁöÑÊ®°Âûã
                        if (currentSelectedModel && models.includes(currentSelectedModel)) {
                            modelSelect.value = currentSelectedModel;
                            console.log('ÊÅ¢Â§ç‰πãÂâçÈÄâÊã©ÁöÑÊ®°Âûã:', currentSelectedModel);
                        } else if (models.length > 0) {
                            // Â¶ÇÊûú‰πãÂâçÁöÑÊ®°Âûã‰∏çÂú®Êñ∞ÂàóË°®‰∏≠ÔºåÈÄâÊã©Á¨¨‰∏Ä‰∏™Ê®°Âûã
                            modelSelect.value = models[0];
                            console.log('ÈÄâÊã©ÈªòËÆ§Ê®°Âûã:', models[0]);
                        }

                        apiStatus.textContent = `ÊàêÂäüÊãâÂèñ ${models.length} ‰∏™Ê®°Âûã`;
                        saveSettings();
                        validateForm();
                    } catch (error) {
                        console.error('Fetch models error:', error);
                        showError(`ÊãâÂèñÊ®°ÂûãÂ§±Ë¥•: ${error.message}`);
                        apiStatus.textContent = 'ÊãâÂèñÂ§±Ë¥•';
                    }
                }

                async function getGeminiModels(apiKey) {
                    try {
                        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${apiKey}`);
                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                        }
                        const data = await response.json();
                        console.log('Gemini API response:', data);
                        console.log('Total models returned:', data.models?.length || 0);

                        if (!data.models || !Array.isArray(data.models)) {
                            throw new Error('Invalid response format from Gemini API');
                        }

                        // ÊòæÁ§∫ÊâÄÊúâÊ®°ÂûãÁöÑËØ¶ÁªÜ‰ø°ÊÅØ
                        data.models.forEach(model => {
                            console.log('Model:', model.name, 'Methods:', model.supportedGenerationMethods);
                        });

                        // ‰∏çËøõË°å‰ªª‰ΩïÁ≠õÈÄâÔºåËøîÂõûÊâÄÊúâÊ®°Âûã
                        const models = data.models
                            .map(model => model.name.replace('models/', ''))
                            .sort(); // ÊåâÂ≠óÊØçÈ°∫Â∫èÊéíÂ∫è

                        console.log('All Gemini models (no filtering):', models);
                        console.log('Total number of models:', models.length);

                        if (models.length === 0) {
                            console.warn('No models found, using fallback list');
                            return [
                                'gemini-1.5-flash-latest',
                                'gemini-1.5-pro-latest',
                                'gemini-1.0-pro',
                                'gemini-1.5-flash',
                                'gemini-1.5-pro',
                                'gemini-pro',
                                'gemini-pro-vision'
                            ];
                        }

                        return models;
                    } catch (error) {
                        console.warn('Failed to fetch Gemini models from API, using fallback list:', error);
                        // Â¶ÇÊûúAPIË∞ÉÁî®Â§±Ë¥•ÔºåËøîÂõûÂ∑≤Áü•ÁöÑÊ®°ÂûãÂàóË°®
                        return [
                            'gemini-1.5-flash-latest',
                            'gemini-1.5-pro-latest',
                            'gemini-1.0-pro',
                            'gemini-1.5-flash',
                            'gemini-1.5-pro',
                            'gemini-pro',
                            'gemini-pro-vision'
                        ];
                    }
                }

                async function getOpenAICompatibleModels(apiKey, customEndpoint = null) {
                    let endpoint = (customEndpoint || 'https://api.openai.com/v1').replace(/\/$/, '');

                    // ÁâπÊÆäÂ§ÑÁêÜÔºöÂ¶ÇÊûúÊòØ guqinghan.icu ÂüüÂêçÔºåÂº∫Âà∂‰ΩøÁî® http
                    if (endpoint.includes('guqinghan.icu')) {
                        endpoint = endpoint.replace('https://', 'http://');
                        if (!endpoint.startsWith('http://')) {
                            endpoint = 'http://' + endpoint.replace(/^https?:\/\//, '');
                        }
                    }

                    const url = `${endpoint}/models`;

                    console.log(`Ê≠£Âú®‰ªé ${url} ÊãâÂèñÊ®°Âûã...`);
                    console.log(`ÂéüÂßãÁ´ØÁÇπ: ${customEndpoint}, Â§ÑÁêÜÂêéÁ´ØÁÇπ: ${endpoint}, ÊúÄÁªàURL: ${url}`);

                    const fetchConfig = {
                        method: 'GET',
                        mode: 'cors',
                        cache: 'no-cache',
                        headers: {
                            'Accept': 'application/json'
                        }
                    };

                    // Ê£ÄÊü•ÊòØÂê¶ÊúâËá™ÂÆö‰πâÈâ¥ÊùÉÂ§¥ÈÖçÁΩÆ
                    const customNameEl = document.getElementById('custom-auth-header-name');
                    const customValEl = document.getElementById('custom-auth-header-value');
                    const customName = customNameEl?.value.trim();
                    const customValTpl = customValEl?.value.trim();

                    if (customName && customValTpl) {
                        // ‰ºòÂÖà‰ΩøÁî®Áî®Êà∑Ëá™ÂÆö‰πâÁöÑÈâ¥ÊùÉÂ§¥
                        const renderedVal = customValTpl.replaceAll('{key}', apiKey);
                        fetchConfig.headers[customName] = renderedVal;
                        console.log(`‰ΩøÁî®Ëá™ÂÆö‰πâÈâ¥ÊùÉÂ§¥: "${customName}: ${renderedVal.substring(0, 10)}..."`);
                    } else {
                        // Âê¶ÂàôÔºå‰ΩøÁî®Ê†áÂáÜÁöÑ Bearer Token Èâ¥ÊùÉ
                        fetchConfig.headers['Authorization'] = `Bearer ${apiKey}`;
                        console.log(`‰ΩøÁî®Ê†áÂáÜÈâ¥ÊùÉÂ§¥: "Authorization: Bearer ${apiKey.substring(0, 10)}..."`);
                    }

                    try {
                        const response = await fetch(url, fetchConfig);

                        if (!response.ok) {
                            // Â¶ÇÊûúËØ∑Ê±ÇÂ§±Ë¥•ÔºåÂ∞ùËØïËØªÂèñÊúçÂä°Âô®ËøîÂõûÁöÑÈîôËØØ‰ø°ÊÅØ
                            let errorBody = 'Êó†Ê≥ïËØªÂèñÈîôËØØËØ¶ÊÉÖ';
                            try {
                                const errorJson = await response.json();
                                errorBody = errorJson.error?.message || JSON.stringify(errorJson);
                            } catch (e) {
                                errorBody = await response.text();
                            }
                            throw new Error(`HTTP ${response.status}: ${response.statusText}. ËØ¶ÊÉÖ: ${errorBody}`);
                        }

                        const json = await response.json();

                        // ÂÖºÂÆπ‰∏§ÁßçÂ∏∏ËßÅÁöÑËøîÂõûÁªìÊûÑÔºö{data:[{id}]} Êàñ [{id}]
                        const modelList = Array.isArray(json.data) ? json.data : (Array.isArray(json) ? json : []);

                        if (modelList.length === 0) {
                            console.warn("APIËøîÂõûÁöÑÊ®°ÂûãÂàóË°®‰∏∫Á©∫ÔºåËØ∑Ê£ÄÊü•ÂìçÂ∫î:", json);
                        }

                        const allIds = modelList.map(m => m.id).filter(Boolean);
                        console.log('ÂèØÁî®Ê®°ÂûãÂàóË°®:', allIds);

                        // ËøáÊª§Êéâ‰∏çÈÄÇÂêàËÅäÂ§©ÁöÑÊ®°Âûã
                        const filteredModels = allIds.filter(id => {
                            const excludePatterns = [
                                'whisper', 'tts', 'dall-e', 'embedding', 'moderation',
                                'text-similarity', 'text-search', 'code-search'
                            ];
                            return !excludePatterns.some(pattern => id.toLowerCase().includes(pattern));
                        });

                        if (filteredModels.length === 0 && allIds.length > 0) {
                             console.log("Ê≤°ÊúâÊ®°ÂûãË¢´ËøáÊª§ÔºåËøîÂõûÊâÄÊúâÊ®°Âûã„ÄÇ");
                             return allIds;
                        }

                        console.log('ËøáÊª§ÂêéÁöÑÊ®°Âûã:', filteredModels);
                        return filteredModels;

                    } catch (error) {
                        console.error('ÊãâÂèñÊ®°ÂûãÊó∂ÂèëÁîüÁΩëÁªúÊàñËß£ÊûêÈîôËØØ:', error);
                        // ÈáçÊñ∞ÊäõÂá∫ÈîôËØØÔºå‰ª•‰æø‰∏äÂ±ÇÂáΩÊï∞ÂèØ‰ª•ÊçïËé∑Âπ∂ÊòæÁ§∫ÁªôÁî®Êà∑
                        throw new Error(`ËØ∑Ê±Ç ${url} Â§±Ë¥•„ÄÇËØ∑Ê£ÄÊü•Ôºö\n1. Ëá™ÂÆö‰πâÁ´ØÁÇπÊòØÂê¶Ê≠£Á°Æ„ÄÇ\n2. API Key ÊòØÂê¶ÊúâÊïà„ÄÇ\n3. ÊµèËßàÂô®ÊéßÂà∂Âè∞ÁöÑÁΩëÁªúËØ∑Ê±ÇËØ¶ÊÉÖ„ÄÇÈîôËØØ‰ø°ÊÅØ: ${error.message}`);
                    }
                }

                async function callAI(apiKey, modelName, prompt, provider) {
                    console.log('ÂºÄÂßãË∞ÉÁî®AI:', { provider, modelName });

                    try {
                        const endpoint = provider === 'custom' ? customEndpointInput.value.trim() : null;
                        if (provider === 'gemini') {
                            return await callGeminiAPI(apiKey, modelName, prompt);
                        } else {
                            return await callOpenAICompatibleAPI(apiKey, modelName, prompt, endpoint);
                        }
                    } catch (error) {
                        console.error('AIË∞ÉÁî®Â§±Ë¥•:', error);
                        throw new Error(`AIË∞ÉÁî®Â§±Ë¥• (${provider}): ${error.message}`);
                    }
                }

                async function callGeminiAPI(apiKey, modelName, prompt) {
                    const url = `https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${apiKey}`;
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                    });
                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(JSON.stringify(error));
                    }
                    const data = await response.json();
                    return data.candidates[0].content.parts[0].text;
                }

                async function callOpenAICompatibleAPI(apiKey, modelName, prompt, customEndpoint = null) {
                    let endpoint = customEndpoint || 'https://api.openai.com/v1';

                    // ÁâπÊÆäÂ§ÑÁêÜÔºöÂ¶ÇÊûúÊòØ guqinghan.icu ÂüüÂêçÔºåÂº∫Âà∂‰ΩøÁî® http
                    if (endpoint.includes('guqinghan.icu')) {
                        endpoint = endpoint.replace('https://', 'http://');
                        if (!endpoint.startsWith('http://')) {
                            endpoint = 'http://' + endpoint.replace(/^https?:\/\//, '');
                        }
                    }

                    const url = `${endpoint}/chat/completions`;

                    console.log('APIË∞ÉÁî®‰ø°ÊÅØ:', {
                        endpoint: endpoint,
                        url: url,
                        model: modelName,
                        hasApiKey: !!apiKey,
                        promptLength: prompt.length
                    });

                    // ÂáÜÂ§áËØ∑Ê±Ç‰Ωì
                    const requestBody = {
                        model: modelName,
                        messages: [{ role: 'user', content: prompt }],
                        temperature: 0.7,
                        stream: false
                    };

                    // Âü∫Á°ÄfetchÈÖçÁΩÆ
                    const fetchConfig = {
                        method: 'POST',
                        mode: 'cors',
                        cache: 'no-cache',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        },
                        body: JSON.stringify(requestBody)
                    };

                    // Ê£ÄÊü•ÊòØÂê¶ÊúâËá™ÂÆö‰πâËÆ§ËØÅÂ§¥ÈÖçÁΩÆ
                    const customNameEl = document.getElementById('custom-auth-header-name');
                    const customValEl = document.getElementById('custom-auth-header-value');
                    const customName = customNameEl?.value.trim();
                    const customValTpl = customValEl?.value.trim();

                    if (customName && customValTpl) {
                        // ‰ºòÂÖà‰ΩøÁî®Áî®Êà∑Ëá™ÂÆö‰πâÁöÑÈâ¥ÊùÉÂ§¥
                        const renderedVal = customValTpl.replaceAll('{key}', apiKey);
                        fetchConfig.headers[customName] = renderedVal;
                        console.log(`‰ΩøÁî®Ëá™ÂÆö‰πâÈâ¥ÊùÉÂ§¥: "${customName}: ${renderedVal.substring(0, 10)}..."`);
                    } else {
                        // Âê¶ÂàôÔºå‰ΩøÁî®Ê†áÂáÜÁöÑ Bearer Token Èâ¥ÊùÉ
                        fetchConfig.headers['Authorization'] = `Bearer ${apiKey}`;
                        console.log(`‰ΩøÁî®Ê†áÂáÜÈâ¥ÊùÉÂ§¥: "Authorization: Bearer ${apiKey.substring(0, 10)}..."`);
                    }

                    try {
                        const response = await fetch(url, fetchConfig);

                        if (!response.ok) {
                            // Â¶ÇÊûúËØ∑Ê±ÇÂ§±Ë¥•ÔºåÂ∞ùËØïËØªÂèñÊúçÂä°Âô®ËøîÂõûÁöÑÈîôËØØ‰ø°ÊÅØ
                            let errorBody = 'Êó†Ê≥ïËØªÂèñÈîôËØØËØ¶ÊÉÖ';
                            try {
                                const errorJson = await response.json();
                                errorBody = errorJson.error?.message || JSON.stringify(errorJson);
                            } catch (e) {
                                errorBody = await response.text();
                            }
                            throw new Error(`HTTP ${response.status}: ${response.statusText}. ËØ¶ÊÉÖ: ${errorBody}`);
                        }

                        const responseText = await response.text();
                        console.log('Raw response:', responseText);

                        // Ê£ÄÊü•ÊòØÂê¶ÊòØSSEÊ†ºÂºèÁöÑÂìçÂ∫î
                        if (responseText.startsWith('data: ')) {
                            // Â§ÑÁêÜSSEÊ†ºÂºèÁöÑÂìçÂ∫î
                            const lines = responseText.split('\n');
                            let content = '';
                            for (const line of lines) {
                                if (line.startsWith('data: ')) {
                                    const dataStr = line.substring(6);
                                    if (dataStr === '[DONE]') break;
                                    try {
                                        const data = JSON.parse(dataStr);
                                        if (data.choices && data.choices[0] && data.choices[0].delta && data.choices[0].delta.content) {
                                            content += data.choices[0].delta.content;
                                        }
                                    } catch (e) {
                                        console.warn('Failed to parse SSE line:', line);
                                    }
                                }
                            }
                            return content;
                        } else {
                            // Â§ÑÁêÜÊ†áÂáÜJSONÂìçÂ∫î
                            const data = JSON.parse(responseText);
                            return data.choices[0].message.content;
                        }

                    } catch (error) {
                        console.error('APIË∞ÉÁî®Êó∂ÂèëÁîüÁΩëÁªúÊàñËß£ÊûêÈîôËØØ:', error);
                        // ÈáçÊñ∞ÊäõÂá∫ÈîôËØØÔºå‰ª•‰æø‰∏äÂ±ÇÂáΩÊï∞ÂèØ‰ª•ÊçïËé∑Âπ∂ÊòæÁ§∫ÁªôÁî®Êà∑
                        throw new Error(`ËØ∑Ê±Ç ${url} Â§±Ë¥•„ÄÇËØ∑Ê£ÄÊü•Ôºö\n1. Ëá™ÂÆö‰πâÁ´ØÁÇπÊòØÂê¶Ê≠£Á°Æ„ÄÇ\n2. API Key ÊòØÂê¶ÊúâÊïà„ÄÇ\n3. ÊµèËßàÂô®ÊéßÂà∂Âè∞ÁöÑÁΩëÁªúËØ∑Ê±ÇËØ¶ÊÉÖ„ÄÇÈîôËØØ‰ø°ÊÅØ: ${error.message}`);
                    }
                }

                // -------------------
                // --- Plan Rendering ---
                // -------------------

                function renderPlan(data) {
                    if (!data.itinerary || !Array.isArray(data.itinerary)) {
                        console.error("AI's JSON response is missing the 'itinerary' array.", data);
                        showError("AIËøîÂõûÁöÑÊï∞ÊçÆÊ†ºÂºè‰∏çÊ≠£Á°ÆÔºåÁº∫Â∞ë 'itinerary' Êï∞ÁªÑ„ÄÇ");
                        return;
                    }

                    const childView = document.getElementById('child-view-content');
                    const teenagerView = document.getElementById('teenager-view-content');
                    const parentView = document.getElementById('parent-view-content');

                    if (!childView || !teenagerView || !parentView) {
                        showError('Êâæ‰∏çÂà∞ÁâàÊú¨ÂÜÖÂÆπÂÆπÂô®');
                        return;
                    }

                    childView.innerHTML = '';
                    teenagerView.innerHTML = '';
                    parentView.innerHTML = '';

                    data.itinerary.forEach((locationData, index) => {
                        childView.innerHTML += renderChildVersion(locationData, index);
                        teenagerView.innerHTML += renderTeenagerVersion(locationData, index);
                        parentView.innerHTML += renderParentVersion(locationData, index);
                    });

                    setupVersionTabs();
                    inputContainer.style.display = 'none';
                    planOutput.style.display = 'block';
                    window.scrollTo(0, 0);
                }

                function setupVersionTabs() {
                    const tabs = document.querySelectorAll('.version-btn');
                    const contents = document.querySelectorAll('.version-content');

                    tabs.forEach(tab => {
                        tab.addEventListener('click', () => {
                            tabs.forEach(t => t.classList.remove('active'));
                            contents.forEach(c => c.classList.remove('active'));
                            tab.classList.add('active');
                            const version = tab.dataset.version;
                            document.getElementById(`${version}-view-content`).classList.add('active');
                        });
                    });
                }

                function renderChildVersion(locationData, index) {
                    const { day, locationName, estimatedTime, childVersion: cv } = locationData;
                    if (!cv) return '';

                    return `
                        <div class="location-page-container">
                            <h1 class="location-title-h1">üìç Á¨¨ ${index + 1} Á´ô: ${locationName}</h1>
                            <h2 class="location-title-h2">(Á¨¨ ${day} Â§© | È¢ÑËÆ°ÈúÄË¶Å: ${estimatedTime || '‰∏ÄÂ∞è‰ºöÂÑø'})</h2>

                            <div class="section-container">
                                <h3 class="section-title-h3"><span>üó∫Ô∏è</span> <input type="text" value="${cv.title || 'ÊàëÁöÑÂÜíÈô©‰ªªÂä°'}" class="editable-title" style="border: none; background: transparent; font-size: inherit; font-weight: inherit; color: inherit; width: auto; min-width: 200px;"></h3>
                                <ul class="mission-list">
                                    ${(cv.missions || []).map((m, i) => `<li class="mission-item">‚ñ° <textarea class="editable-mission" style="border: none; background: transparent; resize: none; width: 100%; font-size: inherit; font-family: inherit; color: inherit; overflow: hidden;" rows="1" oninput="this.style.height='auto'; this.style.height=this.scrollHeight+'px'">${m}</textarea></li>`).join('')}
                                </ul>
                            </div>

                            <div class="section-container">
                                <h3 class="section-title-h3"><span>üí°</span> Ë∂£Âë≥Â∞èÁü•ËØÜ</h3>
                                <div class="fun-fact-box">
                                    <textarea class="editable-funfact" style="border: none; background: transparent; resize: none; width: 100%; font-size: inherit; font-family: inherit; color: inherit; text-align: center; overflow: hidden;" rows="2" oninput="this.style.height='auto'; this.style.height=this.scrollHeight+'px'">${cv.funFact || 'ËøôÈáåËóèÁùÄ‰ªÄ‰πàÁßòÂØÜÂë¢Ôºü'}</textarea>
                                </div>
                            </div>

                            <div class="section-container">
                                <div class="creative-zone">
                                    <div class="creative-zone-header">üé® ÂÑøÁ´•Âàõ‰ΩúÂå∫</div>
                                    <div class="creative-prompt">${cv.creativePrompt || 'Âú®ËøôÈáåÁîª‰∏ã‰Ω†ÁúãÂà∞ÁöÑÊúÄÈÖ∑ÁöÑ‰∏úË•øÔºÅ'}</div>
                                    <div class="drawing-area">
                                        <canvas width="400" height="250"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }

                function renderTeenagerVersion(locationData, index) {
                    const { day, locationName, estimatedTime, teenagerVersion: tv } = locationData;
                    if (!tv) return '';

                    const isValidColor = (str) => {
                        if (!str) return false;
                        const s = new Option().style;
                        s.color = str.toLowerCase();
                        return s.color !== '';
                    };

                    return `
                        <div class="location-page-container">
                            <h1 class="location-title-h1">#${index + 1} ${locationName}</h1>
                            <h2 class="location-title-h2">Day ${day} | Est. ${estimatedTime || 'N/A'}</h2>

                            <div class="section-container">
                                <h3 class="section-title-h3"><span>üéØ</span> <input type="text" value="${tv.title || 'My Challenges'}" class="editable-title" style="border: none; background: transparent; font-size: inherit; font-weight: inherit; color: inherit; width: auto; min-width: 200px;"></h3>
                                ${(tv.challenges || []).map(c => `<p class="teen-mission-item">/ / <textarea class="editable-challenge" style="border: none; background: transparent; resize: none; width: calc(100% - 30px); font-size: inherit; font-family: inherit; color: inherit; overflow: hidden; display: inline;" rows="1" oninput="this.style.height='auto'; this.style.height=this.scrollHeight+'px'">${c}</textarea></p>`).join('')}
                            </div>

                            <div class="section-container">
                                <h3 class="section-title-h3"><span>üß†</span> Knowledge+</h3>
                                <div class="knowledge-plus-box"><textarea class="editable-knowledge" style="border: none; background: transparent; resize: none; width: 100%; font-size: inherit; font-family: inherit; color: inherit; overflow: hidden;" rows="2" oninput="this.style.height='auto'; this.style.height=this.scrollHeight+'px'">${tv.knowledgePlus || 'Discover something new.'}</textarea></div>
                            </div>

                            <div class="section-container">
                                <h3 class="section-title-h3"><span>‚ú®</span> Inspiration Catcher</h3>
                                <div class="inspiration-grid">
                                    <div class="inspiration-item">
                                        <h4>Êó∂Èó¥‰∏é‰∫§ÈÄö</h4>
                                        <p>${tv.inspirationPrompts?.bgm || '...'}</p>
                                    </div>
                                    <div class="inspiration-item">
                                        <h4>Color Palette</h4>
                                        <div class="color-palette">
                                            ${(tv.inspirationPrompts?.colorPalette || []).map(color => {
                                                const bgColor = isValidColor(color) ? color : '#eee';
                                                return `<div class="color-swatch" title="${color}" style="background-color:${bgColor}; border: 1px solid #ddd;"></div>`;
                                            }).join('')}
                                        </div>
                                    </div>
                                    <div class="inspiration-item">
                                        <h4>Reflection</h4>
                                        <p>${tv.inspirationPrompts?.reflection || '...'}</p>
                                    </div>
                                </div>
                            </div>

                            <div class="section-container">
                                 <div class="free-space-zone">
                                     <div class="free-space-header">‚úçÔ∏è Free Space</div>
                                     <div class="drawing-area">
                                         <canvas width="400" height="250"></canvas>
                                     </div>
                                 </div>
                            </div>
                        </div>
                    `;
                }

                function renderParentVersion(locationData, index) {
                    const { day, locationName, estimatedTime, parentVersion: pv } = locationData;
                    if (!pv) return '';

                    return `
                        <div class="location-page-container">
                            <h1 class="location-title-h1">Á¨¨ ${index + 1} Á´ô: ${locationName}</h1>
                            <h2 class="location-title-h2">(Á¨¨ ${day} Â§© | ÂèÇËÄÉÁî®Êó∂: ${estimatedTime || 'ÁÅµÊ¥ªÂÆâÊéí'})</h2>

                            <div class="section-container">
                                <h3 class="section-title-h3"><span>üìã</span> <input type="text" value="${pv.title || 'ÂÆûÁî®‰ø°ÊÅØ'}" class="editable-title" style="border: none; background: transparent; font-size: inherit; font-weight: inherit; color: inherit; width: auto; min-width: 200px;"></h3>
                                <div class="practical-info-box">
                                    <ul>
                                        <li><strong>Âª∫ËÆÆÊó∂Èó¥:</strong> <input type="text" value="${pv.practicalInfo?.timing || 'ÁÅµÊ¥ªÂÆâÊéí'}" class="editable-info" style="border: none; background: transparent; font-size: inherit; font-family: inherit; color: inherit; width: auto; min-width: 150px;"></li>
                                        <li><strong>‰∫§ÈÄöÂª∫ËÆÆ:</strong> <input type="text" value="${pv.practicalInfo?.transport || 'Ê†πÊçÆÂÆûÈôÖÊÉÖÂÜµÈÄâÊã©'}" class="editable-info" style="border: none; background: transparent; font-size: inherit; font-family: inherit; color: inherit; width: auto; min-width: 200px;"></li>
                                        <li><strong>ÈáçË¶ÅÊèêÁ§∫:</strong> <input type="text" value="${pv.practicalInfo?.tips || 'Êó†'}" class="editable-info" style="border: none; background: transparent; font-size: inherit; font-family: inherit; color: inherit; width: auto; min-width: 150px;"></li>
                                    </ul>
                                </div>
                            </div>

                            <div class="section-container">
                                <h3 class="section-title-h3"><span>üéôÔ∏è</span> ÊïÖ‰∫ãÂÆùÂ∫ì</h3>
                                ${(pv.storytellingToolkit || []).map(s => `
                                    <div class="storytelling-item">
                                        <h4><input type="text" value="${s.topic}" class="editable-topic" style="border: none; background: transparent; font-size: inherit; font-weight: inherit; color: inherit; width: 100%;"></h4>
                                        <textarea class="editable-story" style="border: none; background: transparent; resize: none; width: 100%; font-size: inherit; font-family: inherit; color: inherit; overflow: hidden;" rows="3" oninput="this.style.height='auto'; this.style.height=this.scrollHeight+'px'">${s.story}</textarea>
                                    </div>
                                `).join('')}
                            </div>

                            <div class="section-container">
                                <h3 class="section-title-h3"><span>ü§ù</span> ‰∫íÂä®ÊåáÂçó</h3>
                                 ${(pv.engagementGuide || []).map(e => `
                                    <div class="engagement-item">
                                        <p>üí° <textarea class="editable-prompt" style="border: none; background: transparent; resize: none; width: calc(100% - 30px); font-size: inherit; font-family: inherit; color: inherit; overflow: hidden; display: inline;" rows="1" oninput="this.style.height='auto'; this.style.height=this.scrollHeight+'px'">${e.prompt}</textarea></p>
                                    </div>
                                `).join('')}
                            </div>

                            <div class="section-container">
                                <h3 class="section-title-h3"><span>üìî</span> ‰ªäÊó•ÊâãËÆ∞</h3>
                                <div class="journal-space">
                                    <textarea class="editable-journal" style="border: none; background: transparent; resize: none; width: 100%; font-size: inherit; font-family: inherit; color: inherit; overflow: hidden; min-height: 100px;" rows="4" oninput="this.style.height='auto'; this.style.height=this.scrollHeight+'px'">${pv.journalPrompt || 'ËÆ∞ÂΩï‰∏ãÂú®ËøôÈáåÁöÑÁæéÂ•ΩÁû¨Èó¥...'}</textarea>
                                </div>
                            </div>
                        </div>
                    `;
                }

                function generateTravelPlanHTML(tripPlan, destination, familyMembers, tripDuration) {
                    const familyNames = familyMembers.map(m => m.name).join('„ÄÅ') || 'Êàë‰ª¨';

                    let html = `
                        <div class="travel-plan-container">
                            <div class="plan-header">
                                <h1>üåü ${destination} ÊóÖË°åËÆ°Âàí</h1>
                                <div class="plan-info">
                                    <p><strong>ÁõÆÁöÑÂú∞:</strong> ${destination}</p>
                                    <p><strong>ÊóÖË°åÂ§©Êï∞:</strong> ${tripDuration}Â§©</p>
                                    <p><strong>ÊóÖË°åÊàêÂëò:</strong> ${familyNames}</p>
                                </div>
                            </div>

                            <div class="plan-content">
                    `;

                    // ÁîüÊàêÊØèÊó•Ë°åÁ®ã
                    tripPlan.forEach(dayData => {
                        html += `
                            <div class="day-plan">
                                <h2>Á¨¨${dayData.day}Â§©: ${dayData.theme || dayData.parentVersion?.title || dayData.childVersion?.title || ''}</h2>

                                <div class="day-sections">
                                    <!-- ÂÆ∂ÈïøÁâàÊú¨ -->
                                    <div class="parent-section">
                                        <h3>üë®‚Äçüë©‚Äçüëß‚Äçüë¶ ÂÆ∂ÈïøÁâà</h3>
                                        <h4>${dayData.parentVersion?.title || ''}</h4>

                                        ${dayData.parentVersion?.activities ? `
                                            <div class="activities">
                                                <h5>üóìÔ∏è Ê¥ªÂä®ÂÆâÊéí</h5>
                                                <ul>
                                                    ${dayData.parentVersion.activities.map(activity => `<li>${activity}</li>`).join('')}
                                                </ul>
                                            </div>
                                        ` : ''}

                                        ${dayData.parentVersion?.tips ? `
                                            <div class="tips">
                                                <h5>üí° Ë¥¥Â£´</h5>
                                                <ul>
                                                    ${dayData.parentVersion.tips.map(tip => `<li>${tip}</li>`).join('')}
                                                </ul>
                                            </div>
                                        ` : ''}
                                    </div>

                                    <!-- ÂÑøÁ´•ÁâàÊú¨ -->
                                    <div class="child-section">
                                        <h3>üë∂ ÂÑøÁ´•Áâà</h3>
                                        <h4>${dayData.childVersion?.title || ''}</h4>

                                        ${dayData.childVersion?.activities ? `
                                            <div class="activities">
                                                <h5>üéà ‰ªäÂ§©Áé©‰ªÄ‰πà</h5>
                                                <ul>${(dayData.childVersion.itinerary || []).map(i => `<li>${i}</li>`).join('')}</ul>
                                            </div>
                                        ` : ''}

                                        ${dayData.childVersion?.funFacts ? `
                                            <div class="fun-facts">
                                                <h5>ü§î ÊúâË∂£ÁöÑÁü•ËØÜ</h5>
                                                <ul>${(dayData.childVersion.funFacts || []).map(fact => `<li>${fact}</li>`).join('')}</ul>
                                            </div>
                                        ` : ''}
                                    </div>
                                </div>
                            </div>
                        `;
                    });

                    html += `
                            </div>
                        </div>
                    `;

                    return html;
                }

                function renderNotebook(type, tripPlan, destination, familyMembers, tripDuration) {
                    const notebookContent = document.getElementById(`${type}-notebook-content`);
                    const notebookTabs = document.getElementById(`${type}-notebook-tabs`);
                    notebookContent.innerHTML = '';
                    notebookTabs.innerHTML = '';

                    // Create static pages
                    const coverPage = createPage(`${type}-cover`, 'Â∞ÅÈù¢');
                    const itineraryPage = createPage(`${type}-itinerary`, 'ÊÄªËßà');
                    const checklistPage = createPage(`${type}-checklist`, 'Ë°åÊùé');
                    const safetyPage = createPage(`${type}-safety`, 'ÂÆâÂÖ®');

                    // Add static pages to content
                    notebookContent.appendChild(coverPage);
                    notebookContent.appendChild(itineraryPage);
                    notebookContent.appendChild(checklistPage);

                    // Generate content for static pages
                    generateCoverPage(coverPage.querySelector('.page-content'), destination, familyMembers, tripDuration, type);
                    generateChecklistPage(checklistPage.querySelector('.page-content'), familyMembers, type);
                    generateSafetyPage(safetyPage.querySelector('.page-content'), destination);

                    // Generate dynamic detail pages
                    if (type === 'children') {
                        generateSimpleItineraryForChild(itineraryPage.querySelector('.page-content'), tripPlan);
                        generateChildDetailPages(tripPlan, notebookContent);
                    } else {
                        generateSimpleItineraryForParent(itineraryPage.querySelector('.page-content'), tripPlan);
                        generateParentDetailPages(tripPlan, notebookContent);
                    }
                    
                    notebookContent.appendChild(safetyPage);

                    // Update tabs
                    updateNotebookTabs(type, tripPlan.length);

                    // Set initial active tab
                    setActiveTab(notebookTabs.querySelector('.tab-item'));
                }

                function createPage(id, label) {
                    const page = document.createElement('div');
                    page.className = 'notebook-page';
                    page.id = `page-${id}`;
                    page.innerHTML = `<div class="page-content"></div>`;
                    return page;
                }

                function generateCoverPage(container, destination, familyMembers, duration, type) {
                    const familyNames = familyMembers.map(m => m.name).join('„ÄÅ') || 'Êàë‰ª¨';
                    const title = type === 'children' ? 'ÊàëÁöÑ‰∏ìÂ±ûÊóÖË°åÊó•ËÆ∞' : `${destination} ÂÆ∂Â∫≠ÊóÖË°åËÆ°Âàí`;
                    container.innerHTML = `
                        <div class="cover-page">
                            <h1>${title}</h1>
                            <img src="images/7633aa7e-33aa-4ada-b715-ef314f196859.png" alt="Travel Illustration" class="cover-image">
                            <div class="cover-info">
                                <p><strong>ÁõÆÁöÑÂú∞:</strong> ${destination}</p>
                                <p><strong>ÊóÖË°åÂÆ∂:</strong> ${familyNames}</p>
                                <p><strong>Êó∂Èïø:</strong> ${duration} Â§©</p>
                            </div>
                            <div class="cover-footer">${new Date().getFullYear()}</div>
                        </div>
                    `;
                }

                function generateSimpleItineraryForChild(container, tripPlan) {
                    let itineraryHTML = `<h2>üé® Ë°åÁ®ã‰∫ÆÁÇπ</h2>`;
                    tripPlan.forEach(dayData => {
                        itineraryHTML += `
                            <div class="day-summary">
                                <h3>Á¨¨${dayData.day}Â§©: ${dayData.theme}</h3>
                                <p>${dayData.childVersion.title}</p>
                                <ul>
                                    ${(dayData.childVersion.itinerary || []).map(item => `<li>${item}</li>`).join('')}
                                </ul>
                            </div>
                        `;
                    });
                    container.innerHTML = itineraryHTML;
                }

                function generateSimpleItineraryForParent(container, tripPlan) {
                    let itineraryHTML = `<h2>üìã Ë°åÁ®ãÊÄªËßà</h2>`;
                    tripPlan.forEach(dayData => {
                        itineraryHTML += `
                            <div class="day-summary">
                                <h3>Á¨¨${dayData.day}Â§©: ${dayData.theme}</h3>
                                <p>${dayData.parentVersion.title}</p>
                                <ul>
                                    ${(dayData.parentVersion.itinerary || []).map(item => `<li>${item}</li>`).join('')}
                                </ul>
                            </div>
                        `;
                    });
                    container.innerHTML = itineraryHTML;
                }

                function generateChecklistPage(container, familyMembers, type) {
                    let checklistHTML = `<h2>üéí Ë°åÊùéÂ§áÂøòÂΩï</h2>`;
                    const categories = {
                        'ÈÄöÁî®Áâ©ÂìÅ': ['ËØÅ‰ª∂', 'Áé∞Èáë/‰ø°Áî®Âç°', 'ÊâãÊú∫/ÂÖÖÁîµÂô®', 'Â∏∏Áî®ËçØÂìÅ', 'Èõ®ÂÖ∑'],
                        'Ë°£Áâ©': ['ÂÜÖÂ§ñË°£Áâ©', 'Áù°Ë°£', 'Â§áÁî®ÈûãË¢ú'],
                        'Ê¥óÊº±Áî®ÂìÅ': ['ÁâôÂà∑ÁâôËÜè', 'ÊØõÂ∑æ', 'Èò≤ÊôíÈúú']
                    };
                    if (type === 'children') {
                        categories['ÊàëÁöÑ‰∏ìÂ±û'] = ['ÂñúÁà±Áé©ÂÖ∑', 'Èõ∂È£ü/Ê∞¥Â£∂', 'ÊïÖ‰∫ã‰π¶/ÁîªÊùø'];
                    }
                    for (const category in categories) {
                        checklistHTML += `
                            <div class="checklist-section">
                                <h3>${category}</h3>
                                ${categories[category].map(item => `
                                    <div class="checklist-item">
                                        <input type="checkbox" id="check-${type}-${item.replace(/\s|\//g, '')}">
                                        <label for="check-${type}-${item.replace(/\s|\//g, '')}">${item}</label>
                                    </div>
                                `).join('')}
                            </div>
                        `;
                    }
                    container.innerHTML = checklistHTML;
                }

                function generateChildDetailPages(tripPlan, container) {
                    tripPlan.forEach(dayData => {
                        const page = createPage(`children-detail-${dayData.day}`, `Á¨¨${dayData.day}Â§©`);
                        const content = page.querySelector('.page-content');
                        content.innerHTML = `
                            <h2>Á¨¨${dayData.day}Â§©: ${dayData.childVersion.title}</h2>
                            <div class="info-section">
                                <h4>üéà ‰ªäÂ§©Áé©‰ªÄ‰πà?</h4>
                                <ul>${(dayData.childVersion.itinerary || []).map(i => `<li>${i}</li>`).join('')}</ul>
                            </div>
                            <div class="info-section">
                                <h4>üé® Ê∂ÇÈ∏¶ÂíåË¥¥Á∫∏Âå∫</h4>
                                <div class="drawing-area">
                                    <p>Âú®ËøôÈáåÁîª‰∏ã‰ªäÂ§©ÊúÄÂºÄÂøÉÁöÑ‰∫ãÂêßÔºÅ</p>
                                </div>
                            </div>
                        `;
                        container.appendChild(page);
                    });
                }

                function generateParentDetailPages(tripPlan, container) {
                    tripPlan.forEach(dayData => {
                        const page = createPage(`parent-detail-${dayData.day}`, `Á¨¨${dayData.day}Â§©`);
                        const content = page.querySelector('.page-content');
                        content.innerHTML = `
                            <h2>Á¨¨${dayData.day}Â§©: ${dayData.parentVersion.title}</h2>
                             <div class="info-section">
                                <h4>üóìÔ∏è ËØ¶ÁªÜË°åÁ®ã</h4>
                                <ul>${(dayData.parentVersion.itinerary || []).map(i => `<li>${i}</li>`).join('')}</ul>
                            </div>
                            <div class="info-section">
                                <h4><span>üí°</span> ÂÆûÁî®Ë¥¥Â£´</h4>
                                <p>${dayData.parentVersion.tips || 'ÊöÇÊó†'}</p>
                            </div>
                        `;
                        container.appendChild(page);
                    });
                }

                function generateSafetyPage(container, destination) {
                    const isInternational = isInternationalDestination(destination);
                    let safetyHTML = '<h2>üö® ÂÆâÂÖ®È°ªÁü•</h2>';
                    safetyHTML += `
                        <div class="emergency-contact">
                            <h4>üöë Á¥ßÊÄ•ËÅîÁªú</h4>
                            <div class="contact-number">Êä•Ë≠¶Ôºö110</div>
                            <div class="contact-number">ÁÅ´Ë≠¶Ôºö119</div>
                            <div class="contact-number">ÂåªÁñóÊÄ•ÊïëÔºö120</div>
                        </div>
                    `;
                    if (isInternational) {
                        safetyHTML += `
                            <div class="emergency-contact">
                                <h4>üèõÔ∏è ‰∏≠ÂõΩÈ¢Ü‰∫ãÈ¶Ü</h4>
                                <p>Â§ñ‰∫§ÈÉ®ÂÖ®ÁêÉÈ¢Ü‰∫ã‰øùÊä§ÁÉ≠Á∫øÔºö+86-10-12308</p>
                            </div>
                        `;
                    }
                    safetyHTML += `
                        <div class="info-section">
                            <h4>‚ö†Ô∏è ÂÆâÂÖ®ÊèêÈÜí</h4>
                            <ul>
                                <li>‰øùÁÆ°Â•ΩÈáçË¶ÅËØÅ‰ª∂ÔºåÂª∫ËÆÆÊãçÁÖßÂ§á‰ªΩ</li>
                                <li>ÂëäÁü•ÂÆ∂‰∫∫ËØ¶ÁªÜË°åÁ®ãÂíåËÅîÁªúÊñπÂºè</li>
                                <li>ÁúãÂ•ΩÂÑøÁ´•ÔºåÈÅøÂÖçËµ∞Â§±</li>
                            </ul>
                        </div>
                    `;
                    container.innerHTML = safetyHTML;
                }

                function isInternationalDestination(destination) {
                    const domesticKeywords = ['‰∏≠ÂõΩ', 'Âåó‰∫¨', '‰∏äÊµ∑', 'ÂπøÂ∑û', 'Ê∑±Âú≥', 'Êù≠Â∑û', 'Âçó‰∫¨', 'ÊàêÈÉΩ', 'ÈáçÂ∫Ü', 'Ë•øÂÆâ', 'Ê≠¶Ê±â', 'È¶ôÊ∏Ø', 'Êæ≥Èó®', 'Âè∞Âåó'];
                    return !domesticKeywords.some(keyword => destination.includes(keyword));
                }

                function updateNotebookTabs(type, dayCount) {
                    const tabsContainer = document.getElementById(`${type}-notebook-tabs`);
                    tabsContainer.innerHTML = '';

                    const pages = [
                        { id: `${type}-cover`, label: 'Â∞ÅÈù¢' },
                        { id: `${type}-itinerary`, label: 'ÊÄªËßà' },
                        { id: `${type}-checklist`, label: 'Ë°åÊùé' },
                    ];

                    for (let i = 1; i <= dayCount; i++) {
                        pages.push({ id: `${type}-detail-${i}`, label: `Á¨¨${i}Â§©` });
                    }

                    pages.push({ id: `${type}-safety`, label: 'ÂÆâÂÖ®' });

                    pages.forEach((page, index) => {
                        const tabItem = document.createElement('div');
                        tabItem.className = 'tab-item';
                        tabItem.dataset.page = `page-${page.id}`;
                        tabItem.innerHTML = `<span class="tab-label">${page.label}</span>`;
                        tabItem.addEventListener('click', () => setActiveTab(tabItem));
                        tabsContainer.appendChild(tabItem);
                    });
                }

                function setActiveTab(tab) {
                    if (!tab) return;
                    const notebook = tab.closest('.travel-notebook');
                    const targetPageId = tab.dataset.page;

                    // Deactivate all tabs in this notebook
                    notebook.querySelectorAll('.tab-item').forEach(t => t.classList.remove('active'));
                    // Hide all pages in this notebook
                    notebook.querySelectorAll('.notebook-page').forEach(p => p.style.display = 'none');

                    // Activate the clicked tab and show the corresponding page
                    tab.classList.add('active');
                    const targetPage = notebook.querySelector(`#${targetPageId}`);
                    if (targetPage) {
                        targetPage.style.display = 'block';
                    }
                }

    </script>
<script>
    function initializeInteractiveElements() {
        const canvases = document.querySelectorAll('.drawing-area canvas');
        canvases.forEach(canvas => {
            const ctx = canvas.getContext('2d');
            ctx.strokeStyle = '#000';
            ctx.lineWidth = 3;
            ctx.lineCap = 'round';

            let isDrawing = false;
            let lastX = 0;
            let lastY = 0;

            function draw(e) {
                if (!isDrawing) return;
                const rect = canvas.getBoundingClientRect();
                const x = e.offsetX || e.touches[0].clientX - rect.left;
                const y = e.offsetY || e.touches[0].clientY - rect.top;

                ctx.beginPath();
                ctx.moveTo(lastX, lastY);
                ctx.lineTo(x, y);
                ctx.stroke();
                [lastX, lastY] = [x, y];
            }

            canvas.addEventListener('mousedown', (e) => {
                isDrawing = true;
                const rect = canvas.getBoundingClientRect();
                [lastX, lastY] = [e.offsetX, e.offsetY];
            });
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', () => isDrawing = false);
            canvas.addEventListener('mouseout', () => isDrawing = false);

            // Touch events
            canvas.addEventListener('touchstart', (e) => {
                if (e.touches.length === 1) {
                    e.preventDefault();
                    isDrawing = true;
                    const rect = canvas.getBoundingClientRect();
                    [lastX, lastY] = [e.touches[0].clientX - rect.left, e.touches[0].clientY - rect.top];
                }
            });
            canvas.addEventListener('touchmove', (e) => {
                 if (e.touches.length === 1) {
                    e.preventDefault();
                    draw(e);
                 }
            });
            canvas.addEventListener('touchend', () => isDrawing = false);
        });

        const stickers = document.querySelectorAll('.sticker');
        stickers.forEach(sticker => {
            sticker.addEventListener('dragstart', (e) => {
                e.dataTransfer.setData('text/plain', e.target.src);
            });
        });

        canvases.forEach(canvas => {
            canvas.addEventListener('dragover', (e) => {
                e.preventDefault();
            });

            canvas.addEventListener('drop', (e) => {
                e.preventDefault();
                const imgSrc = e.dataTransfer.getData('text/plain');
                const img = new Image();
                img.src = imgSrc;
                img.onload = () => {
                    const rect = canvas.getBoundingClientRect();
                    const x = e.clientX - rect.left - 25; // Center the sticker
                    const y = e.clientY - rect.top - 25;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, x, y, 50, 50);
                };
            });
        });
    }



</script>
</body>
</html>
