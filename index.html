<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äº²å­æ—…æ¸¸æ‰‹å¸AIå°åŠ©æ‰‹ V5.1 - ç»ˆæå®Œæ•´ç‰ˆ</title>
    <style>
     /* CSSæ ·å¼ - 100%å®Œæ•´ */
@import url('https://fonts.googleapis.com/css2?family=ZCOOL+XiaoWei&family=Noto+Sans+SC:wght@400;700&display=swap');
body {
    font-family: 'Noto Sans SC', sans-serif;
    background: linear-gradient(135deg, #E3F2FD 0%, #F3E5F5 50%, #FFF3E0 100%);
    color: #2E3A59;
    margin: 0;
    padding: 20px;
    display: flex;
    flex-direction: column;
    align-items: center;
    min-height: 100vh;
}
.container {
    width: 100%;
    max-width: 800px;
    background: rgba(255, 255, 255, 0.95);
    border-radius: 25px;
    box-shadow: 0 15px 35px rgba(46, 58, 89, 0.15);
    padding: 30px;
    box-sizing: border-box;
    margin-bottom: 20px;
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.2);
}
header { 
    text-align: center; 
    margin-bottom: 30px; 
    border-bottom: 3px dashed #FFCC80; 
    padding-bottom: 20px; 
}
header h1 {
    font-family: 'ZCOOL+XiaoWei', serif;
    font-size: 2.8em;
    color: #5C6BC0;
    margin: 0;
    text-shadow: 2px 2px 4px rgba(92, 107, 192, 0.3);
}
header p { 
    font-size: 1.1em; 
    color: #795548; 
}
.form-block {
    background: linear-gradient(135deg, #F8F9FF 0%, #F3E5F5 100%);
    border-radius: 20px;
    padding: 25px;
    margin-bottom: 25px;
    border: 1px solid rgba(92, 107, 192, 0.1);
    position: relative;
    overflow: hidden;
}

.form-block::before {
    content: '';
    position: absolute;
    top: -50%;
    right: -20px;
    width: 100px;
    height: 100px;
    background: url('images/afbcfbd3-addf-4e32-a3ab-6e2bca0a2ebd.jpeg') no-repeat center;
    background-size: contain;
    opacity: 0.05;
    transform: rotate(15deg);
}
.form-block h3 {
    font-family: 'ZCOOL XiaoWei', serif;
    font-size: 1.5em;
    color: #5C6BC0;
    margin-top: 0;
    display: flex;
    align-items: center;
    position: relative;
    z-index: 2;
    cursor: pointer;
    user-select: none;
    transition: all 0.3s ease;
    padding: 10px;
    border-radius: 10px;
    margin: -10px -10px 15px -10px;
}
.form-block h3:hover {
    background-color: rgba(92, 107, 192, 0.1);
    transform: translateY(-2px);
}
.form-block h3 span {
    font-size: 1.8em;
    margin-right: 10px;
}
.form-block h3::after {
    content: 'â–¼';
    margin-left: auto;
    font-size: 0.8em;
    transition: transform 0.3s ease;
    color: #5C6BC0;
}
.form-block.collapsed h3::after {
    transform: rotate(-90deg);
}
.form-block-content {
    transition: all 0.3s ease;
    overflow: hidden;
}
.form-block.collapsed .form-block-content {
    max-height: 0;
    opacity: 0;
    margin-top: 0;
    padding-top: 0;
}
.input-group { 
    display: flex; 
    flex-direction: column; 
    flex-grow: 1; 
    gap: 5px; 
}
.input-label, label { 
    font-weight: 700; 
    margin-bottom: 5px; 
    display: block; 
}
input[type="text"], input[type="number"], input[type="password"], input[type="date"], select, textarea {
    padding: 12px;
    border: 2px solid #B39DDB;
    border-radius: 12px;
    font-size: 1em;
    background-color: rgba(255, 255, 255, 0.9);
    width: 100%;
    box-sizing: border-box;
    font-family: 'Noto Sans SC', 'Microsoft YaHei', sans-serif;
    transition: all 0.3s ease;
}

input:focus, select:focus, textarea:focus {
    border-color: #5C6BC0;
    box-shadow: 0 0 0 3px rgba(92, 107, 192, 0.1);
    outline: none;
}
textarea {
    resize: vertical;
    min-height: 80px;
}

/* å¯ç¼–è¾‘å…ƒç´ æ ·å¼ */
.editable-title, .editable-mission, .editable-funfact, .editable-challenge,
.editable-knowledge, .editable-info, .editable-topic, .editable-story,
.editable-prompt, .editable-journal {
    transition: all 0.3s ease;
}

.editable-title:focus, .editable-mission:focus, .editable-funfact:focus,
.editable-challenge:focus, .editable-knowledge:focus, .editable-info:focus,
.editable-topic:focus, .editable-story:focus, .editable-prompt:focus,
.editable-journal:focus {
    background-color: rgba(92, 107, 192, 0.1) !important;
    border: 1px solid #5C6BC0 !important;
    border-radius: 4px;
    padding: 4px 8px;
    outline: none;
    box-shadow: 0 0 0 2px rgba(92, 107, 192, 0.2);
}

.editable-title:hover, .editable-mission:hover, .editable-funfact:hover,
.editable-challenge:hover, .editable-knowledge:hover, .editable-info:hover,
.editable-topic:hover, .editable-story:hover, .editable-prompt:hover,
.editable-journal:hover {
    background-color: rgba(92, 107, 192, 0.05) !important;
    cursor: text;
}
.api-key-row { 
    display: flex; 
    gap: 10px; 
    align-items: center; 
}
.fetch-btn, .clear-btn {
    padding: 12px 18px;
    background: linear-gradient(135deg, #7986CB, #5C6BC0);
    color: white;
    border: none;
    border-radius: 12px;
    cursor: pointer;
    font-weight: bold;
    transition: all 0.3s ease;
    box-shadow: 0 4px 12px rgba(92, 107, 192, 0.3);
}

.fetch-btn:hover, .clear-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(92, 107, 192, 0.4);
}
.clear-btn {
    background-color: #E0E0E0;
    color: #757575;
    font-size: 0.8em;
    padding: 5px 10px;
}
#custom-endpoint-group {
    margin-top: 15px;
}
.search-status {
    font-size: 0.9em;
    color: #4CAF50;
    margin-top: 5px;
}
.gemini-search-highlight {
    background: linear-gradient(135deg, #E8F5E9, #F1F8E9);
    border: 1px solid #4CAF50;
    border-radius: 8px;
    padding: 8px;
    margin-top: 5px;
}
.search-feature-badge {
    display: inline-block;
    background: #4CAF50;
    color: white;
    font-size: 0.7em;
    padding: 2px 6px;
    border-radius: 10px;
    margin-left: 5px;
}
#api-status { 
    font-size: 0.9em; 
    color: #4CAF50; 
    min-height: 1.2em; 
}
.icon-options { 
    display: flex; 
    gap: 10px; 
    flex-wrap: wrap; 
}
.icon-options label { 
    display: flex; 
    flex-direction: column; 
    align-items: center; 
    cursor: pointer; 
    padding: 10px; 
    border-radius: 10px; 
    transition: all 0.2s; 
    border: 2px solid transparent; 
}
.icon-options input[type="radio"], .icon-options input[type="checkbox"] { 
    display: none; 
}
.icon-options .icon { 
    font-size: 2.5em; 
}
.icon-options span { 
    margin-top: 5px; 
    font-weight: bold; 
    font-size: 0.9em; 
}
.icon-options .content { 
    display: flex; 
    flex-direction: column; 
    align-items: center; 
    transition: transform 0.2s; 
}
.icon-options input:checked + .content {
    transform: scale(1.1);
    color: #FF7043;
}
.icon-options label.selected {
    background-color: #FFECB3;
    border-color: #FFCC80;
}
.dynamic-list .list-item { 
    display: flex; 
    align-items: center; 
    gap: 10px; 
    background: #fff; 
    padding: 8px 10px; 
    border-radius: 8px; 
    margin-bottom: 10px; 
}
.dynamic-list input { 
    border: none; 
    background: transparent; 
    flex-grow: 1; 
}
#multi-city-container .list-item input { 
    border-bottom: 1px solid #ddd; 
}
.add-btn, .remove-btn { 
    background-color: #FFAB91; 
    color: white; 
    border: none; 
    border-radius: 50%; 
    width: 28px; 
    height: 28px; 
    font-size: 1.5em; 
    cursor: pointer; 
    display: flex; 
    align-items: center; 
    justify-content: center; 
    flex-shrink: 0; 
    line-height: 1; 
}
.remove-btn { 
    background-color: #E0E0E0; 
    color: #757575; 
}
.submit-btn { 
    width: 100%; 
    padding: 15px; 
    font-family: 'ZCOOL XiaoWei', serif; 
    font-size: 1.8em; 
    background-color: #FF7043; 
    color: white; 
    border: none; 
    border-radius: 15px; 
    cursor: pointer; 
}
.submit-btn:disabled, .fetch-btn:disabled { 
    background-color: #BDBDBD; 
    cursor: not-allowed; 
}
.plan-section, #loading-indicator {
    display: none;
}
.action-buttons {
    display: flex;
    gap: 15px;
    justify-content: center;
    margin-top: 30px;
    padding: 20px;
}
.print-btn, .new-plan-btn {
    padding: 12px 24px;
    border: none;
    border-radius: 10px;
    font-family: 'ZCOOL XiaoWei', serif;
    font-size: 1.1em;
    cursor: pointer;
    transition: all 0.3s ease;
}
.print-btn {
    background-color: #4CAF50;
    color: white;
}
.print-btn:hover {
    background-color: #45a049;
}
.new-plan-btn {
    background-color: #2196F3;
    color: white;
}
.new-plan-btn:hover {
    background-color: #1976D2;
}
.tab-controls { 
    display: flex; 
    gap: 10px; 
    margin-bottom: -2px; 
}
.tab-btn { 
    padding: 10px 20px; 
    font-family: 'ZCOOL XiaoWei', serif; 
    font-size: 1.3em; 
    border: 2px solid #FFAB91; 
    border-bottom: none; 
    background: #FFF3E0; 
    border-radius: 10px 10px 0 0; 
    cursor: pointer; 
}
.tab-btn.active { 
    background: #fff; 
    color: #FF7043; 
    border-bottom: 2px solid #fff; 
}
.tab-content { 
    display: none; 
}
.tab-content.active { 
    display: block; 
}
.day-page { 
    background: #fff; 
    border: 2px solid #FFAB91; 
    border-radius: 0 15px 15px 15px; 
    padding: 30px; 
    margin-bottom: 20px; 
}
.day-header h2 { 
    font-family: 'ZCOOL XiaoWei', serif; 
    font-size: 2em; 
    color: #FF7043; 
    margin: 0; 
}
.itinerary-item ul { 
    padding-left: 20px; 
    margin: 0; 
    list-style-type: 'ğŸ–ï¸ '; 
}
.itinerary-item li { 
    margin-bottom: 10px; 
}
.parent-tip { 
    background-color: #E8F5E9; 
    border-left: 4px solid #4CAF50; 
    padding: 10px; 
    margin-top: 15px; 
    border-radius: 4px; 
    font-size: 0.9em; 
}
.doodle-area { 
    border: 2px dashed #BDBDBD; 
    border-radius: 10px; 
    padding: 20px; 
    margin-top: 30px; 
    text-align: center; 
    color: #BDBDBD; 
    min-height: 100px; 
}
.print-btn, .new-plan-btn { 
    width: 100%; 
    padding: 15px; 
    font-weight: bold; 
    font-size: 1.2em; 
    background-color: #4CAF50; 
    color: white; 
    border: none; 
    border-radius: 15px; 
    cursor: pointer; 
    margin-top: 10px; 
}
.new-plan-btn { 
    background-color: #FF9800; 
}
#loading-indicator {
    text-align: center;
    padding: 40px;
    font-size: 1.5em;
    color: #FF7043;
    font-family: 'ZCOOL XiaoWei', serif;
}

/* è®°äº‹æœ¬æ ·å¼ */
.travel-notebook {
    display: flex;
    background: #f8f8f8;
    border-radius: 15px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.15);
    overflow: hidden;
    min-height: 800px;
    position: relative;
}

.notebook-tabs {
    position: absolute;
    right: -15px;
    top: 50px;
    display: flex;
    flex-direction: column;
    gap: 5px;
    z-index: 10;
}

.tab-item {
    width: 35px;
    height: 60px;
    background: linear-gradient(135deg, #7986CB, #5C6BC0);
    border-radius: 8px 0 0 8px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s ease;
    color: white;
    font-size: 0.7em;
    font-weight: bold;
    box-shadow: -3px 3px 8px rgba(92, 107, 192, 0.3);
    position: relative;
}

.tab-item::before {
    content: '';
    position: absolute;
    left: -8px;
    top: 50%;
    transform: translateY(-50%);
    width: 0;
    height: 0;
    border-top: 8px solid transparent;
    border-bottom: 8px solid transparent;
    border-right: 8px solid #5C6BC0;
}

.tab-item:hover {
    transform: translateX(-5px);
    box-shadow: -5px 5px 12px rgba(92, 107, 192, 0.4);
}

.tab-item.active {
    background: linear-gradient(135deg, #AB47BC, #8E24AA);
    transform: translateX(-8px);
    box-shadow: -6px 6px 15px rgba(142, 36, 170, 0.4);
}

.tab-item.active::before {
    border-right-color: #8E24AA;
}

.tab-number {
    font-size: 0.9em;
    font-weight: bold;
    margin-bottom: 2px;
    line-height: 1;
}

.tab-label {
    font-size: 0.6em;
    text-align: center;
    line-height: 1;
    margin-bottom: 2px;
}

.tab-icon {
    font-size: 0.7em;
    opacity: 0.9;
    line-height: 1;
}

.notebook-content {
    width: 100%;
    background: white;
    position: relative;
    overflow: hidden;
    border-radius: 15px;
    box-shadow: 0 10px 25px rgba(46, 58, 89, 0.15);
}

.notebook-page {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    opacity: 0;
    transform: translateX(20px);
    transition: all 0.4s ease;
    display: none;
}

.notebook-page.active {
    opacity: 1;
    transform: translateX(0);
    display: block;
}

.page-content {
    padding: 40px;
    height: 100%;
    overflow-y: auto;
    background:
        linear-gradient(90deg, #5C6BC0 0px, #5C6BC0 2px, transparent 2px),
        repeating-linear-gradient(transparent, transparent 24px, #E8EAF6 24px, #E8EAF6 25px);
    background-size: 100% 100%, 100% 25px;
    background-position: 0 0, 0 40px;
    position: relative;
}

.page-content::after {
    content: '';
    position: absolute;
    bottom: 20px;
    right: 20px;
    width: 60px;
    height: 60px;
    background: url('images/afbcfbd3-addf-4e32-a3ab-6e2bca0a2ebd.jpeg') no-repeat center;
    background-size: cover;
    border-radius: 50%;
    opacity: 0.1;
    pointer-events: none;
}

.notebook-controls {
    display: flex;
    gap: 15px;
    justify-content: center;
    margin-top: 20px;
}

/* å°é¢é¡µæ ·å¼ */
.cover-page {
    text-align: center;
    display: flex;
    flex-direction: column;
    justify-content: center;
    background: linear-gradient(135deg, #E8EAF6 0%, #F3E5F5 50%, #E1F5FE 100%);
    position: relative;
    overflow: hidden;
}

.cover-page::before {
    content: '';
    position: absolute;
    top: 10%;
    left: 10%;
    width: 120px;
    height: 120px;
    background: url('images/afbcfbd3-addf-4e32-a3ab-6e2bca0a2ebd.jpeg') no-repeat center;
    background-size: cover;
    border-radius: 50%;
    opacity: 0.08;
    transform: rotate(-15deg);
}

.cover-page::after {
    content: '';
    position: absolute;
    bottom: 10%;
    right: 10%;
    width: 100px;
    height: 100px;
    background: url('images/afbcfbd3-addf-4e32-a3ab-6e2bca0a2ebd.jpeg') no-repeat center;
    background-size: cover;
    border-radius: 50%;
    opacity: 0.06;
    transform: rotate(25deg);
}

.cover-title {
    font-family: 'ZCOOL XiaoWei', serif;
    font-size: 3em;
    color: #5C6BC0;
    margin-bottom: 20px;
    text-shadow: 2px 2px 4px rgba(92, 107, 192, 0.3);
}

.cover-subtitle {
    font-size: 1.5em;
    color: #8D6E63;
    margin-bottom: 30px;
}

.cover-info {
    background: rgba(255,255,255,0.8);
    padding: 20px;
    border-radius: 15px;
    margin: 20px auto;
    max-width: 400px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}

/* è¡Œç¨‹é¡µæ ·å¼ */
.itinerary-page h2 {
    font-family: 'ZCOOL XiaoWei', serif;
    color: #5C6BC0;
    border-bottom: 3px solid #B39DDB;
    padding-bottom: 10px;
    margin-bottom: 20px;
}

.day-summary {
    background: #FFFDE7;
    border-left: 5px solid #FFCC80;
    padding: 15px;
    margin-bottom: 20px;
    border-radius: 0 10px 10px 0;
}

.day-summary h3 {
    color: #FF7043;
    margin: 0 0 10px 0;
    font-family: 'ZCOOL XiaoWei', serif;
}

/* æ¸…å•é¡µæ ·å¼ */
.checklist-page h2 {
    font-family: 'ZCOOL XiaoWei', serif;
    color: #FF7043;
    border-bottom: 3px solid #FFCC80;
    padding-bottom: 10px;
    margin-bottom: 20px;
}

.checklist-section {
    background: #FFFDE7;
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 20px;
}

.checklist-section h3 {
    color: #8D6E63;
    margin-bottom: 15px;
    font-family: 'ZCOOL XiaoWei', serif;
}

.checklist-item {
    display: flex;
    align-items: center;
    margin-bottom: 8px;
    padding: 5px 0;
}

.checklist-item input[type="checkbox"] {
    margin-right: 10px;
    transform: scale(1.2);
}

/* è¯¦æƒ…é¡µæ ·å¼ */
.detail-page h2 {
    font-family: 'ZCOOL XiaoWei', serif;
    color: #FF7043;
    border-bottom: 3px solid #FFCC80;
    padding-bottom: 10px;
    margin-bottom: 20px;
}

.location-info {
    background: #FFFDE7;
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 20px;
}

.info-section {
    margin-bottom: 20px;
}

.info-section h4 {
    color: #8D6E63;
    margin-bottom: 10px;
    font-family: 'ZCOOL XiaoWei', serif;
}

.drawing-area {
    border: 2px dashed #FFCC80;
    padding: 10px;
    border-radius: 10px;
    background: #FFFDE7;
    display: flex;
    gap: 10px;
    align-items: flex-start;
    flex-wrap: wrap;
}

.drawing-area canvas {
    border: 1px solid #ccc;
    cursor: crosshair;
    background-color: #fff;
    border-radius: 8px;
}

/* åˆ›ä½œåŒºæ ·å¼ä¼˜åŒ– */
.creative-zone {
    position: relative;
    border: 2px dashed #FFCC80;
    border-radius: 15px;
    background: #FFFDE7;
    padding: 15px;
    min-height: 300px;
}

.creative-zone-header {
    position: absolute;
    top: 8px;
    left: 15px;
    font-size: 0.9em;
    font-weight: bold;
    color: #FF8A65;
    background: #FFFDE7;
    padding: 2px 8px;
    border-radius: 4px;
    z-index: 10;
}

.creative-prompt {
    margin-top: 25px;
    margin-bottom: 15px;
    font-size: 0.95em;
    color: #8D6E63;
    text-align: center;
    font-style: italic;
}

.creative-zone .drawing-area {
    border: none;
    padding: 0;
    background: transparent;
    display: flex;
    justify-content: center;
    align-items: center;
}

/* Free SpaceåŒºåŸŸæ ·å¼ */
.free-space-zone {
    position: relative;
    border: 2px dashed #90CAF9;
    border-radius: 15px;
    background: #E3F2FD;
    padding: 15px;
    min-height: 300px;
}

.free-space-header {
    position: absolute;
    top: 8px;
    left: 15px;
    font-size: 0.9em;
    font-weight: bold;
    color: #5C6BC0;
    background: #E3F2FD;
    padding: 2px 8px;
    border-radius: 4px;
    z-index: 10;
}

.free-space-zone .drawing-area {
    border: none;
    padding: 0;
    background: transparent;
    display: flex;
    justify-content: center;
    align-items: center;
    margin-top: 20px;
}

.sticker-palette {
    display: flex;
    flex-direction: column;
    gap: 10px;
    padding: 10px;
    background: rgba(255, 255, 255, 0.5);
    border-radius: 10px;
}

.sticker-palette p {
    margin: 0 0 5px 0;
    font-size: 0.9em;
    color: #8D6E63;
    font-weight: bold;
}

.stickers {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
}

.sticker {
    width: 50px;
    height: 50px;
    cursor: grab;
    transition: transform 0.1s;
}

.sticker:active {
    cursor: grabbing;
    transform: scale(1.1);
}

/* å®‰å…¨é¡µæ ·å¼ */
.safety-page h2 {
    font-family: 'ZCOOL XiaoWei', serif;
    color: #F44336;
    border-bottom: 3px solid #FFCDD2;
    padding-bottom: 10px;
    margin-bottom: 20px;
}

.emergency-contact {
    background: #FFEBEE;
    border: 2px solid #FFCDD2;
    border-radius: 10px;
    padding: 15px;
    margin-bottom: 15px;
}

.emergency-contact h4 {
    color: #F44336;
    margin-bottom: 10px;
    font-family: 'ZCOOL XiaoWei', serif;
}

.contact-number {
    font-size: 1.2em;
    font-weight: bold;
    color: #D32F2F;
    background: white;
    padding: 5px 10px;
    border-radius: 5px;
    display: inline-block;
    margin: 5px 0;
}

/* å›¾ç‰‡ç›¸å…³æ ·å¼ */
.page-decoration {
    position: absolute;
    opacity: 0.1;
    pointer-events: none;
    z-index: 1;
}

.page-decoration.top-right {
    top: 20px;
    right: 20px;
    width: 80px;
    height: 80px;
}

.page-decoration.bottom-left {
    bottom: 20px;
    left: 20px;
    width: 60px;
    height: 60px;
}

.page-decoration.center {
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 100px;
    height: 100px;
    opacity: 0.05;
}

.illustration {
    max-width: 100%;
    height: auto;
    border-radius: 10px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    margin: 15px 0;
}

.cover-illustration {
    width: 120px;
    height: 120px;
    margin: 20px auto;
    border-radius: 50%;
    overflow: hidden;
    box-shadow: 0 10px 25px rgba(255,112,67,0.3);
}

.cover-illustration img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.section-icon {
    width: 40px;
    height: 40px;
    display: inline-block;
    vertical-align: middle;
    margin-right: 10px;
    filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.1));
}

/* å“åº”å¼å›¾ç‰‡å¤„ç† */
@media (max-width: 768px) {
    .cover-illustration {
        width: 80px;
        height: 80px;
    }

    .section-icon {
        width: 30px;
        height: 30px;
    }

    .page-decoration {
        display: none;
    }
}

/* å›¾ç‰‡åŠ è½½åŠ¨ç”» */
.illustration, .cover-illustration img, .section-icon {
    transition: all 0.3s ease;
}

.illustration:hover, .cover-illustration:hover {
    transform: scale(1.05);
}

/* å›¾ç‰‡åŠ è½½å¤±è´¥å¤„ç† */
img {
    max-width: 100%;
    height: auto;
}

img[alt]:after {
    content: attr(alt);
    display: block;
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: #f0f0f0;
    color: #666;
    font-size: 12px;
    text-align: center;
    line-height: 1.5;
    padding: 10px;
    box-sizing: border-box;
}

@media print {
    body {
        background-color: #fff;
        padding: 0;
        margin: 0;
    }
    .container, .input-section, .notebook-controls, header {
        display: none !important;
    }
    .plan-section {
        display: block !important;
        box-shadow: none;
        width: 100%;
        max-width: 100%;
        margin: 0;
    }
    .travel-notebook {
        box-shadow: none;
        border-radius: 0;
        min-height: auto;
    }
    .notebook-tabs {
        display: none !important;
    }
    .notebook-content {
        width: 100%;
    }
    .notebook-page {
        position: static !important;
        opacity: 1 !important;
        transform: none !important;
        display: block !important;
        page-break-after: always;
        height: auto;
        min-height: 100vh;
    }
    .notebook-page:last-child {
        page-break-after: avoid;
    }
    .page-content {
        padding: 20px;
        height: auto;
        min-height: calc(100vh - 40px);
        background: white;
        overflow: visible;
    }
    .cover-page {
        background: white !important;
    }
    .checklist-item input[type="checkbox"] {
        -webkit-appearance: checkbox;
        appearance: checkbox;
    }
    .contact-number {
        background: #f0f0f0 !important;
    }
}

/* ç‰ˆæœ¬åˆ‡æ¢æ ·å¼ */
.version-tabs {
    display: flex;
    justify-content: center;
    gap: 10px;
    margin-bottom: 30px;
    padding-bottom: 0;
    border-bottom: none;
}

.version-btn {
    padding: 12px 20px;
    font-size: 1em;
    font-weight: bold;
    border: 2px solid #E0E0E0;
    background-color: #f8f9fa;
    border-radius: 25px;
    cursor: pointer;
    transition: all 0.3s ease;
    color: #757575;
    position: relative;
    bottom: 0;
}

.version-btn.active {
    background-color: #5C6BC0;
    color: white;
    border-color: #5C6BC0;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(92, 107, 192, 0.3);
}

.version-btn:hover:not(.active) {
    background-color: #e9ecef;
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.version-content-wrapper {
    background: transparent;
    border: none;
    border-radius: 0;
    min-height: 400px;
    position: relative;
}

.version-content {
    display: none;
    padding: 0;
}

.version-content.active {
    display: block;
}

.notebook-controls {
    display: flex;
    justify-content: space-between;
    gap: 15px;
    margin-top: 20px;
}

/* åœ°ç‚¹é¡µé¢å®¹å™¨æ ·å¼ - ä»¿ç¬”è®°æœ¬è®¾è®¡ */
.location-page-container {
    margin-bottom: 40px;
    padding: 20px;
    border: 1px solid #eee;
    border-radius: 15px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    background: white;
}

.location-page-container:last-child {
    margin-bottom: 0;
}

.location-title-h1 {
    font-family: 'ZCOOL XiaoWei', serif;
    font-size: 2.5em;
    color: #5C6BC0;
    text-align: center;
    margin-bottom: 10px;
}

.location-title-h2 {
    font-size: 1.2em;
    color: #795548;
    text-align: center;
    margin-bottom: 30px;
    font-style: italic;
}

.section-container {
    margin-bottom: 25px;
}

.section-title-h3 {
    font-family: 'ZCOOL XiaoWei', serif;
    font-size: 1.6em;
    color: #FF7043;
    display: flex;
    align-items: center;
    gap: 10px;
    border-bottom: 2px solid #FFECB3;
    padding-bottom: 8px;
    margin-bottom: 15px;
}

.section-title-h3 span {
    font-size: 1.5em;
}

/* å„¿ç«¥ç‰ˆä¸“å±æ ·å¼ */
.mission-list {
    list-style-type: none;
    padding-left: 0;
}

.mission-item {
    background: #FFFDE7;
    border-left: 5px solid #FFCC80;
    padding: 15px;
    margin-bottom: 10px;
    border-radius: 0 8px 8px 0;
    font-size: 1.1em;
}

.fun-fact-box {
    background: #E3F2FD;
    border: 2px dashed #90CAF9;
    padding: 20px;
    border-radius: 15px;
    text-align: center;
    margin: 20px 0;
}

.creative-zone {
    border: 3px dashed #B39DDB;
    border-radius: 15px;
    padding: 20px;
    min-height: 150px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    text-align: center;
    color: #9575CD;
    background-color: #F3E5F520;
}

.creative-zone p {
    margin: 5px 0;
    font-weight: bold;
}

/* é’å°‘å¹´ç‰ˆä¸“å±æ ·å¼ */
.teen-mission-item {
    font-size: 1.1em;
    margin-bottom: 8px;
    color: #555;
}

.knowledge-plus-box {
    background-color: #f8f9fa;
    border-left: 4px solid #5C6BC0;
    padding: 15px;
    margin: 15px 0;
    font-size: 0.95em;
    border-radius: 4px;
}

.inspiration-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
}

.inspiration-item {
    background: #fafafa;
    border: 1px solid #eee;
    padding: 15px;
    border-radius: 8px;
}

.inspiration-item h4 {
    margin: 0 0 10px 0;
    color: #333;
    font-weight: bold;
}

.color-palette {
    display: flex;
    gap: 10px;
}

.color-swatch {
    width: 30px;
    height: 30px;
    border-radius: 50%;
    background-color: #eee;
}

.dot-grid {
    background-image: radial-gradient(#ccc 1px, transparent 0);
    background-size: 15px 15px;
    padding: 20px;
}

/* å®¶é•¿ç‰ˆä¸“å±æ ·å¼ */
.practical-info-box {
    background: #E8F5E9;
    padding: 15px;
    border-radius: 8px;
    border-left: 4px solid #66BB6A;
}

.practical-info-box ul {
    padding-left: 20px;
    margin: 0;
}

.storytelling-item, .engagement-item {
    margin-bottom: 15px;
}

.storytelling-item h4, .engagement-item h4 {
    color: #5C6BC0;
    font-weight: bold;
    margin-bottom: 5px;
}

.journal-space {
    border: 2px dashed #FFCC80;
    min-height: 100px;
    padding: 15px;
    border-radius: 10px;
    background: #FFFDE7;
    color: #8D6E63;
}

/* æ—…è¡Œè®¡åˆ’æ ·å¼ */
.travel-plan-container {
    max-width: 800px;
    margin: 0 auto;
    padding: 20px;
    background: white;
    border-radius: 15px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.1);
}

.plan-header {
    text-align: center;
    margin-bottom: 30px;
    padding: 20px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 15px;
}

.plan-header h1 {
    margin: 0 0 15px 0;
    font-size: 2em;
}

.plan-info {
    display: flex;
    justify-content: space-around;
    flex-wrap: wrap;
    gap: 10px;
}

.plan-info p {
    margin: 5px;
    background: rgba(255,255,255,0.2);
    padding: 8px 15px;
    border-radius: 20px;
    font-size: 0.9em;
}

.day-plan {
    margin-bottom: 30px;
    border: 2px solid #f0f0f0;
    border-radius: 15px;
    overflow: hidden;
}

.day-plan h2 {
    background: #f8f9fa;
    margin: 0;
    padding: 15px 20px;
    color: #333;
    border-bottom: 2px solid #e9ecef;
}

.day-sections {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 0;
}

.parent-section, .child-section {
    padding: 20px;
}

.parent-section {
    background: #fff8f0;
    border-right: 1px solid #e9ecef;
}

.child-section {
    background: #f0f8ff;
}

.parent-section h3 {
    color: #d63384;
    margin: 0 0 15px 0;
    font-size: 1.1em;
}

.child-section h3 {
    color: #0d6efd;
    margin: 0 0 15px 0;
    font-size: 1.1em;
}

.parent-section h4, .child-section h4 {
    margin: 0 0 15px 0;
    color: #495057;
    font-size: 1em;
}

.activities, .tips, .fun-facts {
    margin-bottom: 15px;
}

.activities h5, .tips h5, .fun-facts h5 {
    margin: 0 0 8px 0;
    color: #6c757d;
    font-size: 0.9em;
    font-weight: bold;
}

.activities ul, .tips ul, .fun-facts ul {
    margin: 0;
    padding-left: 20px;
}

.activities li, .tips li, .fun-facts li {
    margin-bottom: 5px;
    line-height: 1.4;
}

@media print {
    body {
        background-color: #fff;
        padding: 0;
        margin: 0;
    }
    .container {
        max-width: none;
        margin: 0;
    }
    .plan-section {
        display: block !important;
    }
    .version-tabs, .notebook-controls, .input-section, header {
        display: none !important;
    }
    .version-content {
        display: none !important;
    }
    .version-content.active {
        display: block !important;
    }
    .version-content-wrapper {
        border: none !important;
        padding: 0 !important;
        box-shadow: none;
    }
    .location-page-container {
        border: none !important;
        box-shadow: none;
        page-break-inside: avoid;
        page-break-before: always;
        min-height: 90vh;
        padding: 20px;
        margin: 0;
    }

    .location-page-container:first-child {
        page-break-before: auto;
    }

    /* ç¡®ä¿æ¯ä¸ªåœ°ç‚¹çš„å†…å®¹ä¸ä¼šè·¨é¡µåˆ†å‰² */
    .section-container {
        page-break-inside: avoid;
        margin-bottom: 15px;
    }

    /* æ ‡é¢˜ä¸è¦å•ç‹¬åœ¨é¡µé¢åº•éƒ¨ */
    .location-title-h1, .location-title-h2 {
        page-break-after: avoid;
    }

    /* ç¡®ä¿ç‰ˆæœ¬å†…å®¹å®¹å™¨ä¸ä¼šäº§ç”Ÿé¢å¤–åˆ†é¡µ */
    .version-content-wrapper {
        page-break-inside: auto;
    }

    /* ä¼˜åŒ–é¡µé¢è¾¹è· */
    @page {
        margin: 1cm;
        size: A4;
    }
}

@media (max-width: 768px) {
    .day-sections {
        grid-template-columns: 1fr;
    }

    .parent-section {
        border-right: none;
        border-bottom: 1px solid #e9ecef;
    }

    .plan-info {
        flex-direction: column;
        align-items: center;
    }
}

/* ç¬”è®°æœ¬æ ·å¼ */
.notebook-tabs {
    display: flex;
    justify-content: center;
    margin-bottom: -1px; /* è®©æ ‡ç­¾å’Œé¡µé¢è¾¹æ¡†é‡åˆ */
    flex-wrap: wrap;
    padding: 0 20px;
}

.tab {
    background-color: #F5F5F5;
    border: 1px solid #ddd;
    border-bottom: none;
    padding: 10px 15px;
    cursor: pointer;
    border-radius: 10px 10px 0 0;
    margin: 0 5px;
    font-family: 'LXGW WenKai Screen', cursive;
    font-weight: bold;
    color: #5C6BC0;
    position: relative;
    bottom: -5px;
    transition: all 0.2s ease-in-out;
}

.tab.active {
    background-color: #fff;
    border-top: 3px solid #7986CB;
    bottom: 0;
    padding-top: 12px;
}

.notebook-container {
    display: flex;
    gap: 30px;
    justify-content: center;
    width: 100%;
    margin-bottom: 20px;
}

.notebook-wrapper {
    width: 48%;
    max-width: 700px;
    display: flex;
    flex-direction: column;
    align-items: center;
}

.notebook-wrapper h2 {
    font-family: 'ZCOOL XiaoWei', serif;
    color: #3F51B5;
    margin-bottom: 15px;
}

@media (max-width: 1200px) {
    .notebook-container {
        flex-direction: column;
        align-items: center;
    }
    .notebook-wrapper {
        width: 90%;
    }
}
    </style>
</head>
<body>

    <div class="container input-section" id="input-container">
        <header>
            <h1>äº²å­æ—…è¡Œæ‰‹å†Œ</h1>
            <div style="display: flex; justify-content: center; margin: 15px 0;">
                <img src="images/afbcfbd3-addf-4e32-a3ab-6e2bca0a2ebd.jpeg" style="width: 80px; height: 80px; border-radius: 50%; object-fit: cover; box-shadow: 0 5px 15px rgba(92,107,192,0.3);" alt="å°å¯¼æ¸¸">
            </div>
            <p>ä¸€ä¸ªåœ°ç‚¹ï¼Œä¸‰ç§ç©æ³•ï¼ä¸“ä¸ºæœ‰å“å‘³ã€çˆ±æ¢ç´¢çš„å®¶åº­è®¾è®¡ï¼Œä¸ºä¸åŒå¹´é¾„æ®µçš„å­©å­ç”Ÿæˆä¸“å±çš„æ—…è¡Œæ‰‹è´¦ï¼</p>
        </header>

        <form id="trip-form" onsubmit="return false;">
            <!-- API è®¾ç½® -->
            <div class="form-block">
                <h3><span>ğŸ”‘</span>è¿æ¥AIåŠ©æ‰‹</h3>
                <div class="form-block-content">
                <div class="input-group">
                    <label for="api-provider">é€‰æ‹©AIæœåŠ¡å•†</label>
                    <select id="api-provider">
                        <option value="gemini">Google Gemini (æ¨è)</option>
                        <option value="openai">OpenAI</option>
                        <option value="deepseek">DeepSeek</option>
                        <option value="custom">è‡ªå®šä¹‰OpenAIå…¼å®¹æ¥å£</option>
                    </select>
                </div>
                <div class="input-group" id="custom-endpoint-group" style="margin-top: 15px; display: none;">
                    <label for="custom-endpoint">è‡ªå®šä¹‰APIç«¯ç‚¹</label>
                    <input type="text" id="custom-endpoint" placeholder="ä¾‹å¦‚ï¼šhttps://api.deepseek.com/v1">
                </div>
                <!-- è‡ªå®šä¹‰é‰´æƒï¼ˆä»…åœ¨è‡ªå®šä¹‰OpenAIå…¼å®¹æ¥å£æ—¶å¯é…ç½®ï¼‰ -->
                <div class="input-group" id="custom-auth-group" style="margin-top: 10px; display: none;">
                    <label>è‡ªå®šä¹‰é‰´æƒè¯·æ±‚å¤´ï¼ˆå¯é€‰ï¼‰</label>
                    <div class="api-key-row" style="gap: 10px; align-items: center;">
                        <input type="text" id="custom-auth-header-name" placeholder="å¤´åï¼Œä¾‹å¦‚ï¼šAuthorization æˆ– X-API-Key" style="flex: 1;" />
                        <input type="text" id="custom-auth-header-value" placeholder="å¤´å€¼æ¨¡æ¿ï¼Œä¾‹å¦‚ï¼šBearer {key} æˆ– {key}" style="flex: 1;" />
                    </div>
                    <div style="font-size: 0.8em; color: #666; margin-top: 5px;">
                        ä½¿ç”¨è¯´æ˜ï¼š{key} å°†åœ¨è¯·æ±‚æ—¶æ›¿æ¢ä¸ºæ‚¨å¡«å†™çš„API Keyï¼›ç•™ç©ºåˆ™ä½¿ç”¨å†…ç½®å…¼å®¹é€»è¾‘ï¼ˆBearer/X-API-Key/...ï¼‰ã€‚
                    </div>
                </div>
                <!-- Gemini API Key -->
                <div class="input-group api-key-group" id="gemini-key-group" style="margin-top: 15px;">
                    <label for="gemini-api-key">Gemini API Key</label>
                    <div class="api-key-row">
                        <input type="password" id="gemini-api-key" placeholder="AIza... (ä» Google AI Studio è·å–)">
                        <button type="button" class="fetch-btn" id="fetch-models-btn" disabled>æ‹‰å–æ¨¡å‹</button>
                    </div>
                    <div style="font-size: 0.8em; color: #666; margin-top: 5px;">
                        è·å–åœ°å€: <a href="https://aistudio.google.com/app/apikey" target="_blank">Google AI Studio</a>
                    </div>
                </div>

                <!-- OpenAI API Key -->
                <div class="input-group api-key-group" id="openai-key-group" style="margin-top: 15px; display: none;">
                    <label for="openai-api-key">OpenAI API Key</label>
                    <div class="api-key-row">
                        <input type="password" id="openai-api-key" placeholder="sk-... (ä» OpenAI è·å–)">
                        <button type="button" class="fetch-btn" id="fetch-models-btn" disabled>æ‹‰å–æ¨¡å‹</button>
                    </div>
                    <div style="font-size: 0.8em; color: #666; margin-top: 5px;">
                        è·å–åœ°å€: <a href="https://platform.openai.com/api-keys" target="_blank">OpenAI Platform</a>
                    </div>
                </div>

                <!-- DeepSeek API Key -->
                <div class="input-group api-key-group" id="deepseek-key-group" style="margin-top: 15px; display: none;">
                    <label for="deepseek-api-key">DeepSeek API Key</label>
                    <div class="api-key-row">
                        <input type="password" id="deepseek-api-key" placeholder="sk-... (ä» DeepSeek è·å–)">
                        <button type="button" class="fetch-btn" id="fetch-models-btn" disabled>æ‹‰å–æ¨¡å‹</button>
                    </div>
                    <div style="font-size: 0.8em; color: #666; margin-top: 5px;">
                        è·å–åœ°å€: <a href="https://platform.deepseek.com/api_keys" target="_blank">DeepSeek Platform</a>
                    </div>
                </div>

                <!-- Custom API Key -->
                <div class="input-group api-key-group" id="custom-key-group" style="margin-top: 15px; display: none;">
                    <label for="custom-api-key">è‡ªå®šä¹‰API Key</label>
                    <div class="api-key-row">
                        <input type="password" id="custom-api-key" placeholder="æ ¹æ®æ‚¨çš„æœåŠ¡å•†è¦æ±‚è¾“å…¥">
                        <button type="button" class="fetch-btn" id="fetch-models-btn" disabled>æ‹‰å–æ¨¡å‹</button>
                    </div>
                    <div style="font-size: 0.8em; color: #666; margin-top: 5px;">
                        è¯·å‚è€ƒæ‚¨çš„è‡ªå®šä¹‰æœåŠ¡å•†æ–‡æ¡£
                    </div>
                </div>
                <div class="input-group" style="margin-top: 15px;">
                    <label for="model-select">é€‰æ‹©æ¨¡å‹</label>
                    <select id="model-select" disabled>
                        <option>è¯·å…ˆè¾“å…¥Keyå¹¶æ‹‰å–æ¨¡å‹</option>
                    </select>
                    <div id="api-status"></div>
                </div>
                <div class="input-group" style="margin-top: 15px;">
                    <button type="button" class="clear-btn" id="clear-settings-btn">ğŸ—‘ï¸ æ¸…é™¤ä¿å­˜çš„è®¾ç½®</button>
                    <div style="font-size: 0.8em; color: #666; margin-top: 5px;">
                        æ¸…é™¤æ‰€æœ‰ä¿å­˜åœ¨æµè§ˆå™¨ä¸­çš„APIè®¾ç½®
                    </div>
                    <div id="settings-status" style="font-size: 0.8em; margin-top: 5px;"></div>
                </div>
                <div class="input-group" style="margin-top: 15px;">
                    <label>
                        <input type="checkbox" id="enable-search" checked>
                        å¯ç”¨è”ç½‘æœç´¢ (è·å–å®æ—¶ä¿¡æ¯)
                    </label>
                    <div style="font-size: 0.9em; color: #666; margin-top: 5px;" id="search-description">
                        å¼€å¯åAIå°†æœç´¢æœ€æ–°çš„æ™¯ç‚¹ä¿¡æ¯ã€å¤©æ°”ã€ä»·æ ¼ç­‰
                    </div>
                </div>
                <div class="input-group" style="margin-top: 15px;" id="search-api-group">
                    <label for="search-api-key">æœç´¢API Key (å¯é€‰)</label>
                    <input type="password" id="search-api-key" placeholder="SerpAPI Key - æä¾›æ›´å‡†ç¡®çš„æœç´¢ç»“æœ">
                    <div style="font-size: 0.8em; color: #666; margin-top: 5px;">
                        ä¸å¡«å†™å°†ä½¿ç”¨æ¨¡æ‹Ÿæœç´¢ç»“æœã€‚è·å–å…è´¹API Key: <a href="https://serpapi.com" target="_blank">SerpAPI</a>
                    </div>
                </div>
                </div>
            </div>

            <!-- ä½¿ç”¨æ¨¡å¼é€‰æ‹© -->
            <div class="form-block">
                <h3><span>ğŸ¯</span>ç¬¬ä¸€æ­¥ï¼šé€‰æ‹©ä½¿ç”¨æ¨¡å¼</h3>
                <div class="form-block-content">
                <div class="icon-options" id="usage-mode-selector">
                    <label><input type="radio" name="usage-mode" value="ai-planning" checked><div class="content"><div class="icon">ğŸ¤–</div><span>AIè§„åˆ’è¡Œç¨‹</span><div style="font-size:0.8em;color:#666;margin-top:3px;">è®©AIä¸ºæ‚¨å®‰æ’å®Œæ•´è¡Œç¨‹</div></div></label>
                    <label><input type="radio" name="usage-mode" value="existing-plan"><div class="content"><div class="icon">ğŸ“‹</div><span>å·²æœ‰è¡Œç¨‹å®‰æ’</span><div style="font-size:0.8em;color:#666;margin-top:3px;">ä¸ºç°æœ‰è¡Œç¨‹è¡¥å……æ”»ç•¥ä¿¡æ¯</div></div></label>
                </div>
                </div>
            </div>

            <!-- è¯­è¨€é€‰æ‹© -->
            <div class="form-block">
                <h3><span>ğŸŒ</span>ç¬¬äºŒæ­¥ï¼šé€‰æ‹©æ”»ç•¥è¯­è¨€</h3>
                <div class="form-block-content">
                 <div class="icon-options">
                    <label><input type="radio" name="language" value="Simplified Chinese" checked><div class="content"><div class="icon">ğŸ‡¨ğŸ‡³</div><span>ç®€ä½“ä¸­æ–‡</span></div></label>
                    <label><input type="radio" name="language" value="English"><div class="content"><div class="icon">ğŸ‡¬ğŸ‡§</div><span>English</span></div></label>
                </div>
                </div>
            </div>

            <!-- æ—…ç¨‹åŸºæœ¬è®¾ç½® -->
            <div class="form-block">
                <h3><span>ğŸ—ºï¸</span>ç¬¬ä¸‰æ­¥ï¼šæˆ‘ä»¬çš„æ—…ç¨‹</h3>
                <div class="form-block-content">
                <div class="input-label">æ—…ç¨‹ç±»å‹</div>
                <div class="icon-options" id="trip-type-selector">
                    <label><input type="radio" name="trip-type" value="day-trip" checked><div class="content"><div class="icon">ğŸ™ï¸</div><span>ä¸€æ—¥æ¸¸</span></div></label>
                    <label><input type="radio" name="trip-type" value="single-city"><div class="content"><div class="icon">ğŸ¡</div><span>çŸ­é€”æ—…è¡Œ</span></div></label>
                    <label><input type="radio" name="trip-type" value="multi-city"><div class="content"><div class="icon">âœˆï¸</div><span>é•¿é€”æ—…è¡Œ</span></div></label>
                </div>
                <div id="destination-inputs" style="margin-top: 15px;">
                    <div id="single-dest-group">
                        <div class="input-group">
                            <label for="destination">ç›®çš„åœ°</label>
                            <input type="text" id="destination" placeholder="ä¾‹å¦‚ï¼šåŒ—äº¬">
                        </div>
                        <div class="input-group" style="margin-top:10px;">
                            <label for="duration">å¤©æ•°</label>
                            <input type="number" id="duration" value="1" min="1" readonly>
                        </div>
                        <div class="input-group" style="margin-top:10px;">
                            <label for="departure-date">å‡ºå‘æ—¥æœŸ</label>
                            <input type="date" id="departure-date">
                            <div style="font-size: 0.8em; color: #666; margin-top: 3px;">
                                å¡«å†™åå¯è‡ªåŠ¨æŸ¥è¯¢å¤©æ°”é¢„æŠ¥
                            </div>
                        </div>
                    </div>
                    <div class="dynamic-list" id="multi-city-container" style="display: none;">
                        <button type="button" class="add-btn" id="add-city-btn">+</button>
                    </div>
                </div>

                <!-- AIè§„åˆ’æ¨¡å¼çš„å¿…å»æ™¯ç‚¹ -->
                <div id="ai-planning-section" style="margin-top: 20px;">
                    <div class="input-group">
                        <label for="must-visit-places">å¿…å»æ™¯ç‚¹ (å¯é€‰)</label>
                        <textarea id="must-visit-places" rows="4" placeholder="å¦‚æœæœ‰ç‰¹åˆ«æƒ³å»çš„åœ°æ–¹ï¼Œè¯·åˆ—å‡ºæ¥ï¼Œä¾‹å¦‚ï¼š
- æ•…å®«åšç‰©é™¢
- å¤©å®‰é—¨å¹¿åœº
- é¢å’Œå›­
- ç‹åºœäº•å¤§è¡—
...

AIä¼šä¼˜å…ˆå®‰æ’è¿™äº›æ™¯ç‚¹ï¼Œå¹¶è¡¥å……å…¶ä»–æ¨èåœ°ç‚¹"></textarea>
                        <div style="font-size: 0.8em; color: #666; margin-top: 5px;">
                            AIä¼šä¼˜å…ˆå®‰æ’è¿™äº›æ™¯ç‚¹ï¼Œå¹¶åœ¨æ­¤åŸºç¡€ä¸Šè¡¥å……å…¶ä»–é€‚åˆçš„åœ°ç‚¹å’Œæ´»åŠ¨
                        </div>
                    </div>
                </div>

                <!-- å·²æœ‰è¡Œç¨‹è¾“å…¥åŒºåŸŸ -->
                <div id="existing-plan-section" style="display: none; margin-top: 20px;">
                    <div class="input-group">
                        <label for="existing-itinerary">æ‚¨çš„è¯¦ç»†è¡Œç¨‹å®‰æ’</label>
                        <textarea id="existing-itinerary" rows="8" placeholder="è¯·è¯¦ç»†æè¿°æ‚¨çš„è¡Œç¨‹å®‰æ’ï¼Œä¾‹å¦‚ï¼š
ç¬¬ä¸€å¤©ï¼š
ä¸Šåˆ9:00 - æ•…å®«åšç‰©é™¢
ä¸­åˆ12:00 - åˆé¤
ä¸‹åˆ2:00 - å¤©å®‰é—¨å¹¿åœº
...

ç¬¬äºŒå¤©ï¼š
ä¸Šåˆ10:00 - é¢å’Œå›­
..."></textarea>
                        <div style="font-size: 0.8em; color: #666; margin-top: 5px;">
                            AIå°†ä¸ºæ‚¨çš„è¡Œç¨‹è¡¥å……é¤å…æ¨èã€äº¤é€šå»ºè®®ã€äº²å­è´´å£«ç­‰å®ç”¨ä¿¡æ¯
                        </div>
                    </div>
                </div>
                </div>
            </div>

            <!-- å®¶åº­æˆå‘˜ -->
            <div class="form-block">
                <h3><span>ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦</span>ç¬¬å››æ­¥ï¼šå’Œè°ä¸€èµ·å»ï¼Ÿ</h3>
                <div class="form-block-content">
                <div class="dynamic-list" id="family-list">
                    <div class="list-item">
                        <input type="text" placeholder="ç§°è°“ (å¦‚: çˆ¸çˆ¸)" value="çˆ¸çˆ¸">
                        <input type="number" placeholder="å¹´é¾„" value="35" style="max-width: 80px;">
                        <button type="button" class="remove-btn">-</button>
                    </div>
                    <div class="list-item">
                        <input type="text" placeholder="ç§°è°“" value="æˆ‘">
                        <input type="number" placeholder="å¹´é¾„" value="5" style="max-width: 80px;">
                        <button type="button" class="remove-btn">-</button>
                    </div>
                </div>
                <button type="button" class="add-btn" id="add-family-btn">+</button>
                </div>
            </div>

            <!-- å…´è¶£çˆ±å¥½é€‰æ‹© -->
            <div class="form-block">
                <h3><span>ğŸˆ</span>ç¬¬äº”æ­¥ï¼šæˆ‘ä»¬çš„å–œå¥½ä¸ç‰¹æ®Šéœ€æ±‚</h3>
                <div class="form-block-content">
                <div class="input-label">æˆ‘ä»¬å–œæ¬¢åšä»€ä¹ˆï¼Ÿ(å¯å¤šé€‰)</div>
                <div class="icon-options" id="interests-selector">
                    <label><input type="checkbox" name="interests" value="ä¸»é¢˜ä¹å›­"><div class="content"><div class="icon">ğŸ¢</div><span>ä¸»é¢˜ä¹å›­</span></div></label>
                    <label><input type="checkbox" name="interests" value="åšç‰©é¦†"><div class="content"><div class="icon">ğŸ›ï¸</div><span>åšç‰©é¦†</span></div></label>
                    <label><input type="checkbox" name="interests" value="äº²è¿‘è‡ªç„¶"><div class="content"><div class="icon">ğŸŒ³</div><span>äº²è¿‘è‡ªç„¶</span></div></label>
                    <label><input type="checkbox" name="interests" value="åƒå¥½åƒçš„"><div class="content"><div class="icon">ğŸ”</div><span>åƒå¥½åƒçš„</span></div></label>
                    <label><input type="checkbox" name="interests" value="è´­ç‰©"><div class="content"><div class="icon">ğŸ›ï¸</div><span>è´­ç‰©</span></div></label>
                    <label><input type="checkbox" name="interests" value="å†å²æ–‡åŒ–"><div class="content"><div class="icon">ğŸ¯</div><span>å†å²æ–‡åŒ–</span></div></label>
                    <label><input type="checkbox" name="interests" value="è‰ºæœ¯å±•è§ˆ"><div class="content"><div class="icon">ğŸ¨</div><span>è‰ºæœ¯å±•è§ˆ</span></div></label>
                    <label><input type="checkbox" name="interests" value="ç§‘æŠ€ä½“éªŒ"><div class="content"><div class="icon">ğŸ”¬</div><span>ç§‘æŠ€ä½“éªŒ</span></div></label>
                    <label><input type="checkbox" name="interests" value="è¿åŠ¨å¥èº«"><div class="content"><div class="icon">âš½</div><span>è¿åŠ¨å¥èº«</span></div></label>
                    <label><input type="checkbox" name="interests" value="æµ·æ»©æµ·å²›"><div class="content"><div class="icon">ğŸ–ï¸</div><span>æµ·æ»©æµ·å²›</span></div></label>
                    <label><input type="checkbox" name="interests" value="å±±å·å¾’æ­¥"><div class="content"><div class="icon">â›°ï¸</div><span>å±±å·å¾’æ­¥</span></div></label>
                    <label><input type="checkbox" name="interests" value="åŠ¨ç‰©å›­"><div class="content"><div class="icon">ğŸ¦</div><span>åŠ¨ç‰©å›­</span></div></label>
                    <label><input type="checkbox" name="interests" value="æ°´æ—é¦†"><div class="content"><div class="icon">ğŸ </div><span>æ°´æ—é¦†</span></div></label>
                    <label><input type="checkbox" name="interests" value="æ¸¸ä¹åœº"><div class="content"><div class="icon">ğŸ </div><span>æ¸¸ä¹åœº</span></div></label>
                    <label><input type="checkbox" name="interests" value="æ¸©æ³‰SPA"><div class="content"><div class="icon">â™¨ï¸</div><span>æ¸©æ³‰SPA</span></div></label>
                    <label><input type="checkbox" name="interests" value="å¤œå¸‚å°åƒ"><div class="content"><div class="icon">ğŸœ</div><span>å¤œå¸‚å°åƒ</span></div></label>
                    <label><input type="checkbox" name="interests" value="æ‘„å½±æ‰“å¡"><div class="content"><div class="icon">ğŸ“¸</div><span>æ‘„å½±æ‰“å¡</span></div></label>
                    <label><input type="checkbox" name="interests" value="æ‰‹å·¥ä½“éªŒ"><div class="content"><div class="icon">ğŸ­</div><span>æ‰‹å·¥ä½“éªŒ</span></div></label>
                    <label><input type="checkbox" name="interests" value="éŸ³ä¹æ¼”å‡º"><div class="content"><div class="icon">ğŸµ</div><span>éŸ³ä¹æ¼”å‡º</span></div></label>
                    <label><input type="checkbox" name="interests" value="å½“åœ°æ°‘ä¿—"><div class="content"><div class="icon">ğŸ</div><span>å½“åœ°æ°‘ä¿—</span></div></label>
                </div>

                <div class="input-label" style="margin-top: 20px;">ç‰¹æ®Šéœ€æ±‚ (å¯é€‰)</div>
                <div class="icon-options">
                    <label><input type="checkbox" name="special-needs" value="æ— éšœç¢è®¾æ–½"><div class="content"><div class="icon">â™¿</div><span>æ— éšœç¢è®¾æ–½</span></div></label>
                    <label><input type="checkbox" name="special-needs" value="å©´å„¿å‹å¥½"><div class="content"><div class="icon">ğŸ‘¶</div><span>å©´å„¿å‹å¥½</span></div></label>
                    <label><input type="checkbox" name="special-needs" value="ç´ é£Ÿé€‰æ‹©"><div class="content"><div class="icon">ğŸ¥—</div><span>ç´ é£Ÿé€‰æ‹©</span></div></label>
                    <label><input type="checkbox" name="special-needs" value="å® ç‰©å‹å¥½"><div class="content"><div class="icon">ğŸ•</div><span>å® ç‰©å‹å¥½</span></div></label>
                    <label><input type="checkbox" name="special-needs" value="é¢„ç®—æœ‰é™"><div class="content"><div class="icon">ğŸ’°</div><span>é¢„ç®—æœ‰é™</span></div></label>
                    <label><input type="checkbox" name="special-needs" value="é¿å…äººç¾¤"><div class="content"><div class="icon">ğŸ¤«</div><span>é¿å…äººç¾¤</span></div></label>
                </div>

                <div class="input-group" style="margin-top: 15px;">
                    <label for="other-preferences">å…¶ä»–åå¥½æˆ–è¦æ±‚</label>
                    <textarea id="other-preferences" rows="3" placeholder="ä¾‹å¦‚ï¼šå–œæ¬¢å®‰é™çš„åœ°æ–¹ã€å¯¹æŸäº›é£Ÿç‰©è¿‡æ•ã€å¸Œæœ›æœ‰æ•™è‚²æ„ä¹‰çš„æ´»åŠ¨ç­‰..."></textarea>
                </div>
                </div>
            </div>

            <!-- äº¤é€šå’Œå¤©æ°” -->
            <div class="form-block">
                <h3><span>ğŸš—</span>ç¬¬å…­æ­¥ï¼šäº¤é€šä¸å¤©æ°”</h3>
                <div class="form-block-content">
                <div class="input-label">å»ç›®çš„åœ°åä»€ä¹ˆï¼Ÿ</div>
                <div class="icon-options">
                    <label><input type="radio" name="main-transport" value="é£æœº"><div class="content"><div class="icon">âœˆï¸</div><span>é£æœº</span></div></label>
                    <label><input type="radio" name="main-transport" value="ç«è½¦" checked><div class="content"><div class="icon">ğŸš„</div><span>ç«è½¦</span></div></label>
                    <label><input type="radio" name="main-transport" value="æ±½è½¦"><div class="content"><div class="icon">ğŸš—</div><span>æ±½è½¦</span></div></label>
                    <label><input type="radio" name="main-transport" value="å…¶ä»–"><div class="content"><div class="icon">ğŸšŒ</div><span>å…¶ä»–</span></div></label>
                </div>
                <div class="input-group" id="custom-main-transport-group" style="display: none; margin-top: 10px;">
                    <input type="text" id="custom-main-transport" placeholder="è¯·è¾“å…¥å…¶ä»–äº¤é€šæ–¹å¼ï¼Œä¾‹å¦‚ï¼šé•¿é€”å·´å£«ã€è‡ªé©¾ã€èˆ¹èˆ¶ç­‰">
                </div>
                <div class="input-label" style="margin-top: 15px;">åœ¨åŸå¸‚é‡Œä¸»è¦åä»€ä¹ˆï¼Ÿ(å¯å¤šé€‰)</div>
                <div class="icon-options">
                    <label><input type="checkbox" name="daily-transport" value="åœ°é“"><div class="content"><div class="icon">ğŸš‡</div><span>åœ°é“</span></div></label>
                    <label><input type="checkbox" name="daily-transport" value="å·´å£«"><div class="content"><div class="icon">ğŸšŒ</div><span>å·´å£«</span></div></label>
                    <label><input type="checkbox" name="daily-transport" value="æ±½è½¦"><div class="content"><div class="icon">ğŸš—</div><span>æ±½è½¦</span></div></label>
                    <label><input type="checkbox" name="daily-transport" value="èµ°è·¯" checked><div class="content"><div class="icon">ğŸš¶â€â™‚ï¸</div><span>èµ°è·¯</span></div></label>
                    <label><input type="checkbox" name="daily-transport" value="å…¶ä»–"><div class="content"><div class="icon">ğŸ›´</div><span>å…¶ä»–</span></div></label>
                </div>
                <div class="input-group" id="custom-daily-transport-group" style="display: none; margin-top: 10px;">
                    <input type="text" id="custom-daily-transport" placeholder="è¯·è¾“å…¥å…¶ä»–äº¤é€šæ–¹å¼ï¼Œä¾‹å¦‚ï¼šå…±äº«å•è½¦ã€ç”µåŠ¨æ»‘æ¿è½¦ã€æ‘©æ‰˜è½¦ç­‰">
                </div>

                <div class="input-label" style="margin-top: 15px;">å‡ºè¡Œå­£èŠ‚</div>
                <div class="icon-options">
                    <label><input type="radio" name="season" value="æ˜¥å­£" checked><div class="content"><div class="icon">ğŸŒ¸</div><span>æ˜¥å­£</span><div style="font-size:0.8em;color:#666;margin-top:3px;">3-5æœˆï¼Œæ¸©æš–èˆ’é€‚</div></div></label>
                    <label><input type="radio" name="season" value="å¤å­£"><div class="content"><div class="icon">â˜€ï¸</div><span>å¤å­£</span><div style="font-size:0.8em;color:#666;margin-top:3px;">6-8æœˆï¼Œç‚çƒ­å¤šé›¨</div></div></label>
                    <label><input type="radio" name="season" value="ç§‹å­£"><div class="content"><div class="icon">ğŸ‚</div><span>ç§‹å­£</span><div style="font-size:0.8em;color:#666;margin-top:3px;">9-11æœˆï¼Œå‡‰çˆ½å®œäºº</div></div></label>
                    <label><input type="radio" name="season" value="å†¬å­£"><div class="content"><div class="icon">â„ï¸</div><span>å†¬å­£</span><div style="font-size:0.8em;color:#666;margin-top:3px;">12-2æœˆï¼Œå¯’å†·å¹²ç‡¥</div></div></label>
                </div>
                </div>
            </div>



            <!-- è¡Œææ¸…å• -->
            <div class="form-block">
                <h3><span>ğŸ’</span>ç¬¬ä¸ƒæ­¥ï¼šè¡Œææ¸…å•</h3>
                <div class="form-block-content">
                <div class="input-label">å„¿ç«¥è¡Œææ¸…å• (è®©AIå‚è€ƒ)</div>
                <div class="dynamic-list" id="checklist-items">
                    <div class="list-item"><input type="text" value="æœ€å–œæ¬¢çš„å°ç†Šç©å¶"><button type="button" class="remove-btn">-</button></div>
                    <div class="list-item"><input type="text" value="æé¾™ç»˜æœ¬"><button type="button" class="remove-btn">-</button></div>
                </div>
                <button type="button" class="add-btn" id="add-checklist-btn">+</button>
                </div>
            </div>

            <button type="submit" class="submit-btn" id="generate-btn" disabled>âœ¨ ç”Ÿæˆæ—…è¡Œæ‰‹å¸ âœ¨</button>
        </form>
    </div>

    <!-- è®¡åˆ’è¾“å‡ºåŒºåŸŸ -->
    <div class="container plan-section" id="plan-output" style="display: none;">
        <!-- ç‰ˆæœ¬åˆ‡æ¢æŒ‰é’® -->
        <div class="version-tabs">
            <button class="version-btn active" data-version="child">ğŸ¨ å„¿ç«¥ç‰ˆ (å†’é™©æ—¥å¿—)</button>
            <button class="version-btn" data-version="teenager">âœ’ï¸ é’å°‘å¹´ç‰ˆ (çµæ„Ÿç°¿)</button>
            <button class="version-btn" data-version="parent">ğŸ“– å®¶é•¿ç‰ˆ (æŒ‡å¯¼æ‰‹å†Œ)</button>
        </div>

        <!-- å†…å®¹å®¹å™¨ -->
        <div class="version-content-wrapper">
            <!-- å„¿ç«¥ç‰ˆå†…å®¹ -->
            <div id="child-view-content" class="version-content active">
                <!-- å„¿ç«¥ç‰ˆå†…å®¹å°†åŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
            </div>
            <!-- é’å°‘å¹´ç‰ˆå†…å®¹ -->
            <div id="teenager-view-content" class="version-content">
                <!-- é’å°‘å¹´ç‰ˆå†…å®¹å°†åŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
            </div>
            <!-- å®¶é•¿ç‰ˆå†…å®¹ -->
            <div id="parent-view-content" class="version-content">
                <!-- å®¶é•¿ç‰ˆå†…å®¹å°†åŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
            </div>
        </div>

        <!-- æ§åˆ¶æŒ‰é’® -->
        <div class="notebook-controls">
            <button class="print-btn" onclick="handlePrint()">ğŸ–¨ï¸ æ‰“å°å½“å‰ç‰ˆæœ¬</button>
            <button class="new-plan-btn" onclick="handleNewPlan()">ğŸ†• åˆ¶ä½œæ–°æ”»ç•¥</button>
        </div>
    </div>

    <!-- åŠ è½½æŒ‡ç¤ºå™¨ -->
    <div class="container" id="loading-indicator" style="display: none;">
        <div style="text-align: center; padding: 50px;">
            <div style="font-size: 3em; margin-bottom: 20px;">ğŸ”„</div>
            <h2>AIæ­£åœ¨ä¸ºæ‚¨ç²¾å¿ƒè§„åˆ’æ—…ç¨‹...</h2>
            <p>è¯·ç¨å€™ï¼Œè¿™å¯èƒ½éœ€è¦å‡ åˆ†é’Ÿæ—¶é—´</p>
        </div>
    </div>

                <script>
                // JSé€»è¾‘ - 100%å®Œæ•´

                // å…¨å±€å˜é‡
                let modelsCache = {};
                let currentPlanData = null;
                const imagePaths = [
                    'images/02ee957c-32fc-4cdb-a169-e5f2e738a58f.png',
                    'images/1b49ea1c-cacb-4161-a3ec-89d06d47b306.png',
                    'images/7633aa7e-33aa-4ada-b715-ef314f196859.png',
                    'images/afbcfbd3-addf-4e32-a3ab-6e2bca0a2ebd.jpeg',
                    'images/c5a9952a-2a41-4995-8822-6052069de53c.png',
                    'images/e1f3c3a9-985a-4467-af91-53e4a9990508.png',
                    'images/e3a8a3c2-c07c-42a3-98c1-58133379531e.png'
                ];

                // DOM å…ƒç´ 
                const geminiApiKeyInput = document.getElementById('gemini-api-key');
                const openaiApiKeyInput = document.getElementById('openai-api-key');
                const deepseekApiKeyInput = document.getElementById('deepseek-api-key');
                const customApiKeyInput = document.getElementById('custom-api-key');
                const apiProviderSelect = document.getElementById('api-provider');
                const customEndpointGroup = document.getElementById('custom-endpoint-group');
                const customEndpointInput = document.getElementById('custom-endpoint');
                const modelSelect = document.getElementById('model-select');
                const fetchModelsBtns = document.querySelectorAll('.fetch-btn');
                const apiStatus = document.getElementById('api-status');
                const clearSettingsBtn = document.getElementById('clear-settings-btn');
                const settingsStatus = document.getElementById('settings-status');
                const searchApiKeyInput = document.getElementById('search-api-key');
                const enableSearchCheckbox = document.getElementById('enable-search');
                const searchApiGroup = document.getElementById('search-api-group');
                const searchDescription = document.getElementById('search-description');

                // å¤‡æ³¨ï¼šä¿®å¤â€œæ‹‰å–æ¨¡å‹â€æŒ‰é’®åªå¯¹Geminiç”Ÿæ•ˆçš„é—®é¢˜ã€‚
                // åŸå› ï¼šé¡µé¢å­˜åœ¨å¤šä¸ªç›¸åŒIDçš„æŒ‰é’®(id="fetch-models-btn")ï¼Œä¹‹å‰ä»…ç»™ç¬¬ä¸€ä¸ªæŒ‰é’®ç»‘å®šäº‹ä»¶å’Œæ›´æ–°çŠ¶æ€ã€‚
                // ä¿®æ”¹ï¼šæ”¹ä¸ºé€‰æ‹©æ‰€æœ‰ç±»åä¸º.fetch-btnçš„æŒ‰é’®ç»Ÿä¸€ç»‘å®šï¼›å¹¶ä»…å¯ç”¨å½“å‰æœåŠ¡å•†åˆ†ç»„å†…çš„æŒ‰é’®ã€‚
                // å¤‡æ³¨è¡¥å……ï¼šä¸ºé¿å…æµè§ˆå™¨è‡ªåŠ¨å¡«å……/ç²˜è´´æœªè§¦å‘ input å¯¼è‡´æŒ‰é’®ä¿æŒç¦ç”¨ï¼Œå¢åŠ å¤šäº‹ä»¶ç›‘å¬ä¸åˆå§‹åŒ–å¼ºåˆ¶åˆ·æ–°ã€‚

                function getActiveFetchButton() {
                    const provider = apiProviderSelect.value;
                    const groupIdMap = {
                        gemini: 'gemini-key-group',
                        openai: 'openai-key-group',
                        deepseek: 'deepseek-key-group',
                        custom: 'custom-key-group'
                    };
                    const groupId = groupIdMap[provider];
                    return document.querySelector(`#${groupId} .fetch-btn`);
                }

                // è·å–å½“å‰é€‰ä¸­æœåŠ¡å•†çš„API Key
                function getCurrentApiKey() {
                    const provider = apiProviderSelect.value;
                    switch (provider) {
                        case 'gemini':
                            return geminiApiKeyInput.value.trim();
                        case 'openai':
                            return openaiApiKeyInput.value.trim();
                        case 'deepseek':
                            return deepseekApiKeyInput.value.trim();
                        case 'custom':
                            return customApiKeyInput.value.trim();
                        default:
                            return '';
                    }
                }

                // è·å–å½“å‰é€‰ä¸­æœåŠ¡å•†çš„API Keyè¾“å…¥æ¡†
                function getCurrentApiKeyInput() {
                    const provider = apiProviderSelect.value;
                    switch (provider) {
                        case 'gemini':
                            return geminiApiKeyInput;
                        case 'openai':
                            return openaiApiKeyInput;
                        case 'deepseek':
                            return deepseekApiKeyInput;
                        case 'custom':
                            return customApiKeyInput;
                        default:
                            return null;
                    }
                }

                // æ›´æ–°API Keyè¾“å…¥æ¡†æ˜¾ç¤º
                function updateApiKeyVisibility() {
                    const provider = apiProviderSelect.value;

                    // éšè—æ‰€æœ‰API Keyè¾“å…¥æ¡†
                    document.getElementById('gemini-key-group').style.display = 'none';
                    document.getElementById('openai-key-group').style.display = 'none';
                    document.getElementById('deepseek-key-group').style.display = 'none';
                    document.getElementById('custom-key-group').style.display = 'none';

                    // æ˜¾ç¤ºå¯¹åº”çš„API Keyè¾“å…¥æ¡†
                    switch (provider) {
                        case 'gemini':
                            document.getElementById('gemini-key-group').style.display = 'block';
                            break;
                        case 'openai':
                            document.getElementById('openai-key-group').style.display = 'block';
                            break;
                        case 'deepseek':
                            document.getElementById('deepseek-key-group').style.display = 'block';
                            break;
                        case 'custom':
                            document.getElementById('custom-key-group').style.display = 'block';
                            break;
                    }

                    // è‡ªå®šä¹‰ç«¯ç‚¹ä¸è‡ªå®šä¹‰é‰´æƒå¤´ä»…åœ¨ custom æä¾›å•†ä¸‹å¯è§
                    const isCustom = provider === 'custom';
                    document.getElementById('custom-endpoint-group').style.display = isCustom ? 'block' : 'none';
                    const customAuthGroup = document.getElementById('custom-auth-group');
                    if (customAuthGroup) customAuthGroup.style.display = isCustom ? 'block' : 'none';

                    // æ›´æ–°æ‹‰å–æ¨¡å‹æŒ‰é’®çŠ¶æ€
                    updateFetchButtonState();
                }

                // æ›´æ–°æ‹‰å–æ¨¡å‹æŒ‰é’®çŠ¶æ€
                function updateFetchButtonState() {
                    const apiKey = getCurrentApiKey();
                    // å…ˆå…¨éƒ¨ç¦ç”¨
                    fetchModelsBtns.forEach(btn => btn.disabled = true);
                    // å¯ç”¨å½“å‰æœåŠ¡å•†åˆ†ç»„å†…çš„æŒ‰é’®
                    const activeBtn = getActiveFetchButton();
                    if (activeBtn) activeBtn.disabled = !apiKey;
                }

                const tripForm = document.getElementById('trip-form');
                const submitBtn = document.getElementById('generate-btn');
                const loadingIndicator = document.getElementById('loading-indicator');
                const inputContainer = document.getElementById('input-container');
                const planOutput = document.getElementById('plan-output');
                const tripTypeSelector = document.getElementById('trip-type-selector');
                const destinationInput = document.getElementById('destination');
                const durationInput = document.getElementById('duration');
                const singleDestGroup = document.getElementById('single-dest-group');
                const multiCityContainer = document.getElementById('multi-city-container');
                const addCityBtn = document.getElementById('add-city-btn');
                const departureDateInput = document.getElementById('departure-date');
                const addFamilyBtn = document.getElementById('add-family-btn');
                const familyList = document.getElementById('family-list');
                const usageModeSelector = document.getElementById('usage-mode-selector');
                const aiPlanningSection = document.getElementById('ai-planning-section');
                const existingPlanSection = document.getElementById('existing-plan-section');
                const mainTransportRadios = document.querySelectorAll('input[name="main-transport"]');
                const customMainTransportGroup = document.getElementById('custom-main-transport-group');
                const customMainTransportInput = document.getElementById('custom-main-transport');

                // è®¾ç½®ä¿å­˜å’ŒåŠ è½½åŠŸèƒ½
                function loadSettings() {
                    try {
                        const savedSettings = localStorage.getItem('travelPlannerSettings');
                        if (savedSettings) {
                            const settings = JSON.parse(savedSettings);

                            // æ¢å¤APIè®¾ç½®
                            if (settings.geminiApiKey) geminiApiKeyInput.value = settings.geminiApiKey;
                            if (settings.openaiApiKey) openaiApiKeyInput.value = settings.openaiApiKey;
                            if (settings.deepseekApiKey) deepseekApiKeyInput.value = settings.deepseekApiKey;
                            if (settings.customApiKey) customApiKeyInput.value = settings.customApiKey;
                            if (settings.apiProvider) apiProviderSelect.value = settings.apiProvider;
                            if (settings.customEndpoint) customEndpointInput.value = settings.customEndpoint;
                            if (settings.customAuthHeaderName) document.getElementById('custom-auth-header-name').value = settings.customAuthHeaderName;
                            if (settings.customAuthHeaderValue) document.getElementById('custom-auth-header-value').value = settings.customAuthHeaderValue;
                            if (settings.searchApiKey) searchApiKeyInput.value = settings.searchApiKey;
                            if (settings.enableSearch !== undefined) enableSearchCheckbox.checked = settings.enableSearch;

                            // æ¢å¤å½“å‰æœåŠ¡å•†çš„æ¨¡å‹é€‰æ‹©
                            const currentProvider = apiProviderSelect.value;
                            const providerModelsKey = `${currentProvider}_models`;
                            const providerSelectedModelKey = `${currentProvider}_selectedModel`;

                            if (settings[providerModelsKey] && settings[providerModelsKey].length > 0) {
                                modelSelect.innerHTML = settings[providerModelsKey].map(model => `<option value="${model}">${model}</option>`).join('');
                                modelSelect.disabled = false;
                                if (settings[providerSelectedModelKey]) {
                                    modelSelect.value = settings[providerSelectedModelKey];
                                }
                                console.log(`æ¢å¤${currentProvider}çš„æ¨¡å‹é€‰æ‹©:`, settings[providerSelectedModelKey]);
                            } else if (settings.models && settings.models.length > 0) {
                                // å‘åå…¼å®¹ï¼šå¦‚æœæ²¡æœ‰æœåŠ¡å•†ç‰¹å®šçš„æ¨¡å‹ï¼Œä½¿ç”¨é€šç”¨çš„æ¨¡å‹åˆ—è¡¨
                                modelSelect.innerHTML = settings.models.map(model => `<option value="${model}">${model}</option>`).join('');
                                modelSelect.disabled = false;
                                if (settings.selectedModel) {
                                    modelSelect.value = settings.selectedModel;
                                }
                                console.log('ä½¿ç”¨é€šç”¨æ¨¡å‹é€‰æ‹©:', settings.selectedModel);
                            }

                            settingsStatus.textContent = 'å·²åŠ è½½ä¿å­˜çš„è®¾ç½®';
                            setTimeout(() => settingsStatus.textContent = '', 3000);
                            validateForm();
                        }

                        // æ›´æ–°API Keyæ˜¾ç¤ºå’ŒæŒ‰é’®çŠ¶æ€
                        updateApiKeyVisibility();
                    } catch (error) {
                        console.error('åŠ è½½è®¾ç½®å¤±è´¥:', error);
                        settingsStatus.textContent = 'åŠ è½½è®¾ç½®å¤±è´¥';
                        settingsStatus.style.color = 'red';
                        setTimeout(() => {
                            settingsStatus.textContent = '';
                            settingsStatus.style.color = '';
                        }, 3000);
                    }
                }

                function saveSettings() {
                    try {
                        // è·å–ç°æœ‰è®¾ç½®
                        const existingSettings = localStorage.getItem('travelPlannerSettings');
                        const settings = existingSettings ? JSON.parse(existingSettings) : {};

                        // æ›´æ–°åŸºæœ¬è®¾ç½®
                        settings.geminiApiKey = geminiApiKeyInput.value;
                        settings.openaiApiKey = openaiApiKeyInput.value;
                        settings.deepseekApiKey = deepseekApiKeyInput.value;
                        settings.customApiKey = customApiKeyInput.value;
                        settings.apiProvider = apiProviderSelect.value;
                        settings.customEndpoint = customEndpointInput.value;
                        // ä¿å­˜è‡ªå®šä¹‰é‰´æƒå¤´è®¾ç½®
                        const customAuthHeaderNameInput = document.getElementById('custom-auth-header-name');
                        const customAuthHeaderValueInput = document.getElementById('custom-auth-header-value');
                        settings.customAuthHeaderName = customAuthHeaderNameInput ? customAuthHeaderNameInput.value : '';
                        settings.customAuthHeaderValue = customAuthHeaderValueInput ? customAuthHeaderValueInput.value : '';
                        settings.searchApiKey = searchApiKeyInput.value;
                        settings.enableSearch = enableSearchCheckbox.checked;

                        // ä¸ºå½“å‰æœåŠ¡å•†ä¿å­˜æ¨¡å‹åˆ—è¡¨
                        const currentProvider = apiProviderSelect.value;
                        const providerModelsKey = `${currentProvider}_models`;
                        const providerSelectedModelKey = `${currentProvider}_selectedModel`;

                        settings[providerModelsKey] = Array.from(modelSelect.options).map(option => option.value);
                        settings[providerSelectedModelKey] = modelSelect.value;

                        // ä¿æŒå‘åå…¼å®¹
                        settings.models = Array.from(modelSelect.options).map(option => option.value);
                        settings.selectedModel = modelSelect.value;

                        localStorage.setItem('travelPlannerSettings', JSON.stringify(settings));
                        settingsStatus.textContent = 'è®¾ç½®å·²ä¿å­˜';
                        settingsStatus.style.color = 'green';
                        setTimeout(() => {
                            settingsStatus.textContent = '';
                            settingsStatus.style.color = '';
                        }, 3000);
                    } catch (error) {
                        console.error('ä¿å­˜è®¾ç½®å¤±è´¥:', error);
                        settingsStatus.textContent = 'ä¿å­˜è®¾ç½®å¤±è´¥';
                        settingsStatus.style.color = 'red';
                        setTimeout(() => {
                            settingsStatus.textContent = '';
                            settingsStatus.style.color = '';
                        }, 3000);
                    }
                }

                function clearSettings() {
                    try {
                        localStorage.removeItem('travelPlannerSettings');

                        // æ¸…é™¤è¡¨å•
                        geminiApiKeyInput.value = '';
                        openaiApiKeyInput.value = '';
                        deepseekApiKeyInput.value = '';
                        customApiKeyInput.value = '';
                        apiProviderSelect.value = 'gemini';
                        customEndpointInput.value = '';
                        searchApiKeyInput.value = '';
                        enableSearchCheckbox.checked = true;
                        modelSelect.innerHTML = '<option>è¯·å…ˆè¾“å…¥Keyå¹¶æ‹‰å–æ¨¡å‹</option>';
                        modelSelect.disabled = true;
                        apiStatus.textContent = '';

                        // æ›´æ–°UI
                        updateCustomEndpointVisibility();
                        updateGeminiSearchUI();
                        // ç¦ç”¨æ‰€æœ‰â€œæ‹‰å–æ¨¡å‹â€æŒ‰é’®
                        fetchModelsBtns.forEach(btn => btn.disabled = true);

                        settingsStatus.textContent = 'è®¾ç½®å·²æ¸…é™¤';
                        settingsStatus.style.color = 'orange';
                        setTimeout(() => {
                            settingsStatus.textContent = '';
                            settingsStatus.style.color = '';
                        }, 3000);
                    } catch (error) {
                        console.error('æ¸…é™¤è®¾ç½®å¤±è´¥:', error);
                        settingsStatus.textContent = 'æ¸…é™¤è®¾ç½®å¤±è´¥';
                        settingsStatus.style.color = 'red';
                        setTimeout(() => {
                            settingsStatus.textContent = '';
                            settingsStatus.style.color = '';
                        }, 3000);
                    }
                }

                // åˆå§‹åŒ–å¯ç¼–è¾‘å…ƒç´ 
                function initializeEditableElements() {
                    // è‡ªåŠ¨è°ƒæ•´textareaé«˜åº¦
                    const textareas = document.querySelectorAll('.editable-mission, .editable-funfact, .editable-challenge, .editable-knowledge, .editable-story, .editable-prompt, .editable-journal');
                    textareas.forEach(textarea => {
                        // åˆå§‹åŒ–é«˜åº¦
                        textarea.style.height = 'auto';
                        textarea.style.height = textarea.scrollHeight + 'px';

                        // æ·»åŠ è¾“å…¥äº‹ä»¶ç›‘å¬
                        textarea.addEventListener('input', function() {
                            this.style.height = 'auto';
                            this.style.height = this.scrollHeight + 'px';
                        });
                    });

                    // è‡ªåŠ¨è°ƒæ•´inputå®½åº¦
                    const inputs = document.querySelectorAll('.editable-title, .editable-info, .editable-topic');
                    inputs.forEach(input => {
                        // åˆå§‹åŒ–å®½åº¦
                        adjustInputWidth(input);

                        // æ·»åŠ è¾“å…¥äº‹ä»¶ç›‘å¬
                        input.addEventListener('input', function() {
                            adjustInputWidth(this);
                        });
                    });

                    // åˆå§‹åŒ–äº¤äº’å…ƒç´ ï¼ˆç”»å¸ƒç­‰ï¼‰
                    const canvases = document.querySelectorAll('.drawing-area canvas');
                    canvases.forEach(canvas => {
                        const ctx = canvas.getContext('2d');
                        ctx.strokeStyle = '#000';
                        ctx.lineWidth = 3;
                        ctx.lineCap = 'round';

                        let isDrawing = false;

                        canvas.addEventListener('mousedown', (e) => {
                            isDrawing = true;
                            const rect = canvas.getBoundingClientRect();
                            const x = e.clientX - rect.left;
                            const y = e.clientY - rect.top;
                            ctx.beginPath();
                            ctx.moveTo(x, y);
                        });

                        canvas.addEventListener('mousemove', (e) => {
                            if (!isDrawing) return;
                            const rect = canvas.getBoundingClientRect();
                            const x = e.clientX - rect.left;
                            const y = e.clientY - rect.top;
                            ctx.lineTo(x, y);
                            ctx.stroke();
                        });

                        canvas.addEventListener('mouseup', () => {
                            isDrawing = false;
                        });

                        canvas.addEventListener('mouseout', () => {
                            isDrawing = false;
                        });
                    });
                }

                function adjustInputWidth(input) {
                    // åˆ›å»ºä¸´æ—¶å…ƒç´ æ¥æµ‹é‡æ–‡æœ¬å®½åº¦
                    const temp = document.createElement('span');
                    temp.style.visibility = 'hidden';
                    temp.style.position = 'absolute';
                    temp.style.fontSize = window.getComputedStyle(input).fontSize;
                    temp.style.fontFamily = window.getComputedStyle(input).fontFamily;
                    temp.style.fontWeight = window.getComputedStyle(input).fontWeight;
                    temp.textContent = input.value || input.placeholder;
                    document.body.appendChild(temp);

                    const width = Math.max(temp.offsetWidth + 20, parseInt(input.style.minWidth) || 100);
                    input.style.width = width + 'px';

                    document.body.removeChild(temp);
                }

                // æŠ˜å åŠŸèƒ½
                function initializeCollapsible() {
                    const formBlocks = document.querySelectorAll('.form-block');

                    formBlocks.forEach((block, index) => {
                        const header = block.querySelector('h3');
                        const content = block.querySelector('.form-block-content');

                        if (header && content) {
                            // AIåŠ©æ‰‹(index=0)é»˜è®¤æŠ˜å ï¼Œç¬¬ä¸€æ­¥(index=1)é»˜è®¤å±•å¼€ï¼Œå…¶ä»–æŠ˜å 
                            if (index !== 1) {
                                block.classList.add('collapsed');
                            }

                            header.addEventListener('click', () => {
                                block.classList.toggle('collapsed');

                                // å¹³æ»‘åŠ¨ç”»
                                if (block.classList.contains('collapsed')) {
                                    content.style.maxHeight = '0px';
                                } else {
                                    content.style.maxHeight = content.scrollHeight + 'px';

                                    // åŠ¨ç”»å®Œæˆåç§»é™¤maxHeighté™åˆ¶
                                    setTimeout(() => {
                                        if (!block.classList.contains('collapsed')) {
                                            content.style.maxHeight = 'none';
                                        }
                                    }, 300);
                                }
                            });

                            // è®¾ç½®åˆå§‹çŠ¶æ€
                            if (block.classList.contains('collapsed')) {
                                content.style.maxHeight = '0px';
                            } else {
                                content.style.maxHeight = 'none';
                            }
                        }
                    });
                }

                // åˆå§‹åŒ–
                document.addEventListener('DOMContentLoaded', () => {
                    console.log('DOM loaded, initializing...');
                    loadSettings();
                    setupEventListeners();
                    updateFormForTripType();
                    updateFormForUsageMode();
                    updateGeminiSearchUI();
                    updateCustomEndpointVisibility();
                    updateMainTransportUI();
                    updateOptionStyles();
                    initializeCollapsible();

                    // åˆå§‹åŒ–API Keyæ˜¾ç¤ºå’ŒæŒ‰é’®çŠ¶æ€
                    updateApiKeyVisibility();
                    console.log('API Key present:', !!getCurrentApiKey());
                    const activeBtn = getActiveFetchButton();
                    console.log('Active fetch button disabled:', activeBtn ? activeBtn.disabled : 'N/A');
                    // å¼ºåˆ¶åˆ·æ–°ä¸€æ¬¡æŒ‰é’®çŠ¶æ€ï¼Œè¦†ç›–è‡ªåŠ¨å¡«å……ç­‰æƒ…å†µ
                    updateFetchButtonState();

                    console.log('Initialization complete');
                });

                // è¡¨å•æäº¤å¤„ç†
                async function handleFormSubmit(e) {
                    e.preventDefault();

                    // éªŒè¯å¿…å¡«å­—æ®µ
                    const apiKey = getCurrentApiKey();
                    const selectedModel = modelSelect.value;
                    const provider = apiProviderSelect.value;

                    if (!apiKey) {
                        showError('è¯·è¾“å…¥API Key');
                        return;
                    }

                    if (!selectedModel || selectedModel === 'è¯·å…ˆè¾“å…¥Keyå¹¶æ‹‰å–æ¨¡å‹') {
                        showError('è¯·å…ˆæ‹‰å–å¹¶é€‰æ‹©æ¨¡å‹');
                        return;
                    }

                    // æ”¶é›†è¡¨å•æ•°æ®
                    const formData = collectFormData();
                    if (!formData) return; // éªŒè¯å¤±è´¥

                    // æ˜¾ç¤ºè½½å…¥çŠ¶æ€
                    showLoading();

                    try {
                        // ç”Ÿæˆæç¤ºè¯
                        const prompt = generatePrompt(formData);

                        // è°ƒç”¨AI API
                        const response = await callAI(apiKey, selectedModel, prompt, provider);
                        console.log('AI Response:', response);

                        // è§£æå“åº”
                        let planData;
                        console.log('åŸå§‹AIå“åº”é•¿åº¦:', response.length);
                        console.log('åŸå§‹AIå“åº”å‰500å­—ç¬¦:', response.substring(0, 500));

                        try {
                            // å°è¯•ç›´æ¥è§£æä¸ºJSON
                            planData = JSON.parse(response);
                            console.log('ç›´æ¥JSONè§£ææˆåŠŸ');
                        } catch (e) {
                            console.log('ç›´æ¥JSONè§£æå¤±è´¥ï¼Œå°è¯•å…¶ä»–æ–¹æ³•...');

                            // æ–¹æ³•1: æå–æœ€å¤§çš„JSONå¯¹è±¡
                            let jsonMatch = response.match(/\{[\s\S]*\}/);
                            if (jsonMatch) {
                                try {
                                    planData = JSON.parse(jsonMatch[0]);
                                    console.log('æå–JSONå¯¹è±¡æˆåŠŸ');
                                } catch (e2) {
                                    console.log('æå–çš„JSONå¯¹è±¡è§£æå¤±è´¥ï¼Œå°è¯•æ¸…ç†...');

                                    // æ–¹æ³•2: æ¸…ç†å¸¸è§çš„éJSONå†…å®¹
                                    let cleanedResponse = response
                                        .replace(/```json\s*/gi, '')  // ç§»é™¤markdownä»£ç å—æ ‡è®°
                                        .replace(/```\s*/gi, '')      // ç§»é™¤markdownä»£ç å—ç»“æŸæ ‡è®°
                                        .replace(/^[^{]*/, '')        // ç§»é™¤å¼€å¤´çš„éJSONå†…å®¹
                                        .replace(/[^}]*$/, '}')       // ç¡®ä¿ä»¥}ç»“å°¾
                                        .trim();

                                    try {
                                        planData = JSON.parse(cleanedResponse);
                                        console.log('æ¸…ç†åJSONè§£ææˆåŠŸ');
                                    } catch (e3) {
                                        console.log('æ¸…ç†åä»ç„¶è§£æå¤±è´¥ï¼Œå°è¯•æŸ¥æ‰¾JSONæ•°ç»„...');

                                        // æ–¹æ³•3: æŸ¥æ‰¾JSONæ•°ç»„
                                        const arrayMatch = response.match(/\[[\s\S]*\]/);
                                        if (arrayMatch) {
                                            try {
                                                const arrayData = JSON.parse(arrayMatch[0]);
                                                planData = { itinerary: arrayData };
                                                console.log('JSONæ•°ç»„è§£ææˆåŠŸï¼ŒåŒ…è£…ä¸ºå¯¹è±¡');
                                            } catch (e4) {
                                                console.error('æ‰€æœ‰è§£ææ–¹æ³•éƒ½å¤±è´¥äº†');
                                                console.error('åŸå§‹å“åº”:', response);
                                                throw new Error(`AIè¿”å›çš„å†…å®¹ä¸æ˜¯æœ‰æ•ˆçš„JSONæ ¼å¼ã€‚å“åº”å†…å®¹: ${response.substring(0, 200)}...`);
                                            }
                                        } else {
                                            console.error('æœªæ‰¾åˆ°æœ‰æ•ˆçš„JSONç»“æ„');
                                            console.error('åŸå§‹å“åº”:', response);
                                            throw new Error(`AIè¿”å›çš„å†…å®¹ä¸­æ²¡æœ‰æ‰¾åˆ°JSONæ ¼å¼çš„æ•°æ®ã€‚å“åº”å†…å®¹: ${response.substring(0, 200)}...`);
                                        }
                                    }
                                }
                            } else {
                                console.error('æœªæ‰¾åˆ°JSONå¯¹è±¡');
                                console.error('åŸå§‹å“åº”:', response);
                                throw new Error(`AIè¿”å›çš„å†…å®¹ä¸­æ²¡æœ‰æ‰¾åˆ°JSONæ ¼å¼çš„æ•°æ®ã€‚å“åº”å†…å®¹: ${response.substring(0, 200)}...`);
                            }
                        }

                        // æ¸²æŸ“è®¡åˆ’
                        renderPlan(planData);

                        // åˆå§‹åŒ–å¯ç¼–è¾‘å…ƒç´ 
                        initializeEditableElements();

                        // éšè—åŠ è½½çŠ¶æ€ï¼Œæ˜¾ç¤ºç»“æœ
                        hideLoading();
                        showPlanOutput();

                    } catch (error) {
                        console.error('ç”Ÿæˆè®¡åˆ’å¤±è´¥:', error);
                        hideLoading();
                        showError(`ç”Ÿæˆå¤±è´¥: ${error.message}`);
                    }
                }

                // æ”¶é›†è¡¨å–®æ•¸æ“š
                function collectFormData() {
                    const tripType = document.querySelector('input[name="trip-type"]:checked')?.value;
                    const language = document.querySelector('input[name="language"]:checked')?.value;
                    const usageMode = document.querySelector('input[name="usage-mode"]:checked')?.value;

                    let destination = '';
                    let duration = '';

                    if (tripType === 'multi-city') {
                        const cities = Array.from(document.querySelectorAll('#multi-city-container .list-item')).map(item => {
                            const cityInput = item.querySelector('.city-name') || item.querySelector('input[type="text"]');
                            const durationInput = item.querySelector('.city-duration');
                            return {
                                city: cityInput?.value?.trim() || '',
                                duration: parseInt(durationInput?.value) || 1
                            };
                        }).filter(city => city.city);

                        if (cities.length === 0) {
                            showError('è¯·è‡³å°‘æ·»åŠ ä¸€ä¸ªåŸå¸‚');
                            return null;
                        }

                        destination = cities.map(c => c.city).join('ã€');
                        duration = cities.reduce((sum, c) => sum + c.duration, 0);
                    } else {
                        destination = destinationInput.value.trim();
                        duration = parseInt(document.getElementById('duration')?.value) || 1;

                        if (!destination) {
                            showError('è¯·è¾“å…¥ç›®çš„åœ°');
                            return null;
                        }
                    }

                    // æ”¶é›†å®¶åº­æˆå“¡
                    const familyMembers = Array.from(document.querySelectorAll('#family-list .list-item')).map(item => {
                        const nameInput = item.querySelector('.member-name') || item.querySelector('input[type="text"]');
                        const ageInput = item.querySelector('.member-age') || item.querySelector('input[type="number"]');
                        return {
                            name: nameInput?.value?.trim() || '',
                            age: parseInt(ageInput?.value) || 0
                        };
                    }).filter(member => member.name);

                    // æ”¶é›†å…´è¶£çˆ±å¥½
                    const interests = Array.from(document.querySelectorAll('input[name="interests"]:checked')).map(input => input.value);

                    // æ”¶é›†ç‰¹æ®Šéœ€æ±‚
                    const specialNeeds = Array.from(document.querySelectorAll('input[name="special-needs"]:checked')).map(input => input.value);

                    // æ”¶é›†å…¶ä»–åå¥½
                    const otherPreferences = document.getElementById('other-preferences')?.value?.trim() || '';

                    // æ”¶é›†å­£èŠ‚ä¿¡æ¯
                    const season = document.querySelector('input[name="season"]:checked')?.value || 'æ˜¥å­£';

                    return {
                        tripType,
                        language,
                        usageMode,
                        destination,
                        duration,
                        familyMembers,
                        interests,
                        specialNeeds,
                        otherPreferences,
                        season,
                        enableSearch: enableSearchCheckbox.checked,
                        searchApiKey: searchApiKeyInput.value.trim()
                    };
                }

                // è·å–è¡¨å•å¿«ç…§ï¼ˆç”¨äºæ¸²æŸ“è®¡åˆ’ï¼‰
                function getFormSnapshot() {
                    const tripType = document.querySelector('input[name="trip-type"]:checked')?.value;
                    let destination = '';
                    let tripDuration = '';

                    if (tripType === 'multi-city') {
                        const cities = Array.from(document.querySelectorAll('#multi-city-container .list-item')).map(item => {
                            const cityInput = item.querySelector('.city-name') || item.querySelector('input[type="text"]');
                            const durationInput = item.querySelector('.city-duration');
                            return {
                                city: cityInput?.value?.trim() || '',
                                duration: parseInt(durationInput?.value) || 1
                            };
                        }).filter(city => city.city);

                        destination = cities.map(c => c.city).join('ã€');
                        tripDuration = cities.reduce((sum, c) => sum + c.duration, 0);
                    } else {
                        destination = destinationInput.value.trim();
                        tripDuration = parseInt(document.getElementById('duration')?.value) || 1;
                    }

                    // æ”¶é›†å®¶åº­æˆå“¡
                    const familyMembers = Array.from(document.querySelectorAll('#family-list .list-item')).map(item => {
                        const nameInput = item.querySelector('.member-name') || item.querySelector('input[type="text"]');
                        const ageInput = item.querySelector('.member-age') || item.querySelector('input[type="number"]');
                        return {
                            name: nameInput?.value?.trim() || '',
                            age: parseInt(ageInput?.value) || 0
                        };
                    }).filter(member => member.name);

                    return {
                        destination,
                        familyMembers,
                        tripDuration
                    };
                }

                // éªŒè¯è¡¨å•å¹¶æ›´æ–°æäº¤æŒ‰é’®çŠ¶æ€
                function validateForm() {
                    const apiKey = getCurrentApiKey();
                    const selectedModel = modelSelect.value;
                    const destination = destinationInput.value.trim();

                    const isValid = apiKey &&
                                   selectedModel &&
                                   selectedModel !== 'è¯·å…ˆè¾“å…¥Keyå¹¶æ‹‰å–æ¨¡å‹' &&
                                   destination;

                    submitBtn.disabled = !isValid;
                }

                // æ›´æ–°é€‰é¡¹æ ·å¼
                function updateOptionStyles() {
                    // æ›´æ–°æ‰€æœ‰radioå’Œcheckboxçš„é¸ä¸­æ¨£å¼
                    document.querySelectorAll('.icon-options input[type="radio"], .icon-options input[type="checkbox"]').forEach(input => {
                        const label = input.closest('label');
                        if (input.checked) {
                            label.classList.add('selected');
                        } else {
                            label.classList.remove('selected');
                        }
                    });
                }

                // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
                function setupEventListeners() {
                    // ä¸ºæ‰€æœ‰API Keyè¾“å…¥æ¡†æ·»åŠ äº‹ä»¶ç›‘å¬
                    [geminiApiKeyInput, openaiApiKeyInput, deepseekApiKeyInput, customApiKeyInput].forEach(input => {
                        ['input','change','paste','keyup','blur'].forEach(evt => {
                            input.addEventListener(evt, () => {
                                updateFetchButtonState();
                                validateForm();
                                // å¤‡æ³¨ï¼šç”¨æˆ·è¦æ±‚é™¤ Gemini å¤–çš„å…¶ä»–ä»¤ç‰Œä¹Ÿåº”è‡ªåŠ¨ä¿å­˜ï¼Œè¿™é‡Œåœ¨è¾“å…¥é˜¶æ®µå³ä¿å­˜
                                saveSettings();
                            });
                        });
                    });

                    // ç»‘å®šæ‰€æœ‰â€œæ‹‰å–æ¨¡å‹â€æŒ‰é’®ç‚¹å‡»äº‹ä»¶
                    fetchModelsBtns.forEach(btn => btn.addEventListener('click', fetchModels));
                    clearSettingsBtn.addEventListener('click', clearSettings);

                    // æœåŠ¡å•†åˆ‡æ¢æ—¶ä¹Ÿç«‹å³ä¿å­˜ï¼Œä¿è¯å½“å‰æä¾›å•†ä¸ç›¸å…³KeyæŒä¹…åŒ–
                    apiProviderSelect.addEventListener('change', () => {
                        updateApiKeyVisibility();
                        updateCustomEndpointVisibility();
                        updateGeminiSearchUI();
                        updateMainTransportUI();
                        updateOptionStyles();
                        updateFetchButtonState();

                        // å°è¯•æ¢å¤è¯¥æœåŠ¡å•†çš„æ¨¡å‹åˆ—è¡¨
                        const savedSettings = localStorage.getItem('travelPlannerSettings');
                        if (savedSettings) {
                            const settings = JSON.parse(savedSettings);
                            const currentProvider = apiProviderSelect.value;
                            const providerModelsKey = `${currentProvider}_models`;
                            const providerSelectedModelKey = `${currentProvider}_selectedModel`;

                            if (settings[providerModelsKey] && settings[providerModelsKey].length > 0) {
                                modelSelect.innerHTML = settings[providerModelsKey].map(model => `<option value="${model}">${model}</option>`).join('');
                                modelSelect.disabled = false;
                                if (settings[providerSelectedModelKey]) {
                                    modelSelect.value = settings[providerSelectedModelKey];
                                }
                                apiStatus.textContent = `å·²æ¢å¤ ${settings[providerModelsKey].length} ä¸ªæ¨¡å‹`;
                            } else {
                                modelSelect.innerHTML = '<option>è¯·å…ˆè¾“å…¥Keyå¹¶æ‹‰å–æ¨¡å‹</option>';
                                modelSelect.disabled = true;
                                apiStatus.textContent = '';
                            }
                        } else {
                            modelSelect.innerHTML = '<option>è¯·å…ˆè¾“å…¥Keyå¹¶æ‹‰å–æ¨¡å‹</option>';
                            modelSelect.disabled = true;
                            apiStatus.textContent = '';
                        }

                        validateForm();
                        saveSettings();
                    });

                    // è‡ªå®šä¹‰ç«¯ç‚¹å˜åŒ–æ—¶ä¹Ÿè¿›è¡Œä¿å­˜
                    ['input','change','blur'].forEach(evt => {
                        customEndpointInput.addEventListener(evt, () => {
                            saveSettings();
                        });
                    });
                    // è‡ªå®šä¹‰é‰´æƒå¤´å˜åŒ–æ—¶ä¹Ÿä¿å­˜
                    const customAuthHeaderNameInput = document.getElementById('custom-auth-header-name');
                    const customAuthHeaderValueInput = document.getElementById('custom-auth-header-value');
                    if (customAuthHeaderNameInput && customAuthHeaderValueInput) {
                        ['input','change','blur'].forEach(evt => {
                            customAuthHeaderNameInput.addEventListener(evt, saveSettings);
                            customAuthHeaderValueInput.addEventListener(evt, saveSettings);
                        });
                    }

                    modelSelect.addEventListener('change', () => {
                        validateForm();
                        saveSettings(); // è‡ªåŠ¨ä¿å­˜é€‰æ‹©çš„æ¨¡å‹
                        console.log('æ¨¡å‹é€‰æ‹©å·²ä¿å­˜:', modelSelect.value);
                    });
                    destinationInput.addEventListener('input', validateForm);
                    enableSearchCheckbox.addEventListener('change', updateGeminiSearchUI);
                    tripTypeSelector.addEventListener('change', () => {
                        updateFormForTripType();
                        updateOptionStyles();
                    });
                    usageModeSelector.addEventListener('change', () => {
                        updateFormForUsageMode();
                        updateOptionStyles();
                    });
                    addCityBtn.addEventListener('click', () => addCityRow());
                    addFamilyBtn.addEventListener('click', () => addFamilyMember());
                    familyList.addEventListener('click', e => {
                        if (e.target.classList.contains('remove-btn')) {
                            e.target.closest('.list-item').remove();
                        }
                    });
                    multiCityContainer.addEventListener('click', e => {
                        if (e.target.classList.contains('remove-btn')) {
                            e.target.closest('.list-item').remove();
                            updateDurationFromCities();
                        }
                    });
                    multiCityContainer.addEventListener('input', e => {
                        if (e.target.classList.contains('city-duration')) {
                            updateDurationFromCities();
                        }
                    });
                    tripForm.addEventListener('submit', handleFormSubmit);

                    // ä¸ºæ‰€æœ‰é€‰é¡¹æ·»åŠ æ ·å¼æ›´æ–°äº‹ä»¶
                    document.addEventListener('change', (e) => {
                        if (e.target.matches('.icon-options input[type="radio"], .icon-options input[type="checkbox"]')) {
                            updateOptionStyles();
                        }
                    });

                    mainTransportRadios.forEach(radio => {
                        radio.addEventListener('change', updateMainTransportUI);
                    });
                }

                // ç”ŸæˆAIæç¤ºè¯
                function generatePrompt(formData) {
                    const { destination, duration, familyMembers, tripType, language, usageMode, enableSearch, interests, specialNeeds, otherPreferences, season } = formData;

                    let prompt = `è¯·ä¸ºæˆ‘è§„åˆ’ä¸€ä¸ª${destination}çš„${duration}å¤©æ—…è¡Œè®¡åˆ’ã€‚`;

                    if (familyMembers.length > 0) {
                        const familyInfo = familyMembers.map(m => `${m.name}(${m.age}å²)`).join('ã€');
                        prompt += `æ—…è¡Œæˆå‘˜ï¼š${familyInfo}ã€‚`;
                    }

                    // æ·»åŠ å­£èŠ‚ä¿¡æ¯
                    if (season) {
                        prompt += `å‡ºè¡Œå­£èŠ‚ï¼š${season}ã€‚`;
                    }

                    // æ·»åŠ å…´è¶£çˆ±å¥½ä¿¡æ¯
                    if (interests && interests.length > 0) {
                        prompt += `æˆ‘ä»¬çš„å…´è¶£çˆ±å¥½ï¼š${interests.join('ã€')}ã€‚`;
                    }

                    // æ·»åŠ ç‰¹æ®Šéœ€æ±‚ä¿¡æ¯
                    if (specialNeeds && specialNeeds.length > 0) {
                        prompt += `ç‰¹æ®Šéœ€æ±‚ï¼š${specialNeeds.join('ã€')}ã€‚`;
                    }

                    // æ·»åŠ å…¶ä»–åå¥½
                    if (otherPreferences) {
                        prompt += `å…¶ä»–åå¥½å’Œè¦æ±‚ï¼š${otherPreferences}ã€‚`;
                    }

                    if (enableSearch) {
                        prompt += 'è¯·æœç´¢æœ€æ–°çš„æ™¯ç‚¹ä¿¡æ¯ã€å¤©æ°”ã€ä»·æ ¼ç­‰å®æ—¶èµ„è®¯ã€‚';
                    }

                    prompt += `

é‡è¦è¯´æ˜ï¼š
1. è¯·å°†æ—…è¡Œè®¡åˆ’åˆ†è§£ä¸ºå…·ä½“çš„åœ°ç‚¹/æ™¯ç‚¹ï¼Œè€Œä¸æ˜¯æŒ‰å¤©åˆ†ç»„
2. æ¯ä¸ªåœ°ç‚¹éƒ½è¦æä¾›ä¸‰ä¸ªç‰ˆæœ¬ï¼šå„¿ç«¥ç‰ˆã€é’å°‘å¹´ç‰ˆã€å®¶é•¿ç‰ˆ
3. è¯·ç¡®ä¿å†…å®¹ä¸°å¯Œä¸”é€‚åˆä¸åŒå¹´é¾„å±‚

**é‡è¦ï¼šè¾“å‡ºæ ¼å¼è¦æ±‚**
1. å¿…é¡»åªè¿”å›çº¯JSONæ ¼å¼ï¼Œä¸è¦åŒ…å«ä»»ä½•è§£é‡Šæ–‡å­—
2. ä¸è¦ä½¿ç”¨markdownä»£ç å—æ ‡è®°ï¼ˆå¦‚\`\`\`jsonï¼‰
3. ä¸è¦åœ¨JSONå‰åæ·»åŠ ä»»ä½•è¯´æ˜æ–‡å­—
4. ç¡®ä¿JSONæ ¼å¼å®Œå…¨æ­£ç¡®ï¼Œå¯ä»¥ç›´æ¥è§£æ

è¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹JSONæ ¼å¼è¿”å›ï¼š

{
  "itinerary": [
    {
      "day": 1,
      "locationName": "å…·ä½“åœ°ç‚¹åç§°ï¼Œä¾‹å¦‚ï¼š'é›·å³°å¡”'",
      "estimatedTime": "å»ºè®®åœç•™æ—¶é—´ï¼Œä¾‹å¦‚ï¼š'1.5å°æ—¶'",
      "childVersion": {
        "title": "é€‚åˆå„¿ç«¥çš„æœ‰è¶£æ ‡é¢˜",
        "missions": ["é€‚åˆå„¿ç«¥çš„ç®€å•ä»»åŠ¡ï¼Œä¸æ­¤åœ°ç‚¹ç›¸å…³"],
        "funFact": "å…³äºæ­¤åœ°çš„æœ‰è¶£äº‹å®ï¼Œæ˜“äºç†è§£",
        "creativePrompt": "ä¸æ­¤åœ°ç‚¹ç›¸å…³çš„ç»˜ç”»æç¤º"
      },
      "teenagerVersion": {
        "title": "é€‚åˆé’å°‘å¹´çš„é…·ç‚«æ ‡é¢˜",
        "challenges": ["é€‚åˆé’å°‘å¹´çš„æ·±åº¦ä»»åŠ¡"],
        "knowledgePlus": "å…³äºæ­¤åœ°çš„æ·±åº¦çŸ¥è¯†",
        "inspirationPrompts": {
          "bgm": "é€‚åˆæ­¤åœ°ç‚¹çš„éŸ³ä¹é£æ ¼æç¤º",
          "colorPalette": ["ä»£è¡¨æ­¤åœ°ç‚¹çš„é¢œè‰²1", "é¢œè‰²2"],
          "reflection": "å¼•å‘æ€è€ƒçš„ä¸€å¥è¯æç¤º"
        }
      },
      "parentVersion": {
        "title": "å®ç”¨çš„åœ°ç‚¹æ ‡é¢˜",
        "practicalInfo": {
          "timing": "å»ºè®®æ—¶é—´ï¼Œä¾‹å¦‚ï¼š'ä¸Šåˆ10:00-11:30'",
          "transport": "äº¤é€šå»ºè®®",
          "tips": "é‡è¦æç¤º"
        },
        "storytellingToolkit": [{"topic": "åœ°ç‚¹ç‰¹è‰²", "story": "å¯ä»¥åˆ†äº«çš„å°æ•…äº‹"}],
        "engagementGuide": [{"prompt": "å¯ä»¥åœ¨æ­¤åœ°ç‚¹é—®å­©å­çš„å¼€æ”¾æ€§é—®é¢˜"}],
        "journalPrompt": "å®¶é•¿åæ€æ­¤åœ°ç‚¹çš„æç¤º"
      }
    }
  ]
}


é‡è¦æé†’ï¼š
- è¯·ç”¨${language}å›åº”
- åªè¿”å›JSONï¼Œä¸è¦ä»»ä½•é¢å¤–æ–‡å­—
- ç¡®ä¿JSONè¯­æ³•å®Œå…¨æ­£ç¡®
- ä¸è¦ä½¿ç”¨markdownæ ¼å¼

ç°åœ¨è¯·å¼€å§‹ç”ŸæˆJSONï¼š`;

                    return prompt;
                }

                // æ˜¾ç¤ºè½½å…¥çŠ¶æ€
                function showLoading() {
                    loadingIndicator.style.display = 'block';
                    inputContainer.style.display = 'none';
                    const generateBtn = document.getElementById('generate-btn');
                    if (generateBtn) {
                        generateBtn.disabled = true;
                        generateBtn.textContent = 'æ­£åœ¨ç”Ÿæˆä¸­...';
                    }
                }

                // éšè—è½½å…¥çŠ¶æ€
                function hideLoading() {
                    loadingIndicator.style.display = 'none';
                    const generateBtn = document.getElementById('generate-btn');
                    if (generateBtn) {
                        generateBtn.disabled = false;
                        generateBtn.textContent = 'ç‚¹æˆ‘ç”Ÿæˆå†’é™©æ‰‹è´¦';
                    }
                }

                // æ˜¾ç¤ºè®¡åˆ’è¾“å‡º
                function showPlanOutput() {
                    planOutput.style.display = 'block';
                    inputContainer.style.display = 'none';
                }

                // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
                function showError(message) {
                    alert(message); // ç®€å•çš„é”™è¯¯æ˜¾ç¤ºï¼Œå¯ä»¥åç»­æ”¹è¿›
                }

                // å¤„ç†æ‰“å°åŠŸèƒ½
                function handlePrint() {
                    window.print();
                }

                // å¤„ç†æ–°è®¡åˆ’åŠŸèƒ½
                function handleNewPlan() {
                    planOutput.style.display = 'none';
                    inputContainer.style.display = 'block';

                    // é‡ç½®è¡¨å•ï¼ˆå¯é€‰ï¼‰
                    // tripForm.reset();
                }

                // UI æ›´æ–°å‡½æ•°
                function updateCustomEndpointVisibility() {
                    customEndpointGroup.style.display = apiProviderSelect.value === 'custom' ? 'block' : 'none';
                }

                function updateGeminiSearchUI() {
                    const isGemini = apiProviderSelect.value === 'gemini';
                    enableSearchCheckbox.disabled = !isGemini;
                    searchApiGroup.style.display = enableSearchCheckbox.checked && isGemini ? 'block' : 'none';
                    searchDescription.textContent = isGemini 
                        ? 'å¼€å¯åAIå°†æœç´¢æœ€æ–°çš„æ™¯ç‚¹ä¿¡æ¯ã€å¤©æ°”ã€ä»·æ ¼ç­‰' 
                        : 'è”ç½‘æœç´¢ä»…æ”¯æŒGoogle Geminiæ¨¡å‹';
                    if (!isGemini) {
                        enableSearchCheckbox.checked = false;
                    }
                }

                function updateMainTransportUI() {
                    const selectedTransport = document.querySelector('input[name="main-transport"]:checked').value;
                    customMainTransportGroup.style.display = selectedTransport === 'å…¶ä»–' ? 'block' : 'none';
                }

                function updateFormForTripType() {
                    const selectedTripType = document.querySelector('input[name="trip-type"]:checked')?.value;
                    console.log('Selected trip type:', selectedTripType);

                    // ä¸€æ—¥æ¸¸å’ŒçŸ­é€”æ—…è¡Œéƒ½æ˜¾ç¤ºå•ä¸€ç›®çš„åœ°è¾“å…¥
                    if (selectedTripType === 'day-trip' || selectedTripType === 'single-city') {
                        singleDestGroup.style.display = 'block';
                        multiCityContainer.style.display = 'none';
                        // æ ¹æ®ç±»å‹è®¾ç½®å¤©æ•°
                        if (selectedTripType === 'day-trip') {
                            durationInput.value = 1;
                            durationInput.readOnly = true;
                        } else {
                            durationInput.readOnly = false;
                        }
                    } else if (selectedTripType === 'multi-city') {
                        singleDestGroup.style.display = 'none';
                        multiCityContainer.style.display = 'block';
                        if (multiCityContainer.children.length <= 1) { // åªæœ‰æ·»åŠ æŒ‰é’®
                            addCityRow();
                        }
                    }
                }

                function updateFormForUsageMode() {
                    const selectedMode = document.querySelector('input[name="usage-mode"]:checked')?.value;
                    if (selectedMode === 'ai-planning') {
                        aiPlanningSection.style.display = 'block';
                        existingPlanSection.style.display = 'none';
                    } else if (selectedMode === 'existing-plan') {
                        aiPlanningSection.style.display = 'none';
                        existingPlanSection.style.display = 'block';
                    }
                }

                function addCityRow(city = '', days = 1) {
                    const cityRow = document.createElement('div');
                    cityRow.className = 'list-item';
                    cityRow.innerHTML = `
                        <input type="text" class="city-name" placeholder="åŸå¸‚åç§°" value="${city}">
                        <input type="number" class="city-duration" placeholder="å¤©æ•°" min="1" value="${days}">
                        <button type="button" class="remove-btn">-</button>
                    `;
                    multiCityContainer.appendChild(cityRow);
                }

                function updateDurationFromCities() {
                    const cityDurations = document.querySelectorAll('.city-duration');
                    const totalDays = Array.from(cityDurations).reduce((sum, input) => sum + (parseInt(input.value, 10) || 0), 0);
                    durationInput.value = totalDays;
                }

                function addFamilyMember() {
                    const memberRow = document.createElement('div');
                    memberRow.className = 'list-item';
                    memberRow.innerHTML = `
                        <input type="text" class="member-name" placeholder="å§“å/ç§°å‘¼">
                        <input type="number" class="member-age" placeholder="å¹´é¾„">
                        <select class="member-gender">
                            <option value="male">ç”·</option>
                            <option value="female">å¥³</option>
                        </select>
                        <button type="button" class="remove-btn">-</button>
                    `;
                    familyList.appendChild(memberRow);
                }

                // -------------------
                // --- API Calls ---
                // -------------------

                async function fetchModels() {
                    console.log('fetchModels called');
                    const apiKey = getCurrentApiKey();
                    const provider = apiProviderSelect.value;
                    console.log('API Key:', apiKey ? 'Present' : 'Missing', 'Provider:', provider);
                    if (!apiKey) {
                        showError('è¯·å…ˆè¾“å…¥API Key');
                        return;
                    }

                    apiStatus.textContent = 'æ­£åœ¨æ‹‰å–æ¨¡å‹...';
                    modelSelect.disabled = true;

                    try {
                        let models = [];
                        if (provider === 'gemini') {
                            models = await getGeminiModels(apiKey);
                        } else {
                            const endpoint = provider === 'custom' ? customEndpointInput.value.trim() : null;
                            console.log('è°ƒè¯•ä¿¡æ¯ - ä»è¾“å…¥æ¡†è·å–çš„ç«¯ç‚¹:', endpoint);
                            console.log('è°ƒè¯•ä¿¡æ¯ - è¾“å…¥æ¡†åŸå§‹å€¼:', customEndpointInput.value);
                            models = await getOpenAICompatibleModels(apiKey, endpoint);
                        }

                        // ä¿å­˜å½“å‰é€‰æ‹©çš„æ¨¡å‹
                        const currentSelectedModel = modelSelect.value;

                        // æ›´æ–°æ¨¡å‹åˆ—è¡¨
                        modelSelect.innerHTML = models.map(model => `<option value="${model}">${model}</option>`).join('');
                        modelSelect.disabled = false;

                        // å°è¯•æ¢å¤ä¹‹å‰é€‰æ‹©çš„æ¨¡å‹
                        if (currentSelectedModel && models.includes(currentSelectedModel)) {
                            modelSelect.value = currentSelectedModel;
                            console.log('æ¢å¤ä¹‹å‰é€‰æ‹©çš„æ¨¡å‹:', currentSelectedModel);
                        } else if (models.length > 0) {
                            // å¦‚æœä¹‹å‰çš„æ¨¡å‹ä¸åœ¨æ–°åˆ—è¡¨ä¸­ï¼Œé€‰æ‹©ç¬¬ä¸€ä¸ªæ¨¡å‹
                            modelSelect.value = models[0];
                            console.log('é€‰æ‹©é»˜è®¤æ¨¡å‹:', models[0]);
                        }

                        apiStatus.textContent = `æˆåŠŸæ‹‰å– ${models.length} ä¸ªæ¨¡å‹`;
                        saveSettings();
                        validateForm();
                    } catch (error) {
                        console.error('Fetch models error:', error);
                        showError(`æ‹‰å–æ¨¡å‹å¤±è´¥: ${error.message}`);
                        apiStatus.textContent = 'æ‹‰å–å¤±è´¥';
                    }
                }

                async function getGeminiModels(apiKey) {
                    try {
                        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${apiKey}`);
                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                        }
                        const data = await response.json();
                        console.log('Gemini API response:', data);
                        console.log('Total models returned:', data.models?.length || 0);

                        if (!data.models || !Array.isArray(data.models)) {
                            throw new Error('Invalid response format from Gemini API');
                        }

                        // æ˜¾ç¤ºæ‰€æœ‰æ¨¡å‹çš„è¯¦ç»†ä¿¡æ¯
                        data.models.forEach(model => {
                            console.log('Model:', model.name, 'Methods:', model.supportedGenerationMethods);
                        });

                        // ä¸è¿›è¡Œä»»ä½•ç­›é€‰ï¼Œè¿”å›æ‰€æœ‰æ¨¡å‹
                        const models = data.models
                            .map(model => model.name.replace('models/', ''))
                            .sort(); // æŒ‰å­—æ¯é¡ºåºæ’åº

                        console.log('All Gemini models (no filtering):', models);
                        console.log('Total number of models:', models.length);

                        if (models.length === 0) {
                            console.warn('No models found, using fallback list');
                            return [
                                'gemini-1.5-flash-latest',
                                'gemini-1.5-pro-latest',
                                'gemini-1.0-pro',
                                'gemini-1.5-flash',
                                'gemini-1.5-pro',
                                'gemini-pro',
                                'gemini-pro-vision'
                            ];
                        }

                        return models;
                    } catch (error) {
                        console.warn('Failed to fetch Gemini models from API, using fallback list:', error);
                        // å¦‚æœAPIè°ƒç”¨å¤±è´¥ï¼Œè¿”å›å·²çŸ¥çš„æ¨¡å‹åˆ—è¡¨
                        return [
                            'gemini-1.5-flash-latest',
                            'gemini-1.5-pro-latest',
                            'gemini-1.0-pro',
                            'gemini-1.5-flash',
                            'gemini-1.5-pro',
                            'gemini-pro',
                            'gemini-pro-vision'
                        ];
                    }
                }

                async function getOpenAICompatibleModels(apiKey, customEndpoint = null) {
                    let endpoint = (customEndpoint || 'https://api.openai.com/v1').replace(/\/$/, '');

                    // ç‰¹æ®Šå¤„ç†ï¼šå¦‚æœæ˜¯ guqinghan.icu åŸŸåï¼Œå¼ºåˆ¶ä½¿ç”¨ http
                    if (endpoint.includes('guqinghan.icu')) {
                        endpoint = endpoint.replace('https://', 'http://');
                        if (!endpoint.startsWith('http://')) {
                            endpoint = 'http://' + endpoint.replace(/^https?:\/\//, '');
                        }
                    }

                    const url = `${endpoint}/models`;

                    console.log(`æ­£åœ¨ä» ${url} æ‹‰å–æ¨¡å‹...`);
                    console.log(`åŸå§‹ç«¯ç‚¹: ${customEndpoint}, å¤„ç†åç«¯ç‚¹: ${endpoint}, æœ€ç»ˆURL: ${url}`);

                    const fetchConfig = {
                        method: 'GET',
                        mode: 'cors',
                        cache: 'no-cache',
                        headers: {
                            'Accept': 'application/json'
                        }
                    };

                    // æ£€æŸ¥æ˜¯å¦æœ‰è‡ªå®šä¹‰é‰´æƒå¤´é…ç½®
                    const customNameEl = document.getElementById('custom-auth-header-name');
                    const customValEl = document.getElementById('custom-auth-header-value');
                    const customName = customNameEl?.value.trim();
                    const customValTpl = customValEl?.value.trim();

                    if (customName && customValTpl) {
                        // ä¼˜å…ˆä½¿ç”¨ç”¨æˆ·è‡ªå®šä¹‰çš„é‰´æƒå¤´
                        const renderedVal = customValTpl.replaceAll('{key}', apiKey);
                        fetchConfig.headers[customName] = renderedVal;
                        console.log(`ä½¿ç”¨è‡ªå®šä¹‰é‰´æƒå¤´: "${customName}: ${renderedVal.substring(0, 10)}..."`);
                    } else {
                        // å¦åˆ™ï¼Œä½¿ç”¨æ ‡å‡†çš„ Bearer Token é‰´æƒ
                        fetchConfig.headers['Authorization'] = `Bearer ${apiKey}`;
                        console.log(`ä½¿ç”¨æ ‡å‡†é‰´æƒå¤´: "Authorization: Bearer ${apiKey.substring(0, 10)}..."`);
                    }

                    try {
                        const response = await fetch(url, fetchConfig);

                        if (!response.ok) {
                            // å¦‚æœè¯·æ±‚å¤±è´¥ï¼Œå°è¯•è¯»å–æœåŠ¡å™¨è¿”å›çš„é”™è¯¯ä¿¡æ¯
                            let errorBody = 'æ— æ³•è¯»å–é”™è¯¯è¯¦æƒ…';
                            try {
                                const errorJson = await response.json();
                                errorBody = errorJson.error?.message || JSON.stringify(errorJson);
                            } catch (e) {
                                errorBody = await response.text();
                            }
                            throw new Error(`HTTP ${response.status}: ${response.statusText}. è¯¦æƒ…: ${errorBody}`);
                        }

                        const json = await response.json();

                        // å…¼å®¹ä¸¤ç§å¸¸è§çš„è¿”å›ç»“æ„ï¼š{data:[{id}]} æˆ– [{id}]
                        const modelList = Array.isArray(json.data) ? json.data : (Array.isArray(json) ? json : []);

                        if (modelList.length === 0) {
                            console.warn("APIè¿”å›çš„æ¨¡å‹åˆ—è¡¨ä¸ºç©ºï¼Œè¯·æ£€æŸ¥å“åº”:", json);
                        }

                        const allIds = modelList.map(m => m.id).filter(Boolean);
                        console.log('å¯ç”¨æ¨¡å‹åˆ—è¡¨:', allIds);

                        // è¿‡æ»¤æ‰ä¸é€‚åˆèŠå¤©çš„æ¨¡å‹
                        const filteredModels = allIds.filter(id => {
                            const excludePatterns = [
                                'whisper', 'tts', 'dall-e', 'embedding', 'moderation',
                                'text-similarity', 'text-search', 'code-search'
                            ];
                            return !excludePatterns.some(pattern => id.toLowerCase().includes(pattern));
                        });

                        if (filteredModels.length === 0 && allIds.length > 0) {
                             console.log("æ²¡æœ‰æ¨¡å‹è¢«è¿‡æ»¤ï¼Œè¿”å›æ‰€æœ‰æ¨¡å‹ã€‚");
                             return allIds;
                        }

                        console.log('è¿‡æ»¤åçš„æ¨¡å‹:', filteredModels);
                        return filteredModels;

                    } catch (error) {
                        console.error('æ‹‰å–æ¨¡å‹æ—¶å‘ç”Ÿç½‘ç»œæˆ–è§£æé”™è¯¯:', error);
                        // é‡æ–°æŠ›å‡ºé”™è¯¯ï¼Œä»¥ä¾¿ä¸Šå±‚å‡½æ•°å¯ä»¥æ•è·å¹¶æ˜¾ç¤ºç»™ç”¨æˆ·
                        throw new Error(`è¯·æ±‚ ${url} å¤±è´¥ã€‚è¯·æ£€æŸ¥ï¼š\n1. è‡ªå®šä¹‰ç«¯ç‚¹æ˜¯å¦æ­£ç¡®ã€‚\n2. API Key æ˜¯å¦æœ‰æ•ˆã€‚\n3. æµè§ˆå™¨æ§åˆ¶å°çš„ç½‘ç»œè¯·æ±‚è¯¦æƒ…ã€‚é”™è¯¯ä¿¡æ¯: ${error.message}`);
                    }
                }

                async function callAI(apiKey, modelName, prompt, provider) {
                    console.log('å¼€å§‹è°ƒç”¨AI:', { provider, modelName });

                    try {
                        const endpoint = provider === 'custom' ? customEndpointInput.value.trim() : null;
                        if (provider === 'gemini') {
                            return await callGeminiAPI(apiKey, modelName, prompt);
                        } else {
                            return await callOpenAICompatibleAPI(apiKey, modelName, prompt, endpoint);
                        }
                    } catch (error) {
                        console.error('AIè°ƒç”¨å¤±è´¥:', error);
                        throw new Error(`AIè°ƒç”¨å¤±è´¥ (${provider}): ${error.message}`);
                    }
                }

                async function callGeminiAPI(apiKey, modelName, prompt) {
                    const url = `https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${apiKey}`;
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                    });
                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(JSON.stringify(error));
                    }
                    const data = await response.json();
                    return data.candidates[0].content.parts[0].text;
                }

                async function callOpenAICompatibleAPI(apiKey, modelName, prompt, customEndpoint = null) {
                    let endpoint = customEndpoint || 'https://api.openai.com/v1';

                    // ç‰¹æ®Šå¤„ç†ï¼šå¦‚æœæ˜¯ guqinghan.icu åŸŸåï¼Œå¼ºåˆ¶ä½¿ç”¨ http
                    if (endpoint.includes('guqinghan.icu')) {
                        endpoint = endpoint.replace('https://', 'http://');
                        if (!endpoint.startsWith('http://')) {
                            endpoint = 'http://' + endpoint.replace(/^https?:\/\//, '');
                        }
                    }

                    const url = `${endpoint}/chat/completions`;

                    console.log('APIè°ƒç”¨ä¿¡æ¯:', {
                        endpoint: endpoint,
                        url: url,
                        model: modelName,
                        hasApiKey: !!apiKey,
                        promptLength: prompt.length
                    });

                    // å‡†å¤‡è¯·æ±‚ä½“
                    const requestBody = {
                        model: modelName,
                        messages: [{ role: 'user', content: prompt }],
                        temperature: 0.7,
                        stream: false
                    };

                    // åŸºç¡€fetché…ç½®
                    const fetchConfig = {
                        method: 'POST',
                        mode: 'cors',
                        cache: 'no-cache',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        },
                        body: JSON.stringify(requestBody)
                    };

                    // æ£€æŸ¥æ˜¯å¦æœ‰è‡ªå®šä¹‰è®¤è¯å¤´é…ç½®
                    const customNameEl = document.getElementById('custom-auth-header-name');
                    const customValEl = document.getElementById('custom-auth-header-value');
                    const customName = customNameEl?.value.trim();
                    const customValTpl = customValEl?.value.trim();

                    if (customName && customValTpl) {
                        // ä¼˜å…ˆä½¿ç”¨ç”¨æˆ·è‡ªå®šä¹‰çš„é‰´æƒå¤´
                        const renderedVal = customValTpl.replaceAll('{key}', apiKey);
                        fetchConfig.headers[customName] = renderedVal;
                        console.log(`ä½¿ç”¨è‡ªå®šä¹‰é‰´æƒå¤´: "${customName}: ${renderedVal.substring(0, 10)}..."`);
                    } else {
                        // å¦åˆ™ï¼Œä½¿ç”¨æ ‡å‡†çš„ Bearer Token é‰´æƒ
                        fetchConfig.headers['Authorization'] = `Bearer ${apiKey}`;
                        console.log(`ä½¿ç”¨æ ‡å‡†é‰´æƒå¤´: "Authorization: Bearer ${apiKey.substring(0, 10)}..."`);
                    }

                    try {
                        const response = await fetch(url, fetchConfig);

                        if (!response.ok) {
                            // å¦‚æœè¯·æ±‚å¤±è´¥ï¼Œå°è¯•è¯»å–æœåŠ¡å™¨è¿”å›çš„é”™è¯¯ä¿¡æ¯
                            let errorBody = 'æ— æ³•è¯»å–é”™è¯¯è¯¦æƒ…';
                            try {
                                const errorJson = await response.json();
                                errorBody = errorJson.error?.message || JSON.stringify(errorJson);
                            } catch (e) {
                                errorBody = await response.text();
                            }
                            throw new Error(`HTTP ${response.status}: ${response.statusText}. è¯¦æƒ…: ${errorBody}`);
                        }

                        const responseText = await response.text();
                        console.log('Raw response:', responseText);

                        // æ£€æŸ¥æ˜¯å¦æ˜¯SSEæ ¼å¼çš„å“åº”
                        if (responseText.startsWith('data: ')) {
                            // å¤„ç†SSEæ ¼å¼çš„å“åº”
                            const lines = responseText.split('\n');
                            let content = '';
                            for (const line of lines) {
                                if (line.startsWith('data: ')) {
                                    const dataStr = line.substring(6);
                                    if (dataStr === '[DONE]') break;
                                    try {
                                        const data = JSON.parse(dataStr);
                                        if (data.choices && data.choices[0] && data.choices[0].delta && data.choices[0].delta.content) {
                                            content += data.choices[0].delta.content;
                                        }
                                    } catch (e) {
                                        console.warn('Failed to parse SSE line:', line);
                                    }
                                }
                            }
                            return content;
                        } else {
                            // å¤„ç†æ ‡å‡†JSONå“åº”
                            const data = JSON.parse(responseText);
                            return data.choices[0].message.content;
                        }

                    } catch (error) {
                        console.error('APIè°ƒç”¨æ—¶å‘ç”Ÿç½‘ç»œæˆ–è§£æé”™è¯¯:', error);
                        // é‡æ–°æŠ›å‡ºé”™è¯¯ï¼Œä»¥ä¾¿ä¸Šå±‚å‡½æ•°å¯ä»¥æ•è·å¹¶æ˜¾ç¤ºç»™ç”¨æˆ·
                        throw new Error(`è¯·æ±‚ ${url} å¤±è´¥ã€‚è¯·æ£€æŸ¥ï¼š\n1. è‡ªå®šä¹‰ç«¯ç‚¹æ˜¯å¦æ­£ç¡®ã€‚\n2. API Key æ˜¯å¦æœ‰æ•ˆã€‚\n3. æµè§ˆå™¨æ§åˆ¶å°çš„ç½‘ç»œè¯·æ±‚è¯¦æƒ…ã€‚é”™è¯¯ä¿¡æ¯: ${error.message}`);
                    }
                }

                // -------------------
                // --- Plan Rendering ---
                // -------------------

                function renderPlan(data) {
                    if (!data.itinerary || !Array.isArray(data.itinerary)) {
                        console.error("AI's JSON response is missing the 'itinerary' array.", data);
                        showError("AIè¿”å›çš„æ•°æ®æ ¼å¼ä¸æ­£ç¡®ï¼Œç¼ºå°‘ 'itinerary' æ•°ç»„ã€‚");
                        return;
                    }

                    const childView = document.getElementById('child-view-content');
                    const teenagerView = document.getElementById('teenager-view-content');
                    const parentView = document.getElementById('parent-view-content');

                    if (!childView || !teenagerView || !parentView) {
                        showError('æ‰¾ä¸åˆ°ç‰ˆæœ¬å†…å®¹å®¹å™¨');
                        return;
                    }

                    childView.innerHTML = '';
                    teenagerView.innerHTML = '';
                    parentView.innerHTML = '';

                    data.itinerary.forEach((locationData, index) => {
                        childView.innerHTML += renderChildVersion(locationData, index);
                        teenagerView.innerHTML += renderTeenagerVersion(locationData, index);
                        parentView.innerHTML += renderParentVersion(locationData, index);
                    });

                    setupVersionTabs();
                    inputContainer.style.display = 'none';
                    planOutput.style.display = 'block';
                    window.scrollTo(0, 0);
                }

                function setupVersionTabs() {
                    const tabs = document.querySelectorAll('.version-btn');
                    const contents = document.querySelectorAll('.version-content');

                    tabs.forEach(tab => {
                        tab.addEventListener('click', () => {
                            tabs.forEach(t => t.classList.remove('active'));
                            contents.forEach(c => c.classList.remove('active'));
                            tab.classList.add('active');
                            const version = tab.dataset.version;
                            document.getElementById(`${version}-view-content`).classList.add('active');
                        });
                    });
                }

                function renderChildVersion(locationData, index) {
                    const { day, locationName, estimatedTime, childVersion: cv } = locationData;
                    if (!cv) return '';

                    return `
                        <div class="location-page-container">
                            <h1 class="location-title-h1">ğŸ“ ç¬¬ ${index + 1} ç«™: ${locationName}</h1>
                            <h2 class="location-title-h2">(ç¬¬ ${day} å¤© | é¢„è®¡éœ€è¦: ${estimatedTime || 'ä¸€å°ä¼šå„¿'})</h2>

                            <div class="section-container">
                                <h3 class="section-title-h3"><span>ğŸ—ºï¸</span> <input type="text" value="${cv.title || 'æˆ‘çš„å†’é™©ä»»åŠ¡'}" class="editable-title" style="border: none; background: transparent; font-size: inherit; font-weight: inherit; color: inherit; width: auto; min-width: 200px;"></h3>
                                <ul class="mission-list">
                                    ${(cv.missions || []).map((m, i) => `<li class="mission-item">â–¡ <textarea class="editable-mission" style="border: none; background: transparent; resize: none; width: 100%; font-size: inherit; font-family: inherit; color: inherit; overflow: hidden;" rows="1" oninput="this.style.height='auto'; this.style.height=this.scrollHeight+'px'">${m}</textarea></li>`).join('')}
                                </ul>
                            </div>

                            <div class="section-container">
                                <h3 class="section-title-h3"><span>ğŸ’¡</span> è¶£å‘³å°çŸ¥è¯†</h3>
                                <div class="fun-fact-box">
                                    <textarea class="editable-funfact" style="border: none; background: transparent; resize: none; width: 100%; font-size: inherit; font-family: inherit; color: inherit; text-align: center; overflow: hidden;" rows="2" oninput="this.style.height='auto'; this.style.height=this.scrollHeight+'px'">${cv.funFact || 'è¿™é‡Œè—ç€ä»€ä¹ˆç§˜å¯†å‘¢ï¼Ÿ'}</textarea>
                                </div>
                            </div>

                            <div class="section-container">
                                <div class="creative-zone">
                                    <div class="creative-zone-header">ğŸ¨ å„¿ç«¥åˆ›ä½œåŒº</div>
                                    <div class="creative-prompt">${cv.creativePrompt || 'åœ¨è¿™é‡Œç”»ä¸‹ä½ çœ‹åˆ°çš„æœ€é…·çš„ä¸œè¥¿ï¼'}</div>
                                    <div class="drawing-area">
                                        <canvas width="400" height="250"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }

                function renderTeenagerVersion(locationData, index) {
                    const { day, locationName, estimatedTime, teenagerVersion: tv } = locationData;
                    if (!tv) return '';

                    const isValidColor = (str) => {
                        if (!str) return false;
                        const s = new Option().style;
                        s.color = str.toLowerCase();
                        return s.color !== '';
                    };

                    return `
                        <div class="location-page-container">
                            <h1 class="location-title-h1">#${index + 1} ${locationName}</h1>
                            <h2 class="location-title-h2">Day ${day} | Est. ${estimatedTime || 'N/A'}</h2>

                            <div class="section-container">
                                <h3 class="section-title-h3"><span>ğŸ¯</span> <input type="text" value="${tv.title || 'My Challenges'}" class="editable-title" style="border: none; background: transparent; font-size: inherit; font-weight: inherit; color: inherit; width: auto; min-width: 200px;"></h3>
                                ${(tv.challenges || []).map(c => `<p class="teen-mission-item">/ / <textarea class="editable-challenge" style="border: none; background: transparent; resize: none; width: calc(100% - 30px); font-size: inherit; font-family: inherit; color: inherit; overflow: hidden; display: inline;" rows="1" oninput="this.style.height='auto'; this.style.height=this.scrollHeight+'px'">${c}</textarea></p>`).join('')}
                            </div>

                            <div class="section-container">
                                <h3 class="section-title-h3"><span>ğŸ§ </span> Knowledge+</h3>
                                <div class="knowledge-plus-box"><textarea class="editable-knowledge" style="border: none; background: transparent; resize: none; width: 100%; font-size: inherit; font-family: inherit; color: inherit; overflow: hidden;" rows="2" oninput="this.style.height='auto'; this.style.height=this.scrollHeight+'px'">${tv.knowledgePlus || 'Discover something new.'}</textarea></div>
                            </div>

                            <div class="section-container">
                                <h3 class="section-title-h3"><span>âœ¨</span> Inspiration Catcher</h3>
                                <div class="inspiration-grid">
                                    <div class="inspiration-item">
                                        <h4>æ—¶é—´ä¸äº¤é€š</h4>
                                        <p>${tv.inspirationPrompts?.bgm || '...'}</p>
                                    </div>
                                    <div class="inspiration-item">
                                        <h4>Color Palette</h4>
                                        <div class="color-palette">
                                            ${(tv.inspirationPrompts?.colorPalette || []).map(color => {
                                                const bgColor = isValidColor(color) ? color : '#eee';
                                                return `<div class="color-swatch" title="${color}" style="background-color:${bgColor}; border: 1px solid #ddd;"></div>`;
                                            }).join('')}
                                        </div>
                                    </div>
                                    <div class="inspiration-item">
                                        <h4>Reflection</h4>
                                        <p>${tv.inspirationPrompts?.reflection || '...'}</p>
                                    </div>
                                </div>
                            </div>

                            <div class="section-container">
                                 <div class="free-space-zone">
                                     <div class="free-space-header">âœï¸ Free Space</div>
                                     <div class="drawing-area">
                                         <canvas width="400" height="250"></canvas>
                                     </div>
                                 </div>
                            </div>
                        </div>
                    `;
                }

                function renderParentVersion(locationData, index) {
                    const { day, locationName, estimatedTime, parentVersion: pv } = locationData;
                    if (!pv) return '';

                    return `
                        <div class="location-page-container">
                            <h1 class="location-title-h1">ç¬¬ ${index + 1} ç«™: ${locationName}</h1>
                            <h2 class="location-title-h2">(ç¬¬ ${day} å¤© | å‚è€ƒç”¨æ—¶: ${estimatedTime || 'çµæ´»å®‰æ’'})</h2>

                            <div class="section-container">
                                <h3 class="section-title-h3"><span>ğŸ“‹</span> <input type="text" value="${pv.title || 'å®ç”¨ä¿¡æ¯'}" class="editable-title" style="border: none; background: transparent; font-size: inherit; font-weight: inherit; color: inherit; width: auto; min-width: 200px;"></h3>
                                <div class="practical-info-box">
                                    <ul>
                                        <li><strong>å»ºè®®æ—¶é—´:</strong> <input type="text" value="${pv.practicalInfo?.timing || 'çµæ´»å®‰æ’'}" class="editable-info" style="border: none; background: transparent; font-size: inherit; font-family: inherit; color: inherit; width: auto; min-width: 150px;"></li>
                                        <li><strong>äº¤é€šå»ºè®®:</strong> <input type="text" value="${pv.practicalInfo?.transport || 'æ ¹æ®å®é™…æƒ…å†µé€‰æ‹©'}" class="editable-info" style="border: none; background: transparent; font-size: inherit; font-family: inherit; color: inherit; width: auto; min-width: 200px;"></li>
                                        <li><strong>é‡è¦æç¤º:</strong> <input type="text" value="${pv.practicalInfo?.tips || 'æ— '}" class="editable-info" style="border: none; background: transparent; font-size: inherit; font-family: inherit; color: inherit; width: auto; min-width: 150px;"></li>
                                    </ul>
                                </div>
                            </div>

                            <div class="section-container">
                                <h3 class="section-title-h3"><span>ğŸ™ï¸</span> æ•…äº‹å®åº“</h3>
                                ${(pv.storytellingToolkit || []).map(s => `
                                    <div class="storytelling-item">
                                        <h4><input type="text" value="${s.topic}" class="editable-topic" style="border: none; background: transparent; font-size: inherit; font-weight: inherit; color: inherit; width: 100%;"></h4>
                                        <textarea class="editable-story" style="border: none; background: transparent; resize: none; width: 100%; font-size: inherit; font-family: inherit; color: inherit; overflow: hidden;" rows="3" oninput="this.style.height='auto'; this.style.height=this.scrollHeight+'px'">${s.story}</textarea>
                                    </div>
                                `).join('')}
                            </div>

                            <div class="section-container">
                                <h3 class="section-title-h3"><span>ğŸ¤</span> äº’åŠ¨æŒ‡å—</h3>
                                 ${(pv.engagementGuide || []).map(e => `
                                    <div class="engagement-item">
                                        <p>ğŸ’¡ <textarea class="editable-prompt" style="border: none; background: transparent; resize: none; width: calc(100% - 30px); font-size: inherit; font-family: inherit; color: inherit; overflow: hidden; display: inline;" rows="1" oninput="this.style.height='auto'; this.style.height=this.scrollHeight+'px'">${e.prompt}</textarea></p>
                                    </div>
                                `).join('')}
                            </div>

                            <div class="section-container">
                                <h3 class="section-title-h3"><span>ğŸ“”</span> ä»Šæ—¥æ‰‹è®°</h3>
                                <div class="journal-space">
                                    <textarea class="editable-journal" style="border: none; background: transparent; resize: none; width: 100%; font-size: inherit; font-family: inherit; color: inherit; overflow: hidden; min-height: 100px;" rows="4" oninput="this.style.height='auto'; this.style.height=this.scrollHeight+'px'">${pv.journalPrompt || 'è®°å½•ä¸‹åœ¨è¿™é‡Œçš„ç¾å¥½ç¬é—´...'}</textarea>
                                </div>
                            </div>
                        </div>
                    `;
                }

                function generateTravelPlanHTML(tripPlan, destination, familyMembers, tripDuration) {
                    const familyNames = familyMembers.map(m => m.name).join('ã€') || 'æˆ‘ä»¬';

                    let html = `
                        <div class="travel-plan-container">
                            <div class="plan-header">
                                <h1>ğŸŒŸ ${destination} æ—…è¡Œè®¡åˆ’</h1>
                                <div class="plan-info">
                                    <p><strong>ç›®çš„åœ°:</strong> ${destination}</p>
                                    <p><strong>æ—…è¡Œå¤©æ•°:</strong> ${tripDuration}å¤©</p>
                                    <p><strong>æ—…è¡Œæˆå‘˜:</strong> ${familyNames}</p>
                                </div>
                            </div>

                            <div class="plan-content">
                    `;

                    // ç”Ÿæˆæ¯æ—¥è¡Œç¨‹
                    tripPlan.forEach(dayData => {
                        html += `
                            <div class="day-plan">
                                <h2>ç¬¬${dayData.day}å¤©: ${dayData.theme || dayData.parentVersion?.title || dayData.childVersion?.title || ''}</h2>

                                <div class="day-sections">
                                    <!-- å®¶é•¿ç‰ˆæœ¬ -->
                                    <div class="parent-section">
                                        <h3>ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ å®¶é•¿ç‰ˆ</h3>
                                        <h4>${dayData.parentVersion?.title || ''}</h4>

                                        ${dayData.parentVersion?.activities ? `
                                            <div class="activities">
                                                <h5>ğŸ—“ï¸ æ´»åŠ¨å®‰æ’</h5>
                                                <ul>
                                                    ${dayData.parentVersion.activities.map(activity => `<li>${activity}</li>`).join('')}
                                                </ul>
                                            </div>
                                        ` : ''}

                                        ${dayData.parentVersion?.tips ? `
                                            <div class="tips">
                                                <h5>ğŸ’¡ è´´å£«</h5>
                                                <ul>
                                                    ${dayData.parentVersion.tips.map(tip => `<li>${tip}</li>`).join('')}
                                                </ul>
                                            </div>
                                        ` : ''}
                                    </div>

                                    <!-- å„¿ç«¥ç‰ˆæœ¬ -->
                                    <div class="child-section">
                                        <h3>ğŸ‘¶ å„¿ç«¥ç‰ˆ</h3>
                                        <h4>${dayData.childVersion?.title || ''}</h4>

                                        ${dayData.childVersion?.activities ? `
                                            <div class="activities">
                                                <h5>ğŸˆ ä»Šå¤©ç©ä»€ä¹ˆ</h5>
                                                <ul>${(dayData.childVersion.itinerary || []).map(i => `<li>${i}</li>`).join('')}</ul>
                                            </div>
                                        ` : ''}

                                        ${dayData.childVersion?.funFacts ? `
                                            <div class="fun-facts">
                                                <h5>ğŸ¤” æœ‰è¶£çš„çŸ¥è¯†</h5>
                                                <ul>${(dayData.childVersion.funFacts || []).map(fact => `<li>${fact}</li>`).join('')}</ul>
                                            </div>
                                        ` : ''}
                                    </div>
                                </div>
                            </div>
                        `;
                    });

                    html += `
                            </div>
                        </div>
                    `;

                    return html;
                }

                function renderNotebook(type, tripPlan, destination, familyMembers, tripDuration) {
                    const notebookContent = document.getElementById(`${type}-notebook-content`);
                    const notebookTabs = document.getElementById(`${type}-notebook-tabs`);
                    notebookContent.innerHTML = '';
                    notebookTabs.innerHTML = '';

                    // Create static pages
                    const coverPage = createPage(`${type}-cover`, 'å°é¢');
                    const itineraryPage = createPage(`${type}-itinerary`, 'æ€»è§ˆ');
                    const checklistPage = createPage(`${type}-checklist`, 'è¡Œæ');
                    const safetyPage = createPage(`${type}-safety`, 'å®‰å…¨');

                    // Add static pages to content
                    notebookContent.appendChild(coverPage);
                    notebookContent.appendChild(itineraryPage);
                    notebookContent.appendChild(checklistPage);

                    // Generate content for static pages
                    generateCoverPage(coverPage.querySelector('.page-content'), destination, familyMembers, tripDuration, type);
                    generateChecklistPage(checklistPage.querySelector('.page-content'), familyMembers, type);
                    generateSafetyPage(safetyPage.querySelector('.page-content'), destination);

                    // Generate dynamic detail pages
                    if (type === 'children') {
                        generateSimpleItineraryForChild(itineraryPage.querySelector('.page-content'), tripPlan);
                        generateChildDetailPages(tripPlan, notebookContent);
                    } else {
                        generateSimpleItineraryForParent(itineraryPage.querySelector('.page-content'), tripPlan);
                        generateParentDetailPages(tripPlan, notebookContent);
                    }
                    
                    notebookContent.appendChild(safetyPage);

                    // Update tabs
                    updateNotebookTabs(type, tripPlan.length);

                    // Set initial active tab
                    setActiveTab(notebookTabs.querySelector('.tab-item'));
                }

                function createPage(id, label) {
                    const page = document.createElement('div');
                    page.className = 'notebook-page';
                    page.id = `page-${id}`;
                    page.innerHTML = `<div class="page-content"></div>`;
                    return page;
                }

                function generateCoverPage(container, destination, familyMembers, duration, type) {
                    const familyNames = familyMembers.map(m => m.name).join('ã€') || 'æˆ‘ä»¬';
                    const title = type === 'children' ? 'æˆ‘çš„ä¸“å±æ—…è¡Œæ—¥è®°' : `${destination} å®¶åº­æ—…è¡Œè®¡åˆ’`;
                    container.innerHTML = `
                        <div class="cover-page">
                            <h1>${title}</h1>
                            <img src="images/7633aa7e-33aa-4ada-b715-ef314f196859.png" alt="Travel Illustration" class="cover-image">
                            <div class="cover-info">
                                <p><strong>ç›®çš„åœ°:</strong> ${destination}</p>
                                <p><strong>æ—…è¡Œå®¶:</strong> ${familyNames}</p>
                                <p><strong>æ—¶é•¿:</strong> ${duration} å¤©</p>
                            </div>
                            <div class="cover-footer">${new Date().getFullYear()}</div>
                        </div>
                    `;
                }

                function generateSimpleItineraryForChild(container, tripPlan) {
                    let itineraryHTML = `<h2>ğŸ¨ è¡Œç¨‹äº®ç‚¹</h2>`;
                    tripPlan.forEach(dayData => {
                        itineraryHTML += `
                            <div class="day-summary">
                                <h3>ç¬¬${dayData.day}å¤©: ${dayData.theme}</h3>
                                <p>${dayData.childVersion.title}</p>
                                <ul>
                                    ${(dayData.childVersion.itinerary || []).map(item => `<li>${item}</li>`).join('')}
                                </ul>
                            </div>
                        `;
                    });
                    container.innerHTML = itineraryHTML;
                }

                function generateSimpleItineraryForParent(container, tripPlan) {
                    let itineraryHTML = `<h2>ğŸ“‹ è¡Œç¨‹æ€»è§ˆ</h2>`;
                    tripPlan.forEach(dayData => {
                        itineraryHTML += `
                            <div class="day-summary">
                                <h3>ç¬¬${dayData.day}å¤©: ${dayData.theme}</h3>
                                <p>${dayData.parentVersion.title}</p>
                                <ul>
                                    ${(dayData.parentVersion.itinerary || []).map(item => `<li>${item}</li>`).join('')}
                                </ul>
                            </div>
                        `;
                    });
                    container.innerHTML = itineraryHTML;
                }

                function generateChecklistPage(container, familyMembers, type) {
                    let checklistHTML = `<h2>ğŸ’ è¡Œæå¤‡å¿˜å½•</h2>`;
                    const categories = {
                        'é€šç”¨ç‰©å“': ['è¯ä»¶', 'ç°é‡‘/ä¿¡ç”¨å¡', 'æ‰‹æœº/å……ç”µå™¨', 'å¸¸ç”¨è¯å“', 'é›¨å…·'],
                        'è¡£ç‰©': ['å†…å¤–è¡£ç‰©', 'ç¡è¡£', 'å¤‡ç”¨é‹è¢œ'],
                        'æ´—æ¼±ç”¨å“': ['ç‰™åˆ·ç‰™è†', 'æ¯›å·¾', 'é˜²æ™’éœœ']
                    };
                    if (type === 'children') {
                        categories['æˆ‘çš„ä¸“å±'] = ['å–œçˆ±ç©å…·', 'é›¶é£Ÿ/æ°´å£¶', 'æ•…äº‹ä¹¦/ç”»æ¿'];
                    }
                    for (const category in categories) {
                        checklistHTML += `
                            <div class="checklist-section">
                                <h3>${category}</h3>
                                ${categories[category].map(item => `
                                    <div class="checklist-item">
                                        <input type="checkbox" id="check-${type}-${item.replace(/\s|\//g, '')}">
                                        <label for="check-${type}-${item.replace(/\s|\//g, '')}">${item}</label>
                                    </div>
                                `).join('')}
                            </div>
                        `;
                    }
                    container.innerHTML = checklistHTML;
                }

                function generateChildDetailPages(tripPlan, container) {
                    tripPlan.forEach(dayData => {
                        const page = createPage(`children-detail-${dayData.day}`, `ç¬¬${dayData.day}å¤©`);
                        const content = page.querySelector('.page-content');
                        content.innerHTML = `
                            <h2>ç¬¬${dayData.day}å¤©: ${dayData.childVersion.title}</h2>
                            <div class="info-section">
                                <h4>ğŸˆ ä»Šå¤©ç©ä»€ä¹ˆ?</h4>
                                <ul>${(dayData.childVersion.itinerary || []).map(i => `<li>${i}</li>`).join('')}</ul>
                            </div>
                            <div class="info-section">
                                <h4>ğŸ¨ æ¶‚é¸¦å’Œè´´çº¸åŒº</h4>
                                <div class="drawing-area">
                                    <p>åœ¨è¿™é‡Œç”»ä¸‹ä»Šå¤©æœ€å¼€å¿ƒçš„äº‹å§ï¼</p>
                                </div>
                            </div>
                        `;
                        container.appendChild(page);
                    });
                }

                function generateParentDetailPages(tripPlan, container) {
                    tripPlan.forEach(dayData => {
                        const page = createPage(`parent-detail-${dayData.day}`, `ç¬¬${dayData.day}å¤©`);
                        const content = page.querySelector('.page-content');
                        content.innerHTML = `
                            <h2>ç¬¬${dayData.day}å¤©: ${dayData.parentVersion.title}</h2>
                             <div class="info-section">
                                <h4>ğŸ—“ï¸ è¯¦ç»†è¡Œç¨‹</h4>
                                <ul>${(dayData.parentVersion.itinerary || []).map(i => `<li>${i}</li>`).join('')}</ul>
                            </div>
                            <div class="info-section">
                                <h4><span>ğŸ’¡</span> å®ç”¨è´´å£«</h4>
                                <p>${dayData.parentVersion.tips || 'æš‚æ— '}</p>
                            </div>
                        `;
                        container.appendChild(page);
                    });
                }

                function generateSafetyPage(container, destination) {
                    const isInternational = isInternationalDestination(destination);
                    let safetyHTML = '<h2>ğŸš¨ å®‰å…¨é¡»çŸ¥</h2>';
                    safetyHTML += `
                        <div class="emergency-contact">
                            <h4>ğŸš‘ ç´§æ€¥è”ç»œ</h4>
                            <div class="contact-number">æŠ¥è­¦ï¼š110</div>
                            <div class="contact-number">ç«è­¦ï¼š119</div>
                            <div class="contact-number">åŒ»ç–—æ€¥æ•‘ï¼š120</div>
                        </div>
                    `;
                    if (isInternational) {
                        safetyHTML += `
                            <div class="emergency-contact">
                                <h4>ğŸ›ï¸ ä¸­å›½é¢†äº‹é¦†</h4>
                                <p>å¤–äº¤éƒ¨å…¨çƒé¢†äº‹ä¿æŠ¤çƒ­çº¿ï¼š+86-10-12308</p>
                            </div>
                        `;
                    }
                    safetyHTML += `
                        <div class="info-section">
                            <h4>âš ï¸ å®‰å…¨æé†’</h4>
                            <ul>
                                <li>ä¿ç®¡å¥½é‡è¦è¯ä»¶ï¼Œå»ºè®®æ‹ç…§å¤‡ä»½</li>
                                <li>å‘ŠçŸ¥å®¶äººè¯¦ç»†è¡Œç¨‹å’Œè”ç»œæ–¹å¼</li>
                                <li>çœ‹å¥½å„¿ç«¥ï¼Œé¿å…èµ°å¤±</li>
                            </ul>
                        </div>
                    `;
                    container.innerHTML = safetyHTML;
                }

                function isInternationalDestination(destination) {
                    const domesticKeywords = ['ä¸­å›½', 'åŒ—äº¬', 'ä¸Šæµ·', 'å¹¿å·', 'æ·±åœ³', 'æ­å·', 'å—äº¬', 'æˆéƒ½', 'é‡åº†', 'è¥¿å®‰', 'æ­¦æ±‰', 'é¦™æ¸¯', 'æ¾³é—¨', 'å°åŒ—'];
                    return !domesticKeywords.some(keyword => destination.includes(keyword));
                }

                function updateNotebookTabs(type, dayCount) {
                    const tabsContainer = document.getElementById(`${type}-notebook-tabs`);
                    tabsContainer.innerHTML = '';

                    const pages = [
                        { id: `${type}-cover`, label: 'å°é¢' },
                        { id: `${type}-itinerary`, label: 'æ€»è§ˆ' },
                        { id: `${type}-checklist`, label: 'è¡Œæ' },
                    ];

                    for (let i = 1; i <= dayCount; i++) {
                        pages.push({ id: `${type}-detail-${i}`, label: `ç¬¬${i}å¤©` });
                    }

                    pages.push({ id: `${type}-safety`, label: 'å®‰å…¨' });

                    pages.forEach((page, index) => {
                        const tabItem = document.createElement('div');
                        tabItem.className = 'tab-item';
                        tabItem.dataset.page = `page-${page.id}`;
                        tabItem.innerHTML = `<span class="tab-label">${page.label}</span>`;
                        tabItem.addEventListener('click', () => setActiveTab(tabItem));
                        tabsContainer.appendChild(tabItem);
                    });
                }

                function setActiveTab(tab) {
                    if (!tab) return;
                    const notebook = tab.closest('.travel-notebook');
                    const targetPageId = tab.dataset.page;

                    // Deactivate all tabs in this notebook
                    notebook.querySelectorAll('.tab-item').forEach(t => t.classList.remove('active'));
                    // Hide all pages in this notebook
                    notebook.querySelectorAll('.notebook-page').forEach(p => p.style.display = 'none');

                    // Activate the clicked tab and show the corresponding page
                    tab.classList.add('active');
                    const targetPage = notebook.querySelector(`#${targetPageId}`);
                    if (targetPage) {
                        targetPage.style.display = 'block';
                    }
                }

    </script>
<script>
    function initializeInteractiveElements() {
        const canvases = document.querySelectorAll('.drawing-area canvas');
        canvases.forEach(canvas => {
            const ctx = canvas.getContext('2d');
            ctx.strokeStyle = '#000';
            ctx.lineWidth = 3;
            ctx.lineCap = 'round';

            let isDrawing = false;
            let lastX = 0;
            let lastY = 0;

            function draw(e) {
                if (!isDrawing) return;
                const rect = canvas.getBoundingClientRect();
                const x = e.offsetX || e.touches[0].clientX - rect.left;
                const y = e.offsetY || e.touches[0].clientY - rect.top;

                ctx.beginPath();
                ctx.moveTo(lastX, lastY);
                ctx.lineTo(x, y);
                ctx.stroke();
                [lastX, lastY] = [x, y];
            }

            canvas.addEventListener('mousedown', (e) => {
                isDrawing = true;
                const rect = canvas.getBoundingClientRect();
                [lastX, lastY] = [e.offsetX, e.offsetY];
            });
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', () => isDrawing = false);
            canvas.addEventListener('mouseout', () => isDrawing = false);

            // Touch events
            canvas.addEventListener('touchstart', (e) => {
                if (e.touches.length === 1) {
                    e.preventDefault();
                    isDrawing = true;
                    const rect = canvas.getBoundingClientRect();
                    [lastX, lastY] = [e.touches[0].clientX - rect.left, e.touches[0].clientY - rect.top];
                }
            });
            canvas.addEventListener('touchmove', (e) => {
                 if (e.touches.length === 1) {
                    e.preventDefault();
                    draw(e);
                 }
            });
            canvas.addEventListener('touchend', () => isDrawing = false);
        });

        const stickers = document.querySelectorAll('.sticker');
        stickers.forEach(sticker => {
            sticker.addEventListener('dragstart', (e) => {
                e.dataTransfer.setData('text/plain', e.target.src);
            });
        });

        canvases.forEach(canvas => {
            canvas.addEventListener('dragover', (e) => {
                e.preventDefault();
            });

            canvas.addEventListener('drop', (e) => {
                e.preventDefault();
                const imgSrc = e.dataTransfer.getData('text/plain');
                const img = new Image();
                img.src = imgSrc;
                img.onload = () => {
                    const rect = canvas.getBoundingClientRect();
                    const x = e.clientX - rect.left - 25; // Center the sticker
                    const y = e.clientY - rect.top - 25;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, x, y, 50, 50);
                };
            });
        });
    }



</script>
</body>
</html>
