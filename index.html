<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äº²å­æ—…æ¸¸æ‰‹å¸AIå°åŠ©æ‰‹ V5.1 - ç»ˆæå®Œæ•´ç‰ˆ</title>
    <style>
     /* CSSæ ·å¼ - 100%å®Œæ•´ */
@import url('https://fonts.googleapis.com/css2?family=ZCOOL+XiaoWei&family=Noto+Sans+SC:wght@400;700&display=swap');
body {
    font-family: 'Noto Sans SC', sans-serif;
    background: linear-gradient(135deg, #E3F2FD 0%, #F3E5F5 50%, #FFF3E0 100%);
    color: #2E3A59;
    margin: 0;
    padding: 20px;
    display: flex;
    flex-direction: column;
    align-items: center;
    min-height: 100vh;
}
.container {
    width: 100%;
    max-width: 800px;
    background: rgba(255, 255, 255, 0.95);
    border-radius: 25px;
    box-shadow: 0 15px 35px rgba(46, 58, 89, 0.15);
    padding: 30px;
    box-sizing: border-box;
    margin-bottom: 20px;
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.2);
}
header { 
    text-align: center; 
    margin-bottom: 30px; 
    border-bottom: 3px dashed #FFCC80; 
    padding-bottom: 20px; 
}
header h1 {
    font-family: 'ZCOOL+XiaoWei', serif;
    font-size: 2.8em;
    color: #5C6BC0;
    margin: 0;
    text-shadow: 2px 2px 4px rgba(92, 107, 192, 0.3);
}
header p { 
    font-size: 1.1em; 
    color: #795548; 
}
.form-block {
    background: linear-gradient(135deg, #F8F9FF 0%, #F3E5F5 100%);
    border-radius: 20px;
    padding: 25px;
    margin-bottom: 25px;
    border: 1px solid rgba(92, 107, 192, 0.1);
    position: relative;
    overflow: hidden;
}

.form-block::before {
    content: '';
    position: absolute;
    top: -50%;
    right: -20px;
    width: 100px;
    height: 100px;
    background: url('images/afbcfbd3-addf-4e32-a3ab-6e2bca0a2ebd.jpeg') no-repeat center;
    background-size: contain;
    opacity: 0.05;
    transform: rotate(15deg);
}
.form-block h3 {
    font-family: 'ZCOOL XiaoWei', serif;
    font-size: 1.5em;
    color: #5C6BC0;
    margin-top: 0;
    display: flex;
    align-items: center;
    position: relative;
    z-index: 2;
}
.form-block h3 span { 
    font-size: 1.8em; 
    margin-right: 10px; 
}
.input-group { 
    display: flex; 
    flex-direction: column; 
    flex-grow: 1; 
    gap: 5px; 
}
.input-label, label { 
    font-weight: 700; 
    margin-bottom: 5px; 
    display: block; 
}
input[type="text"], input[type="number"], input[type="password"], input[type="date"], select, textarea {
    padding: 12px;
    border: 2px solid #B39DDB;
    border-radius: 12px;
    font-size: 1em;
    background-color: rgba(255, 255, 255, 0.9);
    width: 100%;
    box-sizing: border-box;
    font-family: 'Noto Sans SC', 'Microsoft YaHei', sans-serif;
    transition: all 0.3s ease;
}

input:focus, select:focus, textarea:focus {
    border-color: #5C6BC0;
    box-shadow: 0 0 0 3px rgba(92, 107, 192, 0.1);
    outline: none;
}
textarea {
    resize: vertical;
    min-height: 80px;
}
.api-key-row { 
    display: flex; 
    gap: 10px; 
    align-items: center; 
}
.fetch-btn, .clear-btn {
    padding: 12px 18px;
    background: linear-gradient(135deg, #7986CB, #5C6BC0);
    color: white;
    border: none;
    border-radius: 12px;
    cursor: pointer;
    font-weight: bold;
    transition: all 0.3s ease;
    box-shadow: 0 4px 12px rgba(92, 107, 192, 0.3);
}

.fetch-btn:hover, .clear-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(92, 107, 192, 0.4);
}
.clear-btn {
    background-color: #E0E0E0;
    color: #757575;
    font-size: 0.8em;
    padding: 5px 10px;
}
#custom-endpoint-group {
    margin-top: 15px;
}
.search-status {
    font-size: 0.9em;
    color: #4CAF50;
    margin-top: 5px;
}
.gemini-search-highlight {
    background: linear-gradient(135deg, #E8F5E9, #F1F8E9);
    border: 1px solid #4CAF50;
    border-radius: 8px;
    padding: 8px;
    margin-top: 5px;
}
.search-feature-badge {
    display: inline-block;
    background: #4CAF50;
    color: white;
    font-size: 0.7em;
    padding: 2px 6px;
    border-radius: 10px;
    margin-left: 5px;
}
#api-status { 
    font-size: 0.9em; 
    color: #4CAF50; 
    min-height: 1.2em; 
}
.icon-options { 
    display: flex; 
    gap: 10px; 
    flex-wrap: wrap; 
}
.icon-options label { 
    display: flex; 
    flex-direction: column; 
    align-items: center; 
    cursor: pointer; 
    padding: 10px; 
    border-radius: 10px; 
    transition: all 0.2s; 
    border: 2px solid transparent; 
}
.icon-options input[type="radio"], .icon-options input[type="checkbox"] { 
    display: none; 
}
.icon-options .icon { 
    font-size: 2.5em; 
}
.icon-options span { 
    margin-top: 5px; 
    font-weight: bold; 
    font-size: 0.9em; 
}
.icon-options .content { 
    display: flex; 
    flex-direction: column; 
    align-items: center; 
    transition: transform 0.2s; 
}
.icon-options input:checked + .content {
    transform: scale(1.1);
    color: #FF7043;
}
.icon-options label.selected {
    background-color: #FFECB3;
    border-color: #FFCC80;
}
.dynamic-list .list-item { 
    display: flex; 
    align-items: center; 
    gap: 10px; 
    background: #fff; 
    padding: 8px 10px; 
    border-radius: 8px; 
    margin-bottom: 10px; 
}
.dynamic-list input { 
    border: none; 
    background: transparent; 
    flex-grow: 1; 
}
#multi-city-container .list-item input { 
    border-bottom: 1px solid #ddd; 
}
.add-btn, .remove-btn { 
    background-color: #FFAB91; 
    color: white; 
    border: none; 
    border-radius: 50%; 
    width: 28px; 
    height: 28px; 
    font-size: 1.5em; 
    cursor: pointer; 
    display: flex; 
    align-items: center; 
    justify-content: center; 
    flex-shrink: 0; 
    line-height: 1; 
}
.remove-btn { 
    background-color: #E0E0E0; 
    color: #757575; 
}
.submit-btn { 
    width: 100%; 
    padding: 15px; 
    font-family: 'ZCOOL XiaoWei', serif; 
    font-size: 1.8em; 
    background-color: #FF7043; 
    color: white; 
    border: none; 
    border-radius: 15px; 
    cursor: pointer; 
}
.submit-btn:disabled, .fetch-btn:disabled { 
    background-color: #BDBDBD; 
    cursor: not-allowed; 
}
.plan-section, #loading-indicator {
    display: none;
}
.action-buttons {
    display: flex;
    gap: 15px;
    justify-content: center;
    margin-top: 30px;
    padding: 20px;
}
.print-btn, .new-plan-btn {
    padding: 12px 24px;
    border: none;
    border-radius: 10px;
    font-family: 'ZCOOL XiaoWei', serif;
    font-size: 1.1em;
    cursor: pointer;
    transition: all 0.3s ease;
}
.print-btn {
    background-color: #4CAF50;
    color: white;
}
.print-btn:hover {
    background-color: #45a049;
}
.new-plan-btn {
    background-color: #2196F3;
    color: white;
}
.new-plan-btn:hover {
    background-color: #1976D2;
}
.tab-controls { 
    display: flex; 
    gap: 10px; 
    margin-bottom: -2px; 
}
.tab-btn { 
    padding: 10px 20px; 
    font-family: 'ZCOOL XiaoWei', serif; 
    font-size: 1.3em; 
    border: 2px solid #FFAB91; 
    border-bottom: none; 
    background: #FFF3E0; 
    border-radius: 10px 10px 0 0; 
    cursor: pointer; 
}
.tab-btn.active { 
    background: #fff; 
    color: #FF7043; 
    border-bottom: 2px solid #fff; 
}
.tab-content { 
    display: none; 
}
.tab-content.active { 
    display: block; 
}
.day-page { 
    background: #fff; 
    border: 2px solid #FFAB91; 
    border-radius: 0 15px 15px 15px; 
    padding: 30px; 
    margin-bottom: 20px; 
}
.day-header h2 { 
    font-family: 'ZCOOL XiaoWei', serif; 
    font-size: 2em; 
    color: #FF7043; 
    margin: 0; 
}
.itinerary-item ul { 
    padding-left: 20px; 
    margin: 0; 
    list-style-type: 'ğŸ–ï¸ '; 
}
.itinerary-item li { 
    margin-bottom: 10px; 
}
.parent-tip { 
    background-color: #E8F5E9; 
    border-left: 4px solid #4CAF50; 
    padding: 10px; 
    margin-top: 15px; 
    border-radius: 4px; 
    font-size: 0.9em; 
}
.doodle-area { 
    border: 2px dashed #BDBDBD; 
    border-radius: 10px; 
    padding: 20px; 
    margin-top: 30px; 
    text-align: center; 
    color: #BDBDBD; 
    min-height: 100px; 
}
.print-btn, .new-plan-btn { 
    width: 100%; 
    padding: 15px; 
    font-weight: bold; 
    font-size: 1.2em; 
    background-color: #4CAF50; 
    color: white; 
    border: none; 
    border-radius: 15px; 
    cursor: pointer; 
    margin-top: 10px; 
}
.new-plan-btn { 
    background-color: #FF9800; 
}
#loading-indicator {
    text-align: center;
    padding: 40px;
    font-size: 1.5em;
    color: #FF7043;
    font-family: 'ZCOOL XiaoWei', serif;
}

/* è®°äº‹æœ¬æ ·å¼ */
.travel-notebook {
    display: flex;
    background: #f8f8f8;
    border-radius: 15px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.15);
    overflow: hidden;
    min-height: 800px;
    position: relative;
}

.notebook-tabs {
    position: absolute;
    right: -15px;
    top: 50px;
    display: flex;
    flex-direction: column;
    gap: 5px;
    z-index: 10;
}

.tab-item {
    width: 35px;
    height: 60px;
    background: linear-gradient(135deg, #7986CB, #5C6BC0);
    border-radius: 8px 0 0 8px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s ease;
    color: white;
    font-size: 0.7em;
    font-weight: bold;
    box-shadow: -3px 3px 8px rgba(92, 107, 192, 0.3);
    position: relative;
}

.tab-item::before {
    content: '';
    position: absolute;
    left: -8px;
    top: 50%;
    transform: translateY(-50%);
    width: 0;
    height: 0;
    border-top: 8px solid transparent;
    border-bottom: 8px solid transparent;
    border-right: 8px solid #5C6BC0;
}

.tab-item:hover {
    transform: translateX(-5px);
    box-shadow: -5px 5px 12px rgba(92, 107, 192, 0.4);
}

.tab-item.active {
    background: linear-gradient(135deg, #AB47BC, #8E24AA);
    transform: translateX(-8px);
    box-shadow: -6px 6px 15px rgba(142, 36, 170, 0.4);
}

.tab-item.active::before {
    border-right-color: #8E24AA;
}

.tab-number {
    font-size: 0.9em;
    font-weight: bold;
    margin-bottom: 2px;
    line-height: 1;
}

.tab-label {
    font-size: 0.6em;
    text-align: center;
    line-height: 1;
    margin-bottom: 2px;
}

.tab-icon {
    font-size: 0.7em;
    opacity: 0.9;
    line-height: 1;
}

.notebook-content {
    width: 100%;
    background: white;
    position: relative;
    overflow: hidden;
    border-radius: 15px;
    box-shadow: 0 10px 25px rgba(46, 58, 89, 0.15);
}

.notebook-page {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    opacity: 0;
    transform: translateX(20px);
    transition: all 0.4s ease;
    display: none;
}

.notebook-page.active {
    opacity: 1;
    transform: translateX(0);
    display: block;
}

.page-content {
    padding: 40px;
    height: 100%;
    overflow-y: auto;
    background:
        linear-gradient(90deg, #5C6BC0 0px, #5C6BC0 2px, transparent 2px),
        repeating-linear-gradient(transparent, transparent 24px, #E8EAF6 24px, #E8EAF6 25px);
    background-size: 100% 100%, 100% 25px;
    background-position: 0 0, 0 40px;
    position: relative;
}

.page-content::after {
    content: '';
    position: absolute;
    bottom: 20px;
    right: 20px;
    width: 60px;
    height: 60px;
    background: url('images/afbcfbd3-addf-4e32-a3ab-6e2bca0a2ebd.jpeg') no-repeat center;
    background-size: cover;
    border-radius: 50%;
    opacity: 0.1;
    pointer-events: none;
}

.notebook-controls {
    display: flex;
    gap: 15px;
    justify-content: center;
    margin-top: 20px;
}

/* å°é¢é¡µæ ·å¼ */
.cover-page {
    text-align: center;
    display: flex;
    flex-direction: column;
    justify-content: center;
    background: linear-gradient(135deg, #E8EAF6 0%, #F3E5F5 50%, #E1F5FE 100%);
    position: relative;
    overflow: hidden;
}

.cover-page::before {
    content: '';
    position: absolute;
    top: 10%;
    left: 10%;
    width: 120px;
    height: 120px;
    background: url('images/afbcfbd3-addf-4e32-a3ab-6e2bca0a2ebd.jpeg') no-repeat center;
    background-size: cover;
    border-radius: 50%;
    opacity: 0.08;
    transform: rotate(-15deg);
}

.cover-page::after {
    content: '';
    position: absolute;
    bottom: 10%;
    right: 10%;
    width: 100px;
    height: 100px;
    background: url('images/afbcfbd3-addf-4e32-a3ab-6e2bca0a2ebd.jpeg') no-repeat center;
    background-size: cover;
    border-radius: 50%;
    opacity: 0.06;
    transform: rotate(25deg);
}

.cover-title {
    font-family: 'ZCOOL XiaoWei', serif;
    font-size: 3em;
    color: #5C6BC0;
    margin-bottom: 20px;
    text-shadow: 2px 2px 4px rgba(92, 107, 192, 0.3);
}

.cover-subtitle {
    font-size: 1.5em;
    color: #8D6E63;
    margin-bottom: 30px;
}

.cover-info {
    background: rgba(255,255,255,0.8);
    padding: 20px;
    border-radius: 15px;
    margin: 20px auto;
    max-width: 400px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}

/* è¡Œç¨‹é¡µæ ·å¼ */
.itinerary-page h2 {
    font-family: 'ZCOOL XiaoWei', serif;
    color: #5C6BC0;
    border-bottom: 3px solid #B39DDB;
    padding-bottom: 10px;
    margin-bottom: 20px;
}

.day-summary {
    background: #FFFDE7;
    border-left: 5px solid #FFCC80;
    padding: 15px;
    margin-bottom: 20px;
    border-radius: 0 10px 10px 0;
}

.day-summary h3 {
    color: #FF7043;
    margin: 0 0 10px 0;
    font-family: 'ZCOOL XiaoWei', serif;
}

/* æ¸…å•é¡µæ ·å¼ */
.checklist-page h2 {
    font-family: 'ZCOOL XiaoWei', serif;
    color: #FF7043;
    border-bottom: 3px solid #FFCC80;
    padding-bottom: 10px;
    margin-bottom: 20px;
}

.checklist-section {
    background: #FFFDE7;
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 20px;
}

.checklist-section h3 {
    color: #8D6E63;
    margin-bottom: 15px;
    font-family: 'ZCOOL XiaoWei', serif;
}

.checklist-item {
    display: flex;
    align-items: center;
    margin-bottom: 8px;
    padding: 5px 0;
}

.checklist-item input[type="checkbox"] {
    margin-right: 10px;
    transform: scale(1.2);
}

/* è¯¦æƒ…é¡µæ ·å¼ */
.detail-page h2 {
    font-family: 'ZCOOL XiaoWei', serif;
    color: #FF7043;
    border-bottom: 3px solid #FFCC80;
    padding-bottom: 10px;
    margin-bottom: 20px;
}

.location-info {
    background: #FFFDE7;
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 20px;
}

.info-section {
    margin-bottom: 20px;
}

.info-section h4 {
    color: #8D6E63;
    margin-bottom: 10px;
    font-family: 'ZCOOL XiaoWei', serif;
}

.drawing-area {
    border: 2px dashed #FFCC80;
    padding: 10px;
    border-radius: 10px;
    background: #FFFDE7;
    display: flex;
    gap: 10px;
    align-items: flex-start;
    flex-wrap: wrap;
}

.drawing-area canvas {
    border: 1px solid #ccc;
    cursor: crosshair;
    background-color: #fff;
}

.sticker-palette {
    display: flex;
    flex-direction: column;
    gap: 10px;
    padding: 10px;
    background: rgba(255, 255, 255, 0.5);
    border-radius: 10px;
}

.sticker-palette p {
    margin: 0 0 5px 0;
    font-size: 0.9em;
    color: #8D6E63;
    font-weight: bold;
}

.stickers {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
}

.sticker {
    width: 50px;
    height: 50px;
    cursor: grab;
    transition: transform 0.1s;
}

.sticker:active {
    cursor: grabbing;
    transform: scale(1.1);
}

/* å®‰å…¨é¡µæ ·å¼ */
.safety-page h2 {
    font-family: 'ZCOOL XiaoWei', serif;
    color: #F44336;
    border-bottom: 3px solid #FFCDD2;
    padding-bottom: 10px;
    margin-bottom: 20px;
}

.emergency-contact {
    background: #FFEBEE;
    border: 2px solid #FFCDD2;
    border-radius: 10px;
    padding: 15px;
    margin-bottom: 15px;
}

.emergency-contact h4 {
    color: #F44336;
    margin-bottom: 10px;
    font-family: 'ZCOOL XiaoWei', serif;
}

.contact-number {
    font-size: 1.2em;
    font-weight: bold;
    color: #D32F2F;
    background: white;
    padding: 5px 10px;
    border-radius: 5px;
    display: inline-block;
    margin: 5px 0;
}

/* å›¾ç‰‡ç›¸å…³æ ·å¼ */
.page-decoration {
    position: absolute;
    opacity: 0.1;
    pointer-events: none;
    z-index: 1;
}

.page-decoration.top-right {
    top: 20px;
    right: 20px;
    width: 80px;
    height: 80px;
}

.page-decoration.bottom-left {
    bottom: 20px;
    left: 20px;
    width: 60px;
    height: 60px;
}

.page-decoration.center {
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 100px;
    height: 100px;
    opacity: 0.05;
}

.illustration {
    max-width: 100%;
    height: auto;
    border-radius: 10px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    margin: 15px 0;
}

.cover-illustration {
    width: 120px;
    height: 120px;
    margin: 20px auto;
    border-radius: 50%;
    overflow: hidden;
    box-shadow: 0 10px 25px rgba(255,112,67,0.3);
}

.cover-illustration img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.section-icon {
    width: 40px;
    height: 40px;
    display: inline-block;
    vertical-align: middle;
    margin-right: 10px;
    filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.1));
}

/* å“åº”å¼å›¾ç‰‡å¤„ç† */
@media (max-width: 768px) {
    .cover-illustration {
        width: 80px;
        height: 80px;
    }

    .section-icon {
        width: 30px;
        height: 30px;
    }

    .page-decoration {
        display: none;
    }
}

/* å›¾ç‰‡åŠ è½½åŠ¨ç”» */
.illustration, .cover-illustration img, .section-icon {
    transition: all 0.3s ease;
}

.illustration:hover, .cover-illustration:hover {
    transform: scale(1.05);
}

/* å›¾ç‰‡åŠ è½½å¤±è´¥å¤„ç† */
img {
    max-width: 100%;
    height: auto;
}

img[alt]:after {
    content: attr(alt);
    display: block;
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: #f0f0f0;
    color: #666;
    font-size: 12px;
    text-align: center;
    line-height: 1.5;
    padding: 10px;
    box-sizing: border-box;
}

@media print {
    body {
        background-color: #fff;
        padding: 0;
        margin: 0;
    }
    .container, .input-section, .notebook-controls, header {
        display: none !important;
    }
    .plan-section {
        display: block !important;
        box-shadow: none;
        width: 100%;
        max-width: 100%;
        margin: 0;
    }
    .travel-notebook {
        box-shadow: none;
        border-radius: 0;
        min-height: auto;
    }
    .notebook-tabs {
        display: none !important;
    }
    .notebook-content {
        width: 100%;
    }
    .notebook-page {
        position: static !important;
        opacity: 1 !important;
        transform: none !important;
        display: block !important;
        page-break-after: always;
        height: auto;
        min-height: 100vh;
    }
    .notebook-page:last-child {
        page-break-after: avoid;
    }
    .page-content {
        padding: 20px;
        height: auto;
        min-height: calc(100vh - 40px);
        background: white;
        overflow: visible;
    }
    .cover-page {
        background: white !important;
    }
    .checklist-item input[type="checkbox"] {
        -webkit-appearance: checkbox;
        appearance: checkbox;
    }
    .contact-number {
        background: #f0f0f0 !important;
    }
}

/* ç‰ˆæœ¬åˆ‡æ¢æ ·å¼ */
.version-tabs {
    display: flex;
    justify-content: center;
    gap: 10px;
    margin-bottom: 30px;
    padding-bottom: 0;
    border-bottom: none;
}

.version-btn {
    padding: 12px 20px;
    font-size: 1em;
    font-weight: bold;
    border: 2px solid #E0E0E0;
    background-color: #f8f9fa;
    border-radius: 25px;
    cursor: pointer;
    transition: all 0.3s ease;
    color: #757575;
    position: relative;
    bottom: 0;
}

.version-btn.active {
    background-color: #5C6BC0;
    color: white;
    border-color: #5C6BC0;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(92, 107, 192, 0.3);
}

.version-btn:hover:not(.active) {
    background-color: #e9ecef;
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.version-content-wrapper {
    background: transparent;
    border: none;
    border-radius: 0;
    min-height: 400px;
    position: relative;
}

.version-content {
    display: none;
    padding: 0;
}

.version-content.active {
    display: block;
}

.notebook-controls {
    display: flex;
    justify-content: space-between;
    gap: 15px;
    margin-top: 20px;
}

/* åœ°ç‚¹é¡µé¢å®¹å™¨æ ·å¼ - ä»¿ç¬”è®°æœ¬è®¾è®¡ */
.location-page-container {
    margin-bottom: 40px;
    padding: 20px;
    border: 1px solid #eee;
    border-radius: 15px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    background: white;
}

.location-page-container:last-child {
    margin-bottom: 0;
}

.location-title-h1 {
    font-family: 'ZCOOL XiaoWei', serif;
    font-size: 2.5em;
    color: #5C6BC0;
    text-align: center;
    margin-bottom: 10px;
}

.location-title-h2 {
    font-size: 1.2em;
    color: #795548;
    text-align: center;
    margin-bottom: 30px;
    font-style: italic;
}

.section-container {
    margin-bottom: 25px;
}

.section-title-h3 {
    font-family: 'ZCOOL XiaoWei', serif;
    font-size: 1.6em;
    color: #FF7043;
    display: flex;
    align-items: center;
    gap: 10px;
    border-bottom: 2px solid #FFECB3;
    padding-bottom: 8px;
    margin-bottom: 15px;
}

.section-title-h3 span {
    font-size: 1.5em;
}

/* å„¿ç«¥ç‰ˆä¸“å±æ ·å¼ */
.mission-list {
    list-style-type: none;
    padding-left: 0;
}

.mission-item {
    background: #FFFDE7;
    border-left: 5px solid #FFCC80;
    padding: 15px;
    margin-bottom: 10px;
    border-radius: 0 8px 8px 0;
    font-size: 1.1em;
}

.fun-fact-box {
    background: #E3F2FD;
    border: 2px dashed #90CAF9;
    padding: 20px;
    border-radius: 15px;
    text-align: center;
    margin: 20px 0;
}

.creative-zone {
    border: 3px dashed #B39DDB;
    border-radius: 15px;
    padding: 20px;
    min-height: 150px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    text-align: center;
    color: #9575CD;
    background-color: #F3E5F520;
}

.creative-zone p {
    margin: 5px 0;
    font-weight: bold;
}

/* é’å°‘å¹´ç‰ˆä¸“å±æ ·å¼ */
.teen-mission-item {
    font-size: 1.1em;
    margin-bottom: 8px;
    color: #555;
}

.knowledge-plus-box {
    background-color: #f8f9fa;
    border-left: 4px solid #5C6BC0;
    padding: 15px;
    margin: 15px 0;
    font-size: 0.95em;
    border-radius: 4px;
}

.inspiration-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
}

.inspiration-item {
    background: #fafafa;
    border: 1px solid #eee;
    padding: 15px;
    border-radius: 8px;
}

.inspiration-item h4 {
    margin: 0 0 10px 0;
    color: #333;
    font-weight: bold;
}

.color-palette {
    display: flex;
    gap: 10px;
}

.color-swatch {
    width: 30px;
    height: 30px;
    border-radius: 50%;
    background-color: #eee;
}

.dot-grid {
    background-image: radial-gradient(#ccc 1px, transparent 0);
    background-size: 15px 15px;
    padding: 20px;
}

/* å®¶é•¿ç‰ˆä¸“å±æ ·å¼ */
.practical-info-box {
    background: #E8F5E9;
    padding: 15px;
    border-radius: 8px;
    border-left: 4px solid #66BB6A;
}

.practical-info-box ul {
    padding-left: 20px;
    margin: 0;
}

.storytelling-item, .engagement-item {
    margin-bottom: 15px;
}

.storytelling-item h4, .engagement-item h4 {
    color: #5C6BC0;
    font-weight: bold;
    margin-bottom: 5px;
}

.journal-space {
    border: 2px dashed #FFCC80;
    min-height: 100px;
    padding: 15px;
    border-radius: 10px;
    background: #FFFDE7;
    color: #8D6E63;
}

/* æ—…è¡Œè®¡åˆ’æ ·å¼ */
.travel-plan-container {
    max-width: 800px;
    margin: 0 auto;
    padding: 20px;
    background: white;
    border-radius: 15px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.1);
}

.plan-header {
    text-align: center;
    margin-bottom: 30px;
    padding: 20px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 15px;
}

.plan-header h1 {
    margin: 0 0 15px 0;
    font-size: 2em;
}

.plan-info {
    display: flex;
    justify-content: space-around;
    flex-wrap: wrap;
    gap: 10px;
}

.plan-info p {
    margin: 5px;
    background: rgba(255,255,255,0.2);
    padding: 8px 15px;
    border-radius: 20px;
    font-size: 0.9em;
}

.day-plan {
    margin-bottom: 30px;
    border: 2px solid #f0f0f0;
    border-radius: 15px;
    overflow: hidden;
}

.day-plan h2 {
    background: #f8f9fa;
    margin: 0;
    padding: 15px 20px;
    color: #333;
    border-bottom: 2px solid #e9ecef;
}

.day-sections {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 0;
}

.parent-section, .child-section {
    padding: 20px;
}

.parent-section {
    background: #fff8f0;
    border-right: 1px solid #e9ecef;
}

.child-section {
    background: #f0f8ff;
}

.parent-section h3 {
    color: #d63384;
    margin: 0 0 15px 0;
    font-size: 1.1em;
}

.child-section h3 {
    color: #0d6efd;
    margin: 0 0 15px 0;
    font-size: 1.1em;
}

.parent-section h4, .child-section h4 {
    margin: 0 0 15px 0;
    color: #495057;
    font-size: 1em;
}

.activities, .tips, .fun-facts {
    margin-bottom: 15px;
}

.activities h5, .tips h5, .fun-facts h5 {
    margin: 0 0 8px 0;
    color: #6c757d;
    font-size: 0.9em;
    font-weight: bold;
}

.activities ul, .tips ul, .fun-facts ul {
    margin: 0;
    padding-left: 20px;
}

.activities li, .tips li, .fun-facts li {
    margin-bottom: 5px;
    line-height: 1.4;
}

@media print {
    body {
        background-color: #fff;
        padding: 0;
        margin: 0;
    }
    .container {
        max-width: none;
        margin: 0;
    }
    .plan-section {
        display: block !important;
    }
    .version-tabs, .notebook-controls, .input-section, header {
        display: none !important;
    }
    .version-content {
        display: none !important;
        page-break-before: always;
    }
    .version-content.active {
        display: block !important;
    }
    .version-content-wrapper {
        border: none !important;
        padding: 0 !important;
        box-shadow: none;
    }
    .location-page-container {
        border: none !important;
        box-shadow: none;
        page-break-inside: avoid;
    }
}

@media (max-width: 768px) {
    .day-sections {
        grid-template-columns: 1fr;
    }

    .parent-section {
        border-right: none;
        border-bottom: 1px solid #e9ecef;
    }

    .plan-info {
        flex-direction: column;
        align-items: center;
    }
}

/* ç¬”è®°æœ¬æ ·å¼ */
.notebook-tabs {
    display: flex;
    justify-content: center;
    margin-bottom: -1px; /* è®©æ ‡ç­¾å’Œé¡µé¢è¾¹æ¡†é‡åˆ */
    flex-wrap: wrap;
    padding: 0 20px;
}

.tab {
    background-color: #F5F5F5;
    border: 1px solid #ddd;
    border-bottom: none;
    padding: 10px 15px;
    cursor: pointer;
    border-radius: 10px 10px 0 0;
    margin: 0 5px;
    font-family: 'LXGW WenKai Screen', cursive;
    font-weight: bold;
    color: #5C6BC0;
    position: relative;
    bottom: -5px;
    transition: all 0.2s ease-in-out;
}

.tab.active {
    background-color: #fff;
    border-top: 3px solid #7986CB;
    bottom: 0;
    padding-top: 12px;
}

.notebook-container {
    display: flex;
    gap: 30px;
    justify-content: center;
    width: 100%;
    margin-bottom: 20px;
}

.notebook-wrapper {
    width: 48%;
    max-width: 700px;
    display: flex;
    flex-direction: column;
    align-items: center;
}

.notebook-wrapper h2 {
    font-family: 'ZCOOL XiaoWei', serif;
    color: #3F51B5;
    margin-bottom: 15px;
}

@media (max-width: 1200px) {
    .notebook-container {
        flex-direction: column;
        align-items: center;
    }
    .notebook-wrapper {
        width: 90%;
    }
}
    </style>
</head>
<body>

    <div class="container input-section" id="input-container">
        <header>
            <h1>äº²å­æ—…è¡Œæ‰‹å†Œ</h1>
            <div style="display: flex; justify-content: center; margin: 15px 0;">
                <img src="images/afbcfbd3-addf-4e32-a3ab-6e2bca0a2ebd.jpeg" style="width: 80px; height: 80px; border-radius: 50%; object-fit: cover; box-shadow: 0 5px 15px rgba(92,107,192,0.3);" alt="å°å¯¼æ¸¸">
            </div>
            <p>ä¸€ä¸ªåœ°ç‚¹ï¼Œä¸‰ç§ç©æ³•ï¼ä¸“ä¸ºæœ‰å“å‘³ã€çˆ±æ¢ç´¢çš„å®¶åº­è®¾è®¡ï¼Œä¸ºä¸åŒå¹´é¾„æ®µçš„å­©å­ç”Ÿæˆä¸“å±çš„æ—…è¡Œæ‰‹è´¦ï¼</p>
        </header>

        <form id="trip-form" onsubmit="return false;">
            <!-- API è®¾ç½® -->
            <div class="form-block">
                <h3><span>ğŸ”‘</span>è¿æ¥AIåŠ©æ‰‹</h3>
                <div class="input-group">
                    <label for="api-provider">é€‰æ‹©AIæœåŠ¡å•†</label>
                    <select id="api-provider">
                        <option value="gemini">Google Gemini (æ¨è)</option>
                        <option value="openai">OpenAI</option>
                        <option value="deepseek">DeepSeek</option>
                        <option value="custom">è‡ªå®šä¹‰OpenAIå…¼å®¹æ¥å£</option>
                    </select>
                </div>
                <div class="input-group" id="custom-endpoint-group" style="margin-top: 15px; display: none;">
                    <label for="custom-endpoint">è‡ªå®šä¹‰APIç«¯ç‚¹</label>
                    <input type="text" id="custom-endpoint" placeholder="ä¾‹å¦‚ï¼šhttps://api.deepseek.com/v1">
                </div>
                <div class="input-group" style="margin-top: 15px;">
                    <label for="api-key">API Key</label>
                    <div class="api-key-row">
                        <input type="password" id="api-key" placeholder="è¯·åœ¨æ­¤ç²˜è´´æ‚¨çš„API Key">
                        <button type="button" class="fetch-btn" id="fetch-models-btn" disabled>æ‹‰å–æ¨¡å‹</button>
                    </div>
                </div>
                <div class="input-group" style="margin-top: 15px;">
                    <label for="model-select">é€‰æ‹©æ¨¡å‹</label>
                    <select id="model-select" disabled>
                        <option>è¯·å…ˆè¾“å…¥Keyå¹¶æ‹‰å–æ¨¡å‹</option>
                    </select>
                    <div id="api-status"></div>
                </div>
                <div class="input-group" style="margin-top: 15px;">
                    <button type="button" class="clear-btn" id="clear-settings-btn">ğŸ—‘ï¸ æ¸…é™¤ä¿å­˜çš„è®¾ç½®</button>
                    <div style="font-size: 0.8em; color: #666; margin-top: 5px;">
                        æ¸…é™¤æ‰€æœ‰ä¿å­˜åœ¨æµè§ˆå™¨ä¸­çš„APIè®¾ç½®
                    </div>
                    <div id="settings-status" style="font-size: 0.8em; margin-top: 5px;"></div>
                </div>
                <div class="input-group" style="margin-top: 15px;">
                    <label>
                        <input type="checkbox" id="enable-search" checked>
                        å¯ç”¨è”ç½‘æœç´¢ (è·å–å®æ—¶ä¿¡æ¯)
                    </label>
                    <div style="font-size: 0.9em; color: #666; margin-top: 5px;" id="search-description">
                        å¼€å¯åAIå°†æœç´¢æœ€æ–°çš„æ™¯ç‚¹ä¿¡æ¯ã€å¤©æ°”ã€ä»·æ ¼ç­‰
                    </div>
                </div>
                <div class="input-group" style="margin-top: 15px;" id="search-api-group">
                    <label for="search-api-key">æœç´¢API Key (å¯é€‰)</label>
                    <input type="password" id="search-api-key" placeholder="SerpAPI Key - æä¾›æ›´å‡†ç¡®çš„æœç´¢ç»“æœ">
                    <div style="font-size: 0.8em; color: #666; margin-top: 5px;">
                        ä¸å¡«å†™å°†ä½¿ç”¨æ¨¡æ‹Ÿæœç´¢ç»“æœã€‚è·å–å…è´¹API Key: <a href="https://serpapi.com" target="_blank">SerpAPI</a>
                    </div>
                </div>
            </div>

            <!-- ä½¿ç”¨æ¨¡å¼é€‰æ‹© -->
            <div class="form-block">
                <h3><span>ğŸ¯</span>ç¬¬ä¸€æ­¥ï¼šé€‰æ‹©ä½¿ç”¨æ¨¡å¼</h3>
                <div class="icon-options" id="usage-mode-selector">
                    <label><input type="radio" name="usage-mode" value="ai-planning" checked><div class="content"><div class="icon">ğŸ¤–</div><span>AIè§„åˆ’è¡Œç¨‹</span><div style="font-size:0.8em;color:#666;margin-top:3px;">è®©AIä¸ºæ‚¨å®‰æ’å®Œæ•´è¡Œç¨‹</div></div></label>
                    <label><input type="radio" name="usage-mode" value="existing-plan"><div class="content"><div class="icon">ğŸ“‹</div><span>å·²æœ‰è¡Œç¨‹å®‰æ’</span><div style="font-size:0.8em;color:#666;margin-top:3px;">ä¸ºç°æœ‰è¡Œç¨‹è¡¥å……æ”»ç•¥ä¿¡æ¯</div></div></label>
                </div>
            </div>

            <!-- è¯­è¨€é€‰æ‹© -->
            <div class="form-block">
                <h3><span>ğŸŒ</span>ç¬¬äºŒæ­¥ï¼šé€‰æ‹©æ”»ç•¥è¯­è¨€</h3>
                 <div class="icon-options">
                    <label><input type="radio" name="language" value="Simplified Chinese" checked><div class="content"><div class="icon">ğŸ‡¨ğŸ‡³</div><span>ç®€ä½“ä¸­æ–‡</span></div></label>
                    <label><input type="radio" name="language" value="English"><div class="content"><div class="icon">ğŸ‡¬ğŸ‡§</div><span>English</span></div></label>
                </div>
            </div>

            <!-- æ—…ç¨‹åŸºæœ¬è®¾ç½® -->
            <div class="form-block">
                <h3><span>ğŸ—ºï¸</span>ç¬¬ä¸‰æ­¥ï¼šæˆ‘ä»¬çš„æ—…ç¨‹</h3>
                <div class="input-label">æ—…ç¨‹ç±»å‹</div>
                <div class="icon-options" id="trip-type-selector">
                    <label><input type="radio" name="trip-type" value="day-trip" checked><div class="content"><div class="icon">ğŸ™ï¸</div><span>ä¸€æ—¥æ¸¸</span></div></label>
                    <label><input type="radio" name="trip-type" value="single-city"><div class="content"><div class="icon">ğŸ¡</div><span>çŸ­é€”æ—…è¡Œ</span></div></label>
                    <label><input type="radio" name="trip-type" value="multi-city"><div class="content"><div class="icon">âœˆï¸</div><span>é•¿é€”æ—…è¡Œ</span></div></label>
                </div>
                <div id="destination-inputs" style="margin-top: 15px;">
                    <div id="single-dest-group">
                        <div class="input-group">
                            <label for="destination">ç›®çš„åœ°</label>
                            <input type="text" id="destination" placeholder="ä¾‹å¦‚ï¼šåŒ—äº¬">
                        </div>
                        <div class="input-group" style="margin-top:10px;">
                            <label for="duration">å¤©æ•°</label>
                            <input type="number" id="duration" value="1" min="1" readonly>
                        </div>
                        <div class="input-group" style="margin-top:10px;">
                            <label for="departure-date">å‡ºå‘æ—¥æœŸ</label>
                            <input type="date" id="departure-date">
                            <div style="font-size: 0.8em; color: #666; margin-top: 3px;">
                                å¡«å†™åå¯è‡ªåŠ¨æŸ¥è¯¢å¤©æ°”é¢„æŠ¥
                            </div>
                        </div>
                    </div>
                    <div class="dynamic-list" id="multi-city-container" style="display: none;">
                        <button type="button" class="add-btn" id="add-city-btn">+</button>
                    </div>
                </div>

                <!-- AIè§„åˆ’æ¨¡å¼çš„å¿…å»æ™¯ç‚¹ -->
                <div id="ai-planning-section" style="margin-top: 20px;">
                    <div class="input-group">
                        <label for="must-visit-places">å¿…å»æ™¯ç‚¹ (å¯é€‰)</label>
                        <textarea id="must-visit-places" rows="4" placeholder="å¦‚æœæœ‰ç‰¹åˆ«æƒ³å»çš„åœ°æ–¹ï¼Œè¯·åˆ—å‡ºæ¥ï¼Œä¾‹å¦‚ï¼š
- æ•…å®«åšç‰©é™¢
- å¤©å®‰é—¨å¹¿åœº
- é¢å’Œå›­
- ç‹åºœäº•å¤§è¡—
...

AIä¼šä¼˜å…ˆå®‰æ’è¿™äº›æ™¯ç‚¹ï¼Œå¹¶è¡¥å……å…¶ä»–æ¨èåœ°ç‚¹"></textarea>
                        <div style="font-size: 0.8em; color: #666; margin-top: 5px;">
                            AIä¼šä¼˜å…ˆå®‰æ’è¿™äº›æ™¯ç‚¹ï¼Œå¹¶åœ¨æ­¤åŸºç¡€ä¸Šè¡¥å……å…¶ä»–é€‚åˆçš„åœ°ç‚¹å’Œæ´»åŠ¨
                        </div>
                    </div>
                </div>

                <!-- å·²æœ‰è¡Œç¨‹è¾“å…¥åŒºåŸŸ -->
                <div id="existing-plan-section" style="display: none; margin-top: 20px;">
                    <div class="input-group">
                        <label for="existing-itinerary">æ‚¨çš„è¯¦ç»†è¡Œç¨‹å®‰æ’</label>
                        <textarea id="existing-itinerary" rows="8" placeholder="è¯·è¯¦ç»†æè¿°æ‚¨çš„è¡Œç¨‹å®‰æ’ï¼Œä¾‹å¦‚ï¼š
ç¬¬ä¸€å¤©ï¼š
ä¸Šåˆ9:00 - æ•…å®«åšç‰©é™¢
ä¸­åˆ12:00 - åˆé¤
ä¸‹åˆ2:00 - å¤©å®‰é—¨å¹¿åœº
...

ç¬¬äºŒå¤©ï¼š
ä¸Šåˆ10:00 - é¢å’Œå›­
..."></textarea>
                        <div style="font-size: 0.8em; color: #666; margin-top: 5px;">
                            AIå°†ä¸ºæ‚¨çš„è¡Œç¨‹è¡¥å……é¤å…æ¨èã€äº¤é€šå»ºè®®ã€äº²å­è´´å£«ç­‰å®ç”¨ä¿¡æ¯
                        </div>
                    </div>
                </div>
            </div>

            <!-- å®¶åº­æˆå‘˜ -->
            <div class="form-block">
                <h3><span>ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦</span>ç¬¬å››æ­¥ï¼šå’Œè°ä¸€èµ·å»ï¼Ÿ</h3>
                <div class="dynamic-list" id="family-list">
                    <div class="list-item">
                        <input type="text" placeholder="ç§°è°“ (å¦‚: çˆ¸çˆ¸)" value="çˆ¸çˆ¸">
                        <input type="number" placeholder="å¹´é¾„" value="35" style="max-width: 80px;">
                        <button type="button" class="remove-btn">-</button>
                    </div>
                    <div class="list-item">
                        <input type="text" placeholder="ç§°è°“" value="æˆ‘">
                        <input type="number" placeholder="å¹´é¾„" value="5" style="max-width: 80px;">
                        <button type="button" class="remove-btn">-</button>
                    </div>
                </div>
                <button type="button" class="add-btn" id="add-family-btn">+</button>
            </div>
            
            <!-- äº¤é€šå’Œå¤©æ°” -->
            <div class="form-block">
                <h3><span>ğŸš—</span>ç¬¬äº”æ­¥ï¼šäº¤é€šä¸å¤©æ°”</h3>
                <div class="input-label">å»ç›®çš„åœ°åä»€ä¹ˆï¼Ÿ</div>
                <div class="icon-options">
                    <label><input type="radio" name="main-transport" value="é£æœº"><div class="content"><div class="icon">âœˆï¸</div><span>é£æœº</span></div></label>
                    <label><input type="radio" name="main-transport" value="ç«è½¦" checked><div class="content"><div class="icon">ğŸš„</div><span>ç«è½¦</span></div></label>
                    <label><input type="radio" name="main-transport" value="æ±½è½¦"><div class="content"><div class="icon">ğŸš—</div><span>æ±½è½¦</span></div></label>
                    <label><input type="radio" name="main-transport" value="å…¶ä»–"><div class="content"><div class="icon">ğŸšŒ</div><span>å…¶ä»–</span></div></label>
                </div>
                <div class="input-group" id="custom-main-transport-group" style="display: none; margin-top: 10px;">
                    <input type="text" id="custom-main-transport" placeholder="è¯·è¾“å…¥å…¶ä»–äº¤é€šæ–¹å¼ï¼Œä¾‹å¦‚ï¼šé•¿é€”å·´å£«ã€è‡ªé©¾ã€èˆ¹èˆ¶ç­‰">
                </div>
                <div class="input-label" style="margin-top: 15px;">åœ¨åŸå¸‚é‡Œä¸»è¦åä»€ä¹ˆï¼Ÿ(å¯å¤šé€‰)</div>
                <div class="icon-options">
                    <label><input type="checkbox" name="daily-transport" value="åœ°é“"><div class="content"><div class="icon">ğŸš‡</div><span>åœ°é“</span></div></label>
                    <label><input type="checkbox" name="daily-transport" value="å·´å£«"><div class="content"><div class="icon">ğŸšŒ</div><span>å·´å£«</span></div></label>
                    <label><input type="checkbox" name="daily-transport" value="æ±½è½¦"><div class="content"><div class="icon">ğŸš—</div><span>æ±½è½¦</span></div></label>
                    <label><input type="checkbox" name="daily-transport" value="èµ°è·¯" checked><div class="content"><div class="icon">ğŸš¶â€â™‚ï¸</div><span>èµ°è·¯</span></div></label>
                    <label><input type="checkbox" name="daily-transport" value="å…¶ä»–"><div class="content"><div class="icon">ğŸ›´</div><span>å…¶ä»–</span></div></label>
                </div>
                <div class="input-group" id="custom-daily-transport-group" style="display: none; margin-top: 10px;">
                    <input type="text" id="custom-daily-transport" placeholder="è¯·è¾“å…¥å…¶ä»–äº¤é€šæ–¹å¼ï¼Œä¾‹å¦‚ï¼šå…±äº«å•è½¦ã€ç”µåŠ¨æ»‘æ¿è½¦ã€æ‘©æ‰˜è½¦ç­‰">
                </div>

                <div class="input-label" style="margin-top: 15px;">å¤©æ°”ä¿¡æ¯</div>
                <div class="input-group">
                    <label>
                        <input type="checkbox" id="auto-weather" checked>
                        è‡ªåŠ¨æŸ¥è¯¢å¤©æ°”é¢„æŠ¥ (éœ€å¡«å†™å‡ºå‘æ—¥æœŸå’Œç›®çš„åœ°)
                    </label>
                </div>
                <div id="manual-weather-section" style="margin-top: 10px;">
                    <div class="input-label">æˆ–æ‰‹åŠ¨é€‰æ‹©é¢„è®¡å¤©æ°”ï¼š</div>
                    <div class="icon-options">
                        <label><input type="radio" name="weather" value="æ™´å¤©" checked><div class="content"><div class="icon">â˜€ï¸</div><span>æ™´å¤©</span></div></label>
                        <label><input type="radio" name="weather" value="å¤šäº‘"><div class="content"><div class="icon">â˜ï¸</div><span>å¤šäº‘</span></div></label>
                        <label><input type="radio" name="weather" value="ä¸‹é›¨"><div class="content"><div class="icon">ğŸŒ¦ï¸</div><span>ä¸‹é›¨</span></div></label>
                        <label><input type="radio" name="weather" value="ä¸‹é›ª"><div class="content"><div class="icon">â„ï¸</div><span>ä¸‹é›ª</span></div></label>
                    </div>
                </div>
                <div id="weather-status" style="font-size: 0.9em; color: #4CAF50; margin-top: 5px;"></div>
            </div>

            <!-- å…´è¶£çˆ±å¥½ -->
            <div class="form-block">
                <h3><span>ğŸ¯</span>ç¬¬å…­æ­¥ï¼šå…´è¶£çˆ±å¥½</h3>
                <div class="input-label">é€‰æ‹©æ„Ÿå…´è¶£çš„æ´»åŠ¨ç±»å‹ (å¯å¤šé€‰)</div>
                <div class="icon-options">
                    <label><input type="checkbox" name="interest" value="è¿åŠ¨æ´»åŠ¨"><div class="content"><div class="icon">âš½</div><span>è¿åŠ¨æ´»åŠ¨</span></div></label>
                    <label><input type="checkbox" name="interest" value="æ‰‹å·¥è‰º"><div class="content"><div class="icon">ğŸ¨</div><span>æ‰‹å·¥è‰º</span></div></label>
                </div>

                <div class="input-group" style="margin-top: 15px;">
                    <label for="custom-interests">å…¶ä»–å…´è¶£çˆ±å¥½ (è‡ªç”±å¡«å†™)</label>
                    <textarea id="custom-interests" rows="3" placeholder="ä¾‹å¦‚ï¼šå¯»æ‰¾ç”²è™«ã€é€›æ–‡å…·åº—ã€çœ‹è¡—å¤´è¡¨æ¼”ã€å¯»æ‰¾å½“åœ°ç‰¹è‰²å°åº—ã€ä½“éªŒä¼ ç»Ÿæ‰‹å·¥è‰º..."></textarea>
                </div>

                <div class="input-group" style="margin-top: 15px;">
                    <label for="special-needs">ç‰¹æ®Šéœ€æ±‚æˆ–æ³¨æ„äº‹é¡¹</label>
                    <textarea id="special-needs" rows="3" placeholder="ä¾‹å¦‚ï¼šå­©å­å¯¹èŠ±ç”Ÿè¿‡æ•ã€éœ€è¦å©´å„¿è½¦å‹å–„çš„åœºæ‰€ã€è€äººè¡ŒåŠ¨ä¸ä¾¿éœ€è¦æ— éšœç¢è®¾æ–½ã€ç´ é£Ÿéœ€æ±‚..."></textarea>
                </div>
            </div>

            <!-- è¡Œææ¸…å• -->
            <div class="form-block">
                <h3><span>ğŸ’</span>ç¬¬ä¸ƒæ­¥ï¼šè¡Œææ¸…å•</h3>
                <div class="input-label">å„¿ç«¥è¡Œææ¸…å• (è®©AIå‚è€ƒ)</div>
                <div class="dynamic-list" id="checklist-items">
                    <div class="list-item"><input type="text" value="æœ€å–œæ¬¢çš„å°ç†Šç©å¶"><button type="button" class="remove-btn">-</button></div>
                    <div class="list-item"><input type="text" value="æé¾™ç»˜æœ¬"><button type="button" class="remove-btn">-</button></div>
                </div>
                <button type="button" class="add-btn" id="add-checklist-btn">+</button>
            </div>

            <button type="submit" class="submit-btn" id="generate-btn" disabled>âœ¨ ç”Ÿæˆæ—…è¡Œæ‰‹å¸ âœ¨</button>
        </form>
    </div>

    <!-- è®¡åˆ’è¾“å‡ºåŒºåŸŸ -->
    <div class="container plan-section" id="plan-output" style="display: none;">
        <!-- ç‰ˆæœ¬åˆ‡æ¢æŒ‰é’® -->
        <div class="version-tabs">
            <button class="version-btn active" data-version="child">ğŸ¨ å„¿ç«¥ç‰ˆ (å†’é™©æ—¥å¿—)</button>
            <button class="version-btn" data-version="teenager">âœ’ï¸ é’å°‘å¹´ç‰ˆ (çµæ„Ÿç°¿)</button>
            <button class="version-btn" data-version="parent">ğŸ“– å®¶é•¿ç‰ˆ (æŒ‡å¯¼æ‰‹å†Œ)</button>
        </div>

        <!-- å†…å®¹å®¹å™¨ -->
        <div class="version-content-wrapper">
            <!-- å„¿ç«¥ç‰ˆå†…å®¹ -->
            <div id="child-view-content" class="version-content active">
                <!-- å„¿ç«¥ç‰ˆå†…å®¹å°†åŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
            </div>
            <!-- é’å°‘å¹´ç‰ˆå†…å®¹ -->
            <div id="teenager-view-content" class="version-content">
                <!-- é’å°‘å¹´ç‰ˆå†…å®¹å°†åŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
            </div>
            <!-- å®¶é•¿ç‰ˆå†…å®¹ -->
            <div id="parent-view-content" class="version-content">
                <!-- å®¶é•¿ç‰ˆå†…å®¹å°†åŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
            </div>
        </div>

        <!-- æ§åˆ¶æŒ‰é’® -->
        <div class="notebook-controls">
            <button class="print-btn" onclick="handlePrint()">ğŸ–¨ï¸ æ‰“å°å½“å‰ç‰ˆæœ¬</button>
            <button class="new-plan-btn" onclick="handleNewPlan()">ğŸ†• åˆ¶ä½œæ–°æ”»ç•¥</button>
        </div>
    </div>

    <!-- åŠ è½½æŒ‡ç¤ºå™¨ -->
    <div class="container" id="loading-indicator" style="display: none;">
        <div style="text-align: center; padding: 50px;">
            <div style="font-size: 3em; margin-bottom: 20px;">ğŸ”„</div>
            <h2>AIæ­£åœ¨ä¸ºæ‚¨ç²¾å¿ƒè§„åˆ’æ—…ç¨‹...</h2>
            <p>è¯·ç¨å€™ï¼Œè¿™å¯èƒ½éœ€è¦å‡ åˆ†é’Ÿæ—¶é—´</p>
        </div>
    </div>

                <script>
                // JSé€»è¾‘ - 100%å®Œæ•´

                // å…¨å±€å˜é‡
                let modelsCache = {};
                let currentPlanData = null;
                const imagePaths = [
                    'images/02ee957c-32fc-4cdb-a169-e5f2e738a58f.png',
                    'images/1b49ea1c-cacb-4161-a3ec-89d06d47b306.png',
                    'images/7633aa7e-33aa-4ada-b715-ef314f196859.png',
                    'images/afbcfbd3-addf-4e32-a3ab-6e2bca0a2ebd.jpeg',
                    'images/c5a9952a-2a41-4995-8822-6052069de53c.png',
                    'images/e1f3c3a9-985a-4467-af91-53e4a9990508.png',
                    'images/e3a8a3c2-c07c-42a3-98c1-58133379531e.png'
                ];

                // DOM å…ƒç´ 
                const apiKeyInput = document.getElementById('api-key');
                const apiProviderSelect = document.getElementById('api-provider');
                const customEndpointGroup = document.getElementById('custom-endpoint-group');
                const customEndpointInput = document.getElementById('custom-endpoint');
                const modelSelect = document.getElementById('model-select');
                const fetchModelsBtn = document.getElementById('fetch-models-btn');
                const apiStatus = document.getElementById('api-status');
                const clearSettingsBtn = document.getElementById('clear-settings-btn');
                const settingsStatus = document.getElementById('settings-status');
                const searchApiKeyInput = document.getElementById('search-api-key');
                const enableSearchCheckbox = document.getElementById('enable-search');
                const searchApiGroup = document.getElementById('search-api-group');
                const searchDescription = document.getElementById('search-description');
                const tripForm = document.getElementById('trip-form');
                const submitBtn = document.getElementById('generate-btn');
                const loadingIndicator = document.getElementById('loading-indicator');
                const inputContainer = document.getElementById('input-container');
                const planOutput = document.getElementById('plan-output');
                const tripTypeSelector = document.getElementById('trip-type-selector');
                const destinationInput = document.getElementById('destination');
                const durationInput = document.getElementById('duration');
                const singleDestGroup = document.getElementById('single-dest-group');
                const multiCityContainer = document.getElementById('multi-city-container');
                const addCityBtn = document.getElementById('add-city-btn');
                const departureDateInput = document.getElementById('departure-date');
                const addFamilyBtn = document.getElementById('add-family-btn');
                const familyList = document.getElementById('family-list');
                const usageModeSelector = document.getElementById('usage-mode-selector');
                const aiPlanningSection = document.getElementById('ai-planning-section');
                const existingPlanSection = document.getElementById('existing-plan-section');
                const mainTransportRadios = document.querySelectorAll('input[name="main-transport"]');
                const customMainTransportGroup = document.getElementById('custom-main-transport-group');
                const customMainTransportInput = document.getElementById('custom-main-transport');

                // è®¾ç½®ä¿å­˜å’ŒåŠ è½½åŠŸèƒ½
                function loadSettings() {
                    try {
                        const savedSettings = localStorage.getItem('travelPlannerSettings');
                        if (savedSettings) {
                            const settings = JSON.parse(savedSettings);

                            // æ¢å¤APIè®¾ç½®
                            if (settings.apiKey) apiKeyInput.value = settings.apiKey;
                            if (settings.apiProvider) apiProviderSelect.value = settings.apiProvider;
                            if (settings.customEndpoint) customEndpointInput.value = settings.customEndpoint;
                            if (settings.searchApiKey) searchApiKeyInput.value = settings.searchApiKey;
                            if (settings.enableSearch !== undefined) enableSearchCheckbox.checked = settings.enableSearch;

                            // æ¢å¤æ¨¡å‹é€‰æ‹©
                            if (settings.models && settings.models.length > 0) {
                                modelSelect.innerHTML = settings.models.map(model => `<option value="${model}">${model}</option>`).join('');
                                modelSelect.disabled = false;
                                if (settings.selectedModel) {
                                    modelSelect.value = settings.selectedModel;
                                }
                            }

                            settingsStatus.textContent = 'å·²åŠ è½½ä¿å­˜çš„è®¾ç½®';
                            setTimeout(() => settingsStatus.textContent = '', 3000);
                            validateForm();
                        }

                        // æ›´æ–°æŒ‰é’®çŠ¶æ€
                        fetchModelsBtn.disabled = !apiKeyInput.value.trim();
                    } catch (error) {
                        console.error('åŠ è½½è®¾ç½®å¤±è´¥:', error);
                        settingsStatus.textContent = 'åŠ è½½è®¾ç½®å¤±è´¥';
                        settingsStatus.style.color = 'red';
                        setTimeout(() => {
                            settingsStatus.textContent = '';
                            settingsStatus.style.color = '';
                        }, 3000);
                    }
                }

                function saveSettings() {
                    try {
                        const settings = {
                            apiKey: apiKeyInput.value,
                            apiProvider: apiProviderSelect.value,
                            customEndpoint: customEndpointInput.value,
                            searchApiKey: searchApiKeyInput.value,
                            enableSearch: enableSearchCheckbox.checked,
                            models: Array.from(modelSelect.options).map(option => option.value),
                            selectedModel: modelSelect.value
                        };

                        localStorage.setItem('travelPlannerSettings', JSON.stringify(settings));
                        settingsStatus.textContent = 'è®¾ç½®å·²ä¿å­˜';
                        settingsStatus.style.color = 'green';
                        setTimeout(() => {
                            settingsStatus.textContent = '';
                            settingsStatus.style.color = '';
                        }, 3000);
                    } catch (error) {
                        console.error('ä¿å­˜è®¾ç½®å¤±è´¥:', error);
                        settingsStatus.textContent = 'ä¿å­˜è®¾ç½®å¤±è´¥';
                        settingsStatus.style.color = 'red';
                        setTimeout(() => {
                            settingsStatus.textContent = '';
                            settingsStatus.style.color = '';
                        }, 3000);
                    }
                }

                function clearSettings() {
                    try {
                        localStorage.removeItem('travelPlannerSettings');

                        // æ¸…é™¤è¡¨å•
                        apiKeyInput.value = '';
                        apiProviderSelect.value = 'openai';
                        customEndpointInput.value = '';
                        searchApiKeyInput.value = '';
                        enableSearchCheckbox.checked = true;
                        modelSelect.innerHTML = '<option>è¯·å…ˆè¾“å…¥Keyå¹¶æ‹‰å–æ¨¡å‹</option>';
                        modelSelect.disabled = true;
                        apiStatus.textContent = '';

                        // æ›´æ–°UI
                        updateCustomEndpointVisibility();
                        updateGeminiSearchUI();
                        fetchModelsBtn.disabled = true;

                        settingsStatus.textContent = 'è®¾ç½®å·²æ¸…é™¤';
                        settingsStatus.style.color = 'orange';
                        setTimeout(() => {
                            settingsStatus.textContent = '';
                            settingsStatus.style.color = '';
                        }, 3000);
                    } catch (error) {
                        console.error('æ¸…é™¤è®¾ç½®å¤±è´¥:', error);
                        settingsStatus.textContent = 'æ¸…é™¤è®¾ç½®å¤±è´¥';
                        settingsStatus.style.color = 'red';
                        setTimeout(() => {
                            settingsStatus.textContent = '';
                            settingsStatus.style.color = '';
                        }, 3000);
                    }
                }

                // åˆå§‹åŒ–
                document.addEventListener('DOMContentLoaded', () => {
                    console.log('DOM loaded, initializing...');
                    loadSettings();
                    setupEventListeners();
                    updateFormForTripType();
                    updateFormForUsageMode();
                    updateGeminiSearchUI();
                    updateCustomEndpointVisibility();
                    updateMainTransportUI();
                    updateOptionStyles();

                    // åˆå§‹åŒ–æŒ‰é’®çŠ¶æ€
                    fetchModelsBtn.disabled = !apiKeyInput.value.trim();
                    console.log('API Key present:', !!apiKeyInput.value.trim());
                    console.log('Fetch button disabled:', fetchModelsBtn.disabled);

                    console.log('Initialization complete');
                });

                // è¡¨å•æäº¤å¤„ç†
                async function handleFormSubmit(e) {
                    e.preventDefault();

                    // éªŒè¯å¿…å¡«å­—æ®µ
                    const apiKey = apiKeyInput.value.trim();
                    const selectedModel = modelSelect.value;
                    const provider = apiProviderSelect.value;

                    if (!apiKey) {
                        showError('è¯·è¾“å…¥API Key');
                        return;
                    }

                    if (!selectedModel || selectedModel === 'è¯·å…ˆè¾“å…¥Keyå¹¶æ‹‰å–æ¨¡å‹') {
                        showError('è¯·å…ˆæ‹‰å–å¹¶é€‰æ‹©æ¨¡å‹');
                        return;
                    }

                    // æ”¶é›†è¡¨å•æ•°æ®
                    const formData = collectFormData();
                    if (!formData) return; // éªŒè¯å¤±è´¥

                    // æ˜¾ç¤ºè½½å…¥çŠ¶æ€
                    showLoading();

                    try {
                        // ç”Ÿæˆæç¤ºè¯
                        const prompt = generatePrompt(formData);

                        // è°ƒç”¨AI API
                        const response = await callAI(apiKey, selectedModel, prompt, provider);
                        console.log('AI Response:', response);

                        // è§£æå“åº”
                        let planData;
                        try {
                            // å°è¯•ç›´æ¥è§£æä¸ºJSON
                            planData = JSON.parse(response);
                        } catch (e) {
                            // å¦‚æœç›´æ¥è§£æå¤±è´¥ï¼Œå°è¯•æå–JSONéƒ¨åˆ†
                            console.log('Direct JSON parse failed, trying to extract JSON...');
                            const jsonMatch = response.match(/\{[\s\S]*\}/);
                            if (jsonMatch) {
                                try {
                                    planData = JSON.parse(jsonMatch[0]);
                                } catch (e2) {
                                    throw new Error('AIè¿”å›çš„å†…å®¹ä¸æ˜¯æœ‰æ•ˆçš„JSONæ ¼å¼');
                                }
                            } else {
                                throw new Error('AIè¿”å›çš„å†…å®¹ä¸­æ²¡æœ‰æ‰¾åˆ°JSONæ ¼å¼çš„æ•°æ®');
                            }
                        }

                        // æ¸²æŸ“è®¡åˆ’
                        renderPlan(planData);

                        // éšè—åŠ è½½çŠ¶æ€ï¼Œæ˜¾ç¤ºç»“æœ
                        hideLoading();
                        showPlanOutput();

                    } catch (error) {
                        console.error('ç”Ÿæˆè®¡åˆ’å¤±è´¥:', error);
                        hideLoading();
                        showError(`ç”Ÿæˆå¤±è´¥: ${error.message}`);
                    }
                }

                // æ”¶é›†è¡¨å–®æ•¸æ“š
                function collectFormData() {
                    const tripType = document.querySelector('input[name="trip-type"]:checked')?.value;
                    const language = document.querySelector('input[name="language"]:checked')?.value;
                    const usageMode = document.querySelector('input[name="usage-mode"]:checked')?.value;

                    let destination = '';
                    let duration = '';

                    if (tripType === 'multi-city') {
                        const cities = Array.from(document.querySelectorAll('#multi-city-container .list-item')).map(item => {
                            const cityInput = item.querySelector('.city-name') || item.querySelector('input[type="text"]');
                            const durationInput = item.querySelector('.city-duration');
                            return {
                                city: cityInput?.value?.trim() || '',
                                duration: parseInt(durationInput?.value) || 1
                            };
                        }).filter(city => city.city);

                        if (cities.length === 0) {
                            showError('è¯·è‡³å°‘æ·»åŠ ä¸€ä¸ªåŸå¸‚');
                            return null;
                        }

                        destination = cities.map(c => c.city).join('ã€');
                        duration = cities.reduce((sum, c) => sum + c.duration, 0);
                    } else {
                        destination = destinationInput.value.trim();
                        duration = parseInt(document.getElementById('duration')?.value) || 1;

                        if (!destination) {
                            showError('è¯·è¾“å…¥ç›®çš„åœ°');
                            return null;
                        }
                    }

                    // æ”¶é›†å®¶åº­æˆå“¡
                    const familyMembers = Array.from(document.querySelectorAll('#family-list .list-item')).map(item => {
                        const nameInput = item.querySelector('.member-name') || item.querySelector('input[type="text"]');
                        const ageInput = item.querySelector('.member-age') || item.querySelector('input[type="number"]');
                        return {
                            name: nameInput?.value?.trim() || '',
                            age: parseInt(ageInput?.value) || 0
                        };
                    }).filter(member => member.name);

                    return {
                        tripType,
                        language,
                        usageMode,
                        destination,
                        duration,
                        familyMembers,
                        enableSearch: enableSearchCheckbox.checked,
                        searchApiKey: searchApiKeyInput.value.trim()
                    };
                }

                // è·å–è¡¨å•å¿«ç…§ï¼ˆç”¨äºæ¸²æŸ“è®¡åˆ’ï¼‰
                function getFormSnapshot() {
                    const tripType = document.querySelector('input[name="trip-type"]:checked')?.value;
                    let destination = '';
                    let tripDuration = '';

                    if (tripType === 'multi-city') {
                        const cities = Array.from(document.querySelectorAll('#multi-city-container .list-item')).map(item => {
                            const cityInput = item.querySelector('.city-name') || item.querySelector('input[type="text"]');
                            const durationInput = item.querySelector('.city-duration');
                            return {
                                city: cityInput?.value?.trim() || '',
                                duration: parseInt(durationInput?.value) || 1
                            };
                        }).filter(city => city.city);

                        destination = cities.map(c => c.city).join('ã€');
                        tripDuration = cities.reduce((sum, c) => sum + c.duration, 0);
                    } else {
                        destination = destinationInput.value.trim();
                        tripDuration = parseInt(document.getElementById('duration')?.value) || 1;
                    }

                    // æ”¶é›†å®¶åº­æˆå“¡
                    const familyMembers = Array.from(document.querySelectorAll('#family-list .list-item')).map(item => {
                        const nameInput = item.querySelector('.member-name') || item.querySelector('input[type="text"]');
                        const ageInput = item.querySelector('.member-age') || item.querySelector('input[type="number"]');
                        return {
                            name: nameInput?.value?.trim() || '',
                            age: parseInt(ageInput?.value) || 0
                        };
                    }).filter(member => member.name);

                    return {
                        destination,
                        familyMembers,
                        tripDuration
                    };
                }

                // éªŒè¯è¡¨å•å¹¶æ›´æ–°æäº¤æŒ‰é’®çŠ¶æ€
                function validateForm() {
                    const apiKey = apiKeyInput.value.trim();
                    const selectedModel = modelSelect.value;
                    const destination = destinationInput.value.trim();

                    const isValid = apiKey &&
                                   selectedModel &&
                                   selectedModel !== 'è¯·å…ˆè¾“å…¥Keyå¹¶æ‹‰å–æ¨¡å‹' &&
                                   destination;

                    submitBtn.disabled = !isValid;
                }

                // æ›´æ–°é€‰é¡¹æ ·å¼
                function updateOptionStyles() {
                    // æ›´æ–°æ‰€æœ‰radioå’Œcheckboxçš„é¸ä¸­æ¨£å¼
                    document.querySelectorAll('.icon-options input[type="radio"], .icon-options input[type="checkbox"]').forEach(input => {
                        const label = input.closest('label');
                        if (input.checked) {
                            label.classList.add('selected');
                        } else {
                            label.classList.remove('selected');
                        }
                    });
                }

                // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
                function setupEventListeners() {
                    apiKeyInput.addEventListener('input', () => {
                        fetchModelsBtn.disabled = !apiKeyInput.value.trim();
                        validateForm();
                    });
                    fetchModelsBtn.addEventListener('click', fetchModels);
                    clearSettingsBtn.addEventListener('click', clearSettings);
                    apiProviderSelect.addEventListener('change', () => {
                        updateCustomEndpointVisibility();
                        updateGeminiSearchUI();
                        modelSelect.innerHTML = '<option>è¯·å…ˆè¾“å…¥Keyå¹¶æ‹‰å–æ¨¡å‹</option>';
                        modelSelect.disabled = true;
                        apiStatus.textContent = '';
                        validateForm();
                    });
                    modelSelect.addEventListener('change', validateForm);
                    destinationInput.addEventListener('input', validateForm);
                    enableSearchCheckbox.addEventListener('change', updateGeminiSearchUI);
                    tripTypeSelector.addEventListener('change', () => {
                        updateFormForTripType();
                        updateOptionStyles();
                    });
                    usageModeSelector.addEventListener('change', () => {
                        updateFormForUsageMode();
                        updateOptionStyles();
                    });
                    addCityBtn.addEventListener('click', () => addCityRow());
                    addFamilyBtn.addEventListener('click', () => addFamilyMember());
                    familyList.addEventListener('click', e => {
                        if (e.target.classList.contains('remove-btn')) {
                            e.target.closest('.list-item').remove();
                        }
                    });
                    multiCityContainer.addEventListener('click', e => {
                        if (e.target.classList.contains('remove-btn')) {
                            e.target.closest('.list-item').remove();
                            updateDurationFromCities();
                        }
                    });
                    multiCityContainer.addEventListener('input', e => {
                        if (e.target.classList.contains('city-duration')) {
                            updateDurationFromCities();
                        }
                    });
                    tripForm.addEventListener('submit', handleFormSubmit);

                    // ä¸ºæ‰€æœ‰é€‰é¡¹æ·»åŠ æ ·å¼æ›´æ–°äº‹ä»¶
                    document.addEventListener('change', (e) => {
                        if (e.target.matches('.icon-options input[type="radio"], .icon-options input[type="checkbox"]')) {
                            updateOptionStyles();
                        }
                    });

                    mainTransportRadios.forEach(radio => {
                        radio.addEventListener('change', updateMainTransportUI);
                    });
                }

                // ç”ŸæˆAIæç¤ºè¯
                function generatePrompt(formData) {
                    const { destination, duration, familyMembers, tripType, language, usageMode, enableSearch } = formData;

                    let prompt = `è¯·ä¸ºæˆ‘è§„åˆ’ä¸€ä¸ª${destination}çš„${duration}å¤©æ—…è¡Œè®¡åˆ’ã€‚`;

                    if (familyMembers.length > 0) {
                        const familyInfo = familyMembers.map(m => `${m.name}(${m.age}å²)`).join('ã€');
                        prompt += `æ—…è¡Œæˆå‘˜ï¼š${familyInfo}ã€‚`;
                    }

                    if (enableSearch) {
                        prompt += 'è¯·æœç´¢æœ€æ–°çš„æ™¯ç‚¹ä¿¡æ¯ã€å¤©æ°”ã€ä»·æ ¼ç­‰å®æ—¶èµ„è®¯ã€‚';
                    }

                    prompt += `

é‡è¦è¯´æ˜ï¼š
1. è¯·å°†æ—…è¡Œè®¡åˆ’åˆ†è§£ä¸ºå…·ä½“çš„åœ°ç‚¹/æ™¯ç‚¹ï¼Œè€Œä¸æ˜¯æŒ‰å¤©åˆ†ç»„
2. æ¯ä¸ªåœ°ç‚¹éƒ½è¦æä¾›ä¸‰ä¸ªç‰ˆæœ¬ï¼šå„¿ç«¥ç‰ˆã€é’å°‘å¹´ç‰ˆã€å®¶é•¿ç‰ˆ
3. è¯·ç¡®ä¿å†…å®¹ä¸°å¯Œä¸”é€‚åˆä¸åŒå¹´é¾„å±‚

**å¿…éœ€çš„JSONè¾“å‡ºæ ¼å¼**
è¯·åªè¿”å›ä»¥ä¸‹JSONæ ¼å¼ï¼Œä¸è¦åŒ…å«ä»»ä½•å…¶ä»–æ–‡å­—ï¼š

{
  "itinerary": [
    {
      "day": 1,
      "locationName": "å…·ä½“åœ°ç‚¹åç§°ï¼Œä¾‹å¦‚ï¼š'é›·å³°å¡”'",
      "estimatedTime": "å»ºè®®åœç•™æ—¶é—´ï¼Œä¾‹å¦‚ï¼š'1.5å°æ—¶'",
      "childVersion": {
        "title": "é€‚åˆå„¿ç«¥çš„æœ‰è¶£æ ‡é¢˜",
        "missions": ["é€‚åˆå„¿ç«¥çš„ç®€å•ä»»åŠ¡ï¼Œä¸æ­¤åœ°ç‚¹ç›¸å…³"],
        "funFact": "å…³äºæ­¤åœ°çš„æœ‰è¶£äº‹å®ï¼Œæ˜“äºç†è§£",
        "creativePrompt": "ä¸æ­¤åœ°ç‚¹ç›¸å…³çš„ç»˜ç”»æç¤º"
      },
      "teenagerVersion": {
        "title": "é€‚åˆé’å°‘å¹´çš„é…·ç‚«æ ‡é¢˜",
        "challenges": ["é€‚åˆé’å°‘å¹´çš„æ·±åº¦ä»»åŠ¡"],
        "knowledgePlus": "å…³äºæ­¤åœ°çš„æ·±åº¦çŸ¥è¯†",
        "inspirationPrompts": {
          "bgm": "é€‚åˆæ­¤åœ°ç‚¹çš„éŸ³ä¹é£æ ¼æç¤º",
          "colorPalette": ["ä»£è¡¨æ­¤åœ°ç‚¹çš„é¢œè‰²1", "é¢œè‰²2"],
          "reflection": "å¼•å‘æ€è€ƒçš„ä¸€å¥è¯æç¤º"
        }
      },
      "parentVersion": {
        "title": "å®ç”¨çš„åœ°ç‚¹æ ‡é¢˜",
        "practicalInfo": {
          "timing": "å»ºè®®æ—¶é—´ï¼Œä¾‹å¦‚ï¼š'ä¸Šåˆ10:00-11:30'",
          "transport": "äº¤é€šå»ºè®®",
          "tips": "é‡è¦æç¤º"
        },
        "storytellingToolkit": [{"topic": "åœ°ç‚¹ç‰¹è‰²", "story": "å¯ä»¥åˆ†äº«çš„å°æ•…äº‹"}],
        "engagementGuide": [{"prompt": "å¯ä»¥åœ¨æ­¤åœ°ç‚¹é—®å­©å­çš„å¼€æ”¾æ€§é—®é¢˜"}],
        "journalPrompt": "å®¶é•¿åæ€æ­¤åœ°ç‚¹çš„æç¤º"
      }
    }
  ]
}

è¯·ç”¨${language}å›åº”ï¼Œå¹¶ç¡®ä¿è¿”å›çš„æ˜¯æœ‰æ•ˆçš„JSONæ ¼å¼ã€‚`;

                    return prompt;
                }

                // æ˜¾ç¤ºè½½å…¥çŠ¶æ€
                function showLoading() {
                    loadingIndicator.style.display = 'block';
                    inputContainer.style.display = 'none';
                    const generateBtn = document.getElementById('generate-btn');
                    if (generateBtn) {
                        generateBtn.disabled = true;
                        generateBtn.textContent = 'æ­£åœ¨ç”Ÿæˆä¸­...';
                    }
                }

                // éšè—è½½å…¥çŠ¶æ€
                function hideLoading() {
                    loadingIndicator.style.display = 'none';
                    const generateBtn = document.getElementById('generate-btn');
                    if (generateBtn) {
                        generateBtn.disabled = false;
                        generateBtn.textContent = 'ç‚¹æˆ‘ç”Ÿæˆå†’é™©æ‰‹è´¦';
                    }
                }

                // æ˜¾ç¤ºè®¡åˆ’è¾“å‡º
                function showPlanOutput() {
                    planOutput.style.display = 'block';
                    inputContainer.style.display = 'none';
                }

                // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
                function showError(message) {
                    alert(message); // ç®€å•çš„é”™è¯¯æ˜¾ç¤ºï¼Œå¯ä»¥åç»­æ”¹è¿›
                }

                // å¤„ç†æ‰“å°åŠŸèƒ½
                function handlePrint() {
                    window.print();
                }

                // å¤„ç†æ–°è®¡åˆ’åŠŸèƒ½
                function handleNewPlan() {
                    planOutput.style.display = 'none';
                    inputContainer.style.display = 'block';

                    // é‡ç½®è¡¨å•ï¼ˆå¯é€‰ï¼‰
                    // tripForm.reset();
                }

                // UI æ›´æ–°å‡½æ•°
                function updateCustomEndpointVisibility() {
                    customEndpointGroup.style.display = apiProviderSelect.value === 'custom' ? 'block' : 'none';
                }

                function updateGeminiSearchUI() {
                    const isGemini = apiProviderSelect.value === 'gemini';
                    enableSearchCheckbox.disabled = !isGemini;
                    searchApiGroup.style.display = enableSearchCheckbox.checked && isGemini ? 'block' : 'none';
                    searchDescription.textContent = isGemini 
                        ? 'å¼€å¯åAIå°†æœç´¢æœ€æ–°çš„æ™¯ç‚¹ä¿¡æ¯ã€å¤©æ°”ã€ä»·æ ¼ç­‰' 
                        : 'è”ç½‘æœç´¢ä»…æ”¯æŒGoogle Geminiæ¨¡å‹';
                    if (!isGemini) {
                        enableSearchCheckbox.checked = false;
                    }
                }

                function updateMainTransportUI() {
                    const selectedTransport = document.querySelector('input[name="main-transport"]:checked').value;
                    customMainTransportGroup.style.display = selectedTransport === 'å…¶ä»–' ? 'block' : 'none';
                }

                function updateFormForTripType() {
                    const selectedTripType = document.querySelector('input[name="trip-type"]:checked')?.value;
                    console.log('Selected trip type:', selectedTripType);

                    // ä¸€æ—¥æ¸¸å’ŒçŸ­é€”æ—…è¡Œéƒ½æ˜¾ç¤ºå•ä¸€ç›®çš„åœ°è¾“å…¥
                    if (selectedTripType === 'day-trip' || selectedTripType === 'single-city') {
                        singleDestGroup.style.display = 'block';
                        multiCityContainer.style.display = 'none';
                        // æ ¹æ®ç±»å‹è®¾ç½®å¤©æ•°
                        if (selectedTripType === 'day-trip') {
                            durationInput.value = 1;
                            durationInput.readOnly = true;
                        } else {
                            durationInput.readOnly = false;
                        }
                    } else if (selectedTripType === 'multi-city') {
                        singleDestGroup.style.display = 'none';
                        multiCityContainer.style.display = 'block';
                        if (multiCityContainer.children.length <= 1) { // åªæœ‰æ·»åŠ æŒ‰é’®
                            addCityRow();
                        }
                    }
                }

                function updateFormForUsageMode() {
                    const selectedMode = document.querySelector('input[name="usage-mode"]:checked')?.value;
                    if (selectedMode === 'ai-planning') {
                        aiPlanningSection.style.display = 'block';
                        existingPlanSection.style.display = 'none';
                    } else if (selectedMode === 'existing-plan') {
                        aiPlanningSection.style.display = 'none';
                        existingPlanSection.style.display = 'block';
                    }
                }

                function addCityRow(city = '', days = 1) {
                    const cityRow = document.createElement('div');
                    cityRow.className = 'list-item';
                    cityRow.innerHTML = `
                        <input type="text" class="city-name" placeholder="åŸå¸‚åç§°" value="${city}">
                        <input type="number" class="city-duration" placeholder="å¤©æ•°" min="1" value="${days}">
                        <button type="button" class="remove-btn">-</button>
                    `;
                    multiCityContainer.appendChild(cityRow);
                }

                function updateDurationFromCities() {
                    const cityDurations = document.querySelectorAll('.city-duration');
                    const totalDays = Array.from(cityDurations).reduce((sum, input) => sum + (parseInt(input.value, 10) || 0), 0);
                    durationInput.value = totalDays;
                }

                function addFamilyMember() {
                    const memberRow = document.createElement('div');
                    memberRow.className = 'list-item';
                    memberRow.innerHTML = `
                        <input type="text" class="member-name" placeholder="å§“å/ç§°å‘¼">
                        <input type="number" class="member-age" placeholder="å¹´é¾„">
                        <select class="member-gender">
                            <option value="male">ç”·</option>
                            <option value="female">å¥³</option>
                        </select>
                        <button type="button" class="remove-btn">-</button>
                    `;
                    familyList.appendChild(memberRow);
                }

                // -------------------
                // --- API Calls ---
                // -------------------

                async function fetchModels() {
                    console.log('fetchModels called');
                    const apiKey = apiKeyInput.value.trim();
                    const provider = apiProviderSelect.value;
                    console.log('API Key:', apiKey ? 'Present' : 'Missing', 'Provider:', provider);
                    if (!apiKey) {
                        showError('è¯·å…ˆè¾“å…¥API Key');
                        return;
                    }

                    apiStatus.textContent = 'æ­£åœ¨æ‹‰å–æ¨¡å‹...';
                    modelSelect.disabled = true;

                    try {
                        let models = [];
                        if (provider === 'gemini') {
                            models = await getGeminiModels(apiKey);
                        } else {
                            const endpoint = provider === 'custom' ? customEndpointInput.value.trim() : null;
                            models = await getOpenAICompatibleModels(apiKey, endpoint);
                        }

                        modelSelect.innerHTML = models.map(model => `<option value="${model}">${model}</option>`).join('');
                        modelSelect.disabled = false;
                        apiStatus.textContent = `æˆåŠŸæ‹‰å– ${models.length} ä¸ªæ¨¡å‹`;
                        saveSettings();
                        validateForm();
                    } catch (error) {
                        console.error('Fetch models error:', error);
                        showError(`æ‹‰å–æ¨¡å‹å¤±è´¥: ${error.message}`);
                        apiStatus.textContent = 'æ‹‰å–å¤±è´¥';
                    }
                }

                async function getGeminiModels(apiKey) {
                    try {
                        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${apiKey}`);
                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                        }
                        const data = await response.json();
                        console.log('Gemini API response:', data);

                        // æå–æ¨¡å‹åç§°å¹¶è¿‡æ»¤å‡ºç”Ÿæˆæ¨¡å‹
                        const models = data.models
                            .filter(model => model.supportedGenerationMethods &&
                                           model.supportedGenerationMethods.includes('generateContent'))
                            .map(model => model.name.replace('models/', ''));

                        console.log('Available Gemini models:', models);
                        return models;
                    } catch (error) {
                        console.warn('Failed to fetch Gemini models from API, using fallback list:', error);
                        // å¦‚æœAPIè°ƒç”¨å¤±è´¥ï¼Œè¿”å›å·²çŸ¥çš„æ¨¡å‹åˆ—è¡¨
                        return [
                            'gemini-1.5-flash-latest',
                            'gemini-1.5-pro-latest',
                            'gemini-1.0-pro',
                            'gemini-1.5-flash',
                            'gemini-1.5-pro'
                        ];
                    }
                }

                async function getOpenAICompatibleModels(apiKey, customEndpoint = null) {
                    const endpoint = customEndpoint || 'https://api.openai.com/v1';
                    const response = await fetch(`${endpoint}/models`, {
                        headers: { 'Authorization': `Bearer ${apiKey}` }
                    });
                    if (!response.ok) {
                        const err = await response.json();
                        throw new Error(err.error.message);
                    }
                    const { data } = await response.json();
                    console.log('All available models:', data.map(model => model.id));

                    // è¿‡æ»¤æ‰ä¸€äº›ä¸é€‚åˆèŠå¤©çš„æ¨¡å‹ï¼Œä½†ä¿ç•™å¤§éƒ¨åˆ†æ¨¡å‹
                    const filteredModels = data.map(model => model.id).filter(id => {
                        // æ’é™¤æ˜æ˜¾ä¸é€‚åˆèŠå¤©çš„æ¨¡å‹
                        const excludePatterns = [
                            'whisper', 'tts', 'dall-e', 'embedding', 'moderation',
                            'text-similarity', 'text-search', 'code-search'
                        ];
                        return !excludePatterns.some(pattern => id.toLowerCase().includes(pattern));
                    });

                    console.log('Filtered models:', filteredModels);
                    return filteredModels;
                }

                async function callAI(apiKey, modelName, prompt, provider) {
                    console.log('å¼€å§‹è°ƒç”¨AI:', { provider, modelName });

                    try {
                        const endpoint = provider === 'custom' ? customEndpointInput.value.trim() : null;
                        if (provider === 'gemini') {
                            return await callGeminiAPI(apiKey, modelName, prompt);
                        } else {
                            return await callOpenAICompatibleAPI(apiKey, modelName, prompt, endpoint);
                        }
                    } catch (error) {
                        console.error('AIè°ƒç”¨å¤±è´¥:', error);
                        throw new Error(`AIè°ƒç”¨å¤±è´¥ (${provider}): ${error.message}`);
                    }
                }

                async function callGeminiAPI(apiKey, modelName, prompt) {
                    const url = `https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${apiKey}`;
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                    });
                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(JSON.stringify(error));
                    }
                    const data = await response.json();
                    return data.candidates[0].content.parts[0].text;
                }

                async function callOpenAICompatibleAPI(apiKey, modelName, prompt, customEndpoint = null) {
                    const endpoint = customEndpoint || 'https://api.openai.com/v1';
                    const url = `${endpoint}/chat/completions`;

                    console.log('APIè°ƒç”¨ä¿¡æ¯:', {
                        endpoint: endpoint,
                        url: url,
                        model: modelName,
                        hasApiKey: !!apiKey,
                        promptLength: prompt.length
                    });

                    let response;
                    try {
                        response = await fetch(url, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${apiKey}`
                            },
                            body: JSON.stringify({
                                model: modelName,
                                messages: [{ role: 'user', content: prompt }],
                                temperature: 0.7,
                                stream: false
                            })
                        });

                        console.log('APIå“åº”çŠ¶æ€:', response.status, response.statusText);

                        if (!response.ok) {
                            let errorMessage = `HTTP ${response.status}: ${response.statusText}`;
                            let errorDetails = '';

                            try {
                                const errorText = await response.text();
                                console.log('é”™è¯¯å“åº”å†…å®¹:', errorText);

                                try {
                                    const error = JSON.parse(errorText);
                                    errorMessage = error.error?.message || error.message || errorMessage;
                                    errorDetails = JSON.stringify(error, null, 2);
                                } catch (parseError) {
                                    errorDetails = errorText;
                                }
                            } catch (e) {
                                console.error('æ— æ³•è¯»å–é”™è¯¯å“åº”:', e);
                            }

                            const fullError = `${errorMessage}\nè¯¦ç»†ä¿¡æ¯: ${errorDetails}`;
                            throw new Error(fullError);
                        }
                    } catch (fetchError) {
                        console.error('ç½‘ç»œè¯·æ±‚å¤±è´¥:', fetchError);
                        if (fetchError.name === 'TypeError' && fetchError.message.includes('fetch')) {
                            throw new Error(`ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥:\n1. ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸\n2. APIç«¯ç‚¹åœ°å€æ˜¯å¦æ­£ç¡®: ${url}\n3. æ˜¯å¦å­˜åœ¨CORSé™åˆ¶\n\nåŸå§‹é”™è¯¯: ${fetchError.message}`);
                        }
                        throw fetchError;
                    }

                    const responseText = await response.text();
                    console.log('Raw response:', responseText);

                    // æ£€æŸ¥æ˜¯å¦æ˜¯SSEæ ¼å¼çš„å“åº”
                    if (responseText.startsWith('data: ')) {
                        // å¤„ç†SSEæ ¼å¼çš„å“åº”
                        const lines = responseText.split('\n');
                        let content = '';
                        for (const line of lines) {
                            if (line.startsWith('data: ')) {
                                const dataStr = line.substring(6);
                                if (dataStr === '[DONE]') break;
                                try {
                                    const data = JSON.parse(dataStr);
                                    if (data.choices && data.choices[0] && data.choices[0].delta && data.choices[0].delta.content) {
                                        content += data.choices[0].delta.content;
                                    }
                                } catch (e) {
                                    console.warn('Failed to parse SSE line:', line);
                                }
                            }
                        }
                        return content;
                    } else {
                        // å¤„ç†æ ‡å‡†JSONå“åº”
                        const data = JSON.parse(responseText);
                        return data.choices[0].message.content;
                    }
                }

                // -------------------
                // --- Plan Rendering ---
                // -------------------

                function renderPlan(data) {
                    if (!data.itinerary || !Array.isArray(data.itinerary)) {
                        console.error("AI's JSON response is missing the 'itinerary' array.", data);
                        showError("AIè¿”å›çš„æ•°æ®æ ¼å¼ä¸æ­£ç¡®ï¼Œç¼ºå°‘ 'itinerary' æ•°ç»„ã€‚");
                        return;
                    }

                    const childView = document.getElementById('child-view-content');
                    const teenagerView = document.getElementById('teenager-view-content');
                    const parentView = document.getElementById('parent-view-content');

                    if (!childView || !teenagerView || !parentView) {
                        showError('æ‰¾ä¸åˆ°ç‰ˆæœ¬å†…å®¹å®¹å™¨');
                        return;
                    }

                    childView.innerHTML = '';
                    teenagerView.innerHTML = '';
                    parentView.innerHTML = '';

                    data.itinerary.forEach((locationData, index) => {
                        childView.innerHTML += renderChildVersion(locationData, index);
                        teenagerView.innerHTML += renderTeenagerVersion(locationData, index);
                        parentView.innerHTML += renderParentVersion(locationData, index);
                    });

                    setupVersionTabs();
                    inputContainer.style.display = 'none';
                    planOutput.style.display = 'block';
                    window.scrollTo(0, 0);
                }

                function setupVersionTabs() {
                    const tabs = document.querySelectorAll('.version-btn');
                    const contents = document.querySelectorAll('.version-content');

                    tabs.forEach(tab => {
                        tab.addEventListener('click', () => {
                            tabs.forEach(t => t.classList.remove('active'));
                            contents.forEach(c => c.classList.remove('active'));
                            tab.classList.add('active');
                            const version = tab.dataset.version;
                            document.getElementById(`${version}-view-content`).classList.add('active');
                        });
                    });
                }

                function renderChildVersion(locationData, index) {
                    const { day, locationName, estimatedTime, childVersion: cv } = locationData;
                    if (!cv) return '';

                    return `
                        <div class="location-page-container">
                            <h1 class="location-title-h1">ğŸ“ ç¬¬ ${index + 1} ç«™: ${locationName}</h1>
                            <h2 class="location-title-h2">(ç¬¬ ${day} å¤© | é¢„è®¡éœ€è¦: ${estimatedTime || 'ä¸€å°ä¼šå„¿'})</h2>

                            <div class="section-container">
                                <h3 class="section-title-h3"><span>ğŸ—ºï¸</span> ${cv.title || 'æˆ‘çš„å†’é™©ä»»åŠ¡'}</h3>
                                <ul class="mission-list">
                                    ${(cv.missions || []).map(m => `<li class="mission-item">â–¡ ${m}</li>`).join('')}
                                </ul>
                            </div>

                            <div class="section-container">
                                <h3 class="section-title-h3"><span>ğŸ’¡</span> è¶£å‘³å°çŸ¥è¯†</h3>
                                <div class="fun-fact-box">
                                    <p>${cv.funFact || 'è¿™é‡Œè—ç€ä»€ä¹ˆç§˜å¯†å‘¢ï¼Ÿ'}</p>
                                </div>
                            </div>

                            <div class="section-container">
                                <h3 class="section-title-h3"><span>ğŸ¨</span> æˆ‘çš„åˆ›ä½œåŒº
                                <div class="creative-zone">
                                    <p>${cv.creativePrompt || 'åœ¨è¿™é‡Œç”»ä¸‹ä½ çœ‹åˆ°çš„æœ€é…·çš„ä¸œè¥¿ï¼'}</p>
                                </div>
                            </div>
                        </div>
                    `;
                }

                function renderTeenagerVersion(locationData, index) {
                    const { day, locationName, estimatedTime, teenagerVersion: tv } = locationData;
                    if (!tv) return '';

                    const isValidColor = (str) => {
                        if (!str) return false;
                        const s = new Option().style;
                        s.color = str.toLowerCase();
                        return s.color !== '';
                    };

                    return `
                        <div class="location-page-container">
                            <h1 class="location-title-h1">#${index + 1} ${locationName}</h1>
                            <h2 class="location-title-h2">Day ${day} | Est. ${estimatedTime || 'N/A'}</h2>

                            <div class="section-container">
                                <h3 class="section-title-h3"><span>ğŸ¯</span> ${tv.title || 'My Challenges'}</h3>
                                ${(tv.challenges || []).map(c => `<p class="teen-mission-item">/ / ${c}</p>`).join('')}
                            </div>

                            <div class="section-container">
                                <h3 class="section-title-h3"><span>ğŸ§ </span> Knowledge+</h3>
                                <div class="knowledge-plus-box">${tv.knowledgePlus || 'Discover something new.'}</div>
                            </div>

                            <div class="section-container">
                                <h3 class="section-title-h3"><span>âœ¨</span> Inspiration Catcher</h3>
                                <div class="inspiration-grid">
                                    <div class="inspiration-item">
                                        <h4>æ—¶é—´ä¸äº¤é€š</h4>
                                        <p>${tv.inspirationPrompts?.bgm || '...'}</p>
                                    </div>
                                    <div class="inspiration-item">
                                        <h4>Color Palette</h4>
                                        <div class="color-palette">
                                            ${(tv.inspirationPrompts?.colorPalette || []).map(color => {
                                                const bgColor = isValidColor(color) ? color : '#eee';
                                                return `<div class="color-swatch" title="${color}" style="background-color:${bgColor}; border: 1px solid #ddd;"></div>`;
                                            }).join('')}
                                        </div>
                                    </div>
                                    <div class="inspiration-item">
                                        <h4>Reflection</h4>
                                        <p>${tv.inspirationPrompts?.reflection || '...'}</p>
                                    </div>
                                </div>
                            </div>

                            <div class="section-container">
                                 <h3 class="section-title-h3"><span>âœï¸</span> Free Space</h3>
                                 <div class="dot-grid" style="min-height: 200px;"></div>
                            </div>
                        </div>
                    `;
                }

                function renderParentVersion(locationData, index) {
                    const { day, locationName, estimatedTime, parentVersion: pv } = locationData;
                    if (!pv) return '';

                    return `
                        <div class="location-page-container">
                            <h1 class="location-title-h1">ç¬¬ ${index + 1} ç«™: ${locationName}</h1>
                            <h2 class="location-title-h2">(ç¬¬ ${day} å¤© | å‚è€ƒç”¨æ—¶: ${estimatedTime || 'çµæ´»å®‰æ’'})</h2>

                            <div class="section-container">
                                <h3 class="section-title-h3"><span>ğŸ“‹</span> ${pv.title || 'å®ç”¨ä¿¡æ¯'}</h3>
                                <div class="practical-info-box">
                                    <ul>
                                        <li><strong>å»ºè®®æ—¶é—´:</strong> ${pv.practicalInfo?.timing || 'çµæ´»å®‰æ’'}</li>
                                        <li><strong>äº¤é€šå»ºè®®:</strong> ${pv.practicalInfo?.transport || 'æ ¹æ®å®é™…æƒ…å†µé€‰æ‹©'}</li>
                                        <li><strong>é‡è¦æç¤º:</strong> ${pv.practicalInfo?.tips || 'æ— '}</li>
                                    </ul>
                                </div>
                            </div>

                            <div class="section-container">
                                <h3 class="section-title-h3"><span>ğŸ™ï¸</span> æ•…äº‹å®åº“</h3>
                                ${(pv.storytellingToolkit || []).map(s => `
                                    <div class="storytelling-item">
                                        <h4>${s.topic}</h4>
                                        <p>${s.story}</p>
                                    </div>
                                `).join('')}
                            </div>

                            <div class="section-container">
                                <h3 class="section-title-h3"><span>ğŸ¤</span> äº’åŠ¨æŒ‡å—</h3>
                                 ${(pv.engagementGuide || []).map(e => `
                                    <div class="engagement-item">
                                        <p>ğŸ’¡ ${e.prompt}</p>
                                    </div>
                                `).join('')}
                            </div>

                            <div class="section-container">
                                <h3 class="section-title-h3"><span>ğŸ“”</span> ä»Šæ—¥æ‰‹è®°</h3>
                                <div class="journal-space">
                                    <p>${pv.journalPrompt || 'è®°å½•ä¸‹åœ¨è¿™é‡Œçš„ç¾å¥½ç¬é—´...'}</p>
                                </div>
                            </div>
                        </div>
                    `;
                }

                function generateTravelPlanHTML(tripPlan, destination, familyMembers, tripDuration) {
                    const familyNames = familyMembers.map(m => m.name).join('ã€') || 'æˆ‘ä»¬';

                    let html = `
                        <div class="travel-plan-container">
                            <div class="plan-header">
                                <h1>ğŸŒŸ ${destination} æ—…è¡Œè®¡åˆ’</h1>
                                <div class="plan-info">
                                    <p><strong>ç›®çš„åœ°:</strong> ${destination}</p>
                                    <p><strong>æ—…è¡Œå¤©æ•°:</strong> ${tripDuration}å¤©</p>
                                    <p><strong>æ—…è¡Œæˆå‘˜:</strong> ${familyNames}</p>
                                </div>
                            </div>

                            <div class="plan-content">
                    `;

                    // ç”Ÿæˆæ¯æ—¥è¡Œç¨‹
                    tripPlan.forEach(dayData => {
                        html += `
                            <div class="day-plan">
                                <h2>ç¬¬${dayData.day}å¤©: ${dayData.theme || dayData.parentVersion?.title || dayData.childVersion?.title || ''}</h2>

                                <div class="day-sections">
                                    <!-- å®¶é•¿ç‰ˆæœ¬ -->
                                    <div class="parent-section">
                                        <h3>ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ å®¶é•¿ç‰ˆ</h3>
                                        <h4>${dayData.parentVersion?.title || ''}</h4>

                                        ${dayData.parentVersion?.activities ? `
                                            <div class="activities">
                                                <h5>ğŸ—“ï¸ æ´»åŠ¨å®‰æ’</h5>
                                                <ul>
                                                    ${dayData.parentVersion.activities.map(activity => `<li>${activity}</li>`).join('')}
                                                </ul>
                                            </div>
                                        ` : ''}

                                        ${dayData.parentVersion?.tips ? `
                                            <div class="tips">
                                                <h5>ğŸ’¡ è´´å£«</h5>
                                                <ul>
                                                    ${dayData.parentVersion.tips.map(tip => `<li>${tip}</li>`).join('')}
                                                </ul>
                                            </div>
                                        ` : ''}
                                    </div>

                                    <!-- å„¿ç«¥ç‰ˆæœ¬ -->
                                    <div class="child-section">
                                        <h3>ğŸ‘¶ å„¿ç«¥ç‰ˆ</h3>
                                        <h4>${dayData.childVersion?.title || ''}</h4>

                                        ${dayData.childVersion?.activities ? `
                                            <div class="activities">
                                                <h5>ğŸˆ ä»Šå¤©ç©ä»€ä¹ˆ</h5>
                                                <ul>${(dayData.childVersion.itinerary || []).map(i => `<li>${i}</li>`).join('')}</ul>
                                            </div>
                                        ` : ''}

                                        ${dayData.childVersion?.funFacts ? `
                                            <div class="fun-facts">
                                                <h5>ğŸ¤” æœ‰è¶£çš„çŸ¥è¯†</h5>
                                                <ul>${(dayData.childVersion.funFacts || []).map(fact => `<li>${fact}</li>`).join('')}</ul>
                                            </div>
                                        ` : ''}
                                    </div>
                                </div>
                            </div>
                        `;
                    });

                    html += `
                            </div>
                        </div>
                    `;

                    return html;
                }

                function renderNotebook(type, tripPlan, destination, familyMembers, tripDuration) {
                    const notebookContent = document.getElementById(`${type}-notebook-content`);
                    const notebookTabs = document.getElementById(`${type}-notebook-tabs`);
                    notebookContent.innerHTML = '';
                    notebookTabs.innerHTML = '';

                    // Create static pages
                    const coverPage = createPage(`${type}-cover`, 'å°é¢');
                    const itineraryPage = createPage(`${type}-itinerary`, 'æ€»è§ˆ');
                    const checklistPage = createPage(`${type}-checklist`, 'è¡Œæ');
                    const safetyPage = createPage(`${type}-safety`, 'å®‰å…¨');

                    // Add static pages to content
                    notebookContent.appendChild(coverPage);
                    notebookContent.appendChild(itineraryPage);
                    notebookContent.appendChild(checklistPage);

                    // Generate content for static pages
                    generateCoverPage(coverPage.querySelector('.page-content'), destination, familyMembers, tripDuration, type);
                    generateChecklistPage(checklistPage.querySelector('.page-content'), familyMembers, type);
                    generateSafetyPage(safetyPage.querySelector('.page-content'), destination);

                    // Generate dynamic detail pages
                    if (type === 'children') {
                        generateSimpleItineraryForChild(itineraryPage.querySelector('.page-content'), tripPlan);
                        generateChildDetailPages(tripPlan, notebookContent);
                    } else {
                        generateSimpleItineraryForParent(itineraryPage.querySelector('.page-content'), tripPlan);
                        generateParentDetailPages(tripPlan, notebookContent);
                    }
                    
                    notebookContent.appendChild(safetyPage);

                    // Update tabs
                    updateNotebookTabs(type, tripPlan.length);

                    // Set initial active tab
                    setActiveTab(notebookTabs.querySelector('.tab-item'));
                }

                function createPage(id, label) {
                    const page = document.createElement('div');
                    page.className = 'notebook-page';
                    page.id = `page-${id}`;
                    page.innerHTML = `<div class="page-content"></div>`;
                    return page;
                }

                function generateCoverPage(container, destination, familyMembers, duration, type) {
                    const familyNames = familyMembers.map(m => m.name).join('ã€') || 'æˆ‘ä»¬';
                    const title = type === 'children' ? 'æˆ‘çš„ä¸“å±æ—…è¡Œæ—¥è®°' : `${destination} å®¶åº­æ—…è¡Œè®¡åˆ’`;
                    container.innerHTML = `
                        <div class="cover-page">
                            <h1>${title}</h1>
                            <img src="images/7633aa7e-33aa-4ada-b715-ef314f196859.png" alt="Travel Illustration" class="cover-image">
                            <div class="cover-info">
                                <p><strong>ç›®çš„åœ°:</strong> ${destination}</p>
                                <p><strong>æ—…è¡Œå®¶:</strong> ${familyNames}</p>
                                <p><strong>æ—¶é•¿:</strong> ${duration} å¤©</p>
                            </div>
                            <div class="cover-footer">${new Date().getFullYear()}</div>
                        </div>
                    `;
                }

                function generateSimpleItineraryForChild(container, tripPlan) {
                    let itineraryHTML = `<h2>ğŸ¨ è¡Œç¨‹äº®ç‚¹</h2>`;
                    tripPlan.forEach(dayData => {
                        itineraryHTML += `
                            <div class="day-summary">
                                <h3>ç¬¬${dayData.day}å¤©: ${dayData.theme}</h3>
                                <p>${dayData.childVersion.title}</p>
                                <ul>
                                    ${(dayData.childVersion.itinerary || []).map(item => `<li>${item}</li>`).join('')}
                                </ul>
                            </div>
                        `;
                    });
                    container.innerHTML = itineraryHTML;
                }

                function generateSimpleItineraryForParent(container, tripPlan) {
                    let itineraryHTML = `<h2>ğŸ“‹ è¡Œç¨‹æ€»è§ˆ</h2>`;
                    tripPlan.forEach(dayData => {
                        itineraryHTML += `
                            <div class="day-summary">
                                <h3>ç¬¬${dayData.day}å¤©: ${dayData.theme}</h3>
                                <p>${dayData.parentVersion.title}</p>
                                <ul>
                                    ${(dayData.parentVersion.itinerary || []).map(item => `<li>${item}</li>`).join('')}
                                </ul>
                            </div>
                        `;
                    });
                    container.innerHTML = itineraryHTML;
                }

                function generateChecklistPage(container, familyMembers, type) {
                    let checklistHTML = `<h2>ğŸ’ è¡Œæå¤‡å¿˜å½•</h2>`;
                    const categories = {
                        'é€šç”¨ç‰©å“': ['è¯ä»¶', 'ç°é‡‘/ä¿¡ç”¨å¡', 'æ‰‹æœº/å……ç”µå™¨', 'å¸¸ç”¨è¯å“', 'é›¨å…·'],
                        'è¡£ç‰©': ['å†…å¤–è¡£ç‰©', 'ç¡è¡£', 'å¤‡ç”¨é‹è¢œ'],
                        'æ´—æ¼±ç”¨å“': ['ç‰™åˆ·ç‰™è†', 'æ¯›å·¾', 'é˜²æ™’éœœ']
                    };
                    if (type === 'children') {
                        categories['æˆ‘çš„ä¸“å±'] = ['å–œçˆ±ç©å…·', 'é›¶é£Ÿ/æ°´å£¶', 'æ•…äº‹ä¹¦/ç”»æ¿'];
                    }
                    for (const category in categories) {
                        checklistHTML += `
                            <div class="checklist-section">
                                <h3>${category}</h3>
                                ${categories[category].map(item => `
                                    <div class="checklist-item">
                                        <input type="checkbox" id="check-${type}-${item.replace(/\s|\//g, '')}">
                                        <label for="check-${type}-${item.replace(/\s|\//g, '')}">${item}</label>
                                    </div>
                                `).join('')}
                            </div>
                        `;
                    }
                    container.innerHTML = checklistHTML;
                }

                function generateChildDetailPages(tripPlan, container) {
                    tripPlan.forEach(dayData => {
                        const page = createPage(`children-detail-${dayData.day}`, `ç¬¬${dayData.day}å¤©`);
                        const content = page.querySelector('.page-content');
                        content.innerHTML = `
                            <h2>ç¬¬${dayData.day}å¤©: ${dayData.childVersion.title}</h2>
                            <div class="info-section">
                                <h4>ğŸˆ ä»Šå¤©ç©ä»€ä¹ˆ?</h4>
                                <ul>${(dayData.childVersion.itinerary || []).map(i => `<li>${i}</li>`).join('')}</ul>
                            </div>
                            <div class="info-section">
                                <h4>ğŸ¨ æ¶‚é¸¦å’Œè´´çº¸åŒº</h4>
                                <div class="drawing-area">
                                    <p>åœ¨è¿™é‡Œç”»ä¸‹ä»Šå¤©æœ€å¼€å¿ƒçš„äº‹å§ï¼</p>
                                </div>
                            </div>
                        `;
                        container.appendChild(page);
                    });
                }

                function generateParentDetailPages(tripPlan, container) {
                    tripPlan.forEach(dayData => {
                        const page = createPage(`parent-detail-${dayData.day}`, `ç¬¬${dayData.day}å¤©`);
                        const content = page.querySelector('.page-content');
                        content.innerHTML = `
                            <h2>ç¬¬${dayData.day}å¤©: ${dayData.parentVersion.title}</h2>
                             <div class="info-section">
                                <h4>ğŸ—“ï¸ è¯¦ç»†è¡Œç¨‹</h4>
                                <ul>${(dayData.parentVersion.itinerary || []).map(i => `<li>${i}</li>`).join('')}</ul>
                            </div>
                            <div class="info-section">
                                <h4><span>ğŸ’¡</span> å®ç”¨è´´å£«</h4>
                                <p>${dayData.parentVersion.tips || 'æš‚æ— '}</p>
                            </div>
                        `;
                        container.appendChild(page);
                    });
                }

                function generateSafetyPage(container, destination) {
                    const isInternational = isInternationalDestination(destination);
                    let safetyHTML = '<h2>ğŸš¨ å®‰å…¨é¡»çŸ¥</h2>';
                    safetyHTML += `
                        <div class="emergency-contact">
                            <h4>ğŸš‘ ç´§æ€¥è”ç»œ</h4>
                            <div class="contact-number">æŠ¥è­¦ï¼š110</div>
                            <div class="contact-number">ç«è­¦ï¼š119</div>
                            <div class="contact-number">åŒ»ç–—æ€¥æ•‘ï¼š120</div>
                        </div>
                    `;
                    if (isInternational) {
                        safetyHTML += `
                            <div class="emergency-contact">
                                <h4>ğŸ›ï¸ ä¸­å›½é¢†äº‹é¦†</h4>
                                <p>å¤–äº¤éƒ¨å…¨çƒé¢†äº‹ä¿æŠ¤çƒ­çº¿ï¼š+86-10-12308</p>
                            </div>
                        `;
                    }
                    safetyHTML += `
                        <div class="info-section">
                            <h4>âš ï¸ å®‰å…¨æé†’</h4>
                            <ul>
                                <li>ä¿ç®¡å¥½é‡è¦è¯ä»¶ï¼Œå»ºè®®æ‹ç…§å¤‡ä»½</li>
                                <li>å‘ŠçŸ¥å®¶äººè¯¦ç»†è¡Œç¨‹å’Œè”ç»œæ–¹å¼</li>
                                <li>çœ‹å¥½å„¿ç«¥ï¼Œé¿å…èµ°å¤±</li>
                            </ul>
                        </div>
                    `;
                    container.innerHTML = safetyHTML;
                }

                function isInternationalDestination(destination) {
                    const domesticKeywords = ['ä¸­å›½', 'åŒ—äº¬', 'ä¸Šæµ·', 'å¹¿å·', 'æ·±åœ³', 'æ­å·', 'å—äº¬', 'æˆéƒ½', 'é‡åº†', 'è¥¿å®‰', 'æ­¦æ±‰', 'é¦™æ¸¯', 'æ¾³é—¨', 'å°åŒ—'];
                    return !domesticKeywords.some(keyword => destination.includes(keyword));
                }

                function updateNotebookTabs(type, dayCount) {
                    const tabsContainer = document.getElementById(`${type}-notebook-tabs`);
                    tabsContainer.innerHTML = '';

                    const pages = [
                        { id: `${type}-cover`, label: 'å°é¢' },
                        { id: `${type}-itinerary`, label: 'æ€»è§ˆ' },
                        { id: `${type}-checklist`, label: 'è¡Œæ' },
                    ];

                    for (let i = 1; i <= dayCount; i++) {
                        pages.push({ id: `${type}-detail-${i}`, label: `ç¬¬${i}å¤©` });
                    }

                    pages.push({ id: `${type}-safety`, label: 'å®‰å…¨' });

                    pages.forEach((page, index) => {
                        const tabItem = document.createElement('div');
                        tabItem.className = 'tab-item';
                        tabItem.dataset.page = `page-${page.id}`;
                        tabItem.innerHTML = `<span class="tab-label">${page.label}</span>`;
                        tabItem.addEventListener('click', () => setActiveTab(tabItem));
                        tabsContainer.appendChild(tabItem);
                    });
                }

                function setActiveTab(tab) {
                    if (!tab) return;
                    const notebook = tab.closest('.travel-notebook');
                    const targetPageId = tab.dataset.page;

                    // Deactivate all tabs in this notebook
                    notebook.querySelectorAll('.tab-item').forEach(t => t.classList.remove('active'));
                    // Hide all pages in this notebook
                    notebook.querySelectorAll('.notebook-page').forEach(p => p.style.display = 'none');

                    // Activate the clicked tab and show the corresponding page
                    tab.classList.add('active');
                    const targetPage = notebook.querySelector(`#${targetPageId}`);
                    if (targetPage) {
                        targetPage.style.display = 'block';
                    }
                }

    </script>
<script>
    function initializeInteractiveElements() {
        const canvases = document.querySelectorAll('.drawing-area canvas');
        canvases.forEach(canvas => {
            const ctx = canvas.getContext('2d');
            ctx.strokeStyle = '#000';
            ctx.lineWidth = 3;
            ctx.lineCap = 'round';

            let isDrawing = false;
            let lastX = 0;
            let lastY = 0;

            function draw(e) {
                if (!isDrawing) return;
                const rect = canvas.getBoundingClientRect();
                const x = e.offsetX || e.touches[0].clientX - rect.left;
                const y = e.offsetY || e.touches[0].clientY - rect.top;

                ctx.beginPath();
                ctx.moveTo(lastX, lastY);
                ctx.lineTo(x, y);
                ctx.stroke();
                [lastX, lastY] = [x, y];
            }

            canvas.addEventListener('mousedown', (e) => {
                isDrawing = true;
                const rect = canvas.getBoundingClientRect();
                [lastX, lastY] = [e.offsetX, e.offsetY];
            });
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', () => isDrawing = false);
            canvas.addEventListener('mouseout', () => isDrawing = false);

            // Touch events
            canvas.addEventListener('touchstart', (e) => {
                if (e.touches.length === 1) {
                    e.preventDefault();
                    isDrawing = true;
                    const rect = canvas.getBoundingClientRect();
                    [lastX, lastY] = [e.touches[0].clientX - rect.left, e.touches[0].clientY - rect.top];
                }
            });
            canvas.addEventListener('touchmove', (e) => {
                 if (e.touches.length === 1) {
                    e.preventDefault();
                    draw(e);
                 }
            });
            canvas.addEventListener('touchend', () => isDrawing = false);
        });

        const stickers = document.querySelectorAll('.sticker');
        stickers.forEach(sticker => {
            sticker.addEventListener('dragstart', (e) => {
                e.dataTransfer.setData('text/plain', e.target.src);
            });
        });

        canvases.forEach(canvas => {
            canvas.addEventListener('dragover', (e) => {
                e.preventDefault();
            });

            canvas.addEventListener('drop', (e) => {
                e.preventDefault();
                const imgSrc = e.dataTransfer.getData('text/plain');
                const img = new Image();
                img.src = imgSrc;
                img.onload = () => {
                    const rect = canvas.getBoundingClientRect();
                    const x = e.clientX - rect.left - 25; // Center the sticker
                    const y = e.clientY - rect.top - 25;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, x, y, 50, 50);
                };
            });
        });
    }

    // Re-initialize when a new plan is rendered.
    const originalRenderPlan = renderPlan;
    renderPlan = function(data) {
        originalRenderPlan(data);
        // Use a timeout to ensure the DOM is updated before we try to find the new elements
        setTimeout(initializeInteractiveElements, 500);
    }

</script>
</body>
</html>
